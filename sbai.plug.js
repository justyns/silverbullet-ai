var J=Object.defineProperty;var y=(e,t)=>{for(var r in t)J(e,r,{get:t[r],enumerable:!0})};var S=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var b=new Map,A=0;function h(e){self.postMessage(e)}S&&(globalThis.syscall=async(e,...t)=>await new Promise((r,n)=>{A++,b.set(A,{resolve:r,reject:n}),h({type:"sys",id:A,name:e,args:t})}));function k(e,t){S&&(self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let s=e[n.name];if(!s)throw new Error(`Function not loaded: ${n.name}`);try{let i=await Promise.resolve(s(...n.args||[]));h({type:"invr",id:n.id,result:i})}catch(i){console.error("An exception was thrown as a result of invoking function",n.name,"error:",i.message),h({type:"invr",id:n.id,error:i.message})}}break;case"sysr":{let s=n.id,i=b.get(s);if(!i)throw Error("Invalid request id");b.delete(s),n.error?i.reject(new Error(n.error)):i.resolve(n.result)}break}})().catch(console.error)}),h({type:"manifest",manifest:t}))}function X(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let s=0;s<r;s++)n[s]=t.charCodeAt(s);return n}function O(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function Z(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),n=r.length>0?O(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function ee(){globalThis.fetch=async function(e,t){let r=t&&t.body?O(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await Z(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(n.base64Body?X(n.base64Body):null,{status:n.status,headers:n.headers})}}S&&ee();function v(e){if(e.children)for(let t of e.children){if(t.parent)return;t.parent=e,v(t)}}function N(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...N(n,t)];return r}async function R(e,t){if(await t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...await R(n,t)];return r}async function M(e,t){if(e.children){let r=e.children.slice();for(let n of r){let s=await t(n);if(s!==void 0){let i=e.children.indexOf(n);s?e.children.splice(i,1,s):e.children.splice(i,1)}else await M(n,t)}}}function I(e,t){return N(e,r=>r.type===t)[0]}function D(e,t){N(e,t)}async function U(e,t){await R(e,t)}function x(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(x(r));return t.join("")}var a={};y(a,{confirm:()=>Ce,dispatch:()=>Me,downloadFile:()=>he,filterBox:()=>we,flashNotification:()=>Pe,fold:()=>Oe,foldAll:()=>Ue,getCurrentPage:()=>te,getCursor:()=>se,getSelection:()=>ie,getText:()=>ne,getUiOption:()=>Fe,goHistory:()=>ye,hidePanel:()=>Ae,insertAtCursor:()=>Ne,insertAtPos:()=>be,moveCursor:()=>ve,navigate:()=>le,openCommandPalette:()=>ue,openPageNavigator:()=>me,openSearchPanel:()=>$e,openUrl:()=>ge,prompt:()=>Ie,reloadPage:()=>fe,reloadSettingsAndCommands:()=>de,reloadUI:()=>pe,replaceRange:()=>Se,save:()=>ce,setPage:()=>re,setSelection:()=>ae,setText:()=>oe,setUiOption:()=>Ee,showPanel:()=>Te,toggleFold:()=>De,unfold:()=>Re,unfoldAll:()=>We,uploadFile:()=>xe,vimEx:()=>ke});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var o=self.syscall;function te(){return o("editor.getCurrentPage")}function re(e){return o("editor.setPage",e)}function ne(){return o("editor.getText")}function oe(e){return o("editor.setText",e)}function se(){return o("editor.getCursor")}function ie(){return o("editor.getSelection")}function ae(e,t){return o("editor.setSelection",e,t)}function ce(){return o("editor.save")}function le(e,t=!1,r=!1){return o("editor.navigate",e,t,r)}function me(e="page"){return o("editor.openPageNavigator",e)}function ue(){return o("editor.openCommandPalette")}function fe(){return o("editor.reloadPage")}function pe(){return o("editor.reloadUI")}function de(){return o("editor.reloadSettingsAndCommands")}function ge(e,t=!1){return o("editor.openUrl",e,t)}function ye(e){return o("editor.goHistory",e)}function he(e,t){return o("editor.downloadFile",e,t)}function xe(e,t){return o("editor.uploadFile",e,t)}function Pe(e,t="info"){return o("editor.flashNotification",e,t)}function we(e,t,r="",n=""){return o("editor.filterBox",e,t,r,n)}function Te(e,t,r,n=""){return o("editor.showPanel",e,t,r,n)}function Ae(e){return o("editor.hidePanel",e)}function be(e,t){return o("editor.insertAtPos",e,t)}function Se(e,t,r){return o("editor.replaceRange",e,t,r)}function ve(e,t=!1){return o("editor.moveCursor",e,t)}function Ne(e){return o("editor.insertAtCursor",e)}function Me(e){return o("editor.dispatch",e)}function Ie(e,t=""){return o("editor.prompt",e,t)}function Ce(e){return o("editor.confirm",e)}function Fe(e){return o("editor.getUiOption",e)}function Ee(e,t){return o("editor.setUiOption",e,t)}function ke(e){return o("editor.vimEx",e)}function Oe(){return o("editor.fold")}function Re(){return o("editor.unfold")}function De(){return o("editor.toggleFold")}function Ue(){return o("editor.foldAll")}function We(){return o("editor.unfoldAll")}function $e(){return o("editor.openSearchPanel")}var p={};y(p,{parseMarkdown:()=>Ke});function Ke(e){return o("markdown.parseMarkdown",e)}var g={};y(g,{deleteAttachment:()=>Ve,deleteFile:()=>tt,deletePage:()=>qe,getAttachmentMeta:()=>Qe,getFileMeta:()=>Ze,getPageMeta:()=>je,listAttachments:()=>ze,listFiles:()=>Je,listPages:()=>Le,listPlugs:()=>Be,readAttachment:()=>He,readFile:()=>Xe,readPage:()=>Ye,writeAttachment:()=>_e,writeFile:()=>et,writePage:()=>Ge});function Le(e=!1){return o("space.listPages",e)}function je(e){return o("space.getPageMeta",e)}function Ye(e){return o("space.readPage",e)}function Ge(e,t){return o("space.writePage",e,t)}function qe(e){return o("space.deletePage",e)}function Be(){return o("space.listPlugs")}function ze(){return o("space.listAttachments")}function Qe(e){return o("space.getAttachmentMeta",e)}function He(e){return o("space.readAttachment",e)}function _e(e,t){return o("space.writeAttachment",e,t)}function Ve(e){return o("space.deleteAttachment",e)}function Je(){return o("space.listFiles")}function Xe(e){return o("space.readFile",e)}function Ze(e){return o("space.getFileMeta",e)}function et(e,t){return o("space.writeFile",e,t)}function tt(e){return o("space.deleteFile",e)}var f=globalThis.syscall;var m={};y(m,{parse:()=>ft,stringify:()=>pt});function ft(e){return f("yaml.parse",e)}function pt(e){return f("yaml.stringify",e)}async function yt(e,t){let r=await g.readPage(e),n=await p.parseMarkdown(r),s;return D(n,i=>{if(i.type!=="FencedCode")return!1;let c=I(i,"CodeInfo");if(t&&!c||t&&!t.includes(c.children[0].text))return!1;let l=I(i,"CodeText");return l?(s=l.children[0].text,!0):!1}),s}async function P(e,t=["yaml"]){let r=await yt(e,t);if(r!==void 0)try{return m.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}var ht="SETTINGS";async function W(e,t){try{let n=(await P(ht,["yaml"])||{})[e];return n===void 0?t:n}catch(r){if(r.message==="Not found")return t;throw r}}async function $(e){try{let r=(await P("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}function w(e){if(!e||typeof e!="object")return e;if(Array.isArray(e))return e.map(w);let t={};for(let r of Object.keys(e)){let n=r.split("."),s=t;for(let i=0;i<n.length-1;i++){let c=n[i];s[c]||(s[c]={}),s=s[c]}s[n[n.length-1]]=w(e[r])}return t}async function K(e,t={}){let r={tags:[]},n=[];return v(e),await M(e,async s=>{if(s.type==="Paragraph"&&s.parent?.type==="Document"){let i=!0,c=new Set;for(let l of s.children)if(l.text){if(l.text.startsWith(`
`)&&l.text!==`
`)break;if(l.text.trim()){i=!1;break}}else if(l.type==="Hashtag"){let u=l.children[0].text.substring(1);c.add(u),(t.removeTags===!0||t.removeTags?.includes(u))&&(l.children[0].text="")}else if(l.type){i=!1;break}i&&n.push(...c)}if(s.type==="FrontMatter"){let i=s.children[1].children[0],c=x(i);try{let l=await m.parse(c),u={...l};if(r={...r,...l},r.tags||(r.tags=[]),typeof r.tags=="string"&&n.push(...r.tags.split(/,\s*|\s+/)),Array.isArray(r.tags)&&n.push(...r.tags),t.removeKeys&&t.removeKeys.length>0){let F=!1;for(let E of t.removeKeys)E in u&&(delete u[E],F=!0);F&&(i.text=await m.stringify(u))}if(Object.keys(u).length===0||t.removeFrontmatterSection)return null}catch(l){console.warn("Could not parse frontmatter",l.message)}}}),r.tags=[...new Set([...n.map(s=>s.replace(/^#/,""))])],r=w(r),r}async function L(e,t){let r=null;if(await U(e,async n=>{if(n.type==="FrontMatter"){let s=n.children[1].children[0],i=x(s);try{let c="";if(typeof t=="string")c=i+t+`
`;else{let u={...await m.parse(i),...t};c=await m.stringify(u)}r={changes:{from:s.from,to:s.to,insert:c}}}catch(c){console.error("Error parsing YAML",c)}return!0}return!1}),!r){let n="";typeof t=="string"?n=t+`
`:n=await m.stringify(t),r={changes:{from:0,to:0,insert:`---
`+n+`---
`}}}return r}var d,xt;async function j(){if(d=await $("OPENAI_API_KEY"),!d)throw new Error("OpenAI API key is missing. Please set it in the secrets page.");xt=await W("ai",{summarizePrompt:"Summarize this note. Use markdown for any formatting. The note name is ${noteName}",tagPrompt:'You are an AI tagging assistant. Given the note titled "${noteName}" with the content below, please provide a short list of tags, separated by spaces. Only return tags and no other content. Tags must be one word only and lowercase.',imagePrompt:"Please rewrite the following prompt for better image generation:",temperature:.5,maxTokens:100})}async function Pt(){let e=await a.getSelection(),t="";return e.from===e.to?t="":t=(await a.getText()).slice(e.from,e.to),{from:e.from,to:e.to,text:t}}async function Y(){let e=await Pt(),t=await a.getText();if(e.text==="")return{from:0,to:t.length,text:t,isWholeNote:!0};let r=e.from===0&&e.to===t.length;return{...e,isWholeNote:r}}async function C(){let e=await Y();if(console.log("selectedTextInfo",e),e.text.length>0){let t=await a.getCurrentPage(),r=await T(`Summarize this note. Use markdown for any formatting. The note name is ${t}`,[{role:"user",content:e.text}]);return console.log("OpenAI response:",r),{summary:r.choices[0].message.content,selectedTextInfo:e}}return{summary:"",selectedTextInfo:null}}async function G(){let e=await Y(),t=await a.prompt("Please enter a prompt to send to the LLM."),r=await a.getCurrentPage(),n=new Date,s=n.toISOString().split("T")[0],i=n.toLocaleDateString("en-US",{weekday:"long"}),c=await T(`You are an AI note assistant. Today is ${i}, ${s}. The current note name is "${r}". Follow the user prompt below as closely as possible. 
${t}`,[{role:"user",content:e.text}]);e.isWholeNote?await a.insertAtCursor(c.choices[0].message.content):await a.replaceRange(e.from,e.to,c.choices[0].message.content)}async function q(){let{summary:e}=await C();e?await a.showPanel("rhs",2,e):await a.flashNotification("No summary available.")}async function B(){let{summary:e,selectedTextInfo:t}=await C();e&&t&&await a.replaceRange(t.from,t.to,e)}async function z(){let{summary:e,selectedTextInfo:t}=await C();e&&t&&await a.insertAtPos(`

**Summary:** `+e,t.to)}async function Q(){let e=await a.getText(),t=await a.getCurrentPage(),n=(await T(`You are an AI tagging assistant. Given the note titled "${t}" with the content below, please provide a short list of tags, separated by spaces. Only return tags and no other content. Tags must be one word only and lowercase.

${e}`,[])).choices[0].message.content.trim().replace(/,/g,"").split(/\s+/),s=await p.parseMarkdown(e),i=await K(s),c=[...new Set([...i.tags||[],...n])];i.tags=c,console.log("Current frontmatter:",i);let l=await L(s,i);console.log("updatedNoteContent",l),await a.dispatch(l),await a.flashNotification("Note tagged successfully.")}async function T(e,t){try{d||await j(),await a.flashNotification("Contacting OpenAI, please wait...");let r=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:e},...t]})});if(!r.ok)throw new Error(`HTTP error, status: ${r.status}`);return await r.json()}catch(r){throw console.error("Error calling OpenAI chat endpoint:",r),r}}async function H(){try{let e=await a.prompt("Enter a prompt for DALL\xB7E:");if(!e){await a.flashNotification("No prompt entered. Operation cancelled.","error");return}let r=(await T("Please rewrite the following prompt for better image generation:",[{role:"user",content:e}])).choices[0].message.content.trim();if(!r){await a.flashNotification("Failed to rewrite prompt for better image generation.","error");return}e=r;let n=await wt(e,1);if(n&&n.data&&n.data.length>0){let s=n.data[0].url,i=`![${e}](${s})
*${e}*`;await a.insertAtCursor(i),await a.flashNotification("Image generated and inserted with caption successfully.")}else await a.flashNotification("Failed to generate image.","error")}catch(e){console.error("Error generating image with DALL\xB7E:",e),await a.flashNotification("Error generating image.","error")}}async function wt(e,t,r="512x512"){try{d||await j(),await a.flashNotification("Contacting DALL\xB7E, please wait...");let n=await fetch("https://api.openai.com/v1/images/generations",{method:"POST",headers:{Authorization:`Bearer ${d}`,"Content-Type":"application/json"},body:JSON.stringify({model:"dall-e-2",prompt:e,n:t,size:r})});if(!n.ok)throw new Error(`HTTP error, status: ${n.status}`);return await n.json()}catch(n){throw console.error("Error calling DALL\xB7E image generation endpoint:",n),n}}var _={summarizeNote:q,replaceWithSummary:B,insertSummary:z,callOpenAI:G,tagNoteWithAI:Q,promptAndGenerateImage:H},V={name:"sbai",requiredPermissions:["fetch"],functions:{summarizeNote:{path:"sbai.ts:openSummaryPanel",command:{name:"AI: Summarize Note and open summary"}},replaceWithSummary:{path:"sbai.ts:replaceWithSummary",command:{name:"AI: Replace with Summary"}},insertSummary:{path:"sbai.ts:insertSummary",command:{name:"AI: Insert Summary"}},callOpenAI:{path:"sbai.ts:callOpenAIwithNote",command:{name:"AI: Call OpenAI with Note context"}},tagNoteWithAI:{path:"sbai.ts:tagNoteWithAI",command:{name:"AI: Generate tags for note"}},promptAndGenerateImage:{path:"sbai.ts:promptAndGenerateImage",command:{name:"AI: Generate and insert image using DallE"}}},assets:{}},vr={manifest:V,functionMapping:_};k(_,V);export{vr as plug};
