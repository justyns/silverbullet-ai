var Ge=Object.defineProperty;var v=(e,t)=>{for(var r in t)Ge(e,r,{get:t[r],enumerable:!0})};var z=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var Q=new Map,Y=0;function L(e){self.postMessage(e)}z&&(globalThis.syscall=async(e,...t)=>await new Promise((r,n)=>{Y++,Q.set(Y,{resolve:r,reject:n}),L({type:"sys",id:Y,name:e,args:t})}));function le(e,t){z&&(self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let o=e[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let s=await Promise.resolve(o(...n.args||[]));L({type:"invr",id:n.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",n.name,"error:",s.message),L({type:"invr",id:n.id,error:s.message})}}break;case"sysr":{let o=n.id,s=Q.get(o);if(!s)throw Error("Invalid request id");Q.delete(o),n.error?s.reject(new Error(n.error)):s.resolve(n.result)}break}})().catch(console.error)}),L({type:"manifest",manifest:t}))}function _e(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}function me(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function Ve(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),n=r.length>0?me(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function Ye(){globalThis.fetch=async function(e,t){let r=t&&t.body?me(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await Ve(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(n.base64Body?_e(n.base64Body):null,{status:n.status,headers:n.headers})}}z&&Ye();function H(e){if(e.children)for(let t of e.children){if(t.parent)return;t.parent=e,H(t)}}function Qe(e,t){return K(e,r=>r.type===t)}function K(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...K(n,t)];return r}async function ue(e,t){if(await t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...await ue(n,t)];return r}async function J(e,t){if(e.children){let r=e.children.slice();for(let n of r){let o=await t(n);if(o!==void 0){let s=e.children.indexOf(n);o?e.children.splice(s,1,o):e.children.splice(s,1)}else await J(n,t)}}}function R(e,t){return K(e,r=>r.type===t)[0]}function X(e,t){K(e,t)}async function pe(e,t){await ue(e,t)}function S(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(S(r));return t.join("")}function Z(e,t=!0){if(Qe(e,"\u26A0").length>0)throw new Error(`Parse error in: ${S(e)}`);if(e.text!==void 0)return e.text;let n=[e.type];for(let o of e.children)o.type&&!o.type.endsWith("Mark")&&n.push(Z(o,t)),o.text&&(t&&o.text.trim()||!t)&&n.push(o.text);return n}function $(e){if(!e||typeof e!="object")return e;if(Array.isArray(e))return e.map($);let t={};for(let r of Object.keys(e)){let n=r.split("."),o=t;for(let s=0;s<n.length-1;s++){let a=n[s];o[a]||(o[a]={}),o=o[a]}o[n[n.length-1]]=$(e[r])}return t}var l={};v(l,{confirm:()=>bt,copyToClipboard:()=>Lt,dispatch:()=>At,downloadFile:()=>ut,filterBox:()=>ft,flashNotification:()=>dt,fold:()=>It,foldAll:()=>Nt,getCurrentPage:()=>ze,getCursor:()=>Ze,getSelection:()=>et,getText:()=>Je,getUiOption:()=>St,goHistory:()=>mt,hidePanel:()=>ht,insertAtCursor:()=>wt,insertAtPos:()=>yt,moveCursor:()=>Pt,navigate:()=>nt,openCommandPalette:()=>st,openPageNavigator:()=>ot,openSearchPanel:()=>Ut,openUrl:()=>lt,prompt:()=>vt,redo:()=>Ft,reloadPage:()=>it,reloadSettingsAndCommands:()=>ct,reloadUI:()=>at,replaceRange:()=>xt,save:()=>rt,setPage:()=>He,setSelection:()=>tt,setText:()=>Xe,setUiOption:()=>Tt,showPanel:()=>gt,toggleFold:()=>Et,undo:()=>kt,unfold:()=>Mt,unfoldAll:()=>Ot,uploadFile:()=>pt,vimEx:()=>Ct});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var i=globalThis.syscall;function ze(){return i("editor.getCurrentPage")}function He(e){return i("editor.setPage",e)}function Je(){return i("editor.getText")}function Xe(e){return i("editor.setText",e)}function Ze(){return i("editor.getCursor")}function et(){return i("editor.getSelection")}function tt(e,t){return i("editor.setSelection",e,t)}function rt(){return i("editor.save")}function nt(e,t=!1,r=!1){return i("editor.navigate",e,t,r)}function ot(e="page"){return i("editor.openPageNavigator",e)}function st(){return i("editor.openCommandPalette")}function it(){return i("editor.reloadPage")}function at(){return i("editor.reloadUI")}function ct(){return i("editor.reloadSettingsAndCommands")}function lt(e,t=!1){return i("editor.openUrl",e,t)}function mt(e){return i("editor.goHistory",e)}function ut(e,t){return i("editor.downloadFile",e,t)}function pt(e,t){return i("editor.uploadFile",e,t)}function dt(e,t="info"){return i("editor.flashNotification",e,t)}function ft(e,t,r="",n=""){return i("editor.filterBox",e,t,r,n)}function gt(e,t,r,n=""){return i("editor.showPanel",e,t,r,n)}function ht(e){return i("editor.hidePanel",e)}function yt(e,t){return i("editor.insertAtPos",e,t)}function xt(e,t,r){return i("editor.replaceRange",e,t,r)}function Pt(e,t=!1){return i("editor.moveCursor",e,t)}function wt(e){return i("editor.insertAtCursor",e)}function At(e){return i("editor.dispatch",e)}function vt(e,t=""){return i("editor.prompt",e,t)}function bt(e){return i("editor.confirm",e)}function St(e){return i("editor.getUiOption",e)}function Tt(e,t){return i("editor.setUiOption",e,t)}function Ct(e){return i("editor.vimEx",e)}function It(){return i("editor.fold")}function Mt(){return i("editor.unfold")}function Et(){return i("editor.toggleFold")}function Nt(){return i("editor.foldAll")}function Ot(){return i("editor.unfoldAll")}function kt(){return i("editor.undo")}function Ft(){return i("editor.redo")}function Ut(){return i("editor.openSearchPanel")}function Lt(e){return i("editor.copyToClipboard",e)}var w={};v(w,{parseMarkdown:()=>Kt});function Kt(e){return i("markdown.parseMarkdown",e)}var g={};v(g,{deleteAttachment:()=>Yt,deleteFile:()=>Xt,deletePage:()=>Dt,getAttachmentMeta:()=>Gt,getFileMeta:()=>Ht,getPageMeta:()=>$t,listAttachments:()=>Bt,listFiles:()=>Qt,listPages:()=>Rt,listPlugs:()=>Wt,readAttachment:()=>_t,readFile:()=>zt,readPage:()=>qt,writeAttachment:()=>Vt,writeFile:()=>Jt,writePage:()=>jt});function Rt(e=!1){return i("space.listPages",e)}function $t(e){return i("space.getPageMeta",e)}function qt(e){return i("space.readPage",e)}function jt(e,t){return i("space.writePage",e,t)}function Dt(e){return i("space.deletePage",e)}function Wt(){return i("space.listPlugs")}function Bt(){return i("space.listAttachments")}function Gt(e){return i("space.getAttachmentMeta",e)}function _t(e){return i("space.readAttachment",e)}function Vt(e,t){return i("space.writeAttachment",e,t)}function Yt(e){return i("space.deleteAttachment",e)}function Qt(){return i("space.listFiles")}function zt(e){return i("space.readFile",e)}function Ht(e){return i("space.getFileMeta",e)}function Jt(e,t){return i("space.writeFile",e,t)}function Xt(e){return i("space.deleteFile",e)}var b={};v(b,{applyAttributeExtractors:()=>or,getEnv:()=>ir,getMode:()=>ar,getVersion:()=>cr,invokeCommand:()=>er,invokeFunction:()=>Zt,invokeSpaceFunction:()=>nr,listCommands:()=>tr,listSyscalls:()=>rr,reloadPlugs:()=>sr});function Zt(e,...t){return i("system.invokeFunction",e,...t)}function er(e,t){return i("system.invokeCommand",e,t)}function tr(){return i("system.listCommands")}function rr(){return i("system.listSyscalls")}function nr(e,...t){return i("system.invokeSpaceFunction",e,...t)}function or(e,t,r){return i("system.applyAttributeExtractors",e,t,r)}function sr(){return i("system.reloadPlugs")}function ir(){return i("system.getEnv")}function ar(){return i("system.getMode")}function cr(){return i("system.getVersion")}var T={};v(T,{del:()=>ur,get:()=>mr,set:()=>lr});function lr(e,t){return i("clientStore.set",e,t)}function mr(e){return i("clientStore.get",e)}function ur(e){return i("clientStore.delete",e)}var q={};v(q,{listLanguages:()=>gr,parseLanguage:()=>fr});function fr(e,t){return i("language.parseLanguage",e,t)}function gr(){return i("language.listLanguages")}var M={};v(M,{parseTemplate:()=>yr,renderTemplate:()=>hr});function hr(e,t,r={}){return i("template.renderTemplate",e,t,r)}function yr(e){return i("template.parseTemplate",e)}var E={};v(E,{dispatchEvent:()=>wr,listEvents:()=>Ar});function wr(e,t,r){return new Promise((n,o)=>{let s=-1;r&&(s=setTimeout(()=>{console.log("Timeout!"),o("timeout")},r)),i("event.dispatch",e,t).then(a=>{s!==-1&&clearTimeout(s),n(a)}).catch(o)})}function Ar(){return i("event.list")}var y={};v(y,{parse:()=>br,stringify:()=>Sr});function br(e){return i("yaml.parse",e)}function Sr(e){return i("yaml.stringify",e)}async function N(e,t={}){let r={tags:[]},n=[];H(e),await J(e,async o=>{if(o.type==="Paragraph"&&o.parent?.type==="Document"){let s=!0,a=new Set;for(let c of o.children)if(c.text){if(c.text.startsWith(`
`)&&c.text!==`
`)break;if(c.text.trim()){s=!1;break}}else if(c.type==="Hashtag"){let m=c.children[0].text.substring(1);a.add(m),(t.removeTags===!0||t.removeTags?.includes(m))&&(c.children[0].text="")}else if(c.type){s=!1;break}s&&n.push(...a)}if(o.type==="FrontMatter"){let s=o.children[1].children[0],a=S(s);try{let c=await y.parse(a),m={...c};if(r={...r,...c},r.tags||(r.tags=[]),typeof r.tags=="string"&&n.push(...r.tags.split(/,\s*|\s+/)),Array.isArray(r.tags)&&n.push(...r.tags),t.removeKeys&&t.removeKeys.length>0){let p=!1;for(let d of t.removeKeys)d in m&&(delete m[d],p=!0);p&&(s.text=await y.stringify(m))}if(Object.keys(m).length===0||t.removeFrontmatterSection)return null}catch(c){console.warn("Could not parse frontmatter",c.message)}}});try{r.tags=[...new Set([...n.map(o=>String(o).replace(/^#/,""))])]}catch(o){console.error("Error while processing tags",o)}return r=$(r),r}async function de(e,t){let r=null;if(await pe(e,async n=>{if(n.type==="FrontMatter"){let o=n.children[1].children[0],s=S(o);try{let a="";if(typeof t=="string")a=s+t+`
`;else{let m={...await y.parse(s),...t};a=await y.stringify(m)}r={changes:{from:o.from,to:o.to,insert:a}}}catch(a){console.error("Error parsing YAML",a)}return!0}return!1}),!r){let n="";typeof t=="string"?n=t+`
`:n=await y.stringify(t),r={changes:{from:0,to:0,insert:`---
`+n+`---
`}}}return r}var j=class{constructor(t,r={}){this.maxSize=t;this.map=new Map(Object.entries(r))}map;set(t,r,n){let o={value:r,la:Date.now()};if(n){let s=this.map.get(t);s?.expTimer&&clearTimeout(s.expTimer),o.expTimer=setTimeout(()=>{this.map.delete(t)},n)}if(this.map.size>=this.maxSize){let s=this.getOldestKey();this.map.delete(s)}this.map.set(t,o)}get(t){let r=this.map.get(t);if(r)return r.la=Date.now(),r.value}remove(t){this.map.delete(t)}toJSON(){return Object.fromEntries(this.map.entries())}getOldestKey(){let t,r;for(let[n,o]of this.map.entries())(!r||o.la<r)&&(t=n,r=o.la);return t}};var fe=new j(50);async function ge(e,t,r){if(!r)return t(e);let n=JSON.stringify(e),o=fe.get(n);if(o)return o;let s=await t(e);return fe.set(n,s,r*1e3),s}function ee(e,t,r){return ge(t,()=>b.invokeFunction("index.queryObjects",e,t),r)}async function he(e,t={},r={}){try{let n=await w.parseMarkdown(e),o=await N(n,{removeFrontmatterSection:!0,removeTags:["template"]});e=S(n).trimStart();let s;return o.frontmatter&&(typeof o.frontmatter=="string"?s=o.frontmatter:s=await y.stringify(o.frontmatter),s=await M.renderTemplate(s,t,r)),{frontmatter:o,renderedFrontmatter:s,text:await M.renderTemplate(e,t,r)}}catch(n){throw console.error("Error rendering template",n),n}}async function Ir(){let e=await l.getSelection(),t="";return e.from===e.to?t="":t=(await l.getText()).slice(e.from,e.to),{from:e.from,to:e.to,text:t}}async function D(){let e=await Ir(),t=await l.getText();if(e.text==="")return{from:0,to:t.length,text:t,isWholeNote:!0};let r=e.from===0&&e.to===t.length;return{...e,isWholeNote:r}}async function O(){return(await l.getText()).length}async function Mr(e,t){let r=await g.readPage(e),n=await w.parseMarkdown(r),o;return X(n,s=>{if(s.type!=="FencedCode")return!1;let a=R(s,"CodeInfo");if(t&&!a||t&&!t.includes(a.children[0].text))return!1;let c=R(s,"CodeText");return c?(o=c.children[0].text,!0):!1}),o}async function W(e,t=["yaml"]){let r=await Mr(e,t);if(r!==void 0)try{return y.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}async function te(e){try{let r=(await W("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}var Er="SETTINGS";async function ye(e,t){try{let n=(await W(Er,["yaml"])||{})[e];return n===void 0?t:n}catch(r){if(r.message==="Not found")return t;throw r}}var k=class{name;apiKey;baseUrl;modelName;constructor(t,r,n,o){this.name=t,this.apiKey=r,this.baseUrl=n,this.modelName=o,console.log(`New AI Provider initialized: ${this.name}, Base URL: ${this.baseUrl}, Model Name: ${this.modelName}`)}async streamChatIntoEditor(t,r){let{onDataReceived:n}=t,o="\u{1F914} Thinking \u2026 ",s=r??await O();await l.insertAtPos(o,s);let a=!0,c=m=>{try{if(!m){console.log("No data received from LLM");return}a?(["`","-","*"].includes(m.charAt(0))&&(console.log("First character of response is:",m.charAt(0)),m=`
`+m),l.replaceRange(s,s+o.length,m),a=!1):l.insertAtPos(m,s),s+=m.length,n&&n(m)}catch(p){console.error("Error handling chat stream data:",p),l.flashNotification("An error occurred while processing chat data.","error")}};await this.chatWithAI({...t,onDataReceived:c})}},B=class{apiKey;baseUrl;name;modelName;requireAuth;constructor(t,r,n,o,s=!0){this.apiKey=t,this.baseUrl=r,this.name=n,this.modelName=o,this.requireAuth=s}};var G=class extends B{constructor(t,r,n){super(t,n,"DALL-E",r)}async generateImage(t){try{P||await C();let r=await nativeFetch(`${this.baseUrl}/images/generations`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.modelName,prompt:t.prompt,n:t.numImages,size:t.size,quality:t.quality,response_format:"b64_json"})});if(!r.ok)throw new Error(`HTTP error, status: ${r.status}`);let n=await r.json();if(!n||n.length===0)throw new Error("Invalid response from DALL-E.");return n}catch(r){throw console.error("Error calling DALL\xB7E image generation endpoint:",r),r}}};var I=function(e,t){if(!(this instanceof I))return new I(e,t);this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.url=e,t=t||{},this.headers=t.headers||{},this.payload=t.payload!==void 0?t.payload:"",this.method=t.method||this.payload&&"POST"||"GET",this.withCredentials=!!t.withCredentials,this.debug=!!t.debug,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=this.INITIALIZING,this.progress=0,this.chunk="",this.addEventListener=function(r,n){this.listeners[r]===void 0&&(this.listeners[r]=[]),this.listeners[r].indexOf(n)===-1&&this.listeners[r].push(n)},this.removeEventListener=function(r,n){if(this.listeners[r]!==void 0){var o=[];this.listeners[r].forEach(function(s){s!==n&&o.push(s)}),o.length===0?delete this.listeners[r]:this.listeners[r]=o}},this.dispatchEvent=function(r){if(!r)return!0;this.debug&&console.debug(r),r.source=this;var n="on"+r.type;return this.hasOwnProperty(n)&&(this[n].call(this,r),r.defaultPrevented)?!1:this.listeners[r.type]?this.listeners[r.type].every(function(o){return o(r),!r.defaultPrevented}):!0},this._setReadyState=function(r){var n=new CustomEvent("readystatechange");n.readyState=r,this.readyState=r,this.dispatchEvent(n)},this._onStreamFailure=function(r){var n=new CustomEvent("error");n.data=r.currentTarget.response,this.dispatchEvent(n),this.close()},this._onStreamAbort=function(r){this.dispatchEvent(new CustomEvent("abort")),this.close()},this._onStreamProgress=function(r){if(this.xhr){if(this.xhr.status!==200){this._onStreamFailure(r);return}this.readyState==this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));var n=this.xhr.responseText.substring(this.progress);this.progress+=n.length;var o=(this.chunk+n).split(/(\r\n\r\n|\r\r|\n\n)/g),s=o.pop();o.forEach(function(a){a.trim().length>0&&this.dispatchEvent(this._parseEventChunk(a))}.bind(this)),this.chunk=s}},this._onStreamLoaded=function(r){this._onStreamProgress(r),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""},this._parseEventChunk=function(r){if(!r||r.length===0)return null;this.debug&&console.debug(r);var n={id:null,retry:null,data:null,event:null};r.split(/\n|\r\n|\r/).forEach(function(s){var a=s.indexOf(this.FIELD_SEPARATOR),c,m;if(a>0){var p=s[a+1]===" "?2:1;c=s.substring(0,a),m=s.substring(a+p)}else if(a<0)c=s,m="";else return;c in n&&(c==="data"&&n[c]!==null?n.data+=`
`+m:n[c]=m)}.bind(this));var o=new CustomEvent(n.event||"message");return o.data=n.data||"",o.id=n.id,o},this._checkStreamClosed=function(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)},this.stream=function(){if(!this.xhr){this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(var r in this.headers)this.xhr.setRequestHeader(r,this.headers[r]);this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))},(t.start===void 0||t.start)&&this.stream()};typeof exports<"u"&&(exports.SSE=I);var _=class extends k{name="Gemini";constructor(t,r){super("Gemini",t,"https://generativelanguage.googleapis.com",r)}async listModels(){let t=`${this.baseUrl}/v1beta/models?key=${this.apiKey}`;try{let r=await fetch(t);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).models||[]}catch(r){throw console.error("Failed to fetch models:",r),r}}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return r?await this.streamChat({messages:t,stream:r,onDataReceived:n}):await this.nonStreamingChat(t)}mapRolesForGemini(t){let r=[],n="";return t.forEach(o=>{let s="user";o.role==="system"||o.role==="user"?s="user":o.role==="assistant"&&(s="model"),s==="model"&&(r.length===0||n==="model")||(s==="user"&&n==="user"?r[r.length-1].parts[0].text+=" "+o.content:r.push({role:s,parts:[{text:o.content}]})),n=s}),r}streamChat(t){let{messages:r,onDataReceived:n}=t;try{let o=`${this.baseUrl}/v1beta/models/${this.modelName}:streamGenerateContent?key=${this.apiKey}&alt=sse`,s={"Content-Type":"application/json"},a=this.mapRolesForGemini(r),c={method:"POST",headers:s,payload:JSON.stringify({contents:a}),withCredentials:!1},m=new I(o,c),p="";m.addEventListener("message",d=>{try{if(d.data=="[DONE]")return m.close(),p;if(!d.data)console.error("Received empty message from Gemini"),console.log("source: ",m);else{let h=JSON.parse(d.data),ce=h.candidates[0].content.parts[0].text||h.text||"";p+=ce,n&&n(ce)}}catch(h){console.error("Error processing message event:",h,d.data)}}),m.addEventListener("end",()=>(m.close(),p)),m.addEventListener("error",d=>{console.error("SSE error:",d),m.close()}),m.stream()}catch(o){throw console.error("Error streaming from Gemini chat endpoint:",o),o}}async nonStreamingChat(t){let r=this.mapRolesForGemini(t),n=await nativeFetch(`${this.baseUrl}/v1beta/models/${this.modelName}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).candidates[0].content.parts[0].text}};var V=class extends k{name="OpenAI";requireAuth;constructor(t,r,n,o){super("OpenAI",t,n,r),this.requireAuth=o}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return r?await this.streamChat({messages:t,onDataReceived:n}):await this.nonStreamingChat(t)}async streamChat(t){let{messages:r,onDataReceived:n}=t;try{let o=`${this.baseUrl}/chat/completions`,s={"Content-Type":"application/json"};this.requireAuth&&(s.Authorization=`Bearer ${this.apiKey}`);let a={method:"POST",headers:s,payload:JSON.stringify({model:this.modelName,stream:!0,messages:r}),withCredentials:!1},c=new I(o,a),m="";c.addEventListener("message",function(p){try{if(p.data=="[DONE]")return c.close(),m;{let h=JSON.parse(p.data).choices[0]?.delta?.content||"";m+=h,n&&n(h)}}catch(d){console.error("Error processing message event:",d,p.data)}}),c.addEventListener("end",function(){return c.close(),m}),c.addEventListener("error",p=>{console.error("SSE error:",p),c.close()}),c.stream()}catch(o){throw console.error("Error streaming from OpenAI chat endpoint:",o),await l.flashNotification("Error streaming from OpenAI chat endpoint.","error"),o}return""}async nonStreamingChat(t){try{let r=JSON.stringify({model:this.modelName,messages:t}),n={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},o=await nativeFetch(this.baseUrl+"/chat/completions",{method:"POST",headers:n,body:r});if(!o.ok)throw console.error("http response: ",o),console.error("http response body: ",await o.json()),new Error(`HTTP error, status: ${o.status}`);let s=await o.json();if(!s||!s.choices||s.choices.length===0)throw new Error("Invalid response from OpenAI.");return s.choices[0].message.content}catch(r){throw console.error("Error calling OpenAI chat endpoint:",r),await l.flashNotification("Error calling OpenAI chat endpoint.","error"),r}}};var P,u,F,x,ne,re,Nr;async function A(){let e=await xe();(!P||!x||!u||!re||JSON.stringify(e)!==JSON.stringify(re))&&await C(!0)}async function xe(){try{return await T.get("ai.selectedTextModel")}catch{return}}async function Or(){try{return await T.get("ai.selectedImageModel")}catch{return}}async function Pe(e){await T.set("ai.selectedImageModel",e)}async function oe(e){await T.set("ai.selectedTextModel",e)}async function kr(){let e=await xe()||u.textModels[0];if(!e)throw new Error("No text model selected or available as default.");await se(e)}async function Fr(){let e=await Or()||u.imageModels[0];if(!e)throw new Error("No image model selected or available as default.");await ie(e)}function Ur(e){let t=e.provider.toLowerCase();switch(console.log("Provider name",t),t){case"dalle":ne=new G(P,e.modelName,e.baseUrl||u.dallEBaseUrl);break;default:throw new Error(`Unsupported image provider: ${e.provider}. Please configure a supported provider.`)}}function Lr(e){switch(e.provider.toLowerCase()){case"openai":x=new V(P,e.modelName,e.baseUrl||u.openAIBaseUrl,e.requireAuth||u.requireAuth);break;case"gemini":x=new _(P,e.modelName);break;default:throw new Error(`Unsupported AI provider: ${e.provider}. Please configure a supported provider.`)}}async function se(e){if(console.log("configureSelectedModel called with:",e),!e)throw new Error("No model provided to configure");if(e.requireAuth===void 0&&(e.requireAuth=u.requireAuth),e.requireAuth){let t=await te(e.secretName||"OPENAI_API_KEY");t!==P&&(P=t,console.log("API key updated"))}if(e.requireAuth&&!P)throw new Error("AI API key is missing. Please set it in the secrets page.");re=e,Lr(e)}async function ie(e){if(console.log("configureSelectedImageModel called with:",e),!e)throw new Error("No image model provided to configure");if(e.requireAuth){let t=await te(e.secretName||"OPENAI_API_KEY");t!==P&&(P=t,console.log("API key updated for image model"))}if(e.requireAuth&&!P)throw new Error("AI API key is missing for image model. Please set it in the secrets page.");Nr=e,Ur(e)}async function Kr(){let e={defaultTextModel:"gpt-3.5-turbo",openAIBaseUrl:"https://api.openai.com/v1",dallEBaseUrl:"https://api.openai.com/v1",requireAuth:!0,secretName:"OPENAI_API_KEY",provider:"OpenAI",chat:{},promptInstructions:{}},t={userInformation:"",userInstructions:"",parseWikiLinks:!0,customEnrichFunctions:[]},r={pageRenameRules:"",tagRules:""},n=await ye("ai",{});n.defaultTextModel?n.backwardsCompat=!0:n.backwardsCompat=!1;let o={...e,...n};return o.chat={...t,...n.chat||{}},o.promptInstructions={...r,...n.promptInstructions||{}},o}async function C(e=!0){let t=await Kr(),r="";if(!t.textModels&&t.defaultTextModel?(t.textModels=[{name:"default",description:"Default model",modelName:t.defaultTextModel,provider:t.provider,secretName:t.secretName}],await oe(t.textModels[0])):t.textModels.length>0&&t.backwardsCompat?r="Both textModels and defaultTextModel found in ai settings. Please remove defaultTextModel.":!t.textModels&&!t.defaultTextModel&&(r="No textModels found in ai settings"),r!=="")throw console.error(r),new Error(r);JSON.stringify(u)!==JSON.stringify(t)?(console.log("aiSettings updating from",u),u=t,console.log("aiSettings updated to",u)):console.log("aiSettings unchanged",u),e&&(await kr(),u.imageModels&&u.imageModels.length>0&&await Fr()),F={role:"system",content:"This is an interactive chat session with a user in a markdown-based note-taking tool called SilverBullet."},u.chat.userInformation&&(F.content+=`
The user has provided the following information about their self: ${u.chat.userInformation}`),u.chat.userInstructions&&(F.content+=`
The user has provided the following instructions for the chat, follow them as closely as possible: ${u.chat.userInstructions}`)}function we(e){return e.split("/").slice(0,-1).join("/")}async function Ae(){let t=(await l.getText()).split(`
`),r=[],n="user",o="";return t.forEach(s=>{let a=s.match(/^\*\*(\w+)\*\*:/);if(a){let c=a[1].toLowerCase();n&&n!==c&&(r.push({role:n,content:o.trim()}),o=""),n=c,o+=s.replace(/^\*\*(\w+)\*\*:/,"").trim()+`
`}else n&&(o+=s.trim()+`
`)}),o&&n&&r.push({role:n,content:o.trim()}),r}async function ve(){try{let e=await syscall("system.getVersion"),[t,r,n]=e.split(".").map(Number),[o,s,a]="0.7.2".split(".").map(Number);return t>o||t===o&&r>s||t===o&&r===s&&n>=a}catch{return!1}}async function ae(e){let t=[];for(let r of e){let n=r.content;if(r.role==="assistant"){t.push(r);continue}u.chat.parseWikiLinks&&(n=await Rr(n));let s=(await E.dispatchEvent("ai:enrichMessage",{enrichedContent:n,message:r})).flat().concat(u.chat.customEnrichFunctions),a=[...new Set(s)];console.log("Received custom enrich message functions",a);for(let c of a)n=await b.invokeSpaceFunction(c,n);t.push({...r,content:n})}return t}async function Rr(e){let t=[],r=e,n=/\[\[([^\]]+)\]\]/g,o,s=!1;for(;(o=n.exec(e))!==null;){let a=o[1];if(!t.includes(a)){s||(r+=`

Base your answer on the content of the following referenced pages (referenced above using the [[page name]] format). In these listings ~~~ is used to mark the page's content start and end. If context is missing, always ask me to link directly to a page mentioned in the context if.`,s=!0);try{let c=await g.readPage(a);t.push(a),r+=`

Content of the [[${a}]] page:
~~~
${c}
~~~
`}catch(c){console.error(`Error fetching page '${a}':`,c)}}}return r}async function be(e){return ve()?{options:(await ee("template",{filter:["attr",["attr","aiprompt"],"slashCommand"]},5)).map(r=>{let n=r.aiprompt;return console.log("ai prompt template: ",n),{label:n.slashCommand,detail:n.description||r.description,order:n.order||0,templatePage:r.ref,pageName:e.pageName,invoke:"silverbullet-ai.insertAiPromptFromTemplate"}})}:void 0}async function Se(e){let t;if(!e||!e.templatePage){let p=await ee("template",{filter:["attr",["attr","aiprompt"],"description"]});t=await l.filterBox("Prompt Template",p.map(d=>{let h=d.ref.split("/").pop();return{...d,description:d.aiprompt.description||d.ref,name:d.aiprompt.displayName||h,systemPrompt:d.aiprompt.systemPrompt||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:d.aiprompt.insertAt||"cursor"}}),"Select the template to use as the prompt.  The prompt will be rendered and sent to the LLM model.")}else{console.log("selectedTemplate from slash completion: ",e);let p=await g.readPage(e.templatePage),d=await w.parseMarkdown(p),{aiprompt:h}=await N(d);console.log("templatePage from slash completion: ",p),t={ref:e.templatePage,systemPrompt:h.systemPrompt||h.system||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:h.insertAt||"cursor"}}if(!t){await l.flashNotification("No template selected");return}console.log("User selected prompt template: ",t);let r=["cursor","page-start","page-end"];if(!r.includes(t.insertAt)){console.error(`Invalid insertAt value: ${t.insertAt}. It must be one of ${r.join(", ")}`),await l.flashNotification(`Invalid insertAt value: ${t.insertAt}. Please select a valid option.`,"error");return}await A();let n,o,s;try{n=await g.readPage(t.ref),o=await l.getCurrentPage(),s=await g.getPageMeta(o)}catch(p){console.error("Error fetching template details or page metadata",p),await l.flashNotification("Error fetching template details or page metadata","error");return}let a;switch(t.insertAt){case"page-start":a=0;break;case"page-end":a=await O();break;case"frontmatter":await l.flashNotification("rendering in frontmatter not supported yet","error");break;case"modal":break;case"replace":break;case"cursor":default:a=await l.getCursor()}console.log("templatetext: ",n);let c=await he(n,s,{page:s});console.log("Rendered template:",c);let m=[{role:"user",content:c.text}];t.systemPrompt&&m.unshift({role:"system",content:t.systemPrompt}),await x.streamChatIntoEditor({messages:m,stream:!0},a)}function Te(e){let t={querySource:""},[r,n,...o]=e;if(r!=="Query")throw new Error(`Expected query type, got ${r}`);t.querySource=n[1];for(let s of o){let[a]=s;switch(a){case"WhereClause":{t.filter?t.filter=["and",t.filter,f(s[2])]:t.filter=f(s[2]);break}case"OrderClause":{t.orderBy||(t.orderBy=[]);for(let c of s.slice(2))if(c[0]==="OrderBy"){let m=c[1][1];c[2]?t.orderBy.push({expr:f(m),desc:c[2][1][1]==="desc"}):t.orderBy.push({expr:f(m),desc:!1})}break}case"LimitClause":{t.limit=f(s[2][1]);break}case"SelectClause":{for(let c of s.slice(2))c[0]==="Select"&&(t.select||(t.select=[]),c.length===2?t.select.push({name:U(c[1][1])}):t.select.push({name:U(c[3][1]),expr:f(c[1])}));break}case"RenderClause":{let c=s.find(m=>m[0]==="PageRef");t.render=c[1].slice(2,-2),t.renderAll=!!s.find(m=>m[0]==="all");break}default:throw new Error(`Unknown clause type: ${a}`)}}return t}function U(e){return e.startsWith("`")&&e.endsWith("`")?e.slice(1,-1):e}function f(e){if(["LVal","Expression","Value"].includes(e[0]))return f(e[1]);switch(e[0]){case"Attribute":return["attr",f(e[1]),U(e[3][1])];case"Identifier":return["attr",U(e[1])];case"String":return["string",e[1].slice(1,-1)];case"Number":return["number",+e[1]];case"Bool":return["boolean",e[1][1]==="true"];case"null":return["null"];case"Regex":return["regexp",e[1].slice(1,-1),"i"];case"List":{let t=[];for(let r of e.slice(2))r[0]==="Expression"&&t.push(r);return["array",t.map(f)]}case"Object":{let t=[];for(let r of e.slice(2)){if(typeof r=="string")continue;let[n,o,s,a]=r;t.push([o[1].slice(1,-1),f(a)])}return["object",t]}case"BinExpression":{let t=f(e[1]),r=e[2][0]==="InKW"?"in":e[2].trim(),n=f(e[3]);return[r,t,n]}case"LogicalExpression":{let t=f(e[1]),r=e[2],n=f(e[3]);return[r[1],t,n]}case"ParenthesizedExpression":return f(e[2]);case"Call":{let t=U(e[1][1]),r=[];for(let n of e.slice(2))n[0]==="Expression"&&r.push(n);return["call",t,r.map(f)]}case"UnaryExpression":{if(e[1][0]==="NotKW"||e[1][0]==="!")return["not",f(e[2])];if(e[1][0]==="-")return["-",f(e[2])];throw new Error(`Unknown unary expression: ${e[1][0]}`)}case"TopLevelVal":return["attr"];case"GlobalIdentifier":return["global",e[1].substring(1)];case"TernaryExpression":{let[t,r,n,o,s,a]=e;return["?",f(r),f(o),f(a)]}case"QueryExpression":return["query",Te(e[2])];case"PageRef":return["pageref",e[1].slice(2,-2)];default:throw new Error(`Not supported: ${e[0]}`)}}async function Ce(e){let t=Z(await q.parseLanguage("query",e));return Te(t[1])}async function Ie(e,t){let r=await Ce(e);return $r(r,t)}async function $r(e,t){e.limit||(e.limit=["number",1e3]);let r=`query:${e.querySource}`,n={query:e};t&&(n.variables=t);let o=await E.dispatchEvent(r,n,30*1e3);if(o.length===0)throw new Error(`Unsupported query source '${e.querySource}'`);return o.flat()}var Do=new TextEncoder;function Me(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}async function Ee(e){(e==="SETTINGS"||e==="SECRETS")&&await C(!0)}async function Ne(){(!u||!u.textModels)&&await C(!1);let e=u.textModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await l.filterBox("Select a model",e);if(!t){await l.flashNotification("No model selected.","error");return}let r=t.name;await oe(t),await se(t),await l.flashNotification(`Selected model: ${r}`),console.log("Selected model:",t)}async function Oe(){(!u||!u.imageModels)&&await C(!1);let e=u.imageModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await l.filterBox("Select an image model",e);if(!t){await l.flashNotification("No image model selected.","error");return}let r=t.name;await Pe(t),await ie(t),await l.flashNotification(`Selected image model: ${r}`),console.log("Selected image model:",t)}async function ke(){await A();let e=await D(),t=await l.prompt("Please enter a prompt to send to the LLM. Selected text or the entire note will also be sent as context."),r=await l.getCurrentPage(),n=new Date,o=n.toISOString().split("T")[0],s=n.toLocaleDateString("en-US",{weekday:"long"});await x.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant.  Follow all user instructions and use the note context and note content to help follow those instructions.  Use Markdown for any formatting."},{role:"user",content:`Note Context: Today is ${s}, ${o}. The current note name is "${r}".
User Prompt: ${t}
Note Content:
${e.text}`}],stream:!0},e.to)}async function Fe(){await A();let e=await D();if(console.log("selectedTextInfo",e),e.text.length>0){let t=await l.getCurrentPage(),r=await x.chatWithAI({messages:[{role:"user",content:`Please summarize this note using markdown for any formatting. Your summary will be appended to the end of this note, do not include any of the note contents yourself. Keep the summary brief. The note name is ${t}.

${e.text}`}],stream:!1});return console.log("OpenAI response:",r),{summary:r,selectedTextInfo:e}}return{summary:"",selectedTextInfo:null}}async function Ue(){let{summary:e,selectedTextInfo:t}=await Fe();e&&t&&await l.insertAtPos(`

`+e,t.to)}async function Le(){let{summary:e}=await Fe();e?await l.showPanel("rhs",2,e):await l.flashNotification("No summary available.")}async function Ke(){await A();let e=await l.getText(),t=await l.getCurrentPage(),r=(await Ie("tag select name where parent = 'page' order by name")).map(p=>p.name);console.log("All tags:",r);let o=(await x.chatWithAI({messages:[{role:"system",content:`You are an AI tagging assistant. Please provide a short list of tags, separated by spaces. Follow these guidelines:
          - Only return tags and no other content.
          - Tags must be one word only and in lowercase.
          - Use existing tags as a starting point.
          - Suggest tags sparingly, treating them as thematic descriptors rather than keywords.

          The following tags are currently being used by other notes:
          ${r.join(", ")}
          
          Always follow the below rules, if any, given by the user:
          ${u.promptInstructions.tagRules}`},{role:"user",content:`Page Title: ${t}

Page Content:
${e}`}],stream:!1})).trim().replace(/,/g,"").split(/\s+/),s=await w.parseMarkdown(e),a=await N(s),c=[...new Set([...a.tags||[],...o])];a.tags=c,console.log("Current frontmatter:",a);let m=await de(s,a);console.log("updatedNoteContent",m),await l.dispatch(m),await l.flashNotification("Note tagged successfully.")}async function Re(){await A();let e=await l.getText(),t=await l.getCurrentPage(),r=[{role:"system",content:`You are an AI note-naming assistant. Your task is to suggest three to five possible names for the provided note content. Please adhere to the following guidelines:
- Provide each name on a new line.
- Avoid most special characters or symbols. Spaces are acceptable. Forward slashes are allowed as folder seperators. Hyphens are allowed.
- Ensure the names are concise and relevant to the content.
- Avoid suggesting the same name as the current note.
- Include as much detail as possible within 3 to 10 words.
- Do not change the folder or prefix of the note name unless explicitly requested by the user.
- Include the current folder name (with trailing /) in the suggestion.
- Retain ALL date and time information from the original note title.

Always follow the below rules, if any, given by the user:
${u.promptInstructions.pageRenameRules}`},{role:"user",content:`Current Page Title: ${t}

Page Content:
${e}`}],n=await ae(r);console.log("enrichedMessages",n);let s=(await x.chatWithAI({messages:n,stream:!1})).trim().split(`
`).filter(m=>m.trim()!=="").map(m=>m.trim());s.length===0&&await l.flashNotification("No suggestions available.");let a=await l.filterBox("Select a page name",s.map(m=>({name:m,description:m})));if(!a){await l.flashNotification("No page name selected.","error");return}console.log("selectedSuggestion",a);let c=await b.invokeFunction("index.renamePageCommand",{oldPage:t,page:a.name});console.log("renamedPage",c),c||await l.flashNotification("Error renaming page.","error")}async function $e(){let e=await D(),t=e.to;await x.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant in a markdown-based note tool."},{role:"user",content:e.text}],stream:!0},t)}async function qe(){await A();let e=await Ae();if(e.length===0){await l.flashNotification("Error: The page does not match the required format for a chat.");return}e.unshift(F);let t=await ae(e);console.log("enrichedMessages",t);let r=await O();await l.insertAtPos(`

**assistant**: `,r),r+=17,await l.insertAtPos(`

**user**: `,r),await l.moveCursor(r+12);try{await x.streamChatIntoEditor({messages:t,stream:!0},r)}catch(n){console.error("Error streaming chat on page:",n),await l.flashNotification("Error streaming chat on page.","error")}}async function je(){await A();try{let e=await l.prompt("Enter a prompt for DALL\xB7E:");if(!e||!e.trim()){await l.flashNotification("No prompt entered. Operation cancelled.","error");return}let t={prompt:e,numImages:1,size:"1024x1024",quality:"hd"},r=await ne.generateImage(t);if(r&&r.data&&r.data.length>0){let n=r.data[0].b64_json,o=r.data[0].revised_prompt,s=new Uint8Array(Me(n)),a=`dall-e-${Date.now()}.png`,c=we(await l.getCurrentPage())+"/";c==="/"&&(c=""),await g.writeAttachment(c+a,s);let m=`![${a}](${a})
*${o}*`;await l.insertAtCursor(m),await l.flashNotification("Image generated and inserted with caption successfully.")}else await l.flashNotification("Failed to generate image.","error")}catch(e){console.error("Error generating image with DALL\xB7E:",e),await l.flashNotification("Error generating image.","error")}}async function De(e,t){try{await A();let r=[];return r.push({role:"system",content:t||"You are an AI note assistant helping to render content for a note.  Please follow user instructions and keep your response short and concise."}),r.push({role:"user",content:e}),await x.chatWithAI({messages:r,stream:!1})}catch(r){throw console.error("Error querying OpenAI:",r),r}}var We={aiPromptSlashCommplete:be,queryOpenAI:De,reloadConfig:Ee,summarizeNote:Le,insertSummary:Ue,callOpenAI:ke,tagNoteWithAI:Ke,promptAndGenerateImage:je,streamOpenAIWithSelectionAsPrompt:$e,streamChatOnPage:qe,insertAiPromptFromTemplate:Se,suggestPageName:Re,selectTextModel:Ne,selectImageModel:Oe},Be={name:"silverbullet-ai",requiredPermissions:["fetch"],functions:{aiPromptSlashCommplete:{path:"src/prompts.ts:aiPromptSlashComplete",events:["slash:complete"]},queryOpenAI:{path:"sbai.ts:queryOpenAI"},reloadConfig:{path:"sbai.ts:reloadConfig",events:["page:saved"]},summarizeNote:{path:"sbai.ts:openSummaryPanel",command:{name:"AI: Summarize Note and open summary"}},insertSummary:{path:"sbai.ts:insertSummary",command:{name:"AI: Insert Summary"}},callOpenAI:{path:"sbai.ts:callOpenAIwithNote",command:{name:"AI: Call OpenAI with Note as context"}},tagNoteWithAI:{path:"sbai.ts:tagNoteWithAI",command:{name:"AI: Generate tags for note"}},promptAndGenerateImage:{path:"sbai.ts:promptAndGenerateImage",command:{name:"AI: Generate and insert image using DallE"}},streamOpenAIWithSelectionAsPrompt:{path:"sbai.ts:streamOpenAIWithSelectionAsPrompt",command:{name:"AI: Stream response with selection or note as prompt"}},streamChatOnPage:{path:"sbai.ts:streamChatOnPage",command:{name:"AI: Chat on current page",key:"Ctrl-Shift-Enter",mac:"Cmd-Shift-Enter"}},insertAiPromptFromTemplate:{path:"src/prompts.ts:insertAiPromptFromTemplate",command:{name:"AI: Execute AI Prompt from Custom Template"}},suggestPageName:{path:"sbai.ts:suggestPageName",command:{name:"AI: Suggest Page Name"}},selectTextModel:{path:"sbai.ts:selectModelFromConfig",command:{name:"AI: Select Text Model from Config"}},selectImageModel:{path:"sbai.ts:selectImageModelFromConfig",command:{name:"AI: Select Image Model from Config"}}},assets:{}},xs={manifest:Be,functionMapping:We};le(We,Be);export{xs as plug};
