var pn=Object.defineProperty;var L=(e,t)=>{for(var r in t)pn(e,r,{get:t[r],enumerable:!0})};var et=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var Ze=new Map,Xe=0;function Ae(e){self.postMessage(e)}et&&(globalThis.syscall=async(e,...t)=>await new Promise((r,n)=>{Xe++,Ze.set(Xe,{resolve:r,reject:n}),Ae({type:"sys",id:Xe,name:e,args:t})}));function Jt(e,t){et&&(self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let o=e[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let i=await Promise.resolve(o(...n.args||[]));Ae({type:"invr",id:n.id,result:i})}catch(i){console.error("An exception was thrown as a result of invoking function",n.name,"error:",i.message),Ae({type:"invr",id:n.id,error:i.message})}}break;case"sysr":{let o=n.id,i=Ze.get(o);if(!i)throw Error("Invalid request id");Ze.delete(o),n.error?i.reject(new Error(n.error)):i.resolve(n.result)}break}})().catch(console.error)}),Ae({type:"manifest",manifest:t}))}function dn(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}function Xt(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function fn(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),n=r.length>0?Xt(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function gn(){globalThis.fetch=async function(e,t){let r=t&&t.body?Xt(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await fn(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(n.base64Body?dn(n.base64Body):null,{status:n.status,headers:n.headers})}}et&&gn();function tt(e){if(e.children)for(let t of e.children){if(t.parent)return;t.parent=e,tt(t)}}function hn(e,t){return rt(e,r=>r.type===t)}function rt(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...rt(n,t)];return r}async function Zt(e,t){if(await t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...await Zt(n,t)];return r}async function nt(e,t){if(e.children){let r=e.children.slice();for(let n of r){let o=await t(n);if(o!==void 0){let i=e.children.indexOf(n);o?e.children.splice(i,1,o):e.children.splice(i,1)}else await nt(n,t)}}}function ot(e,t){return rt(e,r=>r.type===t)[0]}async function Pe(e,t){await Zt(e,t)}function O(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(O(r));return t.join("")}function it(e,t=!0){if(hn(e,"\u26A0").length>0)throw new Error(`Parse error in: ${O(e)}`);if(e.text!==void 0)return e.text;let n=[e.type];for(let o of e.children)o.type&&!o.type.endsWith("Mark")&&n.push(it(o,t)),o.text&&(t&&o.text.trim()||!t)&&n.push(o.text);return n}function yn(e){return e.getUTCHours()===0&&e.getUTCMinutes()===0&&e.getUTCSeconds()===0?e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"):e.toISOString()}function re(e){if(!e||typeof e!="object")return e;if(Array.isArray(e))return e.map(re);if(e instanceof Date)return yn(e);let t={};for(let r of Object.keys(e)){let n=r.split("."),o=t;for(let i=0;i<n.length-1;i++){let s=n[i];o[s]||(o[s]={}),o=o[s]}o[n[n.length-1]]=re(e[r])}return t}var m={};L(m,{confirm:()=>Yn,copyToClipboard:()=>no,deleteLine:()=>oo,dispatch:()=>Bn,downloadFile:()=>Fn,filterBox:()=>$n,flashNotification:()=>Ln,fold:()=>Vn,foldAll:()=>Xn,getCurrentPage:()=>xn,getCursor:()=>An,getSelection:()=>Pn,getText:()=>bn,getUiOption:()=>Wn,goHistory:()=>kn,hidePanel:()=>Dn,insertAtCursor:()=>Gn,insertAtPos:()=>Un,moveCursor:()=>qn,moveCursorToLine:()=>Kn,navigate:()=>En,openCommandPalette:()=>Cn,openPageNavigator:()=>Tn,openSearchPanel:()=>ro,openUrl:()=>Nn,prompt:()=>Hn,redo:()=>to,reloadConfigAndCommands:()=>On,reloadPage:()=>Mn,reloadUI:()=>In,replaceRange:()=>jn,save:()=>vn,setSelection:()=>Sn,setText:()=>wn,setUiOption:()=>Qn,showPanel:()=>_n,toggleFold:()=>Jn,undo:()=>eo,unfold:()=>zn,unfoldAll:()=>Zn,uploadFile:()=>Rn,vimEx:()=>io});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function l(e,...t){return globalThis.syscall(e,...t)}function xn(){return l("editor.getCurrentPage")}function bn(){return l("editor.getText")}function wn(e){return l("editor.setText",e)}function An(){return l("editor.getCursor")}function Pn(){return l("editor.getSelection")}function Sn(e,t){return l("editor.setSelection",e,t)}function vn(){return l("editor.save")}function En(e,t=!1,r=!1){return l("editor.navigate",e,t,r)}function Tn(e="page"){return l("editor.openPageNavigator",e)}function Cn(){return l("editor.openCommandPalette")}function Mn(){return l("editor.reloadPage")}function In(){return l("editor.reloadUI")}function On(){return l("editor.reloadConfigAndCommands")}function Nn(e,t=!1){return l("editor.openUrl",e,t)}function kn(e){return l("editor.goHistory",e)}function Fn(e,t){return l("editor.downloadFile",e,t)}function Rn(e,t){return l("editor.uploadFile",e,t)}function Ln(e,t="info"){return l("editor.flashNotification",e,t)}function $n(e,t,r="",n=""){return l("editor.filterBox",e,t,r,n)}function _n(e,t,r,n=""){return l("editor.showPanel",e,t,r,n)}function Dn(e){return l("editor.hidePanel",e)}function Un(e,t){return l("editor.insertAtPos",e,t)}function jn(e,t,r){return l("editor.replaceRange",e,t,r)}function qn(e,t=!1){return l("editor.moveCursor",e,t)}function Kn(e,t=1,r=!1){return l("editor.moveCursorToLine",e,t,r)}function Gn(e){return l("editor.insertAtCursor",e)}function Bn(e){return l("editor.dispatch",e)}function Hn(e,t=""){return l("editor.prompt",e,t)}function Yn(e){return l("editor.confirm",e)}function Wn(e){return l("editor.getUiOption",e)}function Qn(e,t){return l("editor.setUiOption",e,t)}function Vn(){return l("editor.fold")}function zn(){return l("editor.unfold")}function Jn(){return l("editor.toggleFold")}function Xn(){return l("editor.foldAll")}function Zn(){return l("editor.unfoldAll")}function eo(){return l("editor.undo")}function to(){return l("editor.redo")}function ro(){return l("editor.openSearchPanel")}function no(e){return l("editor.copyToClipboard",e)}function oo(){return l("editor.deleteLine")}function io(e){return l("editor.vimEx",e)}var I={};L(I,{parseMarkdown:()=>so,renderParseTree:()=>ao});function so(e){return l("markdown.parseMarkdown",e)}function ao(e){return l("markdown.renderParseTree",e)}var k={};L(k,{deleteAttachment:()=>bo,deleteFile:()=>vo,deletePage:()=>po,fileExists:()=>Eo,getAttachmentMeta:()=>ho,getFileMeta:()=>Po,getPageMeta:()=>lo,listAttachments:()=>go,listFiles:()=>wo,listPages:()=>co,listPlugs:()=>fo,readAttachment:()=>yo,readFile:()=>Ao,readPage:()=>uo,writeAttachment:()=>xo,writeFile:()=>So,writePage:()=>mo});function co(){return l("space.listPages")}function lo(e){return l("space.getPageMeta",e)}function uo(e){return l("space.readPage",e)}function mo(e,t){return l("space.writePage",e,t)}function po(e){return l("space.deletePage",e)}function fo(){return l("space.listPlugs")}function go(){return l("space.listAttachments")}function ho(e){return l("space.getAttachmentMeta",e)}function yo(e){return l("space.readAttachment",e)}function xo(e,t){return l("space.writeAttachment",e,t)}function bo(e){return l("space.deleteAttachment",e)}function wo(){return l("space.listFiles")}function Ao(e){return l("space.readFile",e)}function Po(e){return l("space.getFileMeta",e)}function So(e,t){return l("space.writeFile",e,t)}function vo(e){return l("space.deleteFile",e)}function Eo(e){return l("space.fileExists",e)}var A={};L(A,{applyAttributeExtractors:()=>No,getEnv:()=>Lo,getMode:()=>$o,getSpaceConfig:()=>ko,getVersion:()=>_o,invokeCommand:()=>Co,invokeFunction:()=>To,invokeSpaceFunction:()=>Oo,listCommands:()=>Mo,listSyscalls:()=>Io,reloadConfig:()=>Ro,reloadPlugs:()=>Fo});function To(e,...t){return l("system.invokeFunction",e,...t)}function Co(e,t){return l("system.invokeCommand",e,t)}function Mo(){return l("system.listCommands")}function Io(){return l("system.listSyscalls")}function Oo(e,...t){return l("system.invokeSpaceFunction",e,...t)}function No(e,t,r){return l("system.applyAttributeExtractors",e,t,r)}async function ko(e,t){return await l("system.getSpaceConfig",e)??t}function Fo(){return l("system.reloadPlugs")}function Ro(){return l("system.reloadConfig")}function Lo(){return l("system.getEnv")}function $o(){return l("system.getMode")}function _o(){return l("system.getVersion")}var G={};L(G,{del:()=>jo,get:()=>Uo,set:()=>Do});function Do(e,t){return l("clientStore.set",e,t)}function Uo(e){return l("clientStore.get",e)}function jo(e){return l("clientStore.delete",e)}var Se={};L(Se,{listLanguages:()=>Bo,parseLanguage:()=>Go});function Go(e,t){return l("language.parseLanguage",e,t)}function Bo(){return l("language.listLanguages")}var z={};L(z,{parseTemplate:()=>Yo,renderTemplate:()=>Ho});function Ho(e,t,r={}){return l("template.renderTemplate",e,t,r)}function Yo(e){return l("template.parseTemplate",e)}var me={};L(me,{dispatchEvent:()=>Vo,listEvents:()=>zo});function Vo(e,t,r){return new Promise((n,o)=>{let i=-1;r&&(i=setTimeout(()=>{console.log("Timeout!"),o("timeout")},r)),l("event.dispatch",e,t).then(s=>{i!==-1&&clearTimeout(i),n(s)}).catch(o)})}function zo(){return l("event.list")}var _={};L(_,{parse:()=>Xo,stringify:()=>Zo});function Xo(e){return l("yaml.parse",e)}function Zo(e){return l("yaml.stringify",e)}var J={};L(J,{ack:()=>ri,batchAck:()=>ni,batchSend:()=>ti,getQueueStats:()=>oi,send:()=>ei});function ei(e,t){return l("mq.send",e,t)}function ti(e,t){return l("mq.batchSend",e,t)}function ri(e,t){return l("mq.ack",e,t)}function ni(e,t){return l("mq.batchAck",e,t)}function oi(e){return l("mq.getQueueStats",e)}async function B(e,t={}){let r={tags:[]},n=[];tt(e),await nt(e,async o=>{if(o.type==="Paragraph"&&o.parent?.type==="Document"){let i=!0,s=new Set;for(let a of o.children)if(a.text){if(a.text.startsWith(`
`)&&a.text!==`
`)break;if(a.text.trim()){i=!1;break}}else if(a.type==="Hashtag"){let c=a.children[0].text.substring(1);s.add(c),(t.removeTags===!0||t.removeTags?.includes(c))&&(a.children[0].text="")}else if(a.type){i=!1;break}i&&n.push(...s)}if(o.type==="FrontMatter"){let i=o.children[1].children[0],s=O(i);try{let a=await _.parse(s),c={...a};if(r={...r,...a},r.tags||(r.tags=[]),typeof r.tags=="string"&&n.push(...r.tags.split(/,\s*|\s+/)),Array.isArray(r.tags)&&n.push(...r.tags),t.removeKeys&&t.removeKeys.length>0){let u=!1;for(let p of t.removeKeys)p in c&&(delete c[p],u=!0);u&&(i.text=await _.stringify(c))}if(Object.keys(c).length===0||t.removeFrontmatterSection)return null}catch{}}});try{r.tags=[...new Set([...n.map(o=>String(o).replace(/^#/,""))])]}catch(o){console.error("Error while processing tags",o)}return r=re(r),r}async function st(e,t){let r=null;if(await Pe(e,async n=>{if(n.type==="FrontMatter"){let o=n.children[1].children[0],i=O(o);try{let s="";if(typeof t=="string")s=i+t+`
`;else{let c={...await _.parse(i),...t};s=await _.stringify(c)}r={changes:{from:o.from,to:o.to,insert:s}}}catch(s){console.error("Error parsing YAML",s)}return!0}return!1}),!r){let n="";typeof t=="string"?n=t+`
`:n=await _.stringify(t),r={changes:{from:0,to:0,insert:`---
`+n+`---
`}}}return r}function er(e){let t={querySource:""},[r,n,...o]=e;if(r!=="Query")throw new Error(`Expected query type, got ${r}`);t.querySource=n[1];for(let i of o){let[s]=i;switch(s){case"WhereClause":{t.filter?t.filter=["and",t.filter,E(i[2])]:t.filter=E(i[2]);break}case"OrderClause":{t.orderBy||(t.orderBy=[]);for(let a of i.slice(2))if(a[0]==="OrderBy"){let c=a[1][1];a[2]?t.orderBy.push({expr:E(c),desc:a[2][1][1]==="desc"}):t.orderBy.push({expr:E(c),desc:!1})}break}case"LimitClause":{t.limit=E(i[2][1]);break}case"SelectClause":{for(let a of i.slice(2))a[0]==="Select"&&(t.select||(t.select=[]),a.length===2?t.select.push({name:pe(a[1][1])}):t.select.push({name:pe(a[3][1]),expr:E(a[1])}));break}case"RenderClause":{let a=i.find(c=>c[0]==="PageRef");t.render=a[1].slice(2,-2),t.renderAll=!!i.find(c=>c[0]==="all");break}default:throw new Error(`Unknown clause type: ${s}`)}}return t}function pe(e){return e.startsWith("`")&&e.endsWith("`")?e.slice(1,-1):e}function E(e){if(["LVal","Expression","Value"].includes(e[0]))return E(e[1]);switch(e[0]){case"Attribute":return["attr",E(e[1]),pe(e[3][1])];case"Identifier":return["attr",pe(e[1])];case"String":return["string",e[1].slice(1,-1)];case"Number":return["number",+e[1]];case"Bool":return["boolean",e[1][1]==="true"];case"null":return["null"];case"Regex":return["regexp",e[1].slice(1,-1),"i"];case"List":{let t=[];for(let r of e.slice(2))r[0]==="Expression"&&t.push(r);return["array",t.map(E)]}case"Object":{let t=[];for(let r of e.slice(2)){if(typeof r=="string")continue;let[n,o,i,s]=r;t.push([o[1].slice(1,-1),E(s)])}return["object",t]}case"BinExpression":{let t=E(e[1]),r=e[2][0]==="InKW"?"in":e[2].trim(),n=E(e[3]);return[r,t,n]}case"LogicalExpression":{let t=E(e[1]),r=e[2],n=E(e[3]);return[r[1],t,n]}case"ParenthesizedExpression":return E(e[2]);case"Call":{let t=pe(e[1][1]),r=[];for(let n of e.slice(2))n[0]==="Expression"&&r.push(n);return["call",t,r.map(E)]}case"UnaryExpression":{if(e[1][0]==="NotKW"||e[1][0]==="!")return["not",E(e[2])];if(e[1][0]==="-")return["-",E(e[2])];throw new Error(`Unknown unary expression: ${e[1][0]}`)}case"TopLevelVal":return["attr"];case"GlobalIdentifier":return["global",e[1].substring(1)];case"TernaryExpression":{let[t,r,n,o,i,s]=e;return["?",E(r),E(o),E(s)]}case"QueryExpression":return["query",er(e[2])];case"PageRef":return["pageref",e[1].slice(2,-2)];default:throw new Error(`Not supported: ${e[0]}`)}}async function tr(e){let t=it(await Se.parseLanguage("query",e));return er(t[1])}async function rr(e,t){let r={};await Pe(t,async i=>{if(t!==i&&i.type==="ListItem")return!0;if(i.type==="Attribute"){let s=ot(i,"AttributeName"),a=ot(i,"AttributeValue");if(s&&a){let c=s.children[0].text,u=a.children[0].text;try{r[c]=re(await _.parse(u))}catch(p){console.error("Error parsing attribute value as YAML",u,p)}}return!0}return!1});let n=O(t),o=await A.applyAttributeExtractors(e,n,t);return r={...r,...o},r}function at(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...at(n,t)];return r}function ct(e,t){return at(e,r=>r.type===t)[0]}function nr(e,t){at(e,t)}typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function h(e,...t){return globalThis.syscall(e,...t)}var ve={};L(ve,{parseMarkdown:()=>ci,renderParseTree:()=>li});function ci(e){return h("markdown.parseMarkdown",e)}function li(e){return h("markdown.renderParseTree",e)}var Ee={};L(Ee,{deleteAttachment:()=>wi,deleteFile:()=>Ei,deletePage:()=>fi,fileExists:()=>Ti,getAttachmentMeta:()=>yi,getFileMeta:()=>Si,getPageMeta:()=>mi,listAttachments:()=>hi,listFiles:()=>Ai,listPages:()=>ui,listPlugs:()=>gi,readAttachment:()=>xi,readFile:()=>Pi,readPage:()=>pi,writeAttachment:()=>bi,writeFile:()=>vi,writePage:()=>di});function ui(){return h("space.listPages")}function mi(e){return h("space.getPageMeta",e)}function pi(e){return h("space.readPage",e)}function di(e,t){return h("space.writePage",e,t)}function fi(e){return h("space.deletePage",e)}function gi(){return h("space.listPlugs")}function hi(){return h("space.listAttachments")}function yi(e){return h("space.getAttachmentMeta",e)}function xi(e){return h("space.readAttachment",e)}function bi(e,t){return h("space.writeAttachment",e,t)}function wi(e){return h("space.deleteAttachment",e)}function Ai(){return h("space.listFiles")}function Pi(e){return h("space.readFile",e)}function Si(e){return h("space.getFileMeta",e)}function vi(e,t){return h("space.writeFile",e,t)}function Ei(e){return h("space.deleteFile",e)}function Ti(e){return h("space.fileExists",e)}var Te={};L(Te,{parse:()=>_i,stringify:()=>Di});function _i(e){return h("yaml.parse",e)}function Di(e){return h("yaml.stringify",e)}async function Ki(e,t){let r=await Ee.readPage(e),n=await ve.parseMarkdown(r),o;return nr(n,i=>{if(i.type!=="FencedCode")return!1;let s=ct(i,"CodeInfo");if(t&&!s||t&&!t.includes(s.children[0].text))return!1;let a=ct(i,"CodeText");return a?(o=a.children[0].text,!0):!1}),o}async function or(e,t=["yaml"]){let r=await Ki(e,t);if(r!==void 0)try{return Te.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}async function Ce(e){try{let r=(await or("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}var ne=class{apiKey;baseUrl;name;modelName;requireAuth;constructor(t,r,n,o,i=!0){this.apiKey=t,this.baseUrl=r,this.name=n,this.modelName=o,this.requireAuth=i}};var Me=class extends ne{constructor(t,r,n){super(t,n,"DALL-E",r)}async generateImage(t){try{S||await H();let r=await nativeFetch(`${this.baseUrl}/images/generations`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.modelName,prompt:t.prompt,n:t.numImages,size:t.size,quality:t.quality,response_format:"b64_json"})});if(!r.ok)throw new Error(`HTTP error, status: ${r.status}`);let n=await r.json();if(!n||n.length===0)throw new Error("Invalid response from DALL-E.");return n}catch(r){throw console.error("Error calling DALL\xB7E image generation endpoint:",r),r}}};var X=function(e,t){if(!(this instanceof X))return new X(e,t);this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.url=e,t=t||{},this.headers=t.headers||{},this.payload=t.payload!==void 0?t.payload:"",this.method=t.method||this.payload&&"POST"||"GET",this.withCredentials=!!t.withCredentials,this.debug=!!t.debug,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=this.INITIALIZING,this.progress=0,this.chunk="",this.addEventListener=function(r,n){this.listeners[r]===void 0&&(this.listeners[r]=[]),this.listeners[r].indexOf(n)===-1&&this.listeners[r].push(n)},this.removeEventListener=function(r,n){if(this.listeners[r]!==void 0){var o=[];this.listeners[r].forEach(function(i){i!==n&&o.push(i)}),o.length===0?delete this.listeners[r]:this.listeners[r]=o}},this.dispatchEvent=function(r){if(!r)return!0;this.debug&&console.debug(r),r.source=this;var n="on"+r.type;return this.hasOwnProperty(n)&&(this[n].call(this,r),r.defaultPrevented)?!1:this.listeners[r.type]?this.listeners[r.type].every(function(o){return o(r),!r.defaultPrevented}):!0},this._setReadyState=function(r){var n=new CustomEvent("readystatechange");n.readyState=r,this.readyState=r,this.dispatchEvent(n)},this._onStreamFailure=function(r){var n=new CustomEvent("error");n.data=r.currentTarget.response,this.dispatchEvent(n),this.close()},this._onStreamAbort=function(r){this.dispatchEvent(new CustomEvent("abort")),this.close()},this._onStreamProgress=function(r){if(this.xhr){if(this.xhr.status!==200){this._onStreamFailure(r);return}this.readyState==this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));var n=this.xhr.responseText.substring(this.progress);this.progress+=n.length;var o=(this.chunk+n).split(/(\r\n\r\n|\r\r|\n\n)/g),i=o.pop();o.forEach(function(s){s.trim().length>0&&this.dispatchEvent(this._parseEventChunk(s))}.bind(this)),this.chunk=i}},this._onStreamLoaded=function(r){this._onStreamProgress(r),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""},this._parseEventChunk=function(r){if(!r||r.length===0)return null;this.debug&&console.debug(r);var n={id:null,retry:null,data:null,event:null};r.split(/\n|\r\n|\r/).forEach(function(i){var s=i.indexOf(this.FIELD_SEPARATOR),a,c;if(s>0){var u=i[s+1]===" "?2:1;a=i.substring(0,s),c=i.substring(s+u)}else if(s<0)a=i,c="";else return;a in n&&(a==="data"&&n[a]!==null?n.data+=`
`+c:n[a]=c)}.bind(this));var o=new CustomEvent(n.event||"message");return o.data=n.data||"",o.id=n.id,o},this._checkStreamClosed=function(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)},this.stream=function(){if(!this.xhr){this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(var r in this.headers)this.xhr.setRequestHeader(r,this.headers[r]);this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))},(t.start===void 0||t.start)&&this.stream()};typeof exports<"u"&&(exports.SSE=X);var ir={};function Ie(e,t){ir[e]=t}function Oe(e){return ir[e]}async function Ne(...e){let t=e.join(""),r=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(n)).map(s=>s.toString(16).padStart(2,"0")).join("")}var j=class{apiKey;baseUrl;name;modelName;requireAuth;constructor(t,r,n,o,i=!0){this.apiKey=t,this.baseUrl=r,this.name=n,this.modelName=o,this.requireAuth=i}async generateEmbeddings(t){let r=await Ne(this.modelName,t.text),n=Oe(r);if(n)return n;let o=await this._generateEmbeddings(t);return Ie(r,o),o}};async function Gi(){let e=await m.getSelection(),t="";return e.from===e.to?t="":t=(await m.getText()).slice(e.from,e.to),{from:e.from,to:e.to,text:t}}async function ke(){let e=await Gi(),t=await m.getText();if(e.text==="")return{from:0,to:t.length,text:t,isWholeNote:!0};let r=e.from===0&&e.to===t.length;return{...e,isWholeNote:r}}async function Z(){return(await m.getText()).length}var q=class{name;apiKey;baseUrl;modelName;constructor(t,r,n,o){this.name=t,this.apiKey=r,this.baseUrl=n,this.modelName=o}async streamChatIntoEditor(t,r){let{onDataReceived:n}=t,o="\u{1F914} Thinking \u2026 ",i=r??await Z();await m.insertAtPos(o,i);let s=!0,a=c=>{try{if(!c){console.log("No data received from LLM");return}s?(["`","-","*"].includes(c.charAt(0))&&(console.log("First character of response is:",c.charAt(0)),c=`
`+c),m.replaceRange(i,i+o.length,c),s=!1):m.insertAtPos(c,i),i+=c.length,n&&n(c)}catch(u){console.error("Error handling chat stream data:",u),m.flashNotification("An error occurred while processing chat data.","error")}};await this.chatWithAI({...t,onDataReceived:a})}async singleMessageChat(t,r,n=!1){let o=[{role:"user",content:t}];return r&&o.unshift({role:"system",content:r}),n&&(o=await oe(o)),await this.chatWithAI({messages:o,stream:!1})}};var Fe=class extends q{name="Gemini";constructor(t,r){super("Gemini",t,"https://generativelanguage.googleapis.com",r)}async listModels(){let t=`${this.baseUrl}/v1beta/models?key=${this.apiKey}`;try{let r=await fetch(t);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).models||[]}catch(r){throw console.error("Failed to fetch models:",r),r}}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return r?await this.streamChat({messages:t,stream:r,onDataReceived:n}):await this.nonStreamingChat(t)}mapRolesForGemini(t){let r=[],n="";return t.forEach(o=>{let i="user";o.role==="system"||o.role==="user"?i="user":o.role==="assistant"&&(i="model"),i==="model"&&(r.length===0||n==="model")||(i==="user"&&n==="user"?r[r.length-1].parts[0].text+=" "+o.content:r.push({role:i,parts:[{text:o.content}]})),n=i}),r}streamChat(t){let{messages:r,onDataReceived:n}=t;try{let o=`${this.baseUrl}/v1beta/models/${this.modelName}:streamGenerateContent?key=${this.apiKey}&alt=sse`,i={"Content-Type":"application/json"},s=this.mapRolesForGemini(r),a={method:"POST",headers:i,payload:JSON.stringify({contents:s}),withCredentials:!1},c=new X(o,a),u="";c.addEventListener("message",p=>{try{if(p.data=="[DONE]")return c.close(),u;if(!p.data)console.error("Received empty message from Gemini"),console.log("source: ",c);else{let f=JSON.parse(p.data),y=f.candidates[0].content.parts[0].text||f.text||"";u+=y,n&&n(y)}}catch(f){console.error("Error processing message event:",f,p.data)}}),c.addEventListener("end",()=>(c.close(),u)),c.addEventListener("error",p=>{console.error("SSE error:",p),c.close()}),c.stream()}catch(o){throw console.error("Error streaming from Gemini chat endpoint:",o),o}}async nonStreamingChat(t){let r=this.mapRolesForGemini(t),n=await nativeFetch(`${this.baseUrl}/v1beta/models/${this.modelName}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).candidates[0].content.parts[0].text}},Re=class extends j{constructor(t,r,n="https://generativelanguage.googleapis.com",o=!0){super(t,n,"Gemini",r,o)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,content:{parts:[{text:t.text}]}}),n={"Content-Type":"application/json"};this.requireAuth&&(n.Authorization=`Bearer ${this.apiKey}`);let o=await nativeFetch(`${this.baseUrl}/v1beta/models/${this.modelName}:embedContent?key=${this.apiKey}`,{method:"POST",headers:n,body:r});if(!o.ok)throw console.error("HTTP response: ",o),console.error("HTTP response body: ",await o.json()),new Error(`HTTP error, status: ${o.status}`);let i=await o.json();if(!i||!i.embedding||!i.embedding.values)throw new Error("Invalid response from Gemini.");return i.embedding.values}};var ie=class extends q{name="OpenAI";requireAuth;constructor(t,r,n,o){super("OpenAI",t,n,r),this.requireAuth=o}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return r?await this.streamChat({messages:t,onDataReceived:n}):await this.nonStreamingChat(t)}async streamChat(t){let{messages:r,onDataReceived:n}=t;try{let o=`${this.baseUrl}/chat/completions`,i={"Content-Type":"application/json"};this.requireAuth&&(i.Authorization=`Bearer ${this.apiKey}`);let s={method:"POST",headers:i,payload:JSON.stringify({model:this.modelName,stream:!0,messages:r}),withCredentials:!1},a=new X(o,s),c="";a.addEventListener("message",function(u){try{if(u.data=="[DONE]")return a.close(),c;{let f=JSON.parse(u.data).choices[0]?.delta?.content||"";c+=f,n&&n(f)}}catch(p){console.error("Error processing message event:",p,u.data)}}),a.addEventListener("end",function(){return a.close(),c}),a.addEventListener("error",u=>{console.error("SSE error:",u),a.close()}),a.stream()}catch(o){throw console.error("Error streaming from OpenAI chat endpoint:",o),await m.flashNotification("Error streaming from OpenAI chat endpoint.","error"),o}return""}async nonStreamingChat(t){try{let r=JSON.stringify({model:this.modelName,messages:t}),n={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},o=await nativeFetch(this.baseUrl+"/chat/completions",{method:"POST",headers:n,body:r});if(!o.ok)throw console.error("http response: ",o),console.error("http response body: ",await o.json()),new Error(`HTTP error, status: ${o.status}`);let i=await o.json();if(!i||!i.choices||i.choices.length===0)throw new Error("Invalid response from OpenAI.");return i.choices[0].message.content}catch(r){throw console.error("Error calling OpenAI chat endpoint:",r),await m.flashNotification("Error calling OpenAI chat endpoint.","error"),r}}},Le=class extends j{constructor(t,r,n,o=!0){super(t,n,"OpenAI",r,o)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,input:t.text,encoding_format:"float"}),n={"Content-Type":"application/json"};this.requireAuth&&(n.Authorization=`Bearer ${this.apiKey}`);let o=await nativeFetch(`${this.baseUrl}/embeddings`,{method:"POST",headers:n,body:r});if(!o.ok)throw console.error("HTTP response: ",o),console.error("HTTP response body: ",await o.json()),new Error(`HTTP error, status: ${o.status}`);let i=await o.json();if(!i||!i.data||i.data.length===0)throw new Error("Invalid response from OpenAI.");return i.data[0].embedding}};var $e=class extends q{name="Ollama";requireAuth;openaiProvider;constructor(t,r,n,o){super("Ollama",t,n,r),this.requireAuth=o,this.openaiProvider=new ie(t,r,n,o)}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return await this.openaiProvider.chatWithAI({messages:t,stream:r,onDataReceived:n})}},_e=class extends j{constructor(t,r,n,o=!1){super(t,n,"Ollama",r,o)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,prompt:t.text}),n={"Content-Type":"application/json"};this.requireAuth&&(n.Authorization=`Bearer ${this.apiKey}`);let o=await nativeFetch(`${this.baseUrl}/api/embeddings`,{method:"POST",headers:n,body:r});if(!o.ok)throw console.error("HTTP response: ",o),console.error("HTTP response body: ",await o.json()),new Error(`HTTP error, status: ${o.status}`);let i=await o.json();if(!i||!i.embedding||i.embedding.length===0)throw new Error("Invalid response from Ollama.");return i.embedding}};var De=class extends q{constructor(t,r,n="http://localhost"){super(t,n,"mock",r)}async chatWithAI(t){let r="This is a mock response from the AI.";if(t.onDataReceived)for(let n of r)await new Promise(o=>setTimeout(o,50)),t.onDataReceived(n);return r}},Ue=class extends ne{constructor(t,r,n="http://localhost"){super(t,n,"mock",r)}generateImage(t){return new Promise(r=>{setTimeout(()=>{r("https://example.com/mock-image.jpg")},5)})}},je=class extends j{constructor(t,r,n="http://localhost"){super(t,n,"mock",r)}_generateEmbeddings(t){return new Promise(r=>{setTimeout(()=>{let n=Array(1536).fill(0).map(()=>Math.random());r(n)},5)})}};var S,d,de,M,qe,$,lt,Bi,fe;async function v(){let e=await ar();(!S||!M||!d||!lt||JSON.stringify(e)!==JSON.stringify(lt))&&await H(!0)}async function ar(){if(await A.getEnv()!="server")try{return await G.get("ai.selectedTextModel")}catch{return}}async function Hi(){if(await A.getEnv()!="server")try{return await G.get("ai.selectedImageModel")}catch{return}}async function Yi(){if(await A.getEnv()!="server")try{return await G.get("ai.selectedEmbeddingModel")}catch{return}}async function ut(e){await A.getEnv()!="server"&&await G.set("ai.selectedImageModel",e)}async function mt(e){await A.getEnv()!="server"&&await G.set("ai.selectedTextModel",e)}async function pt(e){await A.getEnv()!="server"&&await G.set("ai.selectedEmbeddingModel",e)}async function Wi(){let e=await ar()||d.textModels[0];if(!e)throw new Error("No text model selected or available as default.");await ge(e)}async function Qi(){let e=await Hi()||d.imageModels[0];if(!e)throw new Error("No image model selected or available as default.");await dt(e)}async function Vi(){let e=await Yi()||d.embeddingModels[0];if(!e)throw new Error("No embedding model selected or available as default.");await ft(e)}function zi(e){let t=e.provider.toLowerCase();switch(F("client","Provider name",t),t){case"dalle":qe=new Me(S,e.modelName,e.baseUrl||d.dallEBaseUrl);break;case"mock":qe=new Ue(S,e.modelName);break;default:throw new Error(`Unsupported image provider: ${e.provider}. Please configure a supported provider.`)}}function Ji(e){switch(e.provider.toLowerCase()){case"openai":M=new ie(S,e.modelName,e.baseUrl||d.openAIBaseUrl,e.requireAuth||d.requireAuth);break;case"gemini":M=new Fe(S,e.modelName);break;case"ollama":M=new $e(S,e.modelName,e.baseUrl||"http://localhost:11434/v1",e.requireAuth);break;case"mock":M=new De(S,e.modelName,e.baseUrl);break;default:throw new Error(`Unsupported AI provider: ${e.provider}. Please configure a supported provider.`)}return M}function Xi(e){switch(e.provider.toLowerCase()){case"openai":$=new Le(S,e.modelName,e.baseUrl||d.openAIBaseUrl);break;case"gemini":$=new Re(S,e.modelName);break;case"ollama":$=new _e(S,e.modelName,e.baseUrl||"http://localhost:11434",e.requireAuth);break;case"mock":$=new je(S,e.modelName,e.baseUrl);break;default:throw new Error(`Unsupported embedding provider: ${e.provider}. Please configure a supported provider.`)}}async function ge(e){if(F("client","configureSelectedModel called with:",e),!e)throw new Error("No model provided to configure");if(e.requireAuth=e.requireAuth??d.requireAuth,e.requireAuth)try{let t=await Ce(e.secretName||"OPENAI_API_KEY");t!==S&&(S=t,F("client","API key updated"))}catch(t){throw console.error("Error reading secret:",t),new Error("Failed to read the AI API key. Please check the SECRETS page.")}if(e.requireAuth&&!S)throw new Error("AI API key is missing. Please set it in the secrets page.");return lt=e,Ji(e)}async function dt(e){if(F("client","configureSelectedImageModel called with:",e),!e)throw new Error("No image model provided to configure");if(e.requireAuth){let t=await Ce(e.secretName||"OPENAI_API_KEY");t!==S&&(S=t,F("client","API key updated for image model"))}if(e.requireAuth&&!S)throw new Error("AI API key is missing for image model. Please set it in the secrets page.");Bi=e,zi(e)}async function ft(e){if(F("client","configureSelectedEmbeddingModel called with:",e),!e)throw new Error("No embedding model provided to configure");if(e.requireAuth){let t=await Ce(e.secretName||"OPENAI_API_KEY");t!==S&&(S=t,F("client","API key updated for embedding model"))}if(e.requireAuth&&!S)throw new Error("AI API key is missing for embedding model. Please set it in the secrets page.");fe=e,Xi(e)}async function Zi(){let e={openAIBaseUrl:"https://api.openai.com/v1",dallEBaseUrl:"https://api.openai.com/v1",requireAuth:!0,secretName:"OPENAI_API_KEY",provider:"OpenAI",chat:{},promptInstructions:{},imageModels:[],embeddingModels:[],textModels:[],indexEmbeddings:!1,indexSummary:!1,indexSummaryModelName:"",indexEmbeddingsExcludePages:[],indexEmbeddingsExcludeStrings:["**user**:"]},t={userInformation:"",userInstructions:"",parseWikiLinks:!0,bakeMessages:!0,customEnrichFunctions:[],searchEmbeddings:!1},r={pageRenameSystem:"",pageRenameRules:"",tagRules:"",indexSummaryPrompt:"",enhanceFrontMatterPrompt:""},n=await A.getSpaceConfig("ai",{}),o={...e,...n};return o.chat={...t,...n.chat||{}},o.promptInstructions={...r,...n.promptInstructions||{}},o}async function H(e=!0){let t=await Zi();!d||JSON.stringify(d)!==JSON.stringify(t)?(F("client","aiSettings updating from",d),d=t,F("client","aiSettings updated to",d)):F("client","aiSettings unchanged",d),d.textModels.length===1&&await mt(d.textModels[0]),d.imageModels.length===1&&await ut(d.imageModels[0]),d.embeddingModels.length===1&&await pt(d.embeddingModels[0]),e&&(d.textModels.length>0&&await Wi(),d.imageModels.length>0&&await Qi(),d.embeddingModels.length>0&&await Vi()),de={role:"system",content:"This is an interactive chat session with a user in a markdown-based note-taking tool called SilverBullet."},d.chat.userInformation&&(de.content+=`
The user has provided the following information about themselves: ${d.chat.userInformation}`),d.chat.userInstructions&&(de.content+=`
The user has provided the following instructions for the chat, follow them as closely as possible: ${d.chat.userInstructions}`)}var gt="\u{1F916} ";function he(e){return!(["SETTINGS","SECRETS",...d.indexEmbeddingsExcludePages].includes(e)||e.startsWith("_")||e.startsWith("Library/")||/\.conflicted\.\d+$/.test(e))}async function cr(){return await v(),d.indexEmbeddings&&$!==void 0&&fe!==void 0&&d.embeddingModels.length>0&&await A.getEnv()==="server"}async function lr(){return await v(),d.indexEmbeddings&&d.indexSummary&&$!==void 0&&fe!==void 0&&d.embeddingModels.length>0&&await A.getEnv()==="server"}async function es(e){if(!await cr()||!he(e))return;let t=await k.readPage(e),r=await I.parseMarkdown(t);if(!r.children)return;let n=r.children.filter(c=>c.type==="Paragraph"),o=[],i=Date.now();for(let c of n){let u=O(c).trim();if(!u||u.length<10||d.indexEmbeddingsExcludeStrings.some(w=>u.includes(w)))continue;let p=await $.generateEmbeddings({text:u}),f=c.from??0,y={ref:`${e}@${f}`,page:e,pos:f,embedding:p,text:u,tag:"embedding"};o.push(y)}await wt(e,o);let a=(Date.now()-i)/1e3;F("any",`AI: Indexed ${o.length} embedding objects for page ${e} in ${a} seconds`)}async function ts(e){if(!await lr()||!he(e))return;let t=await k.readPage(e),r=await I.parseMarkdown(t);if(!r.children)return;let n=Date.now(),o=O(r),i=d.textModels.find(x=>x.name===d.indexSummaryModelName);if(!i)throw new Error(`Could not find summary model ${d.indexSummaryModelName}`);let s=await ge(i),a;d.promptInstructions.indexSummaryPrompt!==""?a=d.promptInstructions.indexSummaryPrompt:a=`Provide a concise and informative summary of the above page. The summary should capture the key points and be useful for search purposes. Avoid any formatting or extraneous text.  No more than one paragraph.  Summary:
`;let c=await Ne(i.name,o,a),u=Oe(c);u||(u=await s.singleMessageChat("Contents of "+e+`:
`+o+`

`+a),Ie(c,u));let p=await $.generateEmbeddings({text:u}),f={ref:`${e}@0`,page:e,embedding:p,text:u,tag:"aiSummary"};await wt(e,[f]);let w=(Date.now()-n)/1e3;F("any",`AI: Indexed summary for page ${e} in ${w} seconds`)}async function ur({name:e,tree:t}){await v(),he(e)&&t.children&&(await cr()&&await J.send("aiEmbeddingsQueue",e),await lr()&&await J.send("aiSummaryQueue",e))}async function mr(e){await v();for(let r of e){let n=r.body;console.log(`AI: Generating and indexing embeddings for file ${n}`),await es(n)}let t=await J.getQueueStats("aiEmbeddingsQueue");console.log(`AI: Embeddings queue stats: ${JSON.stringify(t)}`)}async function pr(e){await v();for(let r of e){let n=r.body;console.log(`AI: Generating and indexing summary for ${n}`),await ts(n)}let t=await J.getQueueStats("aiSummaryQueue");console.log(`AI: Summary queue stats: ${JSON.stringify(t)}`)}async function yt(){return await At()?await l("system.invokeFunctionOnServer","index.queryObjects","embedding",{}):await se("embedding",{})}async function dr(){return await At()?await l("system.invokeFunctionOnServer","index.queryObjects","aiSummary",{}):await se("aiSummary",{})}async function fr(e){if(await v(),!$||!fe)throw new Error("No embedding provider found");return await $.generateEmbeddings({text:e})}async function ye(e){return await l("system.invokeFunctionOnServer","silverbullet-ai.generateEmbeddings",e)}function ht(e,t){let r=e.reduce((i,s,a)=>i+s*t[a],0),n=Math.sqrt(e.reduce((i,s)=>i+s*s,0)),o=Math.sqrt(t.reduce((i,s)=>i+s*s,0));return r/(n*o)}async function xt(e,t=10,r=!1){await v(),await A.getEnv()==="server"&&(r=!1);let n=Date.now(),o=typeof e=="string"?await ye(e):e,i=Date.now();console.log(`searchEmbeddings: Query embedding generation took ${i-n} ms`);let s=Date.now(),a=await yt(),c=Date.now();console.log(`Retrieved ${a.length} embeddings in ${c-s} ms`);let u="",p=0;r&&(u=`Retrieved ${a.length} embeddings in ${c-s} ms

`,p=(await m.getText()).length,await m.replaceRange(p,p,u));let f=[],y=Date.now();for(let w=0;w<a.length;w++){let x=a[w];if(he(x.page)){if(f.push({page:x.page,ref:x.ref,text:x.text,similarity:ht(o,x.embedding)}),r&&(w%100===0||Date.now()-y>=100)){let C=p+u.length;u=`

Processed ${w+1} of ${a.length} embeddings...

`,await m.replaceRange(p,C,u),y=Date.now()}if(r&&w>=a.length-1){let C=p+u.length;await m.replaceRange(p,C,"")}}}if(console.log(`Finished searching embeddings in ${Date.now()-s} ms`),d.indexSummary){let w=Date.now(),x=await dr(),C=Date.now();console.log(`Retrieved ${x.length} summaries in ${C-w} ms`);let P="",V=0;r&&(P=`Retrieved ${x.length} summaries in ${C-w} ms

`,V=(await m.getText()).length,await m.replaceRange(V,V,P));let Vt=[],zt=Date.now();for(let te=0;te<x.length;te++){let ue=x[te];if(he(ue.page)){if(Vt.push({page:ue.page,ref:ue.ref,text:`Page Summary: ${ue.text}`,similarity:ht(o,ue.embedding)}),r&&(te%100===0||Date.now()-zt>=100)){let Je=V+P.length;P=`

Processed ${te+1} of ${x.length} summaries...

`,await m.replaceRange(V,Je,P),zt=Date.now()}if(r&&te>=x.length-1){let Je=V+P.length;await m.replaceRange(V,Je,"")}}}console.log(`Finished searching summaries in ${Date.now()-w} ms`),f.push(...Vt)}return f.sort((w,x)=>x.similarity-w.similarity).slice(0,t)}async function gr(e,t=10){await v();let r=await ye(e);return(await dr()).map(i=>({page:i.page,ref:i.ref,text:i.text,similarity:ht(r,i.embedding)})).sort((i,s)=>s.similarity-i.similarity).slice(0,t)}async function Ke(e,t=10,r=.15,n=!1){let o;o=await xt(e,-1,n);let i={};for(let a of o)a.similarity<r||(i[a.page]?(i[a.page].score+=a.similarity,i[a.page].children.push(a)):i[a.page]={page:a.page,score:a.similarity,children:[a]});for(let a in i)i[a].children=i[a].children.sort((c,u)=>u.similarity-c.similarity).slice(0,t);return Object.values(i).sort((a,c)=>c.score-a.score).slice(0,t)}async function Ge(e,t=10){try{let r=await Ke(e,t),n="";if(r.length>0)for(let o of r){n+=`>>${o.page}<<
`;for(let i of o.children)n+=`> ${i.text}

`}else return"No relevant pages found.";return n}catch(r){return console.error("Error in searchEmbeddingsForChat:",r),"An error occurred during the search."}}function hr(e){return{data:new TextEncoder().encode(""),meta:{name:e,contentType:"text/markdown",size:0,created:0,lastModified:0,perm:"ro"}}}function bt(e){return{name:e,contentType:"text/markdown",size:-1,created:0,lastModified:0,perm:"ro"}}function yr(e){return bt(e)}async function xr(){let e=await m.getCurrentPage();if(e.startsWith(gt)){await v();let t=e.substring(gt.length),r=`# Search results for "${t}"`,n=r+`

`;if(!d.indexEmbeddings){n+=`> **warning** Embeddings generation is disabled.
`,n+=`> You can enable it in the AI settings.


`,await m.setText(n);return}let o=`${r}

Searching for "${t}"...`;o+=`
Generating query vector embeddings..`,await m.setText(o);let i=[];try{i=await ye(t)}catch(c){console.error("Error generating query vector embeddings",c),o+=`

> **error** \u26A0\uFE0F Failed to generate query vector embeddings.
`,o+=`> ${c}

`,await m.setText(o);return}o+=`
Searching for similar embeddings...`,await m.setText(o);let s=[];try{s=await Ke(i,void 0,void 0,!0)}catch(c){console.error("Error searching embeddings",c),o+=`

> **error** \u26A0\uFE0F Failed to search through embeddings.
`,o+=`> ${c}

`,await m.setText(o);return}let a=o.length;n=r+`

`,s.length===0&&(n+=`No results found.

`);for(let c of s){n+=`## [[${c.page}]]
`;for(let u of c.children){let f=u.ref.split("@")[1].padStart(4," ");n+=`> [[${u.ref}|${f}]] | ${u.text}
`}}await m.replaceRange(0,a,n)}}async function br(){let e=await m.prompt("Search for: ");e&&await m.navigate({page:`${gt}${e}`})}function wr(e){return e.split("/").slice(0,-1).join("/")}async function F(e,...t){(await A.getEnv()===e||e==="any")&&console.log(...t)}async function Ar(e,t){let r=await tr(e);return rs(r,t)}async function rs(e,t){e.limit||(e.limit=["number",1e3]);let r=`query:${e.querySource}`,n={query:e};t&&(n.variables=t);let o=await me.dispatchEvent(r,n,30*1e3);if(o.length===0)throw new Error(`Unsupported query source '${e.querySource}'`);return o.flat()}async function se(e,t){return await A.invokeFunction("index.queryObjects",e,t)}async function wt(e,t){return await A.invokeFunction("index.indexObjects",e,t)}async function Be(e){e||(e=await m.getText());let t=await I.parseMarkdown(e);await B(t,{removeFrontmatterSection:!0}),e=O(t);let r=e.split(`
`),n=[],o="user",i="";return r.forEach(s=>{if(s.trim()==="")return;let a=s.match(/^\*\*(\w+)\*\*:/);if(a){let c=a[1].toLowerCase();o&&o!==c&&i.trim()!==""&&(n.push({role:o,content:i.trim()}),i=""),o=c,i+=s.replace(/^\*\*(\w+)\*\*:/,"").trim()+`
`}else o&&(i+=s.trim()+`
`)}),i&&o&&n.push({role:o,content:i.trim()}),n}async function Pr(){try{let e=await l("system.getVersion"),[t,r,n]=e.split(".").map(Number),[o,i,s]="0.7.2".split(".").map(Number);return t>o||t===o&&r>i||t===o&&r===i&&n>=s}catch{return!1}}async function At(){try{return(await A.listSyscalls()).some(t=>t.name==="system.invokeFunctionOnServer")}catch{return!1}}async function oe(e){let t=[],r,n;try{r=await m.getCurrentPage(),n=await k.getPageMeta(r)}catch(o){return console.error("Error fetching page metadata",o),await m.flashNotification("Error fetching page metadata","error"),[]}for(let o of e){if(o.role==="assistant"||o.role==="system"){t.push(o);continue}let i=await I.parseMarkdown(o.content),s=await rr([],i);if(o.content=o.content.replace(/\[enrich:\s*(false|true)\s*\]\s*/g,""),s.enrich!==void 0&&s.enrich===!1){console.log("Skipping message enrichment due to enrich=false attribute",s),t.push(o);continue}let a=o.content;if(o.role==="user"&&(n?(console.log("Rendering template",o.content,n),a=await z.renderTemplate(o.content,n,{page:n})):console.log("No page metadata found, skipping template rendering")),d.chat.searchEmbeddings&&d.indexEmbeddings){let f=await Ge(a);f!=="No relevant pages found."&&(a+=`

The following pages were found to be relevant to the question. You can use them as context to answer the question. Only partial content is shown. Ask for the whole page if needed. Page name is between >> and <<.
`,a+=f)}if(d.chat.parseWikiLinks&&(a=await ns(a)),d.chat.bakeMessages){let f=await I.parseMarkdown(a),y=await A.invokeFunction("markdown.expandCodeWidgets",f,"");a=O(y).trim()}let u=(await me.dispatchEvent("ai:enrichMessage",{enrichedContent:a,message:o})).flat().concat(d.chat.customEnrichFunctions),p=[...new Set(u)];console.log("Received custom enrich message functions",p);for(let f of p)a=await A.invokeSpaceFunction(f,a);t.push({...o,content:a})}return t}async function ns(e){let t=[],r=e,n=/\[\[([^\]]+)\]\]/g,o,i=!1;for(;(o=n.exec(e))!==null;){let s=o[1];if(!t.includes(s)){i||(r+=`

Base your answer on the content of the following referenced pages (referenced above using the >>page name<< format). In these listings ~~~ is used to mark the page's content start and end. If context is missing, always ask me to link directly to a page mentioned in the context.`,i=!0);try{let a=await k.readPage(s);t.push(s),r+=`

Content of the [[${s}]] page:
~~~
${a}
~~~
`}catch(a){console.error(`Error fetching page '${s}':`,a)}}}return r=r.replace(n,">>$1<<"),r}async function Sr(e,t={},r={}){try{let n=await I.parseMarkdown(e),o=await B(n,{removeFrontmatterSection:!0,removeTags:["template"]});e=O(n).trimStart();let i;return o.frontmatter&&(typeof o.frontmatter=="string"?i=o.frontmatter:i=await _.stringify(o.frontmatter),i=await z.renderTemplate(i,t,r)),{frontmatter:o,renderedFrontmatter:i,text:await z.renderTemplate(e,t,r)}}catch(n){throw console.error("Error rendering template",n),n}}async function vr(e){return Pr()?{options:(await se("template",{filter:["attr",["attr","aiprompt"],"slashCommand"]},5)).map(r=>{let n=r.aiprompt;return console.log("ai prompt template: ",n),{label:n.slashCommand,detail:n.description||r.description,order:n.order||0,templatePage:r.ref,pageName:e.pageName,invoke:"silverbullet-ai.insertAiPromptFromTemplate"}})}:void 0}async function Er(e){let t;if(!e||!e.templatePage){let c=await se("template",{filter:["attr",["attr","aiprompt"],"description"]});t=await m.filterBox("Prompt Template",c.map(u=>{let p=u.ref.split("/").pop();return{...u,description:u.aiprompt.description||u.ref,name:u.aiprompt.displayName||p,systemPrompt:u.aiprompt.systemPrompt||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:u.aiprompt.insertAt||"cursor",chat:u.aiprompt.chat||!1,enrichMessages:u.aiprompt.enrichMessages||!1}}),"Select the template to use as the prompt.  The prompt will be rendered and sent to the LLM model.")}else{console.log("selectedTemplate from slash completion: ",e);let c=await k.readPage(e.templatePage),u=await I.parseMarkdown(c),{aiprompt:p}=await B(u);console.log("templatePage from slash completion: ",c),t={ref:e.templatePage,systemPrompt:p.systemPrompt||p.system||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:p.insertAt||"cursor",chat:p.chat||!1,enrichMessages:p.enrichMessages||!1}}if(!t){await m.flashNotification("No template selected");return}console.log("User selected prompt template: ",t);let r=["cursor","page-start","page-end"];if(!r.includes(t.insertAt)){console.error(`Invalid insertAt value: ${t.insertAt}. It must be one of ${r.join(", ")}`),await m.flashNotification(`Invalid insertAt value: ${t.insertAt}. Please select a valid option.`,"error");return}await v();let n,o,i;try{n=await k.readPage(t.ref),o=await m.getCurrentPage(),i=await k.getPageMeta(o)}catch(c){console.error("Error fetching template details or page metadata",c),await m.flashNotification("Error fetching template details or page metadata","error");return}let s;switch(t.insertAt){case"page-start":s=0;break;case"page-end":s=await Z();break;case"frontmatter":await m.flashNotification("rendering in frontmatter not supported yet","error");break;case"modal":break;case"replace":break;case"cursor":default:s=await m.getCursor()}s===void 0&&(s=await Z()),console.log("templatetext: ",n);let a=[];if(t.chat)a=await Be(n),t.systemPrompt&&a.unshift({role:"system",content:t.systemPrompt}),t.chat&&t.enrichMessages&&(a=await oe(a));else{let c=await Sr(n,i,{page:i});console.log("Rendered template:",c),t.systemPrompt&&a.push({role:"system",content:t.systemPrompt}),a.push({role:"user",content:c.text})}console.log("Messages: ",a),await M.streamChatIntoEditor({messages:a,stream:!0},s)}var jl=new TextEncoder;function Tr(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}var Y=class extends Error{constructor(r="(unknown reason)",n=""){super(`${r} ${n}`);this.mark=n;this.name=this.constructor.name}toString(r){return`${this.name}: ${this.message} ${this.mark}`}};function Cr(e){return typeof e=="boolean"||e instanceof Boolean}function Mr(e){return e!==null&&typeof e=="object"}function U(e,t){let r="";for(let n=0;n<t;n++)r+=e;return r}function xe(e){return e===0&&Number.NEGATIVE_INFINITY===1/e}var He=class{constructor(t,r,n,o,i){this.name=t;this.buffer=r;this.position=n;this.line=o;this.column=i}getSnippet(t=4,r=75){if(!this.buffer)return null;let n="",o=this.position;for(;o>0&&`\0\r
\x85\u2028\u2029`.indexOf(this.buffer.charAt(o-1))===-1;)if(o-=1,this.position-o>r/2-1){n=" ... ",o+=5;break}let i="",s=this.position;for(;s<this.buffer.length&&`\0\r
\x85\u2028\u2029`.indexOf(this.buffer.charAt(s))===-1;)if(s+=1,s-this.position>r/2-1){i=" ... ",s-=5;break}let a=this.buffer.slice(o,s);return`${U(" ",t)}${n}${a}${i}
${U(" ",t+this.position-o+n.length)}^`}toString(t){let r,n="";return this.name&&(n+=`in "${this.name}" `),n+=`at line ${this.line+1}, column ${this.column+1}`,t||(r=this.getSnippet(),r&&(n+=`:
${r}`)),n}};function Pt(e,t,r){let n=[];for(let o of e.include)r=Pt(o,t,r);for(let o of e[t]){for(let i=0;i<r.length;i++){let s=r[i];s.tag===o.tag&&s.kind===o.kind&&n.push(i)}r.push(o)}return r.filter((o,i)=>!n.includes(i))}function os(...e){let t={fallback:{},mapping:{},scalar:{},sequence:{}};for(let r of e)for(let n of r)n.kind!==null&&(t[n.kind][n.tag]=t.fallback[n.tag]=n);return t}var D=class e{static SCHEMA_DEFAULT;implicit;explicit;include;compiledImplicit;compiledExplicit;compiledTypeMap;constructor(t){this.explicit=t.explicit||[],this.implicit=t.implicit||[],this.include=t.include||[];for(let r of this.implicit)if(r.loadKind&&r.loadKind!=="scalar")throw new Y("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");this.compiledImplicit=Pt(this,"implicit",[]),this.compiledExplicit=Pt(this,"explicit",[]),this.compiledTypeMap=os(this.compiledImplicit,this.compiledExplicit)}extend(t){return new e({implicit:[...new Set([...this.implicit,...t?.implicit??[]])],explicit:[...new Set([...this.explicit,...t?.explicit??[]])],include:[...new Set([...this.include,...t?.include??[]])]})}static create(){}};var b=class{tag;kind=null;instanceOf;predicate;represent;defaultStyle;styleAliases;loadKind;constructor(t,r){this.tag=t,r&&(this.kind=r.kind,this.resolve=r.resolve||(()=>!0),this.construct=r.construct||(n=>n),this.instanceOf=r.instanceOf,this.predicate=r.predicate,this.represent=r.represent,this.defaultStyle=r.defaultStyle,this.styleAliases=r.styleAliases)}resolve=()=>!0;construct=t=>t};var St=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;function is(e){if(e===null)return!1;let t,r=0,n=e.length,o=St;for(let i=0;i<n;i++)if(t=o.indexOf(e.charAt(i)),!(t>64)){if(t<0)return!1;r+=6}return r%8===0}function ss(e){let t=e.replace(/[\r\n=]/g,""),r=t.length,n=St,o=[],i=0;for(let a=0;a<r;a++)a%4===0&&a&&(o.push(i>>16&255),o.push(i>>8&255),o.push(i&255)),i=i<<6|n.indexOf(t.charAt(a));let s=r%4*6;return s===0?(o.push(i>>16&255),o.push(i>>8&255),o.push(i&255)):s===18?(o.push(i>>10&255),o.push(i>>2&255)):s===12&&o.push(i>>4&255),new Uint8Array(o)}function as(e){let t=e.length,r=St,n="",o=0;for(let s=0;s<t;s++)s%3===0&&s&&(n+=r[o>>18&63],n+=r[o>>12&63],n+=r[o>>6&63],n+=r[o&63]),o=(o<<8)+e[s];let i=t%3;return i===0?(n+=r[o>>18&63],n+=r[o>>12&63],n+=r[o>>6&63],n+=r[o&63]):i===2?(n+=r[o>>10&63],n+=r[o>>4&63],n+=r[o<<2&63],n+=r[64]):i===1&&(n+=r[o>>2&63],n+=r[o<<4&63],n+=r[64],n+=r[64]),n}function cs(e){return e instanceof Uint8Array}var vt=new b("tag:yaml.org,2002:binary",{construct:ss,kind:"scalar",predicate:cs,represent:as,resolve:is});function ls(e){let t=e.length;return t===4&&(e==="true"||e==="True"||e==="TRUE")||t===5&&(e==="false"||e==="False"||e==="FALSE")}function us(e){return e==="true"||e==="True"||e==="TRUE"}var Et=new b("tag:yaml.org,2002:bool",{construct:us,defaultStyle:"lowercase",kind:"scalar",predicate:Cr,represent:{lowercase(e){return e?"true":"false"},uppercase(e){return e?"TRUE":"FALSE"},camelcase(e){return e?"True":"False"}},resolve:ls});var ms=new RegExp("^(?:[-+]?(?:0|[1-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\\.[0-9_]*|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");function ps(e){return!(!ms.test(e)||e[e.length-1]==="_")}function ds(e){let t=e.replace(/_/g,"").toLowerCase(),r=t[0]==="-"?-1:1,n=[];if("+-".indexOf(t[0])>=0&&(t=t.slice(1)),t===".inf")return r===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY;if(t===".nan")return NaN;if(t.indexOf(":")>=0){t.split(":").forEach(s=>{n.unshift(parseFloat(s))});let o=0,i=1;return n.forEach(s=>{o+=s*i,i*=60}),r*o}return r*parseFloat(t)}var fs=/^[-+]?[0-9]+e/;function gs(e,t){if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(xe(e))return"-0.0";let r=e.toString(10);return fs.test(r)?r.replace("e",".e"):r}function hs(e){return Object.prototype.toString.call(e)==="[object Number]"&&(e%1!==0||xe(e))}var Tt=new b("tag:yaml.org,2002:float",{construct:ds,defaultStyle:"lowercase",kind:"scalar",predicate:hs,represent:gs,resolve:ps});function Or(e){let t=new Function(`return ${e}`)();if(!(t instanceof Function))throw new TypeError(`Expected function but got ${typeof t}: ${e}`);return t}var ys=new b("tag:yaml.org,2002:js/function",{kind:"scalar",resolve(e){if(e===null)return!1;try{return Or(`${e}`),!0}catch{return!1}},construct(e){return Or(e)},predicate(e){return e instanceof Function},represent(e){return e.toString()}});function xs(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function bs(e){return 48<=e&&e<=55}function ws(e){return 48<=e&&e<=57}function As(e){let t=e.length,r=0,n=!1;if(!t)return!1;let o=e[r];if((o==="-"||o==="+")&&(o=e[++r]),o==="0"){if(r+1===t)return!0;if(o=e[++r],o==="b"){for(r++;r<t;r++)if(o=e[r],o!=="_"){if(o!=="0"&&o!=="1")return!1;n=!0}return n&&o!=="_"}if(o==="x"){for(r++;r<t;r++)if(o=e[r],o!=="_"){if(!xs(e.charCodeAt(r)))return!1;n=!0}return n&&o!=="_"}for(;r<t;r++)if(o=e[r],o!=="_"){if(!bs(e.charCodeAt(r)))return!1;n=!0}return n&&o!=="_"}if(o==="_")return!1;for(;r<t;r++)if(o=e[r],o!=="_"){if(o===":")break;if(!ws(e.charCodeAt(r)))return!1;n=!0}return!n||o==="_"?!1:o!==":"?!0:/^(:[0-5]?[0-9])+$/.test(e.slice(r))}function Ps(e){let t=e,r=[];t.indexOf("_")!==-1&&(t=t.replace(/_/g,""));let n=1,o=t[0];if((o==="-"||o==="+")&&(o==="-"&&(n=-1),t=t.slice(1),o=t[0]),t==="0")return 0;if(o==="0")return t[1]==="b"?n*parseInt(t.slice(2),2):t[1]==="x"?n*parseInt(t,16):n*parseInt(t,8);if(t.indexOf(":")!==-1){t.split(":").forEach(a=>{r.unshift(parseInt(a,10))});let i=0,s=1;return r.forEach(a=>{i+=a*s,s*=60}),n*i}return n*parseInt(t,10)}function Ss(e){return Object.prototype.toString.call(e)==="[object Number]"&&e%1===0&&!xe(e)}var Ct=new b("tag:yaml.org,2002:int",{construct:Ps,defaultStyle:"decimal",kind:"scalar",predicate:Ss,represent:{binary(e){return e>=0?`0b${e.toString(2)}`:`-0b${e.toString(2).slice(1)}`},octal(e){return e>=0?`0${e.toString(8)}`:`-0${e.toString(8).slice(1)}`},decimal(e){return e.toString(10)},hexadecimal(e){return e>=0?`0x${e.toString(16).toUpperCase()}`:`-0x${e.toString(16).toUpperCase().slice(1)}`}},resolve:As,styleAliases:{binary:[2,"bin"],decimal:[10,"dec"],hexadecimal:[16,"hex"],octal:[8,"oct"]}});var Mt=new b("tag:yaml.org,2002:map",{construct(e){return e!==null?e:{}},kind:"mapping"});function vs(e){return e==="<<"||e===null}var It=new b("tag:yaml.org,2002:merge",{kind:"scalar",resolve:vs});function Es(e){let t=e.length;return t===1&&e==="~"||t===4&&(e==="null"||e==="Null"||e==="NULL")}function Ts(){return null}function Cs(e){return e===null}var Ot=new b("tag:yaml.org,2002:null",{construct:Ts,defaultStyle:"lowercase",kind:"scalar",predicate:Cs,represent:{canonical(){return"~"},lowercase(){return"null"},uppercase(){return"NULL"},camelcase(){return"Null"}},resolve:Es});var{hasOwn:Ms}=Object,Is=Object.prototype.toString;function Os(e){let t=[],r="",n=!1;for(let o of e){if(n=!1,Is.call(o)!=="[object Object]")return!1;for(r in o)if(Ms(o,r))if(!n)n=!0;else return!1;if(!n)return!1;if(t.indexOf(r)===-1)t.push(r);else return!1}return!0}function Ns(e){return e!==null?e:[]}var Nt=new b("tag:yaml.org,2002:omap",{construct:Ns,kind:"sequence",resolve:Os});var ks=Object.prototype.toString;function Fs(e){let t=Array.from({length:e.length});for(let r=0;r<e.length;r++){let n=e[r];if(ks.call(n)!=="[object Object]")return!1;let o=Object.keys(n);if(o.length!==1)return!1;t[r]=[o[0],n[o[0]]]}return!0}function Rs(e){if(e===null)return[];let t=Array.from({length:e.length});for(let r=0;r<e.length;r+=1){let n=e[r],o=Object.keys(n);t[r]=[o[0],n[o[0]]]}return t}var kt=new b("tag:yaml.org,2002:pairs",{construct:Rs,kind:"sequence",resolve:Fs});var Ft=/^\/(?<regexp>[\s\S]+)\/(?<modifiers>[gismuy]*)$/,Rt=new b("tag:yaml.org,2002:js/regexp",{kind:"scalar",resolve(e){if(e===null||!e.length)return!1;let t=`${e}`;if(t.charAt(0)==="/"){if(!Ft.test(e))return!1;let r=[...t.match(Ft)?.groups?.modifiers??""];if(new Set(r).size<r.length)return!1}return!0},construct(e){let{regexp:t=`${e}`,modifiers:r=""}=`${e}`.match(Ft)?.groups??{};return new RegExp(t,r)},predicate(e){return e instanceof RegExp},represent(e){return e.toString()}});var Lt=new b("tag:yaml.org,2002:seq",{construct(e){return e!==null?e:[]},kind:"sequence"});var{hasOwn:Ls}=Object;function $s(e){if(e===null)return!0;for(let t in e)if(Ls(e,t)&&e[t]!==null)return!1;return!0}function _s(e){return e!==null?e:{}}var $t=new b("tag:yaml.org,2002:set",{construct:_s,kind:"mapping",resolve:$s});var _t=new b("tag:yaml.org,2002:str",{construct(e){return e!==null?e:""},kind:"scalar"});var Nr=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),kr=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");function Ds(e){return e===null?!1:Nr.exec(e)!==null||kr.exec(e)!==null}function Us(e){let t=Nr.exec(e);if(t===null&&(t=kr.exec(e)),t===null)throw new Error("Date resolve error");let r=+t[1],n=+t[2]-1,o=+t[3];if(!t[4])return new Date(Date.UTC(r,n,o));let i=+t[4],s=+t[5],a=+t[6],c=0;if(t[7]){let f=t[7].slice(0,3);for(;f.length<3;)f+="0";c=+f}let u=null;if(t[9]){let f=+t[10],y=+(t[11]||0);u=(f*60+y)*6e4,t[9]==="-"&&(u=-u)}let p=new Date(Date.UTC(r,n,o,i,s,a,c));return u&&p.setTime(p.getTime()-u),p}function js(e){return e.toISOString()}var Dt=new b("tag:yaml.org,2002:timestamp",{construct:Us,instanceOf:Date,kind:"scalar",represent:js,resolve:Ds});var Ut=new b("tag:yaml.org,2002:js/undefined",{kind:"scalar",resolve(){return!0},construct(){},predicate(e){return typeof e>"u"},represent(){return""}});var jt=new D({explicit:[_t,Lt,Mt]});var qt=new D({implicit:[Ot,Et,Ct,Tt],include:[jt]});var Kt=new D({include:[qt]});var be=new D({explicit:[vt,Nt,kt,$t],implicit:[Dt,It],include:[Kt]});var qs=new D({explicit:[Rt,Ut],include:[be]});var we=class{constructor(t=be){this.schema=t}};var Ye=class extends we{constructor(r,{filename:n,schema:o,onWarning:i,legacy:s=!1,json:a=!1,listener:c=null}){super(o);this.input=r;this.filename=n,this.onWarning=i,this.legacy=s,this.json=a,this.listener=c,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=r.length}documents=[];length;lineIndent=0;lineStart=0;position=0;line=0;filename;onWarning;legacy;json;listener;implicitTypes;typeMap;version;checkLineBreaks;tagMap;anchorMap;tag;anchor;kind;result=""};var{hasOwn:Q}=Object,We=1,Ur=2,jr=3,Qe=4,Gt=1,Ks=2,Fr=3,Gs=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Bs=/[\x85\u2028\u2029]/,Hs=/[,\[\]\{\}]/,qr=/^(?:!|!!|![a-z\-]+!)$/i,Kr=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function Rr(e){return Object.prototype.toString.call(e)}function K(e){return e===10||e===13}function ee(e){return e===9||e===32}function R(e){return e===9||e===32||e===10||e===13}function ae(e){return e===44||e===91||e===93||e===123||e===125}function Ys(e){if(48<=e&&e<=57)return e-48;let t=e|32;return 97<=t&&t<=102?t-97+10:-1}function Ws(e){return e===120?2:e===117?4:e===85?8:0}function Qs(e){return 48<=e&&e<=57?e-48:-1}function Lr(e){return e===48?"\0":e===97?"\x07":e===98?"\b":e===116||e===9?"	":e===110?`
`:e===118?"\v":e===102?"\f":e===114?"\r":e===101?"\x1B":e===32?" ":e===34?'"':e===47?"/":e===92?"\\":e===78?"\x85":e===95?"\xA0":e===76?"\u2028":e===80?"\u2029":""}function Vs(e){return e<=65535?String.fromCharCode(e):String.fromCharCode((e-65536>>10)+55296,(e-65536&1023)+56320)}var Gr=Array.from({length:256}),Br=Array.from({length:256});for(let e=0;e<256;e++)Gr[e]=Lr(e)?1:0,Br[e]=Lr(e);function Hr(e,t){return new Y(t,new He(e.filename,e.input,e.position,e.line,e.position-e.lineStart))}function g(e,t){throw Hr(e,t)}function Ve(e,t){e.onWarning&&e.onWarning.call(null,Hr(e,t))}var $r={YAML(e,t,...r){if(e.version!==null)return g(e,"duplication of %YAML directive");if(r.length!==1)return g(e,"YAML directive accepts exactly one argument");let n=/^([0-9]+)\.([0-9]+)$/.exec(r[0]);if(n===null)return g(e,"ill-formed argument of the YAML directive");let o=parseInt(n[1],10),i=parseInt(n[2],10);if(o!==1)return g(e,"unacceptable YAML version of the document");if(e.version=r[0],e.checkLineBreaks=i<2,i!==1&&i!==2)return Ve(e,"unsupported YAML version of the document")},TAG(e,t,...r){if(r.length!==2)return g(e,"TAG directive accepts exactly two arguments");let n=r[0],o=r[1];if(!qr.test(n))return g(e,"ill-formed tag handle (first argument) of the TAG directive");if(e.tagMap&&Q(e.tagMap,n))return g(e,`there is a previously declared suffix for "${n}" tag handle`);if(!Kr.test(o))return g(e,"ill-formed tag prefix (second argument) of the TAG directive");typeof e.tagMap>"u"&&(e.tagMap=Object.create(null)),e.tagMap[n]=o}};function W(e,t,r,n){let o;if(t<r){if(o=e.input.slice(t,r),n)for(let i=0,s=o.length;i<s;i++){let a=o.charCodeAt(i);if(!(a===9||32<=a&&a<=1114111))return g(e,"expected valid JSON character")}else if(Gs.test(o))return g(e,"the stream contains non-printable characters");e.result+=o}}function _r(e,t,r,n){if(!Mr(r))return g(e,"cannot merge mappings; the provided source object is unacceptable");let o=Object.keys(r);for(let i=0,s=o.length;i<s;i++){let a=o[i];Q(t,a)||(Object.defineProperty(t,a,{value:r[a],writable:!0,enumerable:!0,configurable:!0}),n[a]=!0)}}function ce(e,t,r,n,o,i,s,a){if(Array.isArray(o)){o=Array.prototype.slice.call(o);for(let c=0,u=o.length;c<u;c++){if(Array.isArray(o[c]))return g(e,"nested arrays are not supported inside keys");typeof o=="object"&&Rr(o[c])==="[object Object]"&&(o[c]="[object Object]")}}if(typeof o=="object"&&Rr(o)==="[object Object]"&&(o="[object Object]"),o=String(o),t===null&&(t={}),n==="tag:yaml.org,2002:merge")if(Array.isArray(i))for(let c=0,u=i.length;c<u;c++)_r(e,t,i[c],r);else _r(e,t,i,r);else{if(!e.json&&!Q(r,o)&&Q(t,o))return e.line=s||e.line,e.position=a||e.position,g(e,"duplicated mapping key");Object.defineProperty(t,o,{value:i,writable:!0,enumerable:!0,configurable:!0}),delete r[o]}return t}function Bt(e){let t=e.input.charCodeAt(e.position);if(t===10)e.position++;else if(t===13)e.position++,e.input.charCodeAt(e.position)===10&&e.position++;else return g(e,"a line break is expected");e.line+=1,e.lineStart=e.position}function T(e,t,r){let n=0,o=e.input.charCodeAt(e.position);for(;o!==0;){for(;ee(o);)o=e.input.charCodeAt(++e.position);if(t&&o===35)do o=e.input.charCodeAt(++e.position);while(o!==10&&o!==13&&o!==0);if(K(o))for(Bt(e),o=e.input.charCodeAt(e.position),n++,e.lineIndent=0;o===32;)e.lineIndent++,o=e.input.charCodeAt(++e.position);else break}return r!==-1&&n!==0&&e.lineIndent<r&&Ve(e,"deficient indentation"),n}function ze(e){let t=e.position,r=e.input.charCodeAt(t);return!!((r===45||r===46)&&r===e.input.charCodeAt(t+1)&&r===e.input.charCodeAt(t+2)&&(t+=3,r=e.input.charCodeAt(t),r===0||R(r)))}function Ht(e,t){t===1?e.result+=" ":t>1&&(e.result+=U(`
`,t-1))}function zs(e,t,r){let n=e.kind,o=e.result,i=e.input.charCodeAt(e.position);if(R(i)||ae(i)||i===35||i===38||i===42||i===33||i===124||i===62||i===39||i===34||i===37||i===64||i===96)return!1;let s;if((i===63||i===45)&&(s=e.input.charCodeAt(e.position+1),R(s)||r&&ae(s)))return!1;e.kind="scalar",e.result="";let a,c=a=e.position,u=!1,p=0;for(;i!==0;){if(i===58){if(s=e.input.charCodeAt(e.position+1),R(s)||r&&ae(s))break}else if(i===35){let f=e.input.charCodeAt(e.position-1);if(R(f))break}else{if(e.position===e.lineStart&&ze(e)||r&&ae(i))break;if(K(i)){p=e.line;let f=e.lineStart,y=e.lineIndent;if(T(e,!1,-1),e.lineIndent>=t){u=!0,i=e.input.charCodeAt(e.position);continue}else{e.position=a,e.line=p,e.lineStart=f,e.lineIndent=y;break}}}u&&(W(e,c,a,!1),Ht(e,e.line-p),c=a=e.position,u=!1),ee(i)||(a=e.position+1),i=e.input.charCodeAt(++e.position)}return W(e,c,a,!1),e.result?!0:(e.kind=n,e.result=o,!1)}function Js(e,t){let r,n,o;if(r=e.input.charCodeAt(e.position),r!==39)return!1;for(e.kind="scalar",e.result="",e.position++,n=o=e.position;(r=e.input.charCodeAt(e.position))!==0;)if(r===39)if(W(e,n,e.position,!0),r=e.input.charCodeAt(++e.position),r===39)n=e.position,e.position++,o=e.position;else return!0;else if(K(r))W(e,n,o,!0),Ht(e,T(e,!1,t)),n=o=e.position;else{if(e.position===e.lineStart&&ze(e))return g(e,"unexpected end of the document within a single quoted scalar");e.position++,o=e.position}return g(e,"unexpected end of the stream within a single quoted scalar")}function Xs(e,t){let r=e.input.charCodeAt(e.position);if(r!==34)return!1;e.kind="scalar",e.result="",e.position++;let n,o=n=e.position,i;for(;(r=e.input.charCodeAt(e.position))!==0;){if(r===34)return W(e,o,e.position,!0),e.position++,!0;if(r===92){if(W(e,o,e.position,!0),r=e.input.charCodeAt(++e.position),K(r))T(e,!1,t);else if(r<256&&Gr[r])e.result+=Br[r],e.position++;else if((i=Ws(r))>0){let s=i,a=0;for(;s>0;s--)if(r=e.input.charCodeAt(++e.position),(i=Ys(r))>=0)a=(a<<4)+i;else return g(e,"expected hexadecimal character");e.result+=Vs(a),e.position++}else return g(e,"unknown escape sequence");o=n=e.position}else if(K(r))W(e,o,n,!0),Ht(e,T(e,!1,t)),o=n=e.position;else{if(e.position===e.lineStart&&ze(e))return g(e,"unexpected end of the document within a double quoted scalar");e.position++,n=e.position}}return g(e,"unexpected end of the stream within a double quoted scalar")}function Zs(e,t){let r=e.input.charCodeAt(e.position),n,o=!0,i={};if(r===91)n=93,o=!1,i=[];else if(r===123)n=125;else return!1;e.anchor!==null&&typeof e.anchor<"u"&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=i),r=e.input.charCodeAt(++e.position);let s=e.tag,a=e.anchor,c=!0,u,p,f=p=u=null,y,w=y=!1,x=0,C=0,P=Object.create(null);for(;r!==0;){if(T(e,!0,t),r=e.input.charCodeAt(e.position),r===n)return e.position++,e.tag=s,e.anchor=a,e.kind=o?"mapping":"sequence",e.result=i,!0;if(!c)return g(e,"missed comma between flow collection entries");f=p=u=null,w=y=!1,r===63&&(x=e.input.charCodeAt(e.position+1),R(x)&&(w=y=!0,e.position++,T(e,!0,t))),C=e.line,le(e,t,We,!1,!0),f=e.tag||null,p=e.result,T(e,!0,t),r=e.input.charCodeAt(e.position),(y||e.line===C)&&r===58&&(w=!0,r=e.input.charCodeAt(++e.position),T(e,!0,t),le(e,t,We,!1,!0),u=e.result),o?ce(e,i,P,f,p,u):w?i.push(ce(e,null,P,f,p,u)):i.push(p),T(e,!0,t),r=e.input.charCodeAt(e.position),r===44?(c=!0,r=e.input.charCodeAt(++e.position)):c=!1}return g(e,"unexpected end of the stream within a flow collection")}function ea(e,t){let r=Gt,n=!1,o=!1,i=t,s=0,a=!1,c=e.input.charCodeAt(e.position),u=!1;if(c===124)u=!1;else if(c===62)u=!0;else return!1;e.kind="scalar",e.result="";let p=0;for(;c!==0;)if(c=e.input.charCodeAt(++e.position),c===43||c===45)if(Gt===r)r=c===43?Fr:Ks;else return g(e,"repeat of a chomping mode identifier");else if((p=Qs(c))>=0){if(p===0)return g(e,"bad explicit indentation width of a block scalar; it cannot be less than one");if(!o)i=t+p-1,o=!0;else return g(e,"repeat of an indentation width identifier")}else break;if(ee(c)){do c=e.input.charCodeAt(++e.position);while(ee(c));if(c===35)do c=e.input.charCodeAt(++e.position);while(!K(c)&&c!==0)}for(;c!==0;){for(Bt(e),e.lineIndent=0,c=e.input.charCodeAt(e.position);(!o||e.lineIndent<i)&&c===32;)e.lineIndent++,c=e.input.charCodeAt(++e.position);if(!o&&e.lineIndent>i&&(i=e.lineIndent),K(c)){s++;continue}if(e.lineIndent<i){r===Fr?e.result+=U(`
`,n?1+s:s):r===Gt&&n&&(e.result+=`
`);break}u?ee(c)?(a=!0,e.result+=U(`
`,n?1+s:s)):a?(a=!1,e.result+=U(`
`,s+1)):s===0?n&&(e.result+=" "):e.result+=U(`
`,s):e.result+=U(`
`,n?1+s:s),n=!0,o=!0,s=0;let f=e.position;for(;!K(c)&&c!==0;)c=e.input.charCodeAt(++e.position);W(e,f,e.position,!1)}return!0}function Dr(e,t){let r,n,o=!1,i,s=e.tag,a=e.anchor,c=[];for(e.anchor!==null&&typeof e.anchor<"u"&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=c),i=e.input.charCodeAt(e.position);i!==0&&!(i!==45||(n=e.input.charCodeAt(e.position+1),!R(n)));){if(o=!0,e.position++,T(e,!0,-1)&&e.lineIndent<=t){c.push(null),i=e.input.charCodeAt(e.position);continue}if(r=e.line,le(e,t,jr,!1,!0),c.push(e.result),T(e,!0,-1),i=e.input.charCodeAt(e.position),(e.line===r||e.lineIndent>t)&&i!==0)return g(e,"bad indentation of a sequence entry");if(e.lineIndent<t)break}return o?(e.tag=s,e.anchor=a,e.kind="sequence",e.result=c,!0):!1}function ta(e,t,r){let n=e.tag,o=e.anchor,i={},s=Object.create(null),a,c=!1,u,p,f=null,y=null,w=null,x=!1,C=!1,P;for(e.anchor!==null&&typeof e.anchor<"u"&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=i),P=e.input.charCodeAt(e.position);P!==0;){if(a=e.input.charCodeAt(e.position+1),u=e.line,p=e.position,(P===63||P===58)&&R(a)){if(P===63)x&&(ce(e,i,s,f,y,null),f=y=w=null),C=!0,x=!0,c=!0;else if(x)x=!1,c=!0;else return g(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line");e.position+=1,P=a}else if(le(e,r,Ur,!1,!0))if(e.line===u){for(P=e.input.charCodeAt(e.position);ee(P);)P=e.input.charCodeAt(++e.position);if(P===58){if(P=e.input.charCodeAt(++e.position),!R(P))return g(e,"a whitespace character is expected after the key-value separator within a block mapping");x&&(ce(e,i,s,f,y,null),f=y=w=null),C=!0,x=!1,c=!1,f=e.tag,y=e.result}else return C?g(e,"can not read an implicit mapping pair; a colon is missed"):(e.tag=n,e.anchor=o,!0)}else return C?g(e,"can not read a block mapping entry; a multiline key may not be an implicit key"):(e.tag=n,e.anchor=o,!0);else break;if((e.line===u||e.lineIndent>t)&&(le(e,t,Qe,!0,c)&&(x?y=e.result:w=e.result),x||(ce(e,i,s,f,y,w,u,p),f=y=w=null),T(e,!0,-1),P=e.input.charCodeAt(e.position)),e.lineIndent>t&&P!==0)return g(e,"bad indentation of a mapping entry");if(e.lineIndent<t)break}return x&&ce(e,i,s,f,y,null),C&&(e.tag=n,e.anchor=o,e.kind="mapping",e.result=i),C}function ra(e){let t,r=!1,n=!1,o="",i,s;if(s=e.input.charCodeAt(e.position),s!==33)return!1;if(e.tag!==null)return g(e,"duplication of a tag property");if(s=e.input.charCodeAt(++e.position),s===60?(r=!0,s=e.input.charCodeAt(++e.position)):s===33?(n=!0,o="!!",s=e.input.charCodeAt(++e.position)):o="!",t=e.position,r){do s=e.input.charCodeAt(++e.position);while(s!==0&&s!==62);if(e.position<e.length)i=e.input.slice(t,e.position),s=e.input.charCodeAt(++e.position);else return g(e,"unexpected end of the stream within a verbatim tag")}else{for(;s!==0&&!R(s);){if(s===33){if(n)return g(e,"tag suffix cannot contain exclamation marks");if(o=e.input.slice(t-1,e.position+1),!qr.test(o))return g(e,"named tag handle cannot contain such characters");n=!0,t=e.position+1}s=e.input.charCodeAt(++e.position)}if(i=e.input.slice(t,e.position),Hs.test(i))return g(e,"tag suffix cannot contain flow indicator characters")}if(i&&!Kr.test(i))return g(e,`tag name cannot contain such characters: ${i}`);if(r)e.tag=i;else if(typeof e.tagMap<"u"&&Q(e.tagMap,o))e.tag=e.tagMap[o]+i;else if(o==="!")e.tag=`!${i}`;else if(o==="!!")e.tag=`tag:yaml.org,2002:${i}`;else return g(e,`undeclared tag handle "${o}"`);return!0}function na(e){let t=e.input.charCodeAt(e.position);if(t!==38)return!1;if(e.anchor!==null)return g(e,"duplication of an anchor property");t=e.input.charCodeAt(++e.position);let r=e.position;for(;t!==0&&!R(t)&&!ae(t);)t=e.input.charCodeAt(++e.position);return e.position===r?g(e,"name of an anchor node must contain at least one character"):(e.anchor=e.input.slice(r,e.position),!0)}function oa(e){let t=e.input.charCodeAt(e.position);if(t!==42)return!1;t=e.input.charCodeAt(++e.position);let r=e.position;for(;t!==0&&!R(t)&&!ae(t);)t=e.input.charCodeAt(++e.position);if(e.position===r)return g(e,"name of an alias node must contain at least one character");let n=e.input.slice(r,e.position);return typeof e.anchorMap<"u"&&!Q(e.anchorMap,n)?g(e,`unidentified alias "${n}"`):(typeof e.anchorMap<"u"&&(e.result=e.anchorMap[n]),T(e,!0,-1),!0)}function le(e,t,r,n,o){let i,s,a=1,c=!1,u=!1,p,f,y;e.listener&&e.listener!==null&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null;let w=i=s=Qe===r||jr===r;if(n&&T(e,!0,-1)&&(c=!0,e.lineIndent>t?a=1:e.lineIndent===t?a=0:e.lineIndent<t&&(a=-1)),a===1)for(;ra(e)||na(e);)T(e,!0,-1)?(c=!0,s=w,e.lineIndent>t?a=1:e.lineIndent===t?a=0:e.lineIndent<t&&(a=-1)):s=!1;if(s&&(s=c||o),a===1||Qe===r)if(f=We===r||Ur===r?t:t+1,y=e.position-e.lineStart,a===1)if(s&&(Dr(e,y)||ta(e,y,f))||Zs(e,f))u=!0;else{if(i&&ea(e,f)||Js(e,f)||Xs(e,f))u=!0;else if(oa(e)){if(u=!0,e.tag!==null||e.anchor!==null)return g(e,"alias node should not have Any properties")}else zs(e,f,We===r)&&(u=!0,e.tag===null&&(e.tag="?"));e.anchor!==null&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=e.result)}else a===0&&(u=s&&Dr(e,y));if(e.tag!==null&&e.tag!=="!")if(e.tag==="?"){for(let x=0,C=e.implicitTypes.length;x<C;x++)if(p=e.implicitTypes[x],p.resolve(e.result)){e.result=p.construct(e.result),e.tag=p.tag,e.anchor!==null&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=e.result);break}}else if(Q(e.typeMap[e.kind||"fallback"],e.tag)){if(p=e.typeMap[e.kind||"fallback"][e.tag],e.result!==null&&p.kind!==e.kind)return g(e,`unacceptable node kind for !<${e.tag}> tag; it should be "${p.kind}", not "${e.kind}"`);if(p.resolve(e.result))e.result=p.construct(e.result),e.anchor!==null&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=e.result);else return g(e,`cannot resolve a node with !<${e.tag}> explicit tag`)}else return g(e,`unknown tag !<${e.tag}>`);return e.listener&&e.listener!==null&&e.listener("close",e),e.tag!==null||e.anchor!==null||u}function ia(e){let t=e.position,r,n,o,i=!1,s;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);(s=e.input.charCodeAt(e.position))!==0&&(T(e,!0,-1),s=e.input.charCodeAt(e.position),!(e.lineIndent>0||s!==37));){for(i=!0,s=e.input.charCodeAt(++e.position),r=e.position;s!==0&&!R(s);)s=e.input.charCodeAt(++e.position);if(n=e.input.slice(r,e.position),o=[],n.length<1)return g(e,"directive name must not be less than one character in length");for(;s!==0;){for(;ee(s);)s=e.input.charCodeAt(++e.position);if(s===35){do s=e.input.charCodeAt(++e.position);while(s!==0&&!K(s));break}if(K(s))break;for(r=e.position;s!==0&&!R(s);)s=e.input.charCodeAt(++e.position);o.push(e.input.slice(r,e.position))}s!==0&&Bt(e),Q($r,n)?$r[n](e,n,...o):Ve(e,`unknown document directive "${n}"`)}if(T(e,!0,-1),e.lineIndent===0&&e.input.charCodeAt(e.position)===45&&e.input.charCodeAt(e.position+1)===45&&e.input.charCodeAt(e.position+2)===45)e.position+=3,T(e,!0,-1);else if(i)return g(e,"directives end mark is expected");if(le(e,e.lineIndent-1,Qe,!1,!0),T(e,!0,-1),e.checkLineBreaks&&Bs.test(e.input.slice(t,e.position))&&Ve(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&ze(e)){e.input.charCodeAt(e.position)===46&&(e.position+=3,T(e,!0,-1));return}if(e.position<e.length-1)return g(e,"end of the stream or a document separator is expected")}function sa(e,t){e=String(e),t=t||{},e.length!==0&&(e.charCodeAt(e.length-1)!==10&&e.charCodeAt(e.length-1)!==13&&(e+=`
`),e.charCodeAt(0)===65279&&(e=e.slice(1)));let r=new Ye(e,t);for(r.input+="\0";r.input.charCodeAt(r.position)===32;)r.lineIndent+=1,r.position+=1;for(;r.position<r.length-1;)ia(r);return r.documents}function Yr(e,t){let r=sa(e,t);if(r.length===0)return null;if(r.length===1)return r[0];throw new Y("expected a single document in the stream, but found more")}function Wr(e,t){return Yr(e,t)}var{hasOwn:_m}=Object;var{hasOwn:Gm}=Object;var N={};N[0]="\\0";N[7]="\\a";N[8]="\\b";N[9]="\\t";N[10]="\\n";N[11]="\\v";N[12]="\\f";N[13]="\\r";N[27]="\\e";N[34]='\\"';N[92]="\\\\";N[133]="\\N";N[160]="\\_";N[8232]="\\L";N[8233]="\\P";async function Qr(e){(e==="SETTINGS"||e==="SECRETS")&&await H(!0)}async function Vr(){await H(!0)}async function zr(){(!d||!d.textModels)&&await H(!1);let e=d.textModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await m.filterBox("Select a model",e);if(!t){await m.flashNotification("No model selected.","error");return}let r=t.name;await mt(t),await ge(t),await m.flashNotification(`Selected model: ${r}`),console.log("Selected model:",t)}async function Jr(){(!d||!d.imageModels)&&await H(!1);let e=d.imageModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await m.filterBox("Select an image model",e);if(!t){await m.flashNotification("No image model selected.","error");return}let r=t.name;await ut(t),await dt(t),await m.flashNotification(`Selected image model: ${r}`),console.log("Selected image model:",t)}async function Xr(){(!d||!d.embeddingModels)&&await H(!1);let e=d.embeddingModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await m.filterBox("Select an embedding model",e);if(!t){await m.flashNotification("No embedding model selected.","error");return}let r=t.name;await pt(t),await ft(t),await m.flashNotification(`Selected embedding model: ${r}`),console.log("Selected embedding model:",t)}async function Zr(){await v();let e=await ke(),t=await m.prompt("Please enter a prompt to send to the LLM. Selected text or the entire note will also be sent as context."),r=await m.getCurrentPage(),n=new Date,o=n.toISOString().split("T")[0],i=n.toLocaleDateString("en-US",{weekday:"long"});await M.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant. Follow all user instructions and use the note context and note content to help follow those instructions. Use Markdown for any formatting."},{role:"user",content:`Note Context: Today is ${i}, ${o}. The current note name is "${r}".
User Prompt: ${t}
Note Content:
${e.text}`}],stream:!0},e.to)}async function en(){await v();let e=await ke();if(console.log("selectedTextInfo",e),e.text.length>0){let t=await m.getCurrentPage(),r=await M.chatWithAI({messages:[{role:"user",content:`Please summarize this note using markdown for any formatting. Your summary will be appended to the end of this note, do not include any of the note contents yourself. Keep the summary brief. The note name is ${t}.

${e.text}`}],stream:!1});return console.log("OpenAI response:",r),{summary:r,selectedTextInfo:e}}return{summary:"",selectedTextInfo:null}}async function tn(){let{summary:e,selectedTextInfo:t}=await en();e&&t&&await m.insertAtPos(`

`+e,t.to)}async function rn(){let{summary:e}=await en();e?await m.showPanel("rhs",2,e):await m.flashNotification("No summary available.")}async function Yt(){await v();let e=await m.getText(),t=await m.getCurrentPage(),r=(await Ar("tag select name where parent = 'page' order by name")).map(f=>f.name);console.log("All tags:",r);let n=`You are an AI tagging assistant. Please provide a short list of tags, separated by spaces. Follow these guidelines:
    - Only return tags and no other content.
    - Tags must be one word only and in lowercase.
    - Use existing tags as a starting point.
    - Suggest tags sparingly, treating them as thematic descriptors rather than keywords.

    The following tags are currently being used by other notes:
    ${r.join(", ")}
    
    Always follow the below rules, if any, given by the user:
    ${d.promptInstructions.tagRules}`,o=`Page Title: ${t}

Page Content:
${e}`,s=(await M.singleMessageChat(o,n)).trim().replace(/,/g,"").split(/\s+/),a=await I.parseMarkdown(e),c=await B(a),u=[...new Set([...c.tags||[],...s])];c.tags=u,console.log("Current frontmatter:",c);let p=await st(a,c);console.log("updatedNoteContent",p),await m.dispatch(p),await m.flashNotification("Note tagged successfully.")}async function Wt(){await v();let e=await m.getText(),t=await m.getCurrentPage(),r=[{name:"Generating suggestions...",description:""}];m.filterBox("Loading...",r,"Retrieving suggestions from LLM provider.").then(u=>{console.log("Selected option (initial):",u)});let o="";d.promptInstructions.pageRenameSystem?o=d.promptInstructions.pageRenameSystem:o=`You are an AI note-naming assistant. Your task is to suggest three to five possible names for the provided note content. Please adhere to the following guidelines:
    - Provide each name on a new line.
    - Use only spaces, forward slashes (as folder separators), and hyphens as special characters.
    - Ensure the names are concise, descriptive, and relevant to the content.
    - Avoid suggesting the same name as the current note.
    - Include as much detail as possible within 3 to 10 words.
    - Start names with ASCII characters only.
    - Do not use markdown or any other formatting in your response.`;let s=(await M.singleMessageChat(`Current Page Title: ${t}

Page Content:
${e}`,`${o}

Always follow the below rules, if any, given by the user:
${d.promptInstructions.pageRenameRules}`,!0)).trim().split(`
`).filter(u=>u.trim()!=="").map(u=>u.replace(/^[*-]\s*/,"").trim());s.push(t),s=[...new Set(s)],s.length===0&&await m.flashNotification("No suggestions available.");let a=await m.filterBox("New page name",s.map(u=>({name:u})),"Select a new page name from one of the suggestions below.");if(!a){await m.flashNotification("No page name selected.","error");return}console.log("selectedSuggestion",a);let c=await A.invokeFunction("index.renamePageCommand",{oldPage:t,page:a.name});console.log("renamedPage",c),c||await m.flashNotification("Error renaming page.","error")}async function Qt(){await v();let e=await m.getText(),t=await m.getCurrentPage(),r=["title","tags"],o=await M.singleMessageChat(`Current Page Title: ${t}

Page Content:
${e}`,`You are an AI note enhancing assistant. Your task is to understand the content of a note, detect and extract important information, and convert it to frontmatter attributes. Please adhere to the following guidelines:
      - Only return valid YAML frontmatter.
      - Do not use any markdown or any other formatting in your response.
      - Do not include --- in your response.
      - Do not include any content from the note in your response.
      - Extract useful facts from the note and add them to the frontmatter, such as a person's name, age, a location, etc.
      - Do not return any tags.
      - Do not return a new note title.
      - Do not use special characters in key names.  Only ASCII.
      - Only return important information that would be useful when searching or filtering notes.
      

Always follow the below rules, if any, given by the user:
${d.promptInstructions.enhanceFrontMatterPrompt}`,!0);console.log("frontmatter returned by enhanceNoteFrontMatter",o);try{let i=Wr(o);if(typeof i!="object"||Array.isArray(i)||!i)throw new Error("Invalid YAML: Not an object");r.forEach(p=>{delete i[p]});let s=await I.parseMarkdown(e),c={...await B(s),...i},u=await st(s,c);console.log("updatedNoteContent",u),await m.dispatch(u)}catch(i){console.error("Invalid YAML returned by enhanceNoteFrontMatter",i),await m.flashNotification("Error: Invalid Frontmatter YAML returned.","error");return}await m.flashNotification("Frontmatter enhanced successfully.","info")}async function nn(){await Yt(),await Qt(),await Wt()}async function on(){let e=await ke(),t=e.to;await M.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant in a markdown-based note tool."},{role:"user",content:e.text}],stream:!0},t)}async function sn(){await v();let e=await Be();if(e.length===0){await m.flashNotification("Error: The page does not match the required format for a chat.");return}e.unshift(de);let t=await oe(e);console.log("enrichedMessages",t);let r=await Z();await m.insertAtPos(`

**assistant**: `,r),r+=17,await m.insertAtPos(`

**user**: `,r),await m.moveCursor(r+12);try{await M.streamChatIntoEditor({messages:t,stream:!0},r)}catch(n){console.error("Error streaming chat on page:",n),await m.flashNotification("Error streaming chat on page.","error")}}async function an(){if(await v(),!d.imageModels||d.imageModels.length===0){await m.flashNotification("No image models available.","error");return}try{let e=await m.prompt("Enter a prompt for DALL\xB7E:");if(!e||!e.trim()){await m.flashNotification("No prompt entered. Operation cancelled.","error");return}let t={prompt:e,numImages:1,size:"1024x1024",quality:"hd"},r=await qe.generateImage(t);if(r&&r.data&&r.data.length>0){let n=r.data[0].b64_json,o=r.data[0].revised_prompt,i=new Uint8Array(Tr(n)),s=`dall-e-${Date.now()}.png`,a=wr(await m.getCurrentPage())+"/";a==="/"&&(a=""),await k.writeAttachment(a+s,i);let c=`![${s}](${s})
*${o}*`;await m.insertAtCursor(c),await m.flashNotification("Image generated and inserted with caption successfully.")}else await m.flashNotification("Failed to generate image.","error")}catch(e){console.error("Error generating image with DALL\xB7E:",e),await m.flashNotification("Error generating image.","error")}}async function cn(e,t){try{return await v(),await M.singleMessageChat(e,t||"You are an AI note assistant helping to render content for a note. Please follow user instructions and keep your response short and concise.")}catch(r){throw console.error("Error querying OpenAI:",r),r}}async function ln(){await v();let e=await m.prompt("Enter some text to embed:");if(!e){await m.flashNotification("No text entered.","error");return}let t=await $.generateEmbeddings({text:e});await m.insertAtCursor(`

Embedding: ${t}`)}var un={aiPromptSlashCommplete:vr,queryAI:cn,reloadSettingsPageEvent:Qr,reloadConfigEvent:Vr,summarizeNote:rn,insertSummary:tn,callOpenAI:Zr,tagNoteWithAI:Yt,promptAndGenerateImage:an,streamOpenAIWithSelectionAsPrompt:on,streamChatOnPage:sn,insertAiPromptFromTemplate:Er,suggestPageName:Wt,enhanceNoteFrontMatter:Qt,enhanceNoteWithAI:nn,selectTextModel:zr,selectImageModel:Jr,selectEmbeddingModel:Xr,testEmbeddingGeneration:ln,getAllEmbeddings:yt,searchEmbeddings:xt,queueEmbeddingGeneration:ur,processEmbeddingsQueue:mr,processSummaryQueue:pr,generateEmbeddings:fr,generateEmbeddingsOnServer:ye,searchEmbeddingsForChat:Ge,searchCombinedEmbeddings:Ke,searchSummaryEmbeddings:gr,readPageSearchEmbeddings:hr,writePageSearchEmbeddings:yr,getPageMetaSearchEmbeddings:bt,searchCommand:br,updateSearchPage:xr},mn={name:"silverbullet-ai",requiredPermissions:["fetch"],functions:{aiPromptSlashCommplete:{path:"src/prompts.ts:aiPromptSlashComplete",events:["slash:complete"]},queryAI:{path:"sbai.ts:queryAI"},reloadSettingsPageEvent:{path:"sbai.ts:reloadSettingsPage",events:["page:saved"]},reloadConfigEvent:{path:"sbai.ts:reloadConfig",events:["config:loaded"]},summarizeNote:{path:"sbai.ts:openSummaryPanel",command:{name:"AI: Summarize Note and open summary"}},insertSummary:{path:"sbai.ts:insertSummary",command:{name:"AI: Insert Summary"}},callOpenAI:{path:"sbai.ts:callOpenAIwithNote",command:{name:"AI: Call OpenAI with Note as context"}},tagNoteWithAI:{path:"sbai.ts:tagNoteWithAI",command:{name:"AI: Generate tags for note"}},promptAndGenerateImage:{path:"sbai.ts:promptAndGenerateImage",command:{name:"AI: Generate and insert image using DallE"}},streamOpenAIWithSelectionAsPrompt:{path:"sbai.ts:streamOpenAIWithSelectionAsPrompt",command:{name:"AI: Stream response with selection or note as prompt"}},streamChatOnPage:{path:"sbai.ts:streamChatOnPage",command:{name:"AI: Chat on current page",key:"Ctrl-Shift-Enter",mac:"Cmd-Shift-Enter"}},insertAiPromptFromTemplate:{path:"src/prompts.ts:insertAiPromptFromTemplate",command:{name:"AI: Execute AI Prompt from Custom Template"}},suggestPageName:{path:"sbai.ts:suggestPageName",command:{name:"AI: Suggest Page Name"}},enhanceNoteFrontMatter:{path:"sbai.ts:enhanceNoteFrontMatter",command:{name:"AI: Generate Note FrontMatter"}},enhanceNoteWithAI:{path:"sbai.ts:enhanceNoteWithAI",command:{name:"AI: Enhance Note"}},selectTextModel:{path:"sbai.ts:selectModelFromConfig",command:{name:"AI: Select Text Model from Config"}},selectImageModel:{path:"sbai.ts:selectImageModelFromConfig",command:{name:"AI: Select Image Model from Config"}},selectEmbeddingModel:{path:"sbai.ts:selectEmbeddingModelFromConfig",command:{name:"AI: Select Embedding Model from Config"}},testEmbeddingGeneration:{path:"sbai.ts:testEmbeddingGeneration",command:{name:"AI: Test Embedding Generation"}},getAllEmbeddings:{path:"src/embeddings.ts:getAllEmbeddings",env:"server"},searchEmbeddings:{path:"src/embeddings.ts:searchEmbeddings",env:"server"},queueEmbeddingGeneration:{path:"src/embeddings.ts:queueEmbeddingGeneration",env:"server",events:["page:index"]},processEmbeddingsQueue:{path:"src/embeddings.ts:processEmbeddingsQueue",mqSubscriptions:[{queue:"aiEmbeddingsQueue",batchSize:1,autoAck:!0,pollInterval:6e5}]},processSummaryQueue:{path:"src/embeddings.ts:processSummaryQueue",mqSubscriptions:[{queue:"aiSummaryQueue",batchSize:1,autoAck:!0,pollInterval:6e5}]},generateEmbeddings:{path:"src/embeddings.ts:generateEmbeddings"},generateEmbeddingsOnServer:{path:"src/embeddings.ts:generateEmbeddingsOnServer"},searchEmbeddingsForChat:{path:"src/embeddings.ts:searchEmbeddingsForChat"},searchCombinedEmbeddings:{path:"src/embeddings.ts:searchCombinedEmbeddings"},searchSummaryEmbeddings:{path:"src/embeddings.ts:searchSummaryEmbeddings"},readPageSearchEmbeddings:{path:"src/embeddings.ts:readFileEmbeddings",pageNamespace:{pattern:"\u{1F916} .+",operation:"readFile"}},writePageSearchEmbeddings:{path:"src/embeddings.ts:writeFileEmbeddings",pageNamespace:{pattern:"\u{1F916} .+",operation:"writeFile"}},getPageMetaSearchEmbeddings:{path:"src/embeddings.ts:getFileMetaEmbeddings",pageNamespace:{pattern:"\u{1F916} .+",operation:"getFileMeta"}},searchCommand:{path:"src/embeddings.ts:searchCommand",command:{name:"AI: Search"}},updateSearchPage:{path:"src/embeddings.ts:updateSearchPage",events:["editor:pageLoaded","editor:pageReloaded"]}},assets:{}},Kp={manifest:mn,functionMapping:un};Jt(un,mn);export{Kp as plug};
