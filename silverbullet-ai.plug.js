var we=Object.defineProperty;var T=(e,t)=>{for(var r in t)we(e,r,{get:t[r],enumerable:!0})};var j=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var $=new Map,D=0;function M(e){self.postMessage(e)}j&&(globalThis.syscall=async(e,...t)=>await new Promise((r,n)=>{D++,$.set(D,{resolve:r,reject:n}),M({type:"sys",id:D,name:e,args:t})}));function Y(e,t){j&&(self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let o=e[n.name];if(!o)throw new Error(`Function not loaded: ${n.name}`);try{let s=await Promise.resolve(o(...n.args||[]));M({type:"invr",id:n.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",n.name,"error:",s.message),M({type:"invr",id:n.id,error:s.message})}}break;case"sysr":{let o=n.id,s=$.get(o);if(!s)throw Error("Invalid request id");$.delete(o),n.error?s.reject(new Error(n.error)):s.resolve(n.result)}break}})().catch(console.error)}),M({type:"manifest",manifest:t}))}function Ae(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}function H(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function ve(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),n=r.length>0?H(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function Te(){globalThis.fetch=async function(e,t){let r=t&&t.body?H(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await ve(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(n.base64Body?Ae(n.base64Body):null,{status:n.status,headers:n.headers})}}j&&Te();function B(e){if(e.children)for(let t of e.children){if(t.parent)return;t.parent=e,B(t)}}function G(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...G(n,t)];return r}async function z(e,t){if(await t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...await z(n,t)];return r}async function q(e,t){if(e.children){let r=e.children.slice();for(let n of r){let o=await t(n);if(o!==void 0){let s=e.children.indexOf(n);o?e.children.splice(s,1,o):e.children.splice(s,1)}else await q(n,t)}}}function W(e,t){return G(e,r=>r.type===t)[0]}function Q(e,t){G(e,t)}async function J(e,t){await z(e,t)}function b(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(b(r));return t.join("")}function F(e){if(!e||typeof e!="object")return e;if(Array.isArray(e))return e.map(F);let t={};for(let r of Object.keys(e)){let n=r.split("."),o=t;for(let s=0;s<n.length-1;s++){let a=n[s];o[a]||(o[a]={}),o=o[a]}o[n[n.length-1]]=F(e[r])}return t}var c={};T(c,{confirm:()=>Xe,dispatch:()=>Qe,downloadFile:()=>je,filterBox:()=>qe,flashNotification:()=>Ge,fold:()=>rt,foldAll:()=>st,getCurrentPage:()=>be,getCursor:()=>Ie,getSelection:()=>Ne,getText:()=>Ce,getUiOption:()=>Ze,goHistory:()=>$e,hidePanel:()=>_e,insertAtCursor:()=>ze,insertAtPos:()=>Ve,moveCursor:()=>He,navigate:()=>Fe,openCommandPalette:()=>Ue,openPageNavigator:()=>ke,openSearchPanel:()=>at,openUrl:()=>De,prompt:()=>Je,reloadPage:()=>Le,reloadSettingsAndCommands:()=>Re,reloadUI:()=>Ke,replaceRange:()=>Ye,save:()=>Me,setPage:()=>Se,setSelection:()=>Oe,setText:()=>Ee,setUiOption:()=>et,showPanel:()=>We,toggleFold:()=>ot,unfold:()=>nt,unfoldAll:()=>it,uploadFile:()=>Be,vimEx:()=>tt});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var i=globalThis.syscall;function be(){return i("editor.getCurrentPage")}function Se(e){return i("editor.setPage",e)}function Ce(){return i("editor.getText")}function Ee(e){return i("editor.setText",e)}function Ie(){return i("editor.getCursor")}function Ne(){return i("editor.getSelection")}function Oe(e,t){return i("editor.setSelection",e,t)}function Me(){return i("editor.save")}function Fe(e,t=!1,r=!1){return i("editor.navigate",e,t,r)}function ke(e="page"){return i("editor.openPageNavigator",e)}function Ue(){return i("editor.openCommandPalette")}function Le(){return i("editor.reloadPage")}function Ke(){return i("editor.reloadUI")}function Re(){return i("editor.reloadSettingsAndCommands")}function De(e,t=!1){return i("editor.openUrl",e,t)}function $e(e){return i("editor.goHistory",e)}function je(e,t){return i("editor.downloadFile",e,t)}function Be(e,t){return i("editor.uploadFile",e,t)}function Ge(e,t="info"){return i("editor.flashNotification",e,t)}function qe(e,t,r="",n=""){return i("editor.filterBox",e,t,r,n)}function We(e,t,r,n=""){return i("editor.showPanel",e,t,r,n)}function _e(e){return i("editor.hidePanel",e)}function Ve(e,t){return i("editor.insertAtPos",e,t)}function Ye(e,t,r){return i("editor.replaceRange",e,t,r)}function He(e,t=!1){return i("editor.moveCursor",e,t)}function ze(e){return i("editor.insertAtCursor",e)}function Qe(e){return i("editor.dispatch",e)}function Je(e,t=""){return i("editor.prompt",e,t)}function Xe(e){return i("editor.confirm",e)}function Ze(e){return i("editor.getUiOption",e)}function et(e,t){return i("editor.setUiOption",e,t)}function tt(e){return i("editor.vimEx",e)}function rt(){return i("editor.fold")}function nt(){return i("editor.unfold")}function ot(){return i("editor.toggleFold")}function st(){return i("editor.foldAll")}function it(){return i("editor.unfoldAll")}function at(){return i("editor.openSearchPanel")}var P={};T(P,{parseMarkdown:()=>ct});function ct(e){return i("markdown.parseMarkdown",e)}var y={};T(y,{deleteAttachment:()=>Pt,deleteFile:()=>bt,deletePage:()=>ut,getAttachmentMeta:()=>gt,getFileMeta:()=>vt,getPageMeta:()=>mt,listAttachments:()=>ht,listFiles:()=>wt,listPages:()=>lt,listPlugs:()=>ft,readAttachment:()=>yt,readFile:()=>At,readPage:()=>pt,writeAttachment:()=>xt,writeFile:()=>Tt,writePage:()=>dt});function lt(e=!1){return i("space.listPages",e)}function mt(e){return i("space.getPageMeta",e)}function pt(e){return i("space.readPage",e)}function dt(e,t){return i("space.writePage",e,t)}function ut(e){return i("space.deletePage",e)}function ft(){return i("space.listPlugs")}function ht(){return i("space.listAttachments")}function gt(e){return i("space.getAttachmentMeta",e)}function yt(e){return i("space.readAttachment",e)}function xt(e,t){return i("space.writeAttachment",e,t)}function Pt(e){return i("space.deleteAttachment",e)}function wt(){return i("space.listFiles")}function At(e){return i("space.readFile",e)}function vt(e){return i("space.getFileMeta",e)}function Tt(e,t){return i("space.writeFile",e,t)}function bt(e){return i("space.deleteFile",e)}var k={};T(k,{getEnv:()=>Ot,getMode:()=>Mt,getVersion:()=>Ft,invokeCommand:()=>Ct,invokeFunction:()=>St,listCommands:()=>Et,listSyscalls:()=>It,reloadPlugs:()=>Nt});function St(e,...t){return i("system.invokeFunction",e,...t)}function Ct(e,t){return i("system.invokeCommand",e,t)}function Et(){return i("system.listCommands")}function It(){return i("system.listSyscalls")}function Nt(){i("system.reloadPlugs")}function Ot(){return i("system.getEnv")}function Mt(){return i("system.getMode")}function Ft(){return i("system.getVersion")}var I={};T(I,{parseTemplate:()=>Dt,renderTemplate:()=>Rt});function Rt(e,t,r={}){return i("template.renderTemplate",e,t,r)}function Dt(e){return i("template.parseTemplate",e)}var h={};T(h,{parse:()=>qt,stringify:()=>Wt});function qt(e){return i("yaml.parse",e)}function Wt(e){return i("yaml.stringify",e)}async function S(e,t={}){let r={tags:[]},n=[];return B(e),await q(e,async o=>{if(o.type==="Paragraph"&&o.parent?.type==="Document"){let s=!0,a=new Set;for(let l of o.children)if(l.text){if(l.text.startsWith(`
`)&&l.text!==`
`)break;if(l.text.trim()){s=!1;break}}else if(l.type==="Hashtag"){let m=l.children[0].text.substring(1);a.add(m),(t.removeTags===!0||t.removeTags?.includes(m))&&(l.children[0].text="")}else if(l.type){s=!1;break}s&&n.push(...a)}if(o.type==="FrontMatter"){let s=o.children[1].children[0],a=b(s);try{let l=await h.parse(a),m={...l};if(r={...r,...l},r.tags||(r.tags=[]),typeof r.tags=="string"&&n.push(...r.tags.split(/,\s*|\s+/)),Array.isArray(r.tags)&&n.push(...r.tags),t.removeKeys&&t.removeKeys.length>0){let p=!1;for(let f of t.removeKeys)f in m&&(delete m[f],p=!0);p&&(s.text=await h.stringify(m))}if(Object.keys(m).length===0||t.removeFrontmatterSection)return null}catch(l){console.warn("Could not parse frontmatter",l.message)}}}),r.tags=[...new Set([...n.map(o=>o.replace(/^#/,""))])],r=F(r),r}async function X(e,t){let r=null;if(await J(e,async n=>{if(n.type==="FrontMatter"){let o=n.children[1].children[0],s=b(o);try{let a="";if(typeof t=="string")a=s+t+`
`;else{let m={...await h.parse(s),...t};a=await h.stringify(m)}r={changes:{from:o.from,to:o.to,insert:a}}}catch(a){console.error("Error parsing YAML",a)}return!0}return!1}),!r){let n="";typeof t=="string"?n=t+`
`:n=await h.stringify(t),r={changes:{from:0,to:0,insert:`---
`+n+`---
`}}}return r}var Er=new TextEncoder;function Z(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let o=0;o<r;o++)n[o]=t.charCodeAt(o);return n}async function Yt(){let e=await c.getSelection(),t="";return e.from===e.to?t="":t=(await c.getText()).slice(e.from,e.to),{from:e.from,to:e.to,text:t}}async function _(){let e=await Yt(),t=await c.getText();if(e.text==="")return{from:0,to:t.length,text:t,isWholeNote:!0};let r=e.from===0&&e.to===t.length;return{...e,isWholeNote:r}}async function C(){return(await c.getText()).length}async function Ht(e,t){let r=await y.readPage(e),n=await P.parseMarkdown(r),o;return Q(n,s=>{if(s.type!=="FencedCode")return!1;let a=W(s,"CodeInfo");if(t&&!a||t&&!t.includes(a.children[0].text))return!1;let l=W(s,"CodeText");return l?(o=l.children[0].text,!0):!1}),o}async function U(e,t=["yaml"]){let r=await Ht(e,t);if(r!==void 0)try{return h.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}async function ee(e){try{let r=(await U("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}var zt="SETTINGS";async function te(e,t){try{let n=(await U(zt,["yaml"])||{})[e];return n===void 0?t:n}catch(r){if(r.message==="Not found")return t;throw r}}var v=function(e,t){if(!(this instanceof v))return new v(e,t);this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.url=e,t=t||{},this.headers=t.headers||{},this.payload=t.payload!==void 0?t.payload:"",this.method=t.method||this.payload&&"POST"||"GET",this.withCredentials=!!t.withCredentials,this.debug=!!t.debug,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=this.INITIALIZING,this.progress=0,this.chunk="",this.addEventListener=function(r,n){this.listeners[r]===void 0&&(this.listeners[r]=[]),this.listeners[r].indexOf(n)===-1&&this.listeners[r].push(n)},this.removeEventListener=function(r,n){if(this.listeners[r]!==void 0){var o=[];this.listeners[r].forEach(function(s){s!==n&&o.push(s)}),o.length===0?delete this.listeners[r]:this.listeners[r]=o}},this.dispatchEvent=function(r){if(!r)return!0;this.debug&&console.debug(r),r.source=this;var n="on"+r.type;return this.hasOwnProperty(n)&&(this[n].call(this,r),r.defaultPrevented)?!1:this.listeners[r.type]?this.listeners[r.type].every(function(o){return o(r),!r.defaultPrevented}):!0},this._setReadyState=function(r){var n=new CustomEvent("readystatechange");n.readyState=r,this.readyState=r,this.dispatchEvent(n)},this._onStreamFailure=function(r){var n=new CustomEvent("error");n.data=r.currentTarget.response,this.dispatchEvent(n),this.close()},this._onStreamAbort=function(r){this.dispatchEvent(new CustomEvent("abort")),this.close()},this._onStreamProgress=function(r){if(this.xhr){if(this.xhr.status!==200){this._onStreamFailure(r);return}this.readyState==this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));var n=this.xhr.responseText.substring(this.progress);this.progress+=n.length;var o=(this.chunk+n).split(/(\r\n\r\n|\r\r|\n\n)/g),s=o.pop();o.forEach(function(a){a.trim().length>0&&this.dispatchEvent(this._parseEventChunk(a))}.bind(this)),this.chunk=s}},this._onStreamLoaded=function(r){this._onStreamProgress(r),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""},this._parseEventChunk=function(r){if(!r||r.length===0)return null;this.debug&&console.debug(r);var n={id:null,retry:null,data:null,event:null};r.split(/\n|\r\n|\r/).forEach(function(s){var a=s.indexOf(this.FIELD_SEPARATOR),l,m;if(a>0){var p=s[a+1]===" "?2:1;l=s.substring(0,a),m=s.substring(a+p)}else if(a<0)l=s,m="";else return;l in n&&(l==="data"&&n[l]!==null?n.data+=`
`+m:n[l]=m)}.bind(this));var o=new CustomEvent(n.event||"message");return o.data=n.data||"",o.id=n.id,o},this._checkStreamClosed=function(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)},this.stream=function(){if(!this.xhr){this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(var r in this.headers)this.xhr.setRequestHeader(r,this.headers[r]);this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))},(t.start===void 0||t.start)&&this.stream()};typeof exports<"u"&&(exports.SSE=v);var E=class{name;apiKey;baseUrl;modelName;constructor(t,r,n,o){this.name=t,this.apiKey=r,this.baseUrl=n,this.modelName=o,console.log(`New AI Provider initialized: ${this.name}, Base URL: ${this.baseUrl}, Model Name: ${this.modelName}`)}async streamChatIntoEditor(t,r){let{onDataReceived:n}=t,o="\u{1F914} Thinking \u2026 ",s=r??await C();await c.insertAtPos(o,s);let a=!0,l=m=>{try{a?(c.replaceRange(s,s+o.length,m),a=!1):c.insertAtPos(m,s),s+=m.length,n&&n(m)}catch(p){console.error("Error handling chat stream data:",p),c.flashNotification("An error occurred while processing chat data.","error")}};await this.chatWithAI({...t,onDataReceived:l})}};var L=class extends E{name="OpenAI";requireAuth;constructor(t,r,n,o){super("OpenAI",t,n,r),this.requireAuth=o}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return r?await this.streamChat({messages:t,onDataReceived:n}):await this.nonStreamingChat(t)}async streamChat(t){let{messages:r,onDataReceived:n}=t;try{let o=`${this.baseUrl}/chat/completions`,s={"Content-Type":"application/json"};this.requireAuth&&(s.Authorization=`Bearer ${this.apiKey}`);let a={method:"POST",headers:s,payload:JSON.stringify({model:this.modelName,stream:!0,messages:r}),withCredentials:!1},l=new v(o,a),m="";l.addEventListener("message",function(p){try{if(p.data=="[DONE]")return l.close(),m;{let d=JSON.parse(p.data).choices[0]?.delta?.content||"";m+=d,n&&n(d)}}catch(f){console.error("Error processing message event:",f,p.data)}}),l.addEventListener("end",function(){return l.close(),m}),l.addEventListener("error",p=>{console.error("SSE error:",p),l.close()}),l.stream()}catch(o){throw console.error("Error streaming from OpenAI chat endpoint:",o),await c.flashNotification("Error streaming from OpenAI chat endpoint.","error"),o}return""}async nonStreamingChat(t){try{let r=JSON.stringify({model:this.modelName,messages:t}),n={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},o=await nativeFetch(this.baseUrl+"/chat/completions",{method:"POST",headers:n,body:r});if(!o.ok)throw console.error("http response: ",o),console.error("http response body: ",await o.json()),new Error(`HTTP error, status: ${o.status}`);let s=await o.json();if(!s||!s.choices||s.choices.length===0)throw new Error("Invalid response from OpenAI.");return s}catch(r){throw console.error("Error calling OpenAI chat endpoint:",r),await c.flashNotification("Error calling OpenAI chat endpoint.","error"),r}}};async function re(e,t,r="1024x1024",n="hd"){try{w||await N(),await c.flashNotification("Contacting DALL\xB7E, please wait...");let o=await nativeFetch(u.dallEBaseUrl+"/images/generations",{method:"POST",headers:{Authorization:`Bearer ${w}`,"Content-Type":"application/json"},body:JSON.stringify({model:"dall-e-3",prompt:e,quality:n,n:t,size:r,response_format:"b64_json"})});if(!o.ok)throw new Error(`HTTP error, status: ${o.status}`);return await o.json()}catch(o){throw console.error("Error calling DALL\xB7E image generation endpoint:",o),o}}var K=class extends E{name="Gemini";constructor(t,r){super("Gemini",t,"https://generativelanguage.googleapis.com",r)}async listModels(){let t=`${this.baseUrl}/v1beta/models?key=${this.apiKey}`;try{let r=await fetch(t);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).models||[]}catch(r){throw console.error("Failed to fetch models:",r),r}}async chatWithAI({messages:t,stream:r,onDataReceived:n}){if(r)return await this.streamChat({messages:t,onDataReceived:n});console.error("Non-streaming chat not implemented for Gemini.")}async streamChat(t){let{messages:r,onDataReceived:n}=t;try{let o=`${this.baseUrl}/v1beta/models/${this.modelName}:streamGenerateContent?key=${this.apiKey}&alt=sse`,s={"Content-Type":"application/json"},a=[],l="";r.forEach(d=>{let g="user";d.role==="system"||d.role==="user"?g="user":d.role==="assistant"&&(g="model"),g==="model"&&(a.length===0||l==="model")||(g==="user"&&l==="user"?a[a.length-1].parts[0].text+=" "+d.content:a.push({role:g,parts:[{text:d.content}]})),l=g});let m={method:"POST",headers:s,payload:JSON.stringify({contents:a}),withCredentials:!1},p=new v(o,m),f="";p.addEventListener("message",d=>{try{if(d.data=="[DONE]")return p.close(),f;if(!d.data)console.error("Received empty message from Gemini"),console.log("source: ",p);else{let g=JSON.parse(d.data),V=g.candidates[0].content.parts[0].text||g.text||"";f+=V,n&&n(V)}}catch(g){console.error("Error processing message event:",g,d.data)}}),p.addEventListener("end",()=>(p.close(),f)),p.addEventListener("error",d=>{console.error("SSE error:",d),p.close()}),p.stream()}catch(o){throw console.error("Error streaming from Gemini chat endpoint:",o),o}}};var w,u,O,x;async function A(){(!w||!x||!u)&&await N()}async function N(){let e={defaultTextModel:"gpt-3.5-turbo",openAIBaseUrl:"https://api.openai.com/v1",dallEBaseUrl:"https://api.openai.com/v1",requireAuth:!0,secretName:"OPENAI_API_KEY",provider:"OpenAI",chat:{}},t=await te("ai",{}),r={...e,...t};JSON.stringify(u)!==JSON.stringify(r)?(console.log("aiSettings updating from",u),u=r,console.log("aiSettings updated to",u)):console.log("aiSettings unchanged",u);let n=await ee(u.secretName);if(n!==w&&(w=n,console.log("silverbullet-ai API key updated")),!w){let o="AI API key is missing. Please set it in the secrets page.";throw await c.flashNotification(o,"error"),new Error(o)}if(u.provider==="OpenAI")x=new L(w,u.defaultTextModel,u.openAIBaseUrl,u.requireAuth);else if(u.provider==="Gemini")x=new K(w,u.defaultTextModel);else throw console.error(`Unsupported AI provider: ${u.provider}.`),new Error(`Unsupported AI provider: ${u.provider}. Please configure a supported provider.`);O={role:"system",content:"This is an interactive chat session with a user in a markdown-based note-taking tool called SilverBullet."},u.chat.userInformation&&(O.content+=`
The user has provided the following information about their self: ${u.chat.userInformation}`),u.chat.userInstructions&&(O.content+=`
The user has provided the following instructions for the chat, follow them as closely as possible: ${u.chat.userInstructions}`)}function ne(e){return e.split("/").slice(0,-1).join("/")}async function oe(){let t=(await c.getText()).split(`
`),r=[],n="user",o="";return t.forEach(s=>{let a=s.match(/^\*\*(\w+)\*\*:/);if(a){let l=a[1].toLowerCase();n&&n!==l&&(r.push({role:n,content:o.trim()}),o=""),n=l,o+=s.replace(/^\*\*(\w+)\*\*:/,"").trim()+`
`}else n&&(o+=s.trim()+`
`)}),o&&n&&r.push({role:n,content:o.trim()}),r}async function se(e){(e==="SETTINGS"||e==="SECRETS")&&await N()}async function ie(){await A();let e=await _(),t=await c.prompt("Please enter a prompt to send to the LLM. Selected text or the entire note will also be sent as context."),r=await c.getCurrentPage(),n=new Date,o=n.toISOString().split("T")[0],s=n.toLocaleDateString("en-US",{weekday:"long"});await x.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant.  Follow all user instructions and use the note context and note content to help follow those instructions.  Use Markdown for any formatting."},{role:"user",content:`Note Context: Today is ${s}, ${o}. The current note name is "${r}".
User Prompt: ${t}
Note Content:
${e.text}`}],stream:!0},e.to)}async function ae(){let{summary:e}=await summarizeNote();e?await c.showPanel("rhs",2,e):await c.flashNotification("No summary available.")}async function ce(){await A();let e=await c.getText(),t=await c.getCurrentPage(),n=(await x.chatWithAI({messages:[{role:"system",content:"You are an AI tagging assistant. Please provide a short list of tags, separated by spaces. Only return tags and no other content. Tags must be one word only and lowercase.  Suggest tags sparingly, do not treat them as keywords."},{role:"user",content:`Given the note titled "${t}" with the content below, please provide tags.

${e}`}],stream:!1})).choices[0].message.content.trim().replace(/,/g,"").split(/\s+/),o=await P.parseMarkdown(e),s=await S(o),a=[...new Set([...s.tags||[],...n])];s.tags=a,console.log("Current frontmatter:",s);let l=await X(o,s);console.log("updatedNoteContent",l),await c.dispatch(l),await c.flashNotification("Note tagged successfully.")}async function le(){let e=await _(),t=e.to;await x.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant in a markdown-based note tool."},{role:"user",content:e.text}],stream:!0},t)}async function me(){await A();let e=await oe();if(e.length===0){await c.flashNotification("Error: The page does not match the required format for a chat.");return}e.unshift(O);let t=await C();await c.insertAtPos(`

**assistant**: `,t),t+=17,await c.insertAtPos(`

**user**: `,t),await c.moveCursor(t+12);try{await x.streamChatIntoEditor({messages:e,stream:!0},t)}catch(r){console.error("Error streaming chat on page:",r),await c.flashNotification("Error streaming chat on page.","error")}}async function pe(){await A();try{let e=await c.prompt("Enter a prompt for DALL\xB7E:");if(!e||!e.trim()){await c.flashNotification("No prompt entered. Operation cancelled.","error");return}let t=await re(e,1);if(t&&t.data&&t.data.length>0){let r=t.data[0].b64_json,n=t.data[0].revised_prompt,o=new Uint8Array(Z(r)),s=`dall-e-${Date.now()}.png`,a=ne(await c.getCurrentPage())+"/";a==="/"&&(a=""),await y.writeAttachment(a+s,o);let l=`![${s}](${s})
*${n}*`;await c.insertAtCursor(l),await c.flashNotification("Image generated and inserted with caption successfully.")}else await c.flashNotification("Failed to generate image.","error")}catch(e){console.error("Error generating image with DALL\xB7E:",e),await c.flashNotification("Error generating image.","error")}}async function de(e,t){try{await A();let r=[];return r.push({role:"system",content:t||"You are an AI note assistant helping to render content for a note.  Please follow user instructions and keep your response short and concise."}),r.push({role:"user",content:e}),(await x.chatWithAI({messages:r,stream:!1})).choices[0].message.content}catch(r){throw console.error("Error querying OpenAI:",r),r}}var R=class{constructor(t,r={}){this.maxSize=t;this.map=new Map(Object.entries(r))}map;set(t,r,n){let o={value:r,la:Date.now()};if(n){let s=this.map.get(t);s?.expTimer&&clearTimeout(s.expTimer),o.expTimer=setTimeout(()=>{this.map.delete(t)},n)}if(this.map.size>=this.maxSize){let s=this.getOldestKey();this.map.delete(s)}this.map.set(t,o)}get(t){let r=this.map.get(t);if(r)return r.la=Date.now(),r.value}remove(t){this.map.delete(t)}toJSON(){return Object.fromEntries(this.map.entries())}getOldestKey(){let t,r;for(let[n,o]of this.map.entries())(!r||o.la<r)&&(t=n,r=o.la);return t}};var ue=new R(50);async function fe(e,t,r){if(!r)return t(e);let n=JSON.stringify(e),o=ue.get(n);if(o)return o;let s=await t(e);return ue.set(n,s,r*1e3),s}function he(e,t,r){return fe(t,()=>k.invokeFunction("index.queryObjects",e,t),r)}async function ge(e,t={},r={}){try{let n=await P.parseMarkdown(e),o=await S(n,{removeFrontmatterSection:!0,removeTags:["template"]});e=b(n).trimStart();let s;return o.frontmatter&&(typeof o.frontmatter=="string"?s=o.frontmatter:s=await h.stringify(o.frontmatter),s=await I.renderTemplate(s,t,r)),{frontmatter:o,renderedFrontmatter:s,text:await I.renderTemplate(e,t,r)}}catch(n){throw console.error("Error rendering template",n),n}}async function ye(e){let t;if(!e||!e.templatePage){let p=await he("template",{filter:["attr",["attr","aiprompt"],"description"]});t=await c.filterBox("Prompt Template",p.map(f=>{let d=f.ref.split("/").pop();return{...f,description:f.aiprompt.description||f.ref,name:f.aiprompt.displayName||d,systemPrompt:f.aiprompt.systemPrompt||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:f.aiprompt.insertAt||"cursor"}}),"Select the template to use as the prompt.  The prompt will be rendered and sent to the LLM model.")}else{console.log("selectedTemplate from slash completion: ",e);let p=await y.readPage(e.templatePage),f=await P.parseMarkdown(p),{aiprompt:d}=await S(f);console.log("templatePage from slash completion: ",p),t={ref:e.templatePage,systemPrompt:d.systemPrompt||d.system||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:d.insertAt||"cursor"}}if(!t){await c.flashNotification("No template selected");return}console.log("User selected prompt template: ",t);let r=["cursor","page-start","page-end"];if(!r.includes(t.insertAt)){console.error(`Invalid insertAt value: ${t.insertAt}. It must be one of ${r.join(", ")}`),await c.flashNotification(`Invalid insertAt value: ${t.insertAt}. Please select a valid option.`,"error");return}await A();let n,o,s;try{n=await y.readPage(t.ref),o=await c.getCurrentPage(),s=await y.getPageMeta(o)}catch(p){console.error("Error fetching template details or page metadata",p),await c.flashNotification("Error fetching template details or page metadata","error");return}let a;switch(t.insertAt){case"page-start":a=0;break;case"page-end":a=await C();break;case"frontmatter":await c.flashNotification("rendering in frontmatter not supported yet","error");break;case"modal":break;case"replace":break;case"cursor":default:a=await c.getCursor()}console.log("templatetext: ",n);let l=await ge(n,s,{page:s});console.log("Rendered template:",l);let m=[{role:"user",content:l.text}];t.systemPrompt&&m.unshift({role:"system",content:t.systemPrompt}),await x.streamChatIntoEditor({messages:m,stream:!0},a)}var xe={queryOpenAI:de,reloadConfig:se,summarizeNote:ae,callOpenAI:ie,tagNoteWithAI:ce,promptAndGenerateImage:pe,streamOpenAIWithSelectionAsPrompt:le,streamChatOnPage:me,insertAiPromptFromTemplate:ye},Pe={name:"silverbullet-ai",requiredPermissions:["fetch"],functions:{queryOpenAI:{path:"sbai.ts:queryOpenAI"},reloadConfig:{path:"sbai.ts:reloadConfig",events:["page:saved"]},summarizeNote:{path:"sbai.ts:openSummaryPanel",command:{name:"AI: Summarize Note and open summary"}},callOpenAI:{path:"sbai.ts:callOpenAIwithNote",command:{name:"AI: Call OpenAI with Note as context"}},tagNoteWithAI:{path:"sbai.ts:tagNoteWithAI",command:{name:"AI: Generate tags for note"}},promptAndGenerateImage:{path:"sbai.ts:promptAndGenerateImage",command:{name:"AI: Generate and insert image using DallE"}},streamOpenAIWithSelectionAsPrompt:{path:"sbai.ts:streamOpenAIWithSelectionAsPrompt",command:{name:"AI: Stream response with selection or note as prompt"}},streamChatOnPage:{path:"sbai.ts:streamChatOnPage",command:{name:"AI: Chat on current page",key:"Ctrl-Shift-Enter",mac:"Cmd-Shift-Enter"}},insertAiPromptFromTemplate:{path:"src/prompts.ts:insertAiPromptFromTemplate",command:{name:"AI: Execute AI Prompt from Custom Template"}}},assets:{}},Qn={manifest:Pe,functionMapping:xe};Y(xe,Pe);export{Qn as plug};
