var ln=Object.defineProperty;var D=(e,t)=>{for(var r in t)ln(e,r,{get:t[r],enumerable:!0})};var Ge=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var We=new Map,_e=0;function he(e){self.postMessage(e)}Ge&&(globalThis.syscall=async(e,...t)=>await new Promise((r,n)=>{_e++,We.set(_e,{resolve:r,reject:n}),he({type:"sys",id:_e,name:e,args:t})}));function Et(e,t){Ge&&(self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let i=e[n.name];if(!i)throw new Error(`Function not loaded: ${n.name}`);try{let o=await Promise.resolve(i(...n.args||[]));he({type:"invr",id:n.id,result:o})}catch(o){console.error("An exception was thrown as a result of invoking function",n.name,"error:",o.message),he({type:"invr",id:n.id,error:o.message})}}break;case"sysr":{let i=n.id,o=We.get(i);if(!o)throw Error("Invalid request id");We.delete(i),n.error?o.reject(new Error(n.error)):o.resolve(n.result)}break}})().catch(console.error)}),he({type:"manifest",manifest:t}))}function un(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let i=0;i<r;i++)n[i]=t.charCodeAt(i);return n}function Ct(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function dn(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),n=r.length>0?Ct(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function pn(){globalThis.fetch=async function(e,t){let r=t&&t.body?Ct(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await dn(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(n.base64Body?un(n.base64Body):null,{status:n.status,headers:n.headers})}}Ge&&pn();function Be(e){if(e.children)for(let t of e.children){if(t.parent)return;t.parent=e,Be(t)}}function mn(e,t){return ye(e,r=>r.type===t)}function ye(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...ye(n,t)];return r}async function Tt(e,t){if(await t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...await Tt(n,t)];return r}function Ye(e,t){if(e.children){let r=e.children.slice();for(let n of r){let i=t(n);if(i!==void 0){let o=e.children.indexOf(n);i?e.children.splice(o,1,i):e.children.splice(o,1)}else Ye(n,t)}}}async function He(e,t){if(e.children){let r=e.children.slice();for(let n of r){let i=await t(n);if(i!==void 0){let o=e.children.indexOf(n);i?e.children.splice(o,1,i):e.children.splice(o,1)}else await He(n,t)}}}function G(e,t){return ye(e,r=>r.type===t)[0]}function Ve(e,t){ye(e,t)}async function It(e,t){await Tt(e,t)}function $(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push($(r));return t.join("")}function ze(e,t=!0){if(mn(e,"\u26A0").length>0)throw new Error(`Parse error in: ${$(e)}`);if(e.text!==void 0)return e.text;let n=[e.type];for(let i of e.children)i.type&&!i.type.endsWith("Mark")&&n.push(ze(i,t)),i.text&&(t&&i.text.trim()||!t)&&n.push(i.text);return n}function fn(e){return e.getUTCHours()===0&&e.getUTCMinutes()===0&&e.getUTCSeconds()===0?e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"):e.toISOString()}function be(e){if(!e||typeof e!="object")return e;if(Array.isArray(e))return e.map(be);if(e instanceof Date)return fn(e);let t={};for(let r of Object.keys(e)){let n=r.split("."),i=t;for(let o=0;o<n.length-1;o++){let a=n[o];i[a]||(i[a]={}),i=i[a]}i[n[n.length-1]]=be(e[r])}return t}var m={};D(m,{confirm:()=>Wn,copyToClipboard:()=>ti,deleteLine:()=>ri,dispatch:()=>Dn,downloadFile:()=>On,filterBox:()=>jn,flashNotification:()=>Fn,fold:()=>Hn,foldAll:()=>Qn,getCurrentPage:()=>gn,getCursor:()=>xn,getSelection:()=>wn,getText:()=>yn,getUiOption:()=>Gn,goHistory:()=>Nn,hidePanel:()=>$n,insertAtCursor:()=>Kn,insertAtPos:()=>Un,moveCursor:()=>qn,navigate:()=>vn,openCommandPalette:()=>En,openPageNavigator:()=>Sn,openSearchPanel:()=>ei,openUrl:()=>Mn,prompt:()=>_n,redo:()=>Xn,reloadPage:()=>Cn,reloadSettingsAndCommands:()=>In,reloadUI:()=>Tn,replaceRange:()=>Rn,save:()=>Pn,setPage:()=>hn,setSelection:()=>An,setText:()=>bn,setUiOption:()=>Bn,showPanel:()=>Ln,toggleFold:()=>zn,undo:()=>Zn,unfold:()=>Vn,unfoldAll:()=>Jn,uploadFile:()=>kn,vimEx:()=>Yn});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var u=globalThis.syscall;function gn(){return u("editor.getCurrentPage")}function hn(e){return u("editor.setPage",e)}function yn(){return u("editor.getText")}function bn(e){return u("editor.setText",e)}function xn(){return u("editor.getCursor")}function wn(){return u("editor.getSelection")}function An(e,t){return u("editor.setSelection",e,t)}function Pn(){return u("editor.save")}function vn(e,t=!1,r=!1){return u("editor.navigate",e,t,r)}function Sn(e="page"){return u("editor.openPageNavigator",e)}function En(){return u("editor.openCommandPalette")}function Cn(){return u("editor.reloadPage")}function Tn(){return u("editor.reloadUI")}function In(){return u("editor.reloadSettingsAndCommands")}function Mn(e,t=!1){return u("editor.openUrl",e,t)}function Nn(e){return u("editor.goHistory",e)}function On(e,t){return u("editor.downloadFile",e,t)}function kn(e,t){return u("editor.uploadFile",e,t)}function Fn(e,t="info"){return u("editor.flashNotification",e,t)}function jn(e,t,r="",n=""){return u("editor.filterBox",e,t,r,n)}function Ln(e,t,r,n=""){return u("editor.showPanel",e,t,r,n)}function $n(e){return u("editor.hidePanel",e)}function Un(e,t){return u("editor.insertAtPos",e,t)}function Rn(e,t,r){return u("editor.replaceRange",e,t,r)}function qn(e,t=!1){return u("editor.moveCursor",e,t)}function Kn(e){return u("editor.insertAtCursor",e)}function Dn(e){return u("editor.dispatch",e)}function _n(e,t=""){return u("editor.prompt",e,t)}function Wn(e){return u("editor.confirm",e)}function Gn(e){return u("editor.getUiOption",e)}function Bn(e,t){return u("editor.setUiOption",e,t)}function Yn(e){return u("editor.vimEx",e)}function Hn(){return u("editor.fold")}function Vn(){return u("editor.unfold")}function zn(){return u("editor.toggleFold")}function Qn(){return u("editor.foldAll")}function Jn(){return u("editor.unfoldAll")}function Zn(){return u("editor.undo")}function Xn(){return u("editor.redo")}function ei(){return u("editor.openSearchPanel")}function ti(e){return u("editor.copyToClipboard",e)}function ri(){return u("editor.deleteLine")}var k={};D(k,{parseMarkdown:()=>ni});function ni(e){return u("markdown.parseMarkdown",e)}var F={};D(F,{deleteAttachment:()=>fi,deleteFile:()=>xi,deletePage:()=>ci,getAttachmentMeta:()=>di,getFileMeta:()=>yi,getPageMeta:()=>oi,listAttachments:()=>ui,listFiles:()=>gi,listPages:()=>ii,listPlugs:()=>li,readAttachment:()=>pi,readFile:()=>hi,readPage:()=>ai,writeAttachment:()=>mi,writeFile:()=>bi,writePage:()=>si});function ii(e=!1){return u("space.listPages",e)}function oi(e){return u("space.getPageMeta",e)}function ai(e){return u("space.readPage",e)}function si(e,t){return u("space.writePage",e,t)}function ci(e){return u("space.deletePage",e)}function li(){return u("space.listPlugs")}function ui(){return u("space.listAttachments")}function di(e){return u("space.getAttachmentMeta",e)}function pi(e){return u("space.readAttachment",e)}function mi(e,t){return u("space.writeAttachment",e,t)}function fi(e){return u("space.deleteAttachment",e)}function gi(){return u("space.listFiles")}function hi(e){return u("space.readFile",e)}function yi(e){return u("space.getFileMeta",e)}function bi(e,t){return u("space.writeFile",e,t)}function xi(e){return u("space.deleteFile",e)}var A={};D(A,{applyAttributeExtractors:()=>Ei,getEnv:()=>Ti,getMode:()=>Ii,getVersion:()=>Mi,invokeCommand:()=>Ai,invokeFunction:()=>wi,invokeSpaceFunction:()=>Si,listCommands:()=>Pi,listSyscalls:()=>vi,reloadPlugs:()=>Ci});function wi(e,...t){return u("system.invokeFunction",e,...t)}function Ai(e,t){return u("system.invokeCommand",e,t)}function Pi(){return u("system.listCommands")}function vi(){return u("system.listSyscalls")}function Si(e,...t){return u("system.invokeSpaceFunction",e,...t)}function Ei(e,t,r){return u("system.applyAttributeExtractors",e,t,r)}function Ci(){return u("system.reloadPlugs")}function Ti(){return u("system.getEnv")}function Ii(){return u("system.getMode")}function Mi(){return u("system.getVersion")}var _={};D(_,{del:()=>ki,get:()=>Oi,set:()=>Ni});function Ni(e,t){return u("clientStore.set",e,t)}function Oi(e){return u("clientStore.get",e)}function ki(e){return u("clientStore.delete",e)}var xe={};D(xe,{listLanguages:()=>$i,parseLanguage:()=>Li});function Li(e,t){return u("language.parseLanguage",e,t)}function $i(){return u("language.listLanguages")}var ee={};D(ee,{parseTemplate:()=>Ri,renderTemplate:()=>Ui});function Ui(e,t,r={}){return u("template.renderTemplate",e,t,r)}function Ri(e){return u("template.parseTemplate",e)}var z={};D(z,{dispatchEvent:()=>Di,listEvents:()=>_i});function Di(e,t,r){return new Promise((n,i)=>{let o=-1;r&&(o=setTimeout(()=>{console.log("Timeout!"),i("timeout")},r)),u("event.dispatch",e,t).then(a=>{o!==-1&&clearTimeout(o),n(a)}).catch(i)})}function _i(){return u("event.list")}var U={};D(U,{parse:()=>Gi,stringify:()=>Bi});function Gi(e){return u("yaml.parse",e)}function Bi(e){return u("yaml.stringify",e)}async function Q(e,t={}){let r={tags:[]},n=[];Be(e),await He(e,async i=>{if(i.type==="Paragraph"&&i.parent?.type==="Document"){let o=!0,a=new Set;for(let s of i.children)if(s.text){if(s.text.startsWith(`
`)&&s.text!==`
`)break;if(s.text.trim()){o=!1;break}}else if(s.type==="Hashtag"){let c=s.children[0].text.substring(1);a.add(c),(t.removeTags===!0||t.removeTags?.includes(c))&&(s.children[0].text="")}else if(s.type){o=!1;break}o&&n.push(...a)}if(i.type==="FrontMatter"){let o=i.children[1].children[0],a=$(o);try{let s=await U.parse(a),c={...s};if(r={...r,...s},r.tags||(r.tags=[]),typeof r.tags=="string"&&n.push(...r.tags.split(/,\s*|\s+/)),Array.isArray(r.tags)&&n.push(...r.tags),t.removeKeys&&t.removeKeys.length>0){let l=!1;for(let p of t.removeKeys)p in c&&(delete c[p],l=!0);l&&(o.text=await U.stringify(c))}if(Object.keys(c).length===0||t.removeFrontmatterSection)return null}catch(s){console.warn("Could not parse frontmatter",s.message)}}});try{r.tags=[...new Set([...n.map(i=>String(i).replace(/^#/,""))])]}catch(i){console.error("Error while processing tags",i)}return r=be(r),r}async function Qe(e,t){let r=null;if(await It(e,async n=>{if(n.type==="FrontMatter"){let i=n.children[1].children[0],o=$(i);try{let a="";if(typeof t=="string")a=o+t+`
`;else{let c={...await U.parse(o),...t};a=await U.stringify(c)}r={changes:{from:i.from,to:i.to,insert:a}}}catch(a){console.error("Error parsing YAML",a)}return!0}return!1}),!r){let n="";typeof t=="string"?n=t+`
`:n=await U.stringify(t),r={changes:{from:0,to:0,insert:`---
`+n+`---
`}}}return r}var we=class{constructor(t,r={}){this.maxSize=t;this.map=new Map(Object.entries(r))}map;set(t,r,n){let i={value:r,la:Date.now()};if(n){let o=this.map.get(t);o?.expTimer&&clearTimeout(o.expTimer),i.expTimer=setTimeout(()=>{this.map.delete(t)},n)}if(this.map.size>=this.maxSize){let o=this.getOldestKey();this.map.delete(o)}this.map.set(t,i)}get(t){let r=this.map.get(t);if(r)return r.la=Date.now(),r.value}remove(t){this.map.delete(t)}toJSON(){return Object.fromEntries(this.map.entries())}getOldestKey(){let t,r;for(let[n,i]of this.map.entries())(!r||i.la<r)&&(t=n,r=i.la);return t}};var Mt=new we(50);async function Nt(e,t,r){if(!r)return t(e);let n=JSON.stringify(e),i=Mt.get(n);if(i)return i;let o=await t(e);return Mt.set(n,o,r*1e3),o}function Je(e,t){return A.invokeFunction("index.indexObjects",e,t)}function te(e,t,r){return Nt(t,()=>A.invokeFunction("index.queryObjects",e,t),r)}async function Ot(e,t={},r={}){try{let n=await k.parseMarkdown(e),i=await Q(n,{removeFrontmatterSection:!0,removeTags:["template"]});e=$(n).trimStart();let o;return i.frontmatter&&(typeof i.frontmatter=="string"?o=i.frontmatter:o=await U.stringify(i.frontmatter),o=await ee.renderTemplate(o,t,r)),{frontmatter:i,renderedFrontmatter:o,text:await ee.renderTemplate(e,t,r)}}catch(n){throw console.error("Error rendering template",n),n}}async function Vi(){let e=await m.getSelection(),t="";return e.from===e.to?t="":t=(await m.getText()).slice(e.from,e.to),{from:e.from,to:e.to,text:t}}async function Ae(){let e=await Vi(),t=await m.getText();if(e.text==="")return{from:0,to:t.length,text:t,isWholeNote:!0};let r=e.from===0&&e.to===t.length;return{...e,isWholeNote:r}}async function re(){return(await m.getText()).length}async function zi(e,t){let r=await F.readPage(e),n=await k.parseMarkdown(r),i;return Ve(n,o=>{if(o.type!=="FencedCode")return!1;let a=G(o,"CodeInfo");if(t&&!a||t&&!t.includes(a.children[0].text))return!1;let s=G(o,"CodeText");return s?(i=s.children[0].text,!0):!1}),i}async function Pe(e,t=["yaml"]){let r=await zi(e,t);if(r!==void 0)try{return U.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}async function ve(e){try{let r=(await Pe("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}var Qi="SETTINGS";async function kt(e,t){try{let n=(await Pe(Qi,["yaml"])||{})[e];return n===void 0?t:n}catch(r){if(r.message==="Not found")return t;throw r}}var Se=class{apiKey;baseUrl;name;modelName;requireAuth;constructor(t,r,n,i,o=!0){this.apiKey=t,this.baseUrl=r,this.name=n,this.modelName=i,this.requireAuth=o}};var Ee=class extends Se{constructor(t,r,n){super(t,n,"DALL-E",r)}async generateImage(t){try{C||await B();let r=await nativeFetch(`${this.baseUrl}/images/generations`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.modelName,prompt:t.prompt,n:t.numImages,size:t.size,quality:t.quality,response_format:"b64_json"})});if(!r.ok)throw new Error(`HTTP error, status: ${r.status}`);let n=await r.json();if(!n||n.length===0)throw new Error("Invalid response from DALL-E.");return n}catch(r){throw console.error("Error calling DALL\xB7E image generation endpoint:",r),r}}};var J=function(e,t){if(!(this instanceof J))return new J(e,t);this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.url=e,t=t||{},this.headers=t.headers||{},this.payload=t.payload!==void 0?t.payload:"",this.method=t.method||this.payload&&"POST"||"GET",this.withCredentials=!!t.withCredentials,this.debug=!!t.debug,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=this.INITIALIZING,this.progress=0,this.chunk="",this.addEventListener=function(r,n){this.listeners[r]===void 0&&(this.listeners[r]=[]),this.listeners[r].indexOf(n)===-1&&this.listeners[r].push(n)},this.removeEventListener=function(r,n){if(this.listeners[r]!==void 0){var i=[];this.listeners[r].forEach(function(o){o!==n&&i.push(o)}),i.length===0?delete this.listeners[r]:this.listeners[r]=i}},this.dispatchEvent=function(r){if(!r)return!0;this.debug&&console.debug(r),r.source=this;var n="on"+r.type;return this.hasOwnProperty(n)&&(this[n].call(this,r),r.defaultPrevented)?!1:this.listeners[r.type]?this.listeners[r.type].every(function(i){return i(r),!r.defaultPrevented}):!0},this._setReadyState=function(r){var n=new CustomEvent("readystatechange");n.readyState=r,this.readyState=r,this.dispatchEvent(n)},this._onStreamFailure=function(r){var n=new CustomEvent("error");n.data=r.currentTarget.response,this.dispatchEvent(n),this.close()},this._onStreamAbort=function(r){this.dispatchEvent(new CustomEvent("abort")),this.close()},this._onStreamProgress=function(r){if(this.xhr){if(this.xhr.status!==200){this._onStreamFailure(r);return}this.readyState==this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));var n=this.xhr.responseText.substring(this.progress);this.progress+=n.length;var i=(this.chunk+n).split(/(\r\n\r\n|\r\r|\n\n)/g),o=i.pop();i.forEach(function(a){a.trim().length>0&&this.dispatchEvent(this._parseEventChunk(a))}.bind(this)),this.chunk=o}},this._onStreamLoaded=function(r){this._onStreamProgress(r),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""},this._parseEventChunk=function(r){if(!r||r.length===0)return null;this.debug&&console.debug(r);var n={id:null,retry:null,data:null,event:null};r.split(/\n|\r\n|\r/).forEach(function(o){var a=o.indexOf(this.FIELD_SEPARATOR),s,c;if(a>0){var l=o[a+1]===" "?2:1;s=o.substring(0,a),c=o.substring(a+l)}else if(a<0)s=o,c="";else return;s in n&&(s==="data"&&n[s]!==null?n.data+=`
`+c:n[s]=c)}.bind(this));var i=new CustomEvent(n.event||"message");return i.data=n.data||"",i.id=n.id,i},this._checkStreamClosed=function(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)},this.stream=function(){if(!this.xhr){this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(var r in this.headers)this.xhr.setRequestHeader(r,this.headers[r]);this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))},(t.start===void 0||t.start)&&this.stream()};typeof exports<"u"&&(exports.SSE=J);var Ft={};function Ce(e,t){Ft[e]=t}function Te(e){return Ft[e]}async function Ie(...e){let t=e.join(""),r=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(n)).map(a=>a.toString(16).padStart(2,"0")).join("")}var Y=class{apiKey;baseUrl;name;modelName;requireAuth;constructor(t,r,n,i,o=!0){this.apiKey=t,this.baseUrl=r,this.name=n,this.modelName=i,this.requireAuth=o}async generateEmbeddings(t){let r=await Ie(this.modelName,t.text),n=Te(r);if(n)return n;let i=await this._generateEmbeddings(t);return Ce(r,i),i}};var Lt=/@(\d+)$/,$t=/\$([a-zA-Z\.\-\/]+[\w\.\-\/]*)$/,Ut=/#([^#]*)$/;function Rt(e){e.startsWith("[[")&&e.endsWith("]]")&&(e=e.slice(2,-2));let t={page:e},r=t.page.match(Lt);r&&(t.pos=parseInt(r[1]),t.page=t.page.replace(Lt,""));let n=t.page.match($t);n&&(t.anchor=n[1],t.page=t.page.replace($t,""));let i=t.page.match(Ut);return i&&(t.header=i[1],t.page=t.page.replace(Ut,"")),t}function qt(e){return Ye(e,t=>{switch(t.type){case"FrontMatter":return null;case"WikiLink":{let r=G(t,"WikiLinkPage").children[0].text,n=r.split("/").pop(),i=G(t,"WikiLinkAlias");i&&(n=i.children[0].text);let o=Rt(r);return{text:`[${n}](${typeof location<"u"?location.origin:""}/${encodeURI(o.page)})`}}case"NamedAnchor":return null;case"CommandLink":{let n=t.children[1].children[0].text,i=G(t,"CommandLinkAlias");return i&&(n=i.children[0].text),{text:"`"+n+"`"}}case"Attribute":return null}}),e}var Ze="\u{1F916} ";async function Dt({name:e,tree:t}){if(await A.getEnv()!=="server")return;await T();let r=["SETTINGS","SECRETS",...f.indexEmbeddingsExcludePages];if(!f.indexEmbeddings||r.includes(e)||e.startsWith("_")||e.startsWith("Library/")||/\.conflicted\.\d+$/.test(e)||!t.children)return;let n=t.children.filter(o=>o.type==="Paragraph"),i=[];for(let o of n){let a=$(o).trim();if(!a||a.length<10||f.indexEmbeddingsExcludeStrings.some(p=>a.includes(p)))continue;let s=await q.generateEmbeddings({text:a}),c=o.from??0,l={ref:`${e}@${c}`,page:e,pos:c,embedding:s,text:a,tag:"embedding"};i.push(l)}await Je(e,i),N("any",`AI: Indexed ${i.length} embedding objects for page ${e}`)}async function _t({name:e,tree:t}){if(await A.getEnv()!=="server")return;await T();let r=["SETTINGS","SECRETS",...f.indexEmbeddingsExcludePages];if(!f.indexEmbeddings||!f.indexSummary||r.includes(e)||e.startsWith("_")||!t.children)return;let n=$(t),i=f.textModels.find(d=>d.name===f.indexSummaryModelName);if(!i)throw new Error(`Could not find summary model ${f.indexSummaryModelName}`);let o=await ce(i),a;f.promptInstructions.indexSummaryPrompt!==""?a=f.promptInstructions.indexSummaryPrompt:a=`Provide a concise and informative summary of the above page. The summary should capture the key points and be useful for search purposes. Avoid any formatting or extraneous text.  No more than one paragraph.  Summary:
`;let s=await Ie(i.name,n,a),c=Te(s);c||(c=await o.singleMessageChat("Contents of "+e+`:
`+n+`

`+a),Ce(s,c));let l=await q.generateEmbeddings({text:c}),p={ref:`${e}@0`,page:e,embedding:l,text:c,tag:"aiSummary"};await Je(e,[p]),N("any",`AI: Indexed summary for page ${e}`)}async function Xe(){return await te("embedding",{})}async function Ji(){return await te("aiSummary",{})}function Kt(e,t){let r=e.reduce((o,a,s)=>o+a*t[s],0),n=Math.sqrt(e.reduce((o,a)=>o+a*a,0)),i=Math.sqrt(t.reduce((o,a)=>o+a*a,0));return r/(n*i)}async function et(e,t=10){await T();let r=typeof e=="string"?await q.generateEmbeddings({text:e}):e,n=await Xe();console.log("Received embeddings:",n.length),console.log("In env:",await A.getEnv());let i=n.map(o=>({page:o.page,ref:o.ref,text:o.text,similarity:Kt(r,o.embedding)}));if(f.indexSummary){let a=(await Ji()).map(s=>({page:s.page,ref:s.ref,text:`Page Summary: ${s.text}`,similarity:Kt(r,s.embedding)}));i.push(...a)}return i.sort((o,a)=>a.similarity-o.similarity).slice(0,t)}async function Me(e,t=10,r=.15){let n;await Vt()?n=await syscall("system.invokeFunctionOnServer","silverbullet-ai.searchEmbeddings",e,-1):(console.log("system.invokeFunctionOnServer not supported."),n=await et(e,-1));let i={};for(let a of n)a.similarity<r||(i[a.page]?(i[a.page].score+=a.similarity,i[a.page].children.push(a)):i[a.page]={page:a.page,score:a.similarity,children:[a]});for(let a in i)i[a].children=i[a].children.sort((s,c)=>c.similarity-s.similarity).slice(0,t);return Object.values(i).sort((a,s)=>s.score-a.score).slice(0,t)}async function Wt(){let e=await m.prompt("Enter some text to search for:");if(!e){await m.flashNotification("No text entered.","error");return}let t=await Me(e);await m.flashNotification(`Found ${t.length} results`),N("any","AI: Search results",t)}function Gt(e){return{data:new TextEncoder().encode(""),meta:{name:e,contentType:"text/markdown",size:0,created:0,lastModified:0,perm:"ro"}}}function tt(e){return{name:e,contentType:"text/markdown",size:-1,created:0,lastModified:0,perm:"ro"}}function Bt(e){return tt(e)}async function Yt(){let e=await m.getCurrentPage();if(e.startsWith(Ze)){await T();let t=e.substring(Ze.length),r=`# Search results for "${t}"`,n=r+`

`;if(!f.indexEmbeddings){n+=`> **warning** Embeddings generation is disabled.
`,n+=`> You can enable it in the AI settings.


`,await m.setText(n);return}let i=`${r}

Searching for "${t}"...`;i+=`
Generating query vector embeddings..`,await m.setText(i);let o=await q.generateEmbeddings({text:t}),a=await Me(o),s=i.length;n=r+`

`,a.length===0&&(n+=`No results found.

`);for(let c of a){n+=`## [[${c.page}]]
`;for(let l of c.children){let p=l.ref.split("@")[1];n+=`> [[${l.ref}|${p}]] | ${l.text}
`}}await m.replaceRange(0,s,n)}}async function Ht(){let e=await m.prompt("Search for: ");e&&await m.navigate({page:`${Ze}${e}`})}function zt(e){return e.split("/").slice(0,-1).join("/")}async function N(e,...t){(await A.getEnv()===e||e==="any")&&console.log(...t)}async function Qt(){let t=(await m.getText()).split(`
`),r=[],n="user",i="";return t.forEach(o=>{if(o.trim()==="")return;let a=o.match(/^\*\*(\w+)\*\*:/);if(a){let s=a[1].toLowerCase();n&&n!==s&&i.trim()!==""&&(r.push({role:n,content:i.trim()}),i=""),n=s,i+=o.replace(/^\*\*(\w+)\*\*:/,"").trim()+`
`}else n&&(i+=o.trim()+`
`)}),i&&n&&r.push({role:n,content:i.trim()}),r}async function Jt(){try{let e=await syscall("system.getVersion"),[t,r,n]=e.split(".").map(Number),[i,o,a]="0.7.2".split(".").map(Number);return t>i||t===i&&r>o||t===i&&r===o&&n>=a}catch{return!1}}async function Vt(){try{return(await A.listSyscalls()).some(t=>t.name==="system.invokeFunctionOnServer")}catch{return!1}}async function Ne(e){let t=[];for(let r of e){let n=r.content;if(r.role==="assistant"){t.push(r);continue}if(f.chat.searchEmbeddings&&f.indexEmbeddings){let s=await Me(n);if(s.length>0){n+=`

The following pages were found to be relevant to the question. You can use them as context to answer the question.
`;for(let c of s)n+=`* [[${c.page}]] (similarity score ${c.score})
`}}if(f.chat.parseWikiLinks&&(n=await Zi(n)),f.chat.bakeMessages){let s=await k.parseMarkdown(n),c=await A.invokeFunction("markdown.expandCodeWidgets",s,"");n=$(qt(c)).trim()}let o=(await z.dispatchEvent("ai:enrichMessage",{enrichedContent:n,message:r})).flat().concat(f.chat.customEnrichFunctions),a=[...new Set(o)];console.log("Received custom enrich message functions",a);for(let s of a)n=await A.invokeSpaceFunction(s,n);t.push({...r,content:n})}return t}async function Zi(e){let t=[],r=e,n=/\[\[([^\]]+)\]\]/g,i,o=!1;for(;(i=n.exec(e))!==null;){let a=i[1];if(!t.includes(a)){o||(r+=`

Base your answer on the content of the following referenced pages (referenced above using the >>page name<< format). In these listings ~~~ is used to mark the page's content start and end. If context is missing, always ask me to link directly to a page mentioned in the context.`,o=!0);try{let s=await F.readPage(a);t.push(a),r+=`

Content of the [[${a}]] page:
~~~
${s}
~~~
`}catch(s){console.error(`Error fetching page '${a}':`,s)}}}return r=r.replace(n,">>$1<<"),r}var ne=class{name;apiKey;baseUrl;modelName;constructor(t,r,n,i){this.name=t,this.apiKey=r,this.baseUrl=n,this.modelName=i}async streamChatIntoEditor(t,r){let{onDataReceived:n}=t,i="\u{1F914} Thinking \u2026 ",o=r??await re();await m.insertAtPos(i,o);let a=!0,s=c=>{try{if(!c){console.log("No data received from LLM");return}a?(["`","-","*"].includes(c.charAt(0))&&(console.log("First character of response is:",c.charAt(0)),c=`
`+c),m.replaceRange(o,o+i.length,c),a=!1):m.insertAtPos(c,o),o+=c.length,n&&n(c)}catch(l){console.error("Error handling chat stream data:",l),m.flashNotification("An error occurred while processing chat data.","error")}};await this.chatWithAI({...t,onDataReceived:s})}async singleMessageChat(t,r,n=!1){let i=[{role:"user",content:t}];return r&&i.unshift({role:"system",content:r}),n&&(i=await Ne(i)),await this.chatWithAI({messages:i,stream:!1})}};var Oe=class extends ne{name="Gemini";constructor(t,r){super("Gemini",t,"https://generativelanguage.googleapis.com",r)}async listModels(){let t=`${this.baseUrl}/v1beta/models?key=${this.apiKey}`;try{let r=await fetch(t);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).models||[]}catch(r){throw console.error("Failed to fetch models:",r),r}}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return r?await this.streamChat({messages:t,stream:r,onDataReceived:n}):await this.nonStreamingChat(t)}mapRolesForGemini(t){let r=[],n="";return t.forEach(i=>{let o="user";i.role==="system"||i.role==="user"?o="user":i.role==="assistant"&&(o="model"),o==="model"&&(r.length===0||n==="model")||(o==="user"&&n==="user"?r[r.length-1].parts[0].text+=" "+i.content:r.push({role:o,parts:[{text:i.content}]})),n=o}),r}streamChat(t){let{messages:r,onDataReceived:n}=t;try{let i=`${this.baseUrl}/v1beta/models/${this.modelName}:streamGenerateContent?key=${this.apiKey}&alt=sse`,o={"Content-Type":"application/json"},a=this.mapRolesForGemini(r),s={method:"POST",headers:o,payload:JSON.stringify({contents:a}),withCredentials:!1},c=new J(i,s),l="";c.addEventListener("message",p=>{try{if(p.data=="[DONE]")return c.close(),l;if(!p.data)console.error("Received empty message from Gemini"),console.log("source: ",c);else{let d=JSON.parse(p.data),h=d.candidates[0].content.parts[0].text||d.text||"";l+=h,n&&n(h)}}catch(d){console.error("Error processing message event:",d,p.data)}}),c.addEventListener("end",()=>(c.close(),l)),c.addEventListener("error",p=>{console.error("SSE error:",p),c.close()}),c.stream()}catch(i){throw console.error("Error streaming from Gemini chat endpoint:",i),i}}async nonStreamingChat(t){let r=this.mapRolesForGemini(t),n=await nativeFetch(`${this.baseUrl}/v1beta/models/${this.modelName}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).candidates[0].content.parts[0].text}},ke=class extends Y{constructor(t,r,n="https://generativelanguage.googleapis.com",i=!0){super(t,n,"Gemini",r,i)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,content:{parts:[{text:t.text}]}}),n={"Content-Type":"application/json"};this.requireAuth&&(n.Authorization=`Bearer ${this.apiKey}`);let i=await nativeFetch(`${this.baseUrl}/v1beta/models/${this.modelName}:embedContent?key=${this.apiKey}`,{method:"POST",headers:n,body:r});if(!i.ok)throw console.error("HTTP response: ",i),console.error("HTTP response body: ",await i.json()),new Error(`HTTP error, status: ${i.status}`);let o=await i.json();if(!o||!o.embedding||!o.embedding.values)throw new Error("Invalid response from Gemini.");return o.embedding.values}};var Fe=class extends ne{name="OpenAI";requireAuth;constructor(t,r,n,i){super("OpenAI",t,n,r),this.requireAuth=i}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return r?await this.streamChat({messages:t,onDataReceived:n}):await this.nonStreamingChat(t)}async streamChat(t){let{messages:r,onDataReceived:n}=t;try{let i=`${this.baseUrl}/chat/completions`,o={"Content-Type":"application/json"};this.requireAuth&&(o.Authorization=`Bearer ${this.apiKey}`);let a={method:"POST",headers:o,payload:JSON.stringify({model:this.modelName,stream:!0,messages:r}),withCredentials:!1},s=new J(i,a),c="";s.addEventListener("message",function(l){try{if(l.data=="[DONE]")return s.close(),c;{let d=JSON.parse(l.data).choices[0]?.delta?.content||"";c+=d,n&&n(d)}}catch(p){console.error("Error processing message event:",p,l.data)}}),s.addEventListener("end",function(){return s.close(),c}),s.addEventListener("error",l=>{console.error("SSE error:",l),s.close()}),s.stream()}catch(i){throw console.error("Error streaming from OpenAI chat endpoint:",i),await m.flashNotification("Error streaming from OpenAI chat endpoint.","error"),i}return""}async nonStreamingChat(t){try{let r=JSON.stringify({model:this.modelName,messages:t}),n={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},i=await nativeFetch(this.baseUrl+"/chat/completions",{method:"POST",headers:n,body:r});if(!i.ok)throw console.error("http response: ",i),console.error("http response body: ",await i.json()),new Error(`HTTP error, status: ${i.status}`);let o=await i.json();if(!o||!o.choices||o.choices.length===0)throw new Error("Invalid response from OpenAI.");return o.choices[0].message.content}catch(r){throw console.error("Error calling OpenAI chat endpoint:",r),await m.flashNotification("Error calling OpenAI chat endpoint.","error"),r}}},je=class extends Y{constructor(t,r,n,i=!0){super(t,n,"OpenAI",r,i)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,input:t.text,encoding_format:"float"}),n={"Content-Type":"application/json"};this.requireAuth&&(n.Authorization=`Bearer ${this.apiKey}`);let i=await nativeFetch(`${this.baseUrl}/embeddings`,{method:"POST",headers:n,body:r});if(!i.ok)throw console.error("HTTP response: ",i),console.error("HTTP response body: ",await i.json()),new Error(`HTTP error, status: ${i.status}`);let o=await i.json();if(!o||!o.data||o.data.length===0)throw new Error("Invalid response from OpenAI.");return o.data[0].embedding}};var Le=class extends Y{constructor(t,r,n,i=!1){super(t,n,"Ollama",r,i)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,prompt:t.text}),n={"Content-Type":"application/json"};this.requireAuth&&(n.Authorization=`Bearer ${this.apiKey}`);let i=await nativeFetch(`${this.baseUrl}/api/embeddings`,{method:"POST",headers:n,body:r});if(!i.ok)throw console.error("HTTP response: ",i),console.error("HTTP response body: ",await i.json()),new Error(`HTTP error, status: ${i.status}`);let o=await i.json();if(!o||!o.embedding||o.embedding.length===0)throw new Error("Invalid response from Ollama.");return o.embedding}};var C,f,le,O,nt,q,rt,Xi,eo;async function T(){let e=await Zt();(!C||!O||!f||!rt||JSON.stringify(e)!==JSON.stringify(rt))&&await B(!0)}async function Zt(){if(await A.getEnv()=="client")try{return await _.get("ai.selectedTextModel")}catch{return}}async function to(){if(await A.getEnv()=="client")try{return await _.get("ai.selectedImageModel")}catch{return}}async function ro(){if(await A.getEnv()=="client")try{return await _.get("ai.selectedEmbeddingModel")}catch{return}}async function it(e){await A.getEnv()=="client"&&await _.set("ai.selectedImageModel",e)}async function ot(e){await A.getEnv()=="client"&&await _.set("ai.selectedTextModel",e)}async function at(e){await A.getEnv()=="client"&&await _.set("ai.selectedEmbeddingModel",e)}async function no(){let e=await Zt()||f.textModels[0];if(!e)throw new Error("No text model selected or available as default.");await ce(e)}async function io(){let e=await to()||f.imageModels[0];if(!e)throw new Error("No image model selected or available as default.");await st(e)}async function oo(){let e=await ro()||f.embeddingModels[0];if(!e)throw new Error("No embedding model selected or available as default.");await ct(e)}function ao(e){let t=e.provider.toLowerCase();switch(N("client","Provider name",t),t){case"dalle":nt=new Ee(C,e.modelName,e.baseUrl||f.dallEBaseUrl);break;default:throw new Error(`Unsupported image provider: ${e.provider}. Please configure a supported provider.`)}}function so(e){switch(e.provider.toLowerCase()){case"openai":O=new Fe(C,e.modelName,e.baseUrl||f.openAIBaseUrl,e.requireAuth||f.requireAuth);break;case"gemini":O=new Oe(C,e.modelName);break;default:throw new Error(`Unsupported AI provider: ${e.provider}. Please configure a supported provider.`)}return O}function co(e){switch(e.provider.toLowerCase()){case"openai":q=new je(C,e.modelName,e.baseUrl||f.openAIBaseUrl);break;case"gemini":q=new ke(C,e.modelName);break;case"ollama":q=new Le(C,e.modelName,e.baseUrl||"http://localhost:11434",e.requireAuth);break;default:throw new Error(`Unsupported embedding provider: ${e.provider}. Please configure a supported provider.`)}}async function ce(e){if(N("client","configureSelectedModel called with:",e),!e)throw new Error("No model provided to configure");if(e.requireAuth=e.requireAuth??f.requireAuth,e.requireAuth){let t=await ve(e.secretName||"OPENAI_API_KEY");t!==C&&(C=t,N("client","API key updated"))}if(e.requireAuth&&!C)throw new Error("AI API key is missing. Please set it in the secrets page.");return rt=e,so(e)}async function st(e){if(N("client","configureSelectedImageModel called with:",e),!e)throw new Error("No image model provided to configure");if(e.requireAuth){let t=await ve(e.secretName||"OPENAI_API_KEY");t!==C&&(C=t,N("client","API key updated for image model"))}if(e.requireAuth&&!C)throw new Error("AI API key is missing for image model. Please set it in the secrets page.");Xi=e,ao(e)}async function ct(e){if(N("client","configureSelectedEmbeddingModel called with:",e),!e)throw new Error("No embedding model provided to configure");if(e.requireAuth){let t=await ve(e.secretName||"OPENAI_API_KEY");t!==C&&(C=t,N("client","API key updated for embedding model"))}if(e.requireAuth&&!C)throw new Error("AI API key is missing for embedding model. Please set it in the secrets page.");eo=e,co(e)}async function lo(){let e={openAIBaseUrl:"https://api.openai.com/v1",dallEBaseUrl:"https://api.openai.com/v1",requireAuth:!0,secretName:"OPENAI_API_KEY",provider:"OpenAI",chat:{},promptInstructions:{},imageModels:[],embeddingModels:[],textModels:[],indexEmbeddings:!1,indexSummary:!1,indexSummaryModelName:"",indexEmbeddingsExcludePages:[],indexEmbeddingsExcludeStrings:["**user**:"]},t={userInformation:"",userInstructions:"",parseWikiLinks:!0,bakeMessages:!0,customEnrichFunctions:[],searchEmbeddings:!0},r={pageRenameSystem:"",pageRenameRules:"",tagRules:"",indexSummaryPrompt:"",enhanceFrontMatterPrompt:""},n=await kt("ai",{}),i={...e,...n};return i.chat={...t,...n.chat||{}},i.promptInstructions={...r,...n.promptInstructions||{}},i}async function B(e=!0){let t=await lo();!f||JSON.stringify(f)!==JSON.stringify(t)?(N("client","aiSettings updating from",f),f=t,N("client","aiSettings updated to",f)):N("client","aiSettings unchanged",f),f.textModels.length===1&&await ot(f.textModels[0]),f.imageModels.length===1&&await it(f.imageModels[0]),f.embeddingModels.length===1&&await at(f.embeddingModels[0]),e&&(f.textModels.length>0&&await no(),f.imageModels.length>0&&await io(),f.embeddingModels.length>0&&await oo()),le={role:"system",content:"This is an interactive chat session with a user in a markdown-based note-taking tool called SilverBullet."},f.chat.userInformation&&(le.content+=`
The user has provided the following information about themselves: ${f.chat.userInformation}`),f.chat.userInstructions&&(le.content+=`
The user has provided the following instructions for the chat, follow them as closely as possible: ${f.chat.userInstructions}`)}async function Xt(e){return Jt()?{options:(await te("template",{filter:["attr",["attr","aiprompt"],"slashCommand"]},5)).map(r=>{let n=r.aiprompt;return console.log("ai prompt template: ",n),{label:n.slashCommand,detail:n.description||r.description,order:n.order||0,templatePage:r.ref,pageName:e.pageName,invoke:"silverbullet-ai.insertAiPromptFromTemplate"}})}:void 0}async function er(e){let t;if(!e||!e.templatePage){let l=await te("template",{filter:["attr",["attr","aiprompt"],"description"]});t=await m.filterBox("Prompt Template",l.map(p=>{let d=p.ref.split("/").pop();return{...p,description:p.aiprompt.description||p.ref,name:p.aiprompt.displayName||d,systemPrompt:p.aiprompt.systemPrompt||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:p.aiprompt.insertAt||"cursor"}}),"Select the template to use as the prompt.  The prompt will be rendered and sent to the LLM model.")}else{console.log("selectedTemplate from slash completion: ",e);let l=await F.readPage(e.templatePage),p=await k.parseMarkdown(l),{aiprompt:d}=await Q(p);console.log("templatePage from slash completion: ",l),t={ref:e.templatePage,systemPrompt:d.systemPrompt||d.system||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:d.insertAt||"cursor"}}if(!t){await m.flashNotification("No template selected");return}console.log("User selected prompt template: ",t);let r=["cursor","page-start","page-end"];if(!r.includes(t.insertAt)){console.error(`Invalid insertAt value: ${t.insertAt}. It must be one of ${r.join(", ")}`),await m.flashNotification(`Invalid insertAt value: ${t.insertAt}. Please select a valid option.`,"error");return}await T();let n,i,o;try{n=await F.readPage(t.ref),i=await m.getCurrentPage(),o=await F.getPageMeta(i)}catch(l){console.error("Error fetching template details or page metadata",l),await m.flashNotification("Error fetching template details or page metadata","error");return}let a;switch(t.insertAt){case"page-start":a=0;break;case"page-end":a=await re();break;case"frontmatter":await m.flashNotification("rendering in frontmatter not supported yet","error");break;case"modal":break;case"replace":break;case"cursor":default:a=await m.getCursor()}console.log("templatetext: ",n);let s=await Ot(n,o,{page:o});console.log("Rendered template:",s);let c=[{role:"user",content:s.text}];t.systemPrompt&&c.unshift({role:"system",content:t.systemPrompt}),await O.streamChatIntoEditor({messages:c,stream:!0},a)}function tr(e){let t={querySource:""},[r,n,...i]=e;if(r!=="Query")throw new Error(`Expected query type, got ${r}`);t.querySource=n[1];for(let o of i){let[a]=o;switch(a){case"WhereClause":{t.filter?t.filter=["and",t.filter,v(o[2])]:t.filter=v(o[2]);break}case"OrderClause":{t.orderBy||(t.orderBy=[]);for(let s of o.slice(2))if(s[0]==="OrderBy"){let c=s[1][1];s[2]?t.orderBy.push({expr:v(c),desc:s[2][1][1]==="desc"}):t.orderBy.push({expr:v(c),desc:!1})}break}case"LimitClause":{t.limit=v(o[2][1]);break}case"SelectClause":{for(let s of o.slice(2))s[0]==="Select"&&(t.select||(t.select=[]),s.length===2?t.select.push({name:ue(s[1][1])}):t.select.push({name:ue(s[3][1]),expr:v(s[1])}));break}case"RenderClause":{let s=o.find(c=>c[0]==="PageRef");t.render=s[1].slice(2,-2),t.renderAll=!!o.find(c=>c[0]==="all");break}default:throw new Error(`Unknown clause type: ${a}`)}}return t}function ue(e){return e.startsWith("`")&&e.endsWith("`")?e.slice(1,-1):e}function v(e){if(["LVal","Expression","Value"].includes(e[0]))return v(e[1]);switch(e[0]){case"Attribute":return["attr",v(e[1]),ue(e[3][1])];case"Identifier":return["attr",ue(e[1])];case"String":return["string",e[1].slice(1,-1)];case"Number":return["number",+e[1]];case"Bool":return["boolean",e[1][1]==="true"];case"null":return["null"];case"Regex":return["regexp",e[1].slice(1,-1),"i"];case"List":{let t=[];for(let r of e.slice(2))r[0]==="Expression"&&t.push(r);return["array",t.map(v)]}case"Object":{let t=[];for(let r of e.slice(2)){if(typeof r=="string")continue;let[n,i,o,a]=r;t.push([i[1].slice(1,-1),v(a)])}return["object",t]}case"BinExpression":{let t=v(e[1]),r=e[2][0]==="InKW"?"in":e[2].trim(),n=v(e[3]);return[r,t,n]}case"LogicalExpression":{let t=v(e[1]),r=e[2],n=v(e[3]);return[r[1],t,n]}case"ParenthesizedExpression":return v(e[2]);case"Call":{let t=ue(e[1][1]),r=[];for(let n of e.slice(2))n[0]==="Expression"&&r.push(n);return["call",t,r.map(v)]}case"UnaryExpression":{if(e[1][0]==="NotKW"||e[1][0]==="!")return["not",v(e[2])];if(e[1][0]==="-")return["-",v(e[2])];throw new Error(`Unknown unary expression: ${e[1][0]}`)}case"TopLevelVal":return["attr"];case"GlobalIdentifier":return["global",e[1].substring(1)];case"TernaryExpression":{let[t,r,n,i,o,a]=e;return["?",v(r),v(i),v(a)]}case"QueryExpression":return["query",tr(e[2])];case"PageRef":return["pageref",e[1].slice(2,-2)];default:throw new Error(`Not supported: ${e[0]}`)}}async function rr(e){let t=ze(await xe.parseLanguage("query",e));return tr(t[1])}async function nr(e,t){let r=await rr(e);return uo(r,t)}async function uo(e,t){e.limit||(e.limit=["number",1e3]);let r=`query:${e.querySource}`,n={query:e};t&&(n.variables=t);let i=await z.dispatchEvent(r,n,30*1e3);if(i.length===0)throw new Error(`Unsupported query source '${e.querySource}'`);return i.flat()}var ou=new TextEncoder;function ir(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let i=0;i<r;i++)n[i]=t.charCodeAt(i);return n}function wr(e){return typeof e>"u"||e===null}function po(e){return typeof e=="object"&&e!==null}function mo(e){return Array.isArray(e)?e:wr(e)?[]:[e]}function fo(e,t){var r,n,i,o;if(t)for(o=Object.keys(t),r=0,n=o.length;r<n;r+=1)i=o[r],e[i]=t[i];return e}function go(e,t){var r="",n;for(n=0;n<t;n+=1)r+=e;return r}function ho(e){return e===0&&Number.NEGATIVE_INFINITY===1/e}var yo=wr,bo=po,xo=mo,wo=go,Ao=ho,Po=fo,E={isNothing:yo,isObject:bo,toArray:xo,repeat:wo,isNegativeZero:Ao,extend:Po};function Ar(e,t){var r="",n=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(r+='in "'+e.mark.name+'" '),r+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!t&&e.mark.snippet&&(r+=`

`+e.mark.snippet),n+" "+r):n}function pe(e,t){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=t,this.message=Ar(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}pe.prototype=Object.create(Error.prototype);pe.prototype.constructor=pe;pe.prototype.toString=function(e){return this.name+": "+Ar(this,e)};var j=pe;function lt(e,t,r,n,i){var o="",a="",s=Math.floor(i/2)-1;return n-t>s&&(o=" ... ",t=n-s+o.length),r-n>s&&(a=" ...",r=n+s-a.length),{str:o+e.slice(t,r).replace(/\t/g,"\u2192")+a,pos:n-t+o.length}}function ut(e,t){return E.repeat(" ",t-e.length)+e}function vo(e,t){if(t=Object.create(t||null),!e.buffer)return null;t.maxLength||(t.maxLength=79),typeof t.indent!="number"&&(t.indent=1),typeof t.linesBefore!="number"&&(t.linesBefore=3),typeof t.linesAfter!="number"&&(t.linesAfter=2);for(var r=/\r?\n|\r|\0/g,n=[0],i=[],o,a=-1;o=r.exec(e.buffer);)i.push(o.index),n.push(o.index+o[0].length),e.position<=o.index&&a<0&&(a=n.length-2);a<0&&(a=n.length-1);var s="",c,l,p=Math.min(e.line+t.linesAfter,i.length).toString().length,d=t.maxLength-(t.indent+p+3);for(c=1;c<=t.linesBefore&&!(a-c<0);c++)l=lt(e.buffer,n[a-c],i[a-c],e.position-(n[a]-n[a-c]),d),s=E.repeat(" ",t.indent)+ut((e.line-c+1).toString(),p)+" | "+l.str+`
`+s;for(l=lt(e.buffer,n[a],i[a],e.position,d),s+=E.repeat(" ",t.indent)+ut((e.line+1).toString(),p)+" | "+l.str+`
`,s+=E.repeat("-",t.indent+p+3+l.pos)+`^
`,c=1;c<=t.linesAfter&&!(a+c>=i.length);c++)l=lt(e.buffer,n[a+c],i[a+c],e.position-(n[a]-n[a+c]),d),s+=E.repeat(" ",t.indent)+ut((e.line+c+1).toString(),p)+" | "+l.str+`
`;return s.replace(/\n$/,"")}var So=vo,Eo=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],Co=["scalar","sequence","mapping"];function To(e){var t={};return e!==null&&Object.keys(e).forEach(function(r){e[r].forEach(function(n){t[String(n)]=r})}),t}function Io(e,t){if(t=t||{},Object.keys(t).forEach(function(r){if(Eo.indexOf(r)===-1)throw new j('Unknown option "'+r+'" is met in definition of "'+e+'" YAML type.')}),this.options=t,this.tag=e,this.kind=t.kind||null,this.resolve=t.resolve||function(){return!0},this.construct=t.construct||function(r){return r},this.instanceOf=t.instanceOf||null,this.predicate=t.predicate||null,this.represent=t.represent||null,this.representName=t.representName||null,this.defaultStyle=t.defaultStyle||null,this.multi=t.multi||!1,this.styleAliases=To(t.styleAliases||null),Co.indexOf(this.kind)===-1)throw new j('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')}var I=Io;function or(e,t){var r=[];return e[t].forEach(function(n){var i=r.length;r.forEach(function(o,a){o.tag===n.tag&&o.kind===n.kind&&o.multi===n.multi&&(i=a)}),r[i]=n}),r}function Mo(){var e={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}},t,r;function n(i){i.multi?(e.multi[i.kind].push(i),e.multi.fallback.push(i)):e[i.kind][i.tag]=e.fallback[i.tag]=i}for(t=0,r=arguments.length;t<r;t+=1)arguments[t].forEach(n);return e}function pt(e){return this.extend(e)}pt.prototype.extend=function(e){var t=[],r=[];if(e instanceof I)r.push(e);else if(Array.isArray(e))r=r.concat(e);else if(e&&(Array.isArray(e.implicit)||Array.isArray(e.explicit)))e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(r=r.concat(e.explicit));else throw new j("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");t.forEach(function(i){if(!(i instanceof I))throw new j("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(i.loadKind&&i.loadKind!=="scalar")throw new j("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(i.multi)throw new j("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")}),r.forEach(function(i){if(!(i instanceof I))throw new j("Specified list of YAML types (or a single Type object) contains a non-Type object.")});var n=Object.create(pt.prototype);return n.implicit=(this.implicit||[]).concat(t),n.explicit=(this.explicit||[]).concat(r),n.compiledImplicit=or(n,"implicit"),n.compiledExplicit=or(n,"explicit"),n.compiledTypeMap=Mo(n.compiledImplicit,n.compiledExplicit),n};var No=pt,Oo=new I("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return e!==null?e:""}}),ko=new I("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return e!==null?e:[]}}),Fo=new I("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return e!==null?e:{}}}),jo=new No({explicit:[Oo,ko,Fo]});function Lo(e){if(e===null)return!0;var t=e.length;return t===1&&e==="~"||t===4&&(e==="null"||e==="Null"||e==="NULL")}function $o(){return null}function Uo(e){return e===null}var Ro=new I("tag:yaml.org,2002:null",{kind:"scalar",resolve:Lo,construct:$o,predicate:Uo,represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});function qo(e){if(e===null)return!1;var t=e.length;return t===4&&(e==="true"||e==="True"||e==="TRUE")||t===5&&(e==="false"||e==="False"||e==="FALSE")}function Ko(e){return e==="true"||e==="True"||e==="TRUE"}function Do(e){return Object.prototype.toString.call(e)==="[object Boolean]"}var _o=new I("tag:yaml.org,2002:bool",{kind:"scalar",resolve:qo,construct:Ko,predicate:Do,represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});function Wo(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function Go(e){return 48<=e&&e<=55}function Bo(e){return 48<=e&&e<=57}function Yo(e){if(e===null)return!1;var t=e.length,r=0,n=!1,i;if(!t)return!1;if(i=e[r],(i==="-"||i==="+")&&(i=e[++r]),i==="0"){if(r+1===t)return!0;if(i=e[++r],i==="b"){for(r++;r<t;r++)if(i=e[r],i!=="_"){if(i!=="0"&&i!=="1")return!1;n=!0}return n&&i!=="_"}if(i==="x"){for(r++;r<t;r++)if(i=e[r],i!=="_"){if(!Wo(e.charCodeAt(r)))return!1;n=!0}return n&&i!=="_"}if(i==="o"){for(r++;r<t;r++)if(i=e[r],i!=="_"){if(!Go(e.charCodeAt(r)))return!1;n=!0}return n&&i!=="_"}}if(i==="_")return!1;for(;r<t;r++)if(i=e[r],i!=="_"){if(!Bo(e.charCodeAt(r)))return!1;n=!0}return!(!n||i==="_")}function Ho(e){var t=e,r=1,n;if(t.indexOf("_")!==-1&&(t=t.replace(/_/g,"")),n=t[0],(n==="-"||n==="+")&&(n==="-"&&(r=-1),t=t.slice(1),n=t[0]),t==="0")return 0;if(n==="0"){if(t[1]==="b")return r*parseInt(t.slice(2),2);if(t[1]==="x")return r*parseInt(t.slice(2),16);if(t[1]==="o")return r*parseInt(t.slice(2),8)}return r*parseInt(t,10)}function Vo(e){return Object.prototype.toString.call(e)==="[object Number]"&&e%1===0&&!E.isNegativeZero(e)}var zo=new I("tag:yaml.org,2002:int",{kind:"scalar",resolve:Yo,construct:Ho,predicate:Vo,represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),Qo=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");function Jo(e){return!(e===null||!Qo.test(e)||e[e.length-1]==="_")}function Zo(e){var t,r;return t=e.replace(/_/g,"").toLowerCase(),r=t[0]==="-"?-1:1,"+-".indexOf(t[0])>=0&&(t=t.slice(1)),t===".inf"?r===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:t===".nan"?NaN:r*parseFloat(t,10)}var Xo=/^[-+]?[0-9]+e/;function ea(e,t){var r;if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(E.isNegativeZero(e))return"-0.0";return r=e.toString(10),Xo.test(r)?r.replace("e",".e"):r}function ta(e){return Object.prototype.toString.call(e)==="[object Number]"&&(e%1!==0||E.isNegativeZero(e))}var ra=new I("tag:yaml.org,2002:float",{kind:"scalar",resolve:Jo,construct:Zo,predicate:ta,represent:ea,defaultStyle:"lowercase"}),na=jo.extend({implicit:[Ro,_o,zo,ra]}),ia=na,Pr=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),vr=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");function oa(e){return e===null?!1:Pr.exec(e)!==null||vr.exec(e)!==null}function aa(e){var t,r,n,i,o,a,s,c=0,l=null,p,d,h;if(t=Pr.exec(e),t===null&&(t=vr.exec(e)),t===null)throw new Error("Date resolve error");if(r=+t[1],n=+t[2]-1,i=+t[3],!t[4])return new Date(Date.UTC(r,n,i));if(o=+t[4],a=+t[5],s=+t[6],t[7]){for(c=t[7].slice(0,3);c.length<3;)c+="0";c=+c}return t[9]&&(p=+t[10],d=+(t[11]||0),l=(p*60+d)*6e4,t[9]==="-"&&(l=-l)),h=new Date(Date.UTC(r,n,i,o,a,s,c)),l&&h.setTime(h.getTime()-l),h}function sa(e){return e.toISOString()}var ca=new I("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:oa,construct:aa,instanceOf:Date,represent:sa});function la(e){return e==="<<"||e===null}var ua=new I("tag:yaml.org,2002:merge",{kind:"scalar",resolve:la}),yt=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;function da(e){if(e===null)return!1;var t,r,n=0,i=e.length,o=yt;for(r=0;r<i;r++)if(t=o.indexOf(e.charAt(r)),!(t>64)){if(t<0)return!1;n+=6}return n%8===0}function pa(e){var t,r,n=e.replace(/[\r\n=]/g,""),i=n.length,o=yt,a=0,s=[];for(t=0;t<i;t++)t%4===0&&t&&(s.push(a>>16&255),s.push(a>>8&255),s.push(a&255)),a=a<<6|o.indexOf(n.charAt(t));return r=i%4*6,r===0?(s.push(a>>16&255),s.push(a>>8&255),s.push(a&255)):r===18?(s.push(a>>10&255),s.push(a>>2&255)):r===12&&s.push(a>>4&255),new Uint8Array(s)}function ma(e){var t="",r=0,n,i,o=e.length,a=yt;for(n=0;n<o;n++)n%3===0&&n&&(t+=a[r>>18&63],t+=a[r>>12&63],t+=a[r>>6&63],t+=a[r&63]),r=(r<<8)+e[n];return i=o%3,i===0?(t+=a[r>>18&63],t+=a[r>>12&63],t+=a[r>>6&63],t+=a[r&63]):i===2?(t+=a[r>>10&63],t+=a[r>>4&63],t+=a[r<<2&63],t+=a[64]):i===1&&(t+=a[r>>2&63],t+=a[r<<4&63],t+=a[64],t+=a[64]),t}function fa(e){return Object.prototype.toString.call(e)==="[object Uint8Array]"}var ga=new I("tag:yaml.org,2002:binary",{kind:"scalar",resolve:da,construct:pa,predicate:fa,represent:ma}),ha=Object.prototype.hasOwnProperty,ya=Object.prototype.toString;function ba(e){if(e===null)return!0;var t=[],r,n,i,o,a,s=e;for(r=0,n=s.length;r<n;r+=1){if(i=s[r],a=!1,ya.call(i)!=="[object Object]")return!1;for(o in i)if(ha.call(i,o))if(!a)a=!0;else return!1;if(!a)return!1;if(t.indexOf(o)===-1)t.push(o);else return!1}return!0}function xa(e){return e!==null?e:[]}var wa=new I("tag:yaml.org,2002:omap",{kind:"sequence",resolve:ba,construct:xa}),Aa=Object.prototype.toString;function Pa(e){if(e===null)return!0;var t,r,n,i,o,a=e;for(o=new Array(a.length),t=0,r=a.length;t<r;t+=1){if(n=a[t],Aa.call(n)!=="[object Object]"||(i=Object.keys(n),i.length!==1))return!1;o[t]=[i[0],n[i[0]]]}return!0}function va(e){if(e===null)return[];var t,r,n,i,o,a=e;for(o=new Array(a.length),t=0,r=a.length;t<r;t+=1)n=a[t],i=Object.keys(n),o[t]=[i[0],n[i[0]]];return o}var Sa=new I("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:Pa,construct:va}),Ea=Object.prototype.hasOwnProperty;function Ca(e){if(e===null)return!0;var t,r=e;for(t in r)if(Ea.call(r,t)&&r[t]!==null)return!1;return!0}function Ta(e){return e!==null?e:{}}var Ia=new I("tag:yaml.org,2002:set",{kind:"mapping",resolve:Ca,construct:Ta}),Sr=ia.extend({implicit:[ca,ua],explicit:[ga,wa,Sa,Ia]}),V=Object.prototype.hasOwnProperty,$e=1,Er=2,Cr=3,Ue=4,dt=1,Ma=2,ar=3,Na=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Oa=/[\x85\u2028\u2029]/,ka=/[,\[\]\{\}]/,Tr=/^(?:!|!!|![a-z\-]+!)$/i,Ir=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function sr(e){return Object.prototype.toString.call(e)}function K(e){return e===10||e===13}function X(e){return e===9||e===32}function L(e){return e===9||e===32||e===10||e===13}function oe(e){return e===44||e===91||e===93||e===123||e===125}function Fa(e){var t;return 48<=e&&e<=57?e-48:(t=e|32,97<=t&&t<=102?t-97+10:-1)}function ja(e){return e===120?2:e===117?4:e===85?8:0}function La(e){return 48<=e&&e<=57?e-48:-1}function cr(e){return e===48?"\0":e===97?"\x07":e===98?"\b":e===116||e===9?"	":e===110?`
`:e===118?"\v":e===102?"\f":e===114?"\r":e===101?"\x1B":e===32?" ":e===34?'"':e===47?"/":e===92?"\\":e===78?"\x85":e===95?"\xA0":e===76?"\u2028":e===80?"\u2029":""}function $a(e){return e<=65535?String.fromCharCode(e):String.fromCharCode((e-65536>>10)+55296,(e-65536&1023)+56320)}var Mr=new Array(256),Nr=new Array(256);for(Z=0;Z<256;Z++)Mr[Z]=cr(Z)?1:0,Nr[Z]=cr(Z);var Z;function Ua(e,t){this.input=e,this.filename=t.filename||null,this.schema=t.schema||Sr,this.onWarning=t.onWarning||null,this.legacy=t.legacy||!1,this.json=t.json||!1,this.listener=t.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=e.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function Or(e,t){var r={name:e.filename,buffer:e.input.slice(0,-1),position:e.position,line:e.line,column:e.position-e.lineStart};return r.snippet=So(r),new j(t,r)}function g(e,t){throw Or(e,t)}function Re(e,t){e.onWarning&&e.onWarning.call(null,Or(e,t))}var lr={YAML:function(e,t,r){var n,i,o;e.version!==null&&g(e,"duplication of %YAML directive"),r.length!==1&&g(e,"YAML directive accepts exactly one argument"),n=/^([0-9]+)\.([0-9]+)$/.exec(r[0]),n===null&&g(e,"ill-formed argument of the YAML directive"),i=parseInt(n[1],10),o=parseInt(n[2],10),i!==1&&g(e,"unacceptable YAML version of the document"),e.version=r[0],e.checkLineBreaks=o<2,o!==1&&o!==2&&Re(e,"unsupported YAML version of the document")},TAG:function(e,t,r){var n,i;r.length!==2&&g(e,"TAG directive accepts exactly two arguments"),n=r[0],i=r[1],Tr.test(n)||g(e,"ill-formed tag handle (first argument) of the TAG directive"),V.call(e.tagMap,n)&&g(e,'there is a previously declared suffix for "'+n+'" tag handle'),Ir.test(i)||g(e,"ill-formed tag prefix (second argument) of the TAG directive");try{i=decodeURIComponent(i)}catch{g(e,"tag prefix is malformed: "+i)}e.tagMap[n]=i}};function H(e,t,r,n){var i,o,a,s;if(t<r){if(s=e.input.slice(t,r),n)for(i=0,o=s.length;i<o;i+=1)a=s.charCodeAt(i),a===9||32<=a&&a<=1114111||g(e,"expected valid JSON character");else Na.test(s)&&g(e,"the stream contains non-printable characters");e.result+=s}}function ur(e,t,r,n){var i,o,a,s;for(E.isObject(r)||g(e,"cannot merge mappings; the provided source object is unacceptable"),i=Object.keys(r),a=0,s=i.length;a<s;a+=1)o=i[a],V.call(t,o)||(t[o]=r[o],n[o]=!0)}function ae(e,t,r,n,i,o,a,s,c){var l,p;if(Array.isArray(i))for(i=Array.prototype.slice.call(i),l=0,p=i.length;l<p;l+=1)Array.isArray(i[l])&&g(e,"nested arrays are not supported inside keys"),typeof i=="object"&&sr(i[l])==="[object Object]"&&(i[l]="[object Object]");if(typeof i=="object"&&sr(i)==="[object Object]"&&(i="[object Object]"),i=String(i),t===null&&(t={}),n==="tag:yaml.org,2002:merge")if(Array.isArray(o))for(l=0,p=o.length;l<p;l+=1)ur(e,t,o[l],r);else ur(e,t,o,r);else!e.json&&!V.call(r,i)&&V.call(t,i)&&(e.line=a||e.line,e.lineStart=s||e.lineStart,e.position=c||e.position,g(e,"duplicated mapping key")),i==="__proto__"?Object.defineProperty(t,i,{configurable:!0,enumerable:!0,writable:!0,value:o}):t[i]=o,delete r[i];return t}function bt(e){var t;t=e.input.charCodeAt(e.position),t===10?e.position++:t===13?(e.position++,e.input.charCodeAt(e.position)===10&&e.position++):g(e,"a line break is expected"),e.line+=1,e.lineStart=e.position,e.firstTabInLine=-1}function S(e,t,r){for(var n=0,i=e.input.charCodeAt(e.position);i!==0;){for(;X(i);)i===9&&e.firstTabInLine===-1&&(e.firstTabInLine=e.position),i=e.input.charCodeAt(++e.position);if(t&&i===35)do i=e.input.charCodeAt(++e.position);while(i!==10&&i!==13&&i!==0);if(K(i))for(bt(e),i=e.input.charCodeAt(e.position),n++,e.lineIndent=0;i===32;)e.lineIndent++,i=e.input.charCodeAt(++e.position);else break}return r!==-1&&n!==0&&e.lineIndent<r&&Re(e,"deficient indentation"),n}function De(e){var t=e.position,r;return r=e.input.charCodeAt(t),!!((r===45||r===46)&&r===e.input.charCodeAt(t+1)&&r===e.input.charCodeAt(t+2)&&(t+=3,r=e.input.charCodeAt(t),r===0||L(r)))}function xt(e,t){t===1?e.result+=" ":t>1&&(e.result+=E.repeat(`
`,t-1))}function Ra(e,t,r){var n,i,o,a,s,c,l,p,d=e.kind,h=e.result,y;if(y=e.input.charCodeAt(e.position),L(y)||oe(y)||y===35||y===38||y===42||y===33||y===124||y===62||y===39||y===34||y===37||y===64||y===96||(y===63||y===45)&&(i=e.input.charCodeAt(e.position+1),L(i)||r&&oe(i)))return!1;for(e.kind="scalar",e.result="",o=a=e.position,s=!1;y!==0;){if(y===58){if(i=e.input.charCodeAt(e.position+1),L(i)||r&&oe(i))break}else if(y===35){if(n=e.input.charCodeAt(e.position-1),L(n))break}else{if(e.position===e.lineStart&&De(e)||r&&oe(y))break;if(K(y))if(c=e.line,l=e.lineStart,p=e.lineIndent,S(e,!1,-1),e.lineIndent>=t){s=!0,y=e.input.charCodeAt(e.position);continue}else{e.position=a,e.line=c,e.lineStart=l,e.lineIndent=p;break}}s&&(H(e,o,a,!1),xt(e,e.line-c),o=a=e.position,s=!1),X(y)||(a=e.position+1),y=e.input.charCodeAt(++e.position)}return H(e,o,a,!1),e.result?!0:(e.kind=d,e.result=h,!1)}function qa(e,t){var r,n,i;if(r=e.input.charCodeAt(e.position),r!==39)return!1;for(e.kind="scalar",e.result="",e.position++,n=i=e.position;(r=e.input.charCodeAt(e.position))!==0;)if(r===39)if(H(e,n,e.position,!0),r=e.input.charCodeAt(++e.position),r===39)n=e.position,e.position++,i=e.position;else return!0;else K(r)?(H(e,n,i,!0),xt(e,S(e,!1,t)),n=i=e.position):e.position===e.lineStart&&De(e)?g(e,"unexpected end of the document within a single quoted scalar"):(e.position++,i=e.position);g(e,"unexpected end of the stream within a single quoted scalar")}function Ka(e,t){var r,n,i,o,a,s;if(s=e.input.charCodeAt(e.position),s!==34)return!1;for(e.kind="scalar",e.result="",e.position++,r=n=e.position;(s=e.input.charCodeAt(e.position))!==0;){if(s===34)return H(e,r,e.position,!0),e.position++,!0;if(s===92){if(H(e,r,e.position,!0),s=e.input.charCodeAt(++e.position),K(s))S(e,!1,t);else if(s<256&&Mr[s])e.result+=Nr[s],e.position++;else if((a=ja(s))>0){for(i=a,o=0;i>0;i--)s=e.input.charCodeAt(++e.position),(a=Fa(s))>=0?o=(o<<4)+a:g(e,"expected hexadecimal character");e.result+=$a(o),e.position++}else g(e,"unknown escape sequence");r=n=e.position}else K(s)?(H(e,r,n,!0),xt(e,S(e,!1,t)),r=n=e.position):e.position===e.lineStart&&De(e)?g(e,"unexpected end of the document within a double quoted scalar"):(e.position++,n=e.position)}g(e,"unexpected end of the stream within a double quoted scalar")}function Da(e,t){var r=!0,n,i,o,a=e.tag,s,c=e.anchor,l,p,d,h,y,b=Object.create(null),w,P,R,x;if(x=e.input.charCodeAt(e.position),x===91)p=93,y=!1,s=[];else if(x===123)p=125,y=!0,s={};else return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=s),x=e.input.charCodeAt(++e.position);x!==0;){if(S(e,!0,t),x=e.input.charCodeAt(e.position),x===p)return e.position++,e.tag=a,e.anchor=c,e.kind=y?"mapping":"sequence",e.result=s,!0;r?x===44&&g(e,"expected the node content, but found ','"):g(e,"missed comma between flow collection entries"),P=w=R=null,d=h=!1,x===63&&(l=e.input.charCodeAt(e.position+1),L(l)&&(d=h=!0,e.position++,S(e,!0,t))),n=e.line,i=e.lineStart,o=e.position,se(e,t,$e,!1,!0),P=e.tag,w=e.result,S(e,!0,t),x=e.input.charCodeAt(e.position),(h||e.line===n)&&x===58&&(d=!0,x=e.input.charCodeAt(++e.position),S(e,!0,t),se(e,t,$e,!1,!0),R=e.result),y?ae(e,s,b,P,w,R,n,i,o):d?s.push(ae(e,null,b,P,w,R,n,i,o)):s.push(w),S(e,!0,t),x=e.input.charCodeAt(e.position),x===44?(r=!0,x=e.input.charCodeAt(++e.position)):r=!1}g(e,"unexpected end of the stream within a flow collection")}function _a(e,t){var r,n,i=dt,o=!1,a=!1,s=t,c=0,l=!1,p,d;if(d=e.input.charCodeAt(e.position),d===124)n=!1;else if(d===62)n=!0;else return!1;for(e.kind="scalar",e.result="";d!==0;)if(d=e.input.charCodeAt(++e.position),d===43||d===45)dt===i?i=d===43?ar:Ma:g(e,"repeat of a chomping mode identifier");else if((p=La(d))>=0)p===0?g(e,"bad explicit indentation width of a block scalar; it cannot be less than one"):a?g(e,"repeat of an indentation width identifier"):(s=t+p-1,a=!0);else break;if(X(d)){do d=e.input.charCodeAt(++e.position);while(X(d));if(d===35)do d=e.input.charCodeAt(++e.position);while(!K(d)&&d!==0)}for(;d!==0;){for(bt(e),e.lineIndent=0,d=e.input.charCodeAt(e.position);(!a||e.lineIndent<s)&&d===32;)e.lineIndent++,d=e.input.charCodeAt(++e.position);if(!a&&e.lineIndent>s&&(s=e.lineIndent),K(d)){c++;continue}if(e.lineIndent<s){i===ar?e.result+=E.repeat(`
`,o?1+c:c):i===dt&&o&&(e.result+=`
`);break}for(n?X(d)?(l=!0,e.result+=E.repeat(`
`,o?1+c:c)):l?(l=!1,e.result+=E.repeat(`
`,c+1)):c===0?o&&(e.result+=" "):e.result+=E.repeat(`
`,c):e.result+=E.repeat(`
`,o?1+c:c),o=!0,a=!0,c=0,r=e.position;!K(d)&&d!==0;)d=e.input.charCodeAt(++e.position);H(e,r,e.position,!1)}return!0}function dr(e,t){var r,n=e.tag,i=e.anchor,o=[],a,s=!1,c;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=o),c=e.input.charCodeAt(e.position);c!==0&&(e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,g(e,"tab characters must not be used in indentation")),!(c!==45||(a=e.input.charCodeAt(e.position+1),!L(a))));){if(s=!0,e.position++,S(e,!0,-1)&&e.lineIndent<=t){o.push(null),c=e.input.charCodeAt(e.position);continue}if(r=e.line,se(e,t,Cr,!1,!0),o.push(e.result),S(e,!0,-1),c=e.input.charCodeAt(e.position),(e.line===r||e.lineIndent>t)&&c!==0)g(e,"bad indentation of a sequence entry");else if(e.lineIndent<t)break}return s?(e.tag=n,e.anchor=i,e.kind="sequence",e.result=o,!0):!1}function Wa(e,t,r){var n,i,o,a,s,c,l=e.tag,p=e.anchor,d={},h=Object.create(null),y=null,b=null,w=null,P=!1,R=!1,x;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=d),x=e.input.charCodeAt(e.position);x!==0;){if(!P&&e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,g(e,"tab characters must not be used in indentation")),n=e.input.charCodeAt(e.position+1),o=e.line,(x===63||x===58)&&L(n))x===63?(P&&(ae(e,d,h,y,b,null,a,s,c),y=b=w=null),R=!0,P=!0,i=!0):P?(P=!1,i=!0):g(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),e.position+=1,x=n;else{if(a=e.line,s=e.lineStart,c=e.position,!se(e,r,Er,!1,!0))break;if(e.line===o){for(x=e.input.charCodeAt(e.position);X(x);)x=e.input.charCodeAt(++e.position);if(x===58)x=e.input.charCodeAt(++e.position),L(x)||g(e,"a whitespace character is expected after the key-value separator within a block mapping"),P&&(ae(e,d,h,y,b,null,a,s,c),y=b=w=null),R=!0,P=!1,i=!1,y=e.tag,b=e.result;else if(R)g(e,"can not read an implicit mapping pair; a colon is missed");else return e.tag=l,e.anchor=p,!0}else if(R)g(e,"can not read a block mapping entry; a multiline key may not be an implicit key");else return e.tag=l,e.anchor=p,!0}if((e.line===o||e.lineIndent>t)&&(P&&(a=e.line,s=e.lineStart,c=e.position),se(e,t,Ue,!0,i)&&(P?b=e.result:w=e.result),P||(ae(e,d,h,y,b,w,a,s,c),y=b=w=null),S(e,!0,-1),x=e.input.charCodeAt(e.position)),(e.line===o||e.lineIndent>t)&&x!==0)g(e,"bad indentation of a mapping entry");else if(e.lineIndent<t)break}return P&&ae(e,d,h,y,b,null,a,s,c),R&&(e.tag=l,e.anchor=p,e.kind="mapping",e.result=d),R}function Ga(e){var t,r=!1,n=!1,i,o,a;if(a=e.input.charCodeAt(e.position),a!==33)return!1;if(e.tag!==null&&g(e,"duplication of a tag property"),a=e.input.charCodeAt(++e.position),a===60?(r=!0,a=e.input.charCodeAt(++e.position)):a===33?(n=!0,i="!!",a=e.input.charCodeAt(++e.position)):i="!",t=e.position,r){do a=e.input.charCodeAt(++e.position);while(a!==0&&a!==62);e.position<e.length?(o=e.input.slice(t,e.position),a=e.input.charCodeAt(++e.position)):g(e,"unexpected end of the stream within a verbatim tag")}else{for(;a!==0&&!L(a);)a===33&&(n?g(e,"tag suffix cannot contain exclamation marks"):(i=e.input.slice(t-1,e.position+1),Tr.test(i)||g(e,"named tag handle cannot contain such characters"),n=!0,t=e.position+1)),a=e.input.charCodeAt(++e.position);o=e.input.slice(t,e.position),ka.test(o)&&g(e,"tag suffix cannot contain flow indicator characters")}o&&!Ir.test(o)&&g(e,"tag name cannot contain such characters: "+o);try{o=decodeURIComponent(o)}catch{g(e,"tag name is malformed: "+o)}return r?e.tag=o:V.call(e.tagMap,i)?e.tag=e.tagMap[i]+o:i==="!"?e.tag="!"+o:i==="!!"?e.tag="tag:yaml.org,2002:"+o:g(e,'undeclared tag handle "'+i+'"'),!0}function Ba(e){var t,r;if(r=e.input.charCodeAt(e.position),r!==38)return!1;for(e.anchor!==null&&g(e,"duplication of an anchor property"),r=e.input.charCodeAt(++e.position),t=e.position;r!==0&&!L(r)&&!oe(r);)r=e.input.charCodeAt(++e.position);return e.position===t&&g(e,"name of an anchor node must contain at least one character"),e.anchor=e.input.slice(t,e.position),!0}function Ya(e){var t,r,n;if(n=e.input.charCodeAt(e.position),n!==42)return!1;for(n=e.input.charCodeAt(++e.position),t=e.position;n!==0&&!L(n)&&!oe(n);)n=e.input.charCodeAt(++e.position);return e.position===t&&g(e,"name of an alias node must contain at least one character"),r=e.input.slice(t,e.position),V.call(e.anchorMap,r)||g(e,'unidentified alias "'+r+'"'),e.result=e.anchorMap[r],S(e,!0,-1),!0}function se(e,t,r,n,i){var o,a,s,c=1,l=!1,p=!1,d,h,y,b,w,P;if(e.listener!==null&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null,o=a=s=Ue===r||Cr===r,n&&S(e,!0,-1)&&(l=!0,e.lineIndent>t?c=1:e.lineIndent===t?c=0:e.lineIndent<t&&(c=-1)),c===1)for(;Ga(e)||Ba(e);)S(e,!0,-1)?(l=!0,s=o,e.lineIndent>t?c=1:e.lineIndent===t?c=0:e.lineIndent<t&&(c=-1)):s=!1;if(s&&(s=l||i),(c===1||Ue===r)&&($e===r||Er===r?w=t:w=t+1,P=e.position-e.lineStart,c===1?s&&(dr(e,P)||Wa(e,P,w))||Da(e,w)?p=!0:(a&&_a(e,w)||qa(e,w)||Ka(e,w)?p=!0:Ya(e)?(p=!0,(e.tag!==null||e.anchor!==null)&&g(e,"alias node should not have any properties")):Ra(e,w,$e===r)&&(p=!0,e.tag===null&&(e.tag="?")),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):c===0&&(p=s&&dr(e,P))),e.tag===null)e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);else if(e.tag==="?"){for(e.result!==null&&e.kind!=="scalar"&&g(e,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+e.kind+'"'),d=0,h=e.implicitTypes.length;d<h;d+=1)if(b=e.implicitTypes[d],b.resolve(e.result)){e.result=b.construct(e.result),e.tag=b.tag,e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);break}}else if(e.tag!=="!"){if(V.call(e.typeMap[e.kind||"fallback"],e.tag))b=e.typeMap[e.kind||"fallback"][e.tag];else for(b=null,y=e.typeMap.multi[e.kind||"fallback"],d=0,h=y.length;d<h;d+=1)if(e.tag.slice(0,y[d].tag.length)===y[d].tag){b=y[d];break}b||g(e,"unknown tag !<"+e.tag+">"),e.result!==null&&b.kind!==e.kind&&g(e,"unacceptable node kind for !<"+e.tag+'> tag; it should be "'+b.kind+'", not "'+e.kind+'"'),b.resolve(e.result,e.tag)?(e.result=b.construct(e.result,e.tag),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):g(e,"cannot resolve a node with !<"+e.tag+"> explicit tag")}return e.listener!==null&&e.listener("close",e),e.tag!==null||e.anchor!==null||p}function Ha(e){var t=e.position,r,n,i,o=!1,a;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);(a=e.input.charCodeAt(e.position))!==0&&(S(e,!0,-1),a=e.input.charCodeAt(e.position),!(e.lineIndent>0||a!==37));){for(o=!0,a=e.input.charCodeAt(++e.position),r=e.position;a!==0&&!L(a);)a=e.input.charCodeAt(++e.position);for(n=e.input.slice(r,e.position),i=[],n.length<1&&g(e,"directive name must not be less than one character in length");a!==0;){for(;X(a);)a=e.input.charCodeAt(++e.position);if(a===35){do a=e.input.charCodeAt(++e.position);while(a!==0&&!K(a));break}if(K(a))break;for(r=e.position;a!==0&&!L(a);)a=e.input.charCodeAt(++e.position);i.push(e.input.slice(r,e.position))}a!==0&&bt(e),V.call(lr,n)?lr[n](e,n,i):Re(e,'unknown document directive "'+n+'"')}if(S(e,!0,-1),e.lineIndent===0&&e.input.charCodeAt(e.position)===45&&e.input.charCodeAt(e.position+1)===45&&e.input.charCodeAt(e.position+2)===45?(e.position+=3,S(e,!0,-1)):o&&g(e,"directives end mark is expected"),se(e,e.lineIndent-1,Ue,!1,!0),S(e,!0,-1),e.checkLineBreaks&&Oa.test(e.input.slice(t,e.position))&&Re(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&De(e)){e.input.charCodeAt(e.position)===46&&(e.position+=3,S(e,!0,-1));return}if(e.position<e.length-1)g(e,"end of the stream or a document separator is expected");else return}function kr(e,t){e=String(e),t=t||{},e.length!==0&&(e.charCodeAt(e.length-1)!==10&&e.charCodeAt(e.length-1)!==13&&(e+=`
`),e.charCodeAt(0)===65279&&(e=e.slice(1)));var r=new Ua(e,t),n=e.indexOf("\0");for(n!==-1&&(r.position=n,g(r,"null byte is not allowed in input")),r.input+="\0";r.input.charCodeAt(r.position)===32;)r.lineIndent+=1,r.position+=1;for(;r.position<r.length-1;)Ha(r);return r.documents}function Va(e,t,r){t!==null&&typeof t=="object"&&typeof r>"u"&&(r=t,t=null);var n=kr(e,r);if(typeof t!="function")return n;for(var i=0,o=n.length;i<o;i+=1)t(n[i])}function za(e,t){var r=kr(e,t);if(r.length!==0){if(r.length===1)return r[0];throw new j("expected a single document in the stream, but found more")}}var Qa=Va,Ja=za,Fr={loadAll:Qa,load:Ja},jr=Object.prototype.toString,Lr=Object.prototype.hasOwnProperty,wt=65279,Za=9,me=10,Xa=13,es=32,ts=33,rs=34,mt=35,ns=37,is=38,os=39,as=42,$r=44,ss=45,qe=58,cs=61,ls=62,us=63,ds=64,Ur=91,Rr=93,ps=96,qr=123,ms=124,Kr=125,M={};M[0]="\\0";M[7]="\\a";M[8]="\\b";M[9]="\\t";M[10]="\\n";M[11]="\\v";M[12]="\\f";M[13]="\\r";M[27]="\\e";M[34]='\\"';M[92]="\\\\";M[133]="\\N";M[160]="\\_";M[8232]="\\L";M[8233]="\\P";var fs=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],gs=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function hs(e,t){var r,n,i,o,a,s,c;if(t===null)return{};for(r={},n=Object.keys(t),i=0,o=n.length;i<o;i+=1)a=n[i],s=String(t[a]),a.slice(0,2)==="!!"&&(a="tag:yaml.org,2002:"+a.slice(2)),c=e.compiledTypeMap.fallback[a],c&&Lr.call(c.styleAliases,s)&&(s=c.styleAliases[s]),r[a]=s;return r}function ys(e){var t,r,n;if(t=e.toString(16).toUpperCase(),e<=255)r="x",n=2;else if(e<=65535)r="u",n=4;else if(e<=4294967295)r="U",n=8;else throw new j("code point within a string may not be greater than 0xFFFFFFFF");return"\\"+r+E.repeat("0",n-t.length)+t}var bs=1,fe=2;function xs(e){this.schema=e.schema||Sr,this.indent=Math.max(1,e.indent||2),this.noArrayIndent=e.noArrayIndent||!1,this.skipInvalid=e.skipInvalid||!1,this.flowLevel=E.isNothing(e.flowLevel)?-1:e.flowLevel,this.styleMap=hs(this.schema,e.styles||null),this.sortKeys=e.sortKeys||!1,this.lineWidth=e.lineWidth||80,this.noRefs=e.noRefs||!1,this.noCompatMode=e.noCompatMode||!1,this.condenseFlow=e.condenseFlow||!1,this.quotingType=e.quotingType==='"'?fe:bs,this.forceQuotes=e.forceQuotes||!1,this.replacer=typeof e.replacer=="function"?e.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function pr(e,t){for(var r=E.repeat(" ",t),n=0,i=-1,o="",a,s=e.length;n<s;)i=e.indexOf(`
`,n),i===-1?(a=e.slice(n),n=s):(a=e.slice(n,i+1),n=i+1),a.length&&a!==`
`&&(o+=r),o+=a;return o}function ft(e,t){return`
`+E.repeat(" ",e.indent*t)}function ws(e,t){var r,n,i;for(r=0,n=e.implicitTypes.length;r<n;r+=1)if(i=e.implicitTypes[r],i.resolve(t))return!0;return!1}function Ke(e){return e===es||e===Za}function ge(e){return 32<=e&&e<=126||161<=e&&e<=55295&&e!==8232&&e!==8233||57344<=e&&e<=65533&&e!==wt||65536<=e&&e<=1114111}function mr(e){return ge(e)&&e!==wt&&e!==Xa&&e!==me}function fr(e,t,r){var n=mr(e),i=n&&!Ke(e);return(r?n:n&&e!==$r&&e!==Ur&&e!==Rr&&e!==qr&&e!==Kr)&&e!==mt&&!(t===qe&&!i)||mr(t)&&!Ke(t)&&e===mt||t===qe&&i}function As(e){return ge(e)&&e!==wt&&!Ke(e)&&e!==ss&&e!==us&&e!==qe&&e!==$r&&e!==Ur&&e!==Rr&&e!==qr&&e!==Kr&&e!==mt&&e!==is&&e!==as&&e!==ts&&e!==ms&&e!==cs&&e!==ls&&e!==os&&e!==rs&&e!==ns&&e!==ds&&e!==ps}function Ps(e){return!Ke(e)&&e!==qe}function de(e,t){var r=e.charCodeAt(t),n;return r>=55296&&r<=56319&&t+1<e.length&&(n=e.charCodeAt(t+1),n>=56320&&n<=57343)?(r-55296)*1024+n-56320+65536:r}function Dr(e){var t=/^\n* /;return t.test(e)}var _r=1,gt=2,Wr=3,Gr=4,ie=5;function vs(e,t,r,n,i,o,a,s){var c,l=0,p=null,d=!1,h=!1,y=n!==-1,b=-1,w=As(de(e,0))&&Ps(de(e,e.length-1));if(t||a)for(c=0;c<e.length;l>=65536?c+=2:c++){if(l=de(e,c),!ge(l))return ie;w=w&&fr(l,p,s),p=l}else{for(c=0;c<e.length;l>=65536?c+=2:c++){if(l=de(e,c),l===me)d=!0,y&&(h=h||c-b-1>n&&e[b+1]!==" ",b=c);else if(!ge(l))return ie;w=w&&fr(l,p,s),p=l}h=h||y&&c-b-1>n&&e[b+1]!==" "}return!d&&!h?w&&!a&&!i(e)?_r:o===fe?ie:gt:r>9&&Dr(e)?ie:a?o===fe?ie:gt:h?Gr:Wr}function Ss(e,t,r,n,i){e.dump=function(){if(t.length===0)return e.quotingType===fe?'""':"''";if(!e.noCompatMode&&(fs.indexOf(t)!==-1||gs.test(t)))return e.quotingType===fe?'"'+t+'"':"'"+t+"'";var o=e.indent*Math.max(1,r),a=e.lineWidth===-1?-1:Math.max(Math.min(e.lineWidth,40),e.lineWidth-o),s=n||e.flowLevel>-1&&r>=e.flowLevel;function c(l){return ws(e,l)}switch(vs(t,s,e.indent,a,c,e.quotingType,e.forceQuotes&&!n,i)){case _r:return t;case gt:return"'"+t.replace(/'/g,"''")+"'";case Wr:return"|"+gr(t,e.indent)+hr(pr(t,o));case Gr:return">"+gr(t,e.indent)+hr(pr(Es(t,a),o));case ie:return'"'+Cs(t)+'"';default:throw new j("impossible error: invalid scalar style")}}()}function gr(e,t){var r=Dr(e)?String(t):"",n=e[e.length-1]===`
`,i=n&&(e[e.length-2]===`
`||e===`
`),o=i?"+":n?"":"-";return r+o+`
`}function hr(e){return e[e.length-1]===`
`?e.slice(0,-1):e}function Es(e,t){for(var r=/(\n+)([^\n]*)/g,n=function(){var l=e.indexOf(`
`);return l=l!==-1?l:e.length,r.lastIndex=l,yr(e.slice(0,l),t)}(),i=e[0]===`
`||e[0]===" ",o,a;a=r.exec(e);){var s=a[1],c=a[2];o=c[0]===" ",n+=s+(!i&&!o&&c!==""?`
`:"")+yr(c,t),i=o}return n}function yr(e,t){if(e===""||e[0]===" ")return e;for(var r=/ [^ ]/g,n,i=0,o,a=0,s=0,c="";n=r.exec(e);)s=n.index,s-i>t&&(o=a>i?a:s,c+=`
`+e.slice(i,o),i=o+1),a=s;return c+=`
`,e.length-i>t&&a>i?c+=e.slice(i,a)+`
`+e.slice(a+1):c+=e.slice(i),c.slice(1)}function Cs(e){for(var t="",r=0,n,i=0;i<e.length;r>=65536?i+=2:i++)r=de(e,i),n=M[r],!n&&ge(r)?(t+=e[i],r>=65536&&(t+=e[i+1])):t+=n||ys(r);return t}function Ts(e,t,r){var n="",i=e.tag,o,a,s;for(o=0,a=r.length;o<a;o+=1)s=r[o],e.replacer&&(s=e.replacer.call(r,String(o),s)),(W(e,t,s,!1,!1)||typeof s>"u"&&W(e,t,null,!1,!1))&&(n!==""&&(n+=","+(e.condenseFlow?"":" ")),n+=e.dump);e.tag=i,e.dump="["+n+"]"}function br(e,t,r,n){var i="",o=e.tag,a,s,c;for(a=0,s=r.length;a<s;a+=1)c=r[a],e.replacer&&(c=e.replacer.call(r,String(a),c)),(W(e,t+1,c,!0,!0,!1,!0)||typeof c>"u"&&W(e,t+1,null,!0,!0,!1,!0))&&((!n||i!=="")&&(i+=ft(e,t)),e.dump&&me===e.dump.charCodeAt(0)?i+="-":i+="- ",i+=e.dump);e.tag=o,e.dump=i||"[]"}function Is(e,t,r){var n="",i=e.tag,o=Object.keys(r),a,s,c,l,p;for(a=0,s=o.length;a<s;a+=1)p="",n!==""&&(p+=", "),e.condenseFlow&&(p+='"'),c=o[a],l=r[c],e.replacer&&(l=e.replacer.call(r,c,l)),W(e,t,c,!1,!1)&&(e.dump.length>1024&&(p+="? "),p+=e.dump+(e.condenseFlow?'"':"")+":"+(e.condenseFlow?"":" "),W(e,t,l,!1,!1)&&(p+=e.dump,n+=p));e.tag=i,e.dump="{"+n+"}"}function Ms(e,t,r,n){var i="",o=e.tag,a=Object.keys(r),s,c,l,p,d,h;if(e.sortKeys===!0)a.sort();else if(typeof e.sortKeys=="function")a.sort(e.sortKeys);else if(e.sortKeys)throw new j("sortKeys must be a boolean or a function");for(s=0,c=a.length;s<c;s+=1)h="",(!n||i!=="")&&(h+=ft(e,t)),l=a[s],p=r[l],e.replacer&&(p=e.replacer.call(r,l,p)),W(e,t+1,l,!0,!0,!0)&&(d=e.tag!==null&&e.tag!=="?"||e.dump&&e.dump.length>1024,d&&(e.dump&&me===e.dump.charCodeAt(0)?h+="?":h+="? "),h+=e.dump,d&&(h+=ft(e,t)),W(e,t+1,p,!0,d)&&(e.dump&&me===e.dump.charCodeAt(0)?h+=":":h+=": ",h+=e.dump,i+=h));e.tag=o,e.dump=i||"{}"}function xr(e,t,r){var n,i,o,a,s,c;for(i=r?e.explicitTypes:e.implicitTypes,o=0,a=i.length;o<a;o+=1)if(s=i[o],(s.instanceOf||s.predicate)&&(!s.instanceOf||typeof t=="object"&&t instanceof s.instanceOf)&&(!s.predicate||s.predicate(t))){if(r?s.multi&&s.representName?e.tag=s.representName(t):e.tag=s.tag:e.tag="?",s.represent){if(c=e.styleMap[s.tag]||s.defaultStyle,jr.call(s.represent)==="[object Function]")n=s.represent(t,c);else if(Lr.call(s.represent,c))n=s.represent[c](t,c);else throw new j("!<"+s.tag+'> tag resolver accepts not "'+c+'" style');e.dump=n}return!0}return!1}function W(e,t,r,n,i,o,a){e.tag=null,e.dump=r,xr(e,r,!1)||xr(e,r,!0);var s=jr.call(e.dump),c=n,l;n&&(n=e.flowLevel<0||e.flowLevel>t);var p=s==="[object Object]"||s==="[object Array]",d,h;if(p&&(d=e.duplicates.indexOf(r),h=d!==-1),(e.tag!==null&&e.tag!=="?"||h||e.indent!==2&&t>0)&&(i=!1),h&&e.usedDuplicates[d])e.dump="*ref_"+d;else{if(p&&h&&!e.usedDuplicates[d]&&(e.usedDuplicates[d]=!0),s==="[object Object]")n&&Object.keys(e.dump).length!==0?(Ms(e,t,e.dump,i),h&&(e.dump="&ref_"+d+e.dump)):(Is(e,t,e.dump),h&&(e.dump="&ref_"+d+" "+e.dump));else if(s==="[object Array]")n&&e.dump.length!==0?(e.noArrayIndent&&!a&&t>0?br(e,t-1,e.dump,i):br(e,t,e.dump,i),h&&(e.dump="&ref_"+d+e.dump)):(Ts(e,t,e.dump),h&&(e.dump="&ref_"+d+" "+e.dump));else if(s==="[object String]")e.tag!=="?"&&Ss(e,e.dump,t,o,c);else{if(s==="[object Undefined]"||e.skipInvalid)return!1;throw new j("unacceptable kind of an object to dump "+s)}e.tag!==null&&e.tag!=="?"&&(l=encodeURI(e.tag[0]==="!"?e.tag.slice(1):e.tag).replace(/!/g,"%21"),e.tag[0]==="!"?l="!"+l:l.slice(0,18)==="tag:yaml.org,2002:"?l="!!"+l.slice(18):l="!<"+l+">",e.dump=l+" "+e.dump)}return!0}function Ns(e,t){var r=[],n=[],i,o;for(ht(e,r,n),i=0,o=n.length;i<o;i+=1)t.duplicates.push(r[n[i]]);t.usedDuplicates=new Array(o)}function ht(e,t,r){var n,i,o;if(e!==null&&typeof e=="object")if(i=t.indexOf(e),i!==-1)r.indexOf(i)===-1&&r.push(i);else if(t.push(e),Array.isArray(e))for(i=0,o=e.length;i<o;i+=1)ht(e[i],t,r);else for(n=Object.keys(e),i=0,o=n.length;i<o;i+=1)ht(e[n[i]],t,r)}function Os(e,t){t=t||{};var r=new xs(t);r.noRefs||Ns(e,r);var n=e;return r.replacer&&(n=r.replacer.call({"":n},"",n)),W(r,0,n,!0,!0)?r.dump+`
`:""}var ks=Os,Fs={dump:ks};function At(e,t){return function(){throw new Error("Function yaml."+e+" is removed in js-yaml 4. Use yaml."+t+" instead, which is now safe by default.")}}var Br=Fr.load,uu=Fr.loadAll,du=Fs.dump;var pu=At("safeLoad","load"),mu=At("safeLoadAll","loadAll"),fu=At("safeDump","dump");async function Yr(e){(e==="SETTINGS"||e==="SECRETS")&&await B(!0)}async function Hr(){(!f||!f.textModels)&&await B(!1);let e=f.textModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await m.filterBox("Select a model",e);if(!t){await m.flashNotification("No model selected.","error");return}let r=t.name;await ot(t),await ce(t),await m.flashNotification(`Selected model: ${r}`),console.log("Selected model:",t)}async function Vr(){(!f||!f.imageModels)&&await B(!1);let e=f.imageModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await m.filterBox("Select an image model",e);if(!t){await m.flashNotification("No image model selected.","error");return}let r=t.name;await it(t),await st(t),await m.flashNotification(`Selected image model: ${r}`),console.log("Selected image model:",t)}async function zr(){(!f||!f.embeddingModels)&&await B(!1);let e=f.embeddingModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await m.filterBox("Select an embedding model",e);if(!t){await m.flashNotification("No embedding model selected.","error");return}let r=t.name;await at(t),await ct(t),await m.flashNotification(`Selected embedding model: ${r}`),console.log("Selected embedding model:",t)}async function Qr(){await T();let e=await Ae(),t=await m.prompt("Please enter a prompt to send to the LLM. Selected text or the entire note will also be sent as context."),r=await m.getCurrentPage(),n=new Date,i=n.toISOString().split("T")[0],o=n.toLocaleDateString("en-US",{weekday:"long"});await O.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant. Follow all user instructions and use the note context and note content to help follow those instructions. Use Markdown for any formatting."},{role:"user",content:`Note Context: Today is ${o}, ${i}. The current note name is "${r}".
User Prompt: ${t}
Note Content:
${e.text}`}],stream:!0},e.to)}async function Jr(){await T();let e=await Ae();if(console.log("selectedTextInfo",e),e.text.length>0){let t=await m.getCurrentPage(),r=await O.chatWithAI({messages:[{role:"user",content:`Please summarize this note using markdown for any formatting. Your summary will be appended to the end of this note, do not include any of the note contents yourself. Keep the summary brief. The note name is ${t}.

${e.text}`}],stream:!1});return console.log("OpenAI response:",r),{summary:r,selectedTextInfo:e}}return{summary:"",selectedTextInfo:null}}async function Zr(){let{summary:e,selectedTextInfo:t}=await Jr();e&&t&&await m.insertAtPos(`

`+e,t.to)}async function Xr(){let{summary:e}=await Jr();e?await m.showPanel("rhs",2,e):await m.flashNotification("No summary available.")}async function Pt(){await T();let e=await m.getText(),t=await m.getCurrentPage(),r=(await nr("tag select name where parent = 'page' order by name")).map(d=>d.name);console.log("All tags:",r);let n=`You are an AI tagging assistant. Please provide a short list of tags, separated by spaces. Follow these guidelines:
    - Only return tags and no other content.
    - Tags must be one word only and in lowercase.
    - Use existing tags as a starting point.
    - Suggest tags sparingly, treating them as thematic descriptors rather than keywords.

    The following tags are currently being used by other notes:
    ${r.join(", ")}
    
    Always follow the below rules, if any, given by the user:
    ${f.promptInstructions.tagRules}`,i=`Page Title: ${t}

Page Content:
${e}`,a=(await O.singleMessageChat(i,n)).trim().replace(/,/g,"").split(/\s+/),s=await k.parseMarkdown(e),c=await Q(s),l=[...new Set([...c.tags||[],...a])];c.tags=l,console.log("Current frontmatter:",c);let p=await Qe(s,c);console.log("updatedNoteContent",p),await m.dispatch(p),await m.flashNotification("Note tagged successfully.")}async function vt(){await T();let e=await m.getText(),t=await m.getCurrentPage(),r=[{name:"Generating suggestions...",description:""}];m.filterBox("Loading...",r,"Retrieving suggestions from LLM provider.").then(l=>{console.log("Selected option (initial):",l)});let i="";f.promptInstructions.pageRenameSystem?i=f.promptInstructions.pageRenameSystem:i=`You are an AI note-naming assistant. Your task is to suggest three to five possible names for the provided note content. Please adhere to the following guidelines:
    - Provide each name on a new line.
    - Use only spaces, forward slashes (as folder separators), and hyphens as special characters.
    - Ensure the names are concise, descriptive, and relevant to the content.
    - Avoid suggesting the same name as the current note.
    - Include as much detail as possible within 3 to 10 words.
    - Start names with ASCII characters only.
    - Do not use markdown or any other formatting in your response.`;let a=(await O.singleMessageChat(`Current Page Title: ${t}

Page Content:
${e}`,`${i}

Always follow the below rules, if any, given by the user:
${f.promptInstructions.pageRenameRules}`,!0)).trim().split(`
`).filter(l=>l.trim()!=="").map(l=>l.replace(/^[*-]\s*/,"").trim());a.push(t),a=[...new Set(a)],a.length===0&&await m.flashNotification("No suggestions available.");let s=await m.filterBox("New page name",a.map(l=>({name:l})),"Select a new page name from one of the suggestions below.");if(!s){await m.flashNotification("No page name selected.","error");return}console.log("selectedSuggestion",s);let c=await A.invokeFunction("index.renamePageCommand",{oldPage:t,page:s.name});console.log("renamedPage",c),c||await m.flashNotification("Error renaming page.","error")}async function St(){await T();let e=await m.getText(),t=await m.getCurrentPage(),r=["title","tags"],i=await O.singleMessageChat(`Current Page Title: ${t}

Page Content:
${e}`,`You are an AI note enhancing assistant. Your task is to understand the content of a note, detect and extract important information, and convert it to frontmatter attributes. Please adhere to the following guidelines:
      - Only return valid YAML frontmatter.
      - Do not use any markdown or any other formatting in your response.
      - Do not include --- in your response.
      - Do not include any content from the note in your response.
      - Extract useful facts from the note and add them to the frontmatter, such as a person's name, age, a location, etc.
      - Do not return any tags.
      - Do not return a new note title.
      - Do not use special characters in key names.  Only ASCII.
      - Only return important information that would be useful when searching or filtering notes.
      

Always follow the below rules, if any, given by the user:
${f.promptInstructions.enhanceFrontMatterPrompt}`,!0);console.log("frontmatter returned by enhanceNoteFrontMatter",i);try{let o=Br(i);if(typeof o!="object"||Array.isArray(o)||!o)throw new Error("Invalid YAML: Not an object");r.forEach(p=>{delete o[p]});let a=await k.parseMarkdown(e),c={...await Q(a),...o},l=await Qe(a,c);console.log("updatedNoteContent",l),await m.dispatch(l)}catch(o){console.error("Invalid YAML returned by enhanceNoteFrontMatter",o),await m.flashNotification("Error: Invalid Frontmatter YAML returned.","error");return}await m.flashNotification("Frontmatter enhanced successfully.","info")}async function en(){await Pt(),await St(),await vt()}async function tn(){let e=await Ae(),t=e.to;await O.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant in a markdown-based note tool."},{role:"user",content:e.text}],stream:!0},t)}async function rn(){await T();let e=await Qt();if(e.length===0){await m.flashNotification("Error: The page does not match the required format for a chat.");return}e.unshift(le);let t=await Ne(e);console.log("enrichedMessages",t);let r=await re();await m.insertAtPos(`

**assistant**: `,r),r+=17,await m.insertAtPos(`

**user**: `,r),await m.moveCursor(r+12);try{await O.streamChatIntoEditor({messages:t,stream:!0},r)}catch(n){console.error("Error streaming chat on page:",n),await m.flashNotification("Error streaming chat on page.","error")}}async function nn(){if(await T(),!f.imageModels||f.imageModels.length===0){await m.flashNotification("No image models available.","error");return}try{let e=await m.prompt("Enter a prompt for DALL\xB7E:");if(!e||!e.trim()){await m.flashNotification("No prompt entered. Operation cancelled.","error");return}let t={prompt:e,numImages:1,size:"1024x1024",quality:"hd"},r=await nt.generateImage(t);if(r&&r.data&&r.data.length>0){let n=r.data[0].b64_json,i=r.data[0].revised_prompt,o=new Uint8Array(ir(n)),a=`dall-e-${Date.now()}.png`,s=zt(await m.getCurrentPage())+"/";s==="/"&&(s=""),await F.writeAttachment(s+a,o);let c=`![${a}](${a})
*${i}*`;await m.insertAtCursor(c),await m.flashNotification("Image generated and inserted with caption successfully.")}else await m.flashNotification("Failed to generate image.","error")}catch(e){console.error("Error generating image with DALL\xB7E:",e),await m.flashNotification("Error generating image.","error")}}async function on(e,t){try{return await T(),await O.singleMessageChat(e,t||"You are an AI note assistant helping to render content for a note. Please follow user instructions and keep your response short and concise.")}catch(r){throw console.error("Error querying OpenAI:",r),r}}async function an(){await T();let e=await m.prompt("Enter some text to embed:");if(!e){await m.flashNotification("No text entered.","error");return}let t=await q.generateEmbeddings({text:e});await m.insertAtCursor(`

Embedding: ${t}`)}var sn={aiPromptSlashCommplete:Xt,queryAI:on,reloadConfig:Yr,summarizeNote:Xr,insertSummary:Zr,callOpenAI:Qr,tagNoteWithAI:Pt,promptAndGenerateImage:nn,streamOpenAIWithSelectionAsPrompt:tn,streamChatOnPage:rn,insertAiPromptFromTemplate:er,suggestPageName:vt,enhanceNoteFrontMatter:St,enhanceNoteWithAI:en,selectTextModel:Hr,selectImageModel:Vr,selectEmbeddingModel:zr,testEmbeddingGeneration:an,getAllEmbeddings:Xe,searchEmbeddings:et,indexEmbeddings:Dt,indexSummaryEmbeddings:_t,debugSearchEmbeddings:Wt,readPageSearchEmbeddings:Gt,writePageSearchEmbeddings:Bt,getPageMetaSearchEmbeddings:tt,searchCommand:Ht,updateSearchPage:Yt},cn={name:"silverbullet-ai",requiredPermissions:["fetch"],functions:{aiPromptSlashCommplete:{path:"src/prompts.ts:aiPromptSlashComplete",events:["slash:complete"]},queryAI:{path:"sbai.ts:queryAI"},reloadConfig:{path:"sbai.ts:reloadConfig",events:["page:saved"]},summarizeNote:{path:"sbai.ts:openSummaryPanel",command:{name:"AI: Summarize Note and open summary"}},insertSummary:{path:"sbai.ts:insertSummary",command:{name:"AI: Insert Summary"}},callOpenAI:{path:"sbai.ts:callOpenAIwithNote",command:{name:"AI: Call OpenAI with Note as context"}},tagNoteWithAI:{path:"sbai.ts:tagNoteWithAI",command:{name:"AI: Generate tags for note"}},promptAndGenerateImage:{path:"sbai.ts:promptAndGenerateImage",command:{name:"AI: Generate and insert image using DallE"}},streamOpenAIWithSelectionAsPrompt:{path:"sbai.ts:streamOpenAIWithSelectionAsPrompt",command:{name:"AI: Stream response with selection or note as prompt"}},streamChatOnPage:{path:"sbai.ts:streamChatOnPage",command:{name:"AI: Chat on current page",key:"Ctrl-Shift-Enter",mac:"Cmd-Shift-Enter"}},insertAiPromptFromTemplate:{path:"src/prompts.ts:insertAiPromptFromTemplate",command:{name:"AI: Execute AI Prompt from Custom Template"}},suggestPageName:{path:"sbai.ts:suggestPageName",command:{name:"AI: Suggest Page Name"}},enhanceNoteFrontMatter:{path:"sbai.ts:enhanceNoteFrontMatter",command:{name:"AI: Generate Note FrontMatter"}},enhanceNoteWithAI:{path:"sbai.ts:enhanceNoteWithAI",command:{name:"AI: Enhance Note"}},selectTextModel:{path:"sbai.ts:selectModelFromConfig",command:{name:"AI: Select Text Model from Config"}},selectImageModel:{path:"sbai.ts:selectImageModelFromConfig",command:{name:"AI: Select Image Model from Config"}},selectEmbeddingModel:{path:"sbai.ts:selectEmbeddingModelFromConfig",command:{name:"AI: Select Embedding Model from Config"}},testEmbeddingGeneration:{path:"sbai.ts:testEmbeddingGeneration",command:{name:"AI: Test Embedding Generation"}},getAllEmbeddings:{path:"src/embeddings.ts:getAllEmbeddings",env:"server"},searchEmbeddings:{path:"src/embeddings.ts:searchEmbeddings",env:"server"},indexEmbeddings:{path:"src/embeddings.ts:indexEmbeddings",env:"server",events:["page:index"]},indexSummaryEmbeddings:{path:"src/embeddings.ts:indexSummary",env:"server",events:["page:index"]},debugSearchEmbeddings:{path:"src/embeddings.ts:debugSearchEmbeddings",command:{name:"AI: Debug Search Embeddings"}},readPageSearchEmbeddings:{path:"src/embeddings.ts:readFileEmbeddings",pageNamespace:{pattern:"\u{1F916} .+",operation:"readFile"}},writePageSearchEmbeddings:{path:"src/embeddings.ts:writeFileEmbeddings",pageNamespace:{pattern:"\u{1F916} .+",operation:"writeFile"}},getPageMetaSearchEmbeddings:{path:"src/embeddings.ts:getFileMetaEmbeddings",pageNamespace:{pattern:"\u{1F916} .+",operation:"getFileMeta"}},searchCommand:{path:"src/embeddings.ts:searchCommand",command:{name:"AI: Search"}},updateSearchPage:{path:"src/embeddings.ts:updateSearchPage",events:["editor:pageLoaded","editor:pageReloaded"]}},assets:{}},rd={manifest:cn,functionMapping:sn};Et(sn,cn);export{rd as plug};
/*! Bundled license information:

js-yaml/dist/js-yaml.mjs:
  (*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT *)
*/
