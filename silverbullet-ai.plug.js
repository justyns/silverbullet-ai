var nn=Object.defineProperty;var G=(e,t)=>{for(var r in t)nn(e,r,{get:t[r],enumerable:!0})};function Vt(e){let t=atob(e),r=t.length,o=new Uint8Array(r);for(let n=0;n<r;n++)o[n]=t.charCodeAt(n);return o}function et(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let o=0;o<r;o++)t+=String.fromCharCode(e[o]);return btoa(t)}var be=e=>{throw new Error("Not initialized yet")},nt=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var rt=new Map,tt=0;nt&&(globalThis.syscall=async(e,...t)=>await new Promise((r,o)=>{tt++,rt.set(tt,{resolve:r,reject:o}),be({type:"sys",id:tt,name:e,args:t})}));function zt(e,t,r){nt&&(be=r,self.addEventListener("message",o=>{(async()=>{let n=o.data;switch(n.type){case"inv":{let i=e[n.name];if(!i)throw new Error(`Function not loaded: ${n.name}`);try{let s=await Promise.resolve(i(...n.args||[]));be({type:"invr",id:n.id,result:s})}catch(s){console.error("An exception was thrown as a result of invoking function",n.name,"error:",s.message),be({type:"invr",id:n.id,error:s.message})}}break;case"sysr":{let i=n.id,s=rt.get(i);if(!s)throw Error("Invalid request id");rt.delete(i),n.error?s.reject(new Error(n.error)):s.resolve(n.result)}break}})().catch(console.error)}),be({type:"manifest",manifest:t}))}async function on(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),o=r.length>0?et(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:o},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function sn(){globalThis.fetch=async function(e,t){let r=t&&t.body?et(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,o=await on(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(o.base64Body?Vt(o.base64Body):null,{status:o.status,headers:o.headers})}}nt&&sn();function ot(e){if(e.children)for(let t of e.children){if(t.parent)return;t.parent=e,ot(t)}}function Jt(e,t){return it(e,r=>r.type===t)}function it(e,t){if(t(e))return[e];let r=[];if(e.children)for(let o of e.children)r=[...r,...it(o,t)];return r}async function Xt(e,t){if(await t(e))return[e];let r=[];if(e.children)for(let o of e.children)r=[...r,...await Xt(o,t)];return r}async function st(e,t){if(e.children){let r=e.children.slice();for(let o of r){let n=await t(o);if(n!==void 0){let i=e.children.indexOf(o);n?e.children.splice(i,1,n):e.children.splice(i,1)}else await st(o,t)}}}function at(e,t){return it(e,r=>r.type===t)[0]}async function Zt(e,t){await Xt(e,t)}function j(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(j(r));return t.join("")}function an(e){return e.getUTCHours()===0&&e.getUTCMinutes()===0&&e.getUTCSeconds()===0?e.getUTCFullYear()+"-"+String(e.getUTCMonth()+1).padStart(2,"0")+"-"+String(e.getUTCDate()).padStart(2,"0"):e.toISOString()}function ne(e){if(!e||typeof e!="object")return e;if(Array.isArray(e))return e.map(ne);if(e instanceof Date)return an(e);let t={};for(let r of Object.keys(e)){let o=r.split("."),n=t;for(let i=0;i<o.length-1;i++){let s=o[i];n[s]||(n[s]={}),n=n[s]}n[o[o.length-1]]=ne(e[r])}return t}var p={};G(p,{alert:()=>Gn,configureVimMode:()=>co,confirm:()=>Bn,copyToClipboard:()=>ro,deleteLine:()=>no,dispatch:()=>qn,downloadFile:()=>On,filterBox:()=>Rn,flashNotification:()=>Nn,fold:()=>Qn,foldAll:()=>Jn,getCurrentEditor:()=>dn,getCurrentPage:()=>cn,getCurrentPageMeta:()=>ln,getCurrentPath:()=>un,getCursor:()=>gn,getRecentlyOpenedPages:()=>pn,getSelection:()=>hn,getText:()=>mn,getUiOption:()=>Yn,goHistory:()=>In,hidePanel:()=>Fn,insertAtCursor:()=>Hn,insertAtPos:()=>_n,invokeCommand:()=>bn,isMobile:()=>uo,moveCursor:()=>Un,moveCursorToLine:()=>jn,moveLineDown:()=>so,moveLineUp:()=>io,navigate:()=>wn,newWindow:()=>Mn,openCommandPalette:()=>Pn,openPageNavigator:()=>An,openSearchPanel:()=>to,openUrl:()=>Tn,prompt:()=>Kn,rebuildEditorState:()=>vn,redo:()=>eo,reloadConfigAndCommands:()=>Cn,reloadPage:()=>Sn,reloadUI:()=>En,replaceRange:()=>Dn,save:()=>xn,sendMessage:()=>lo,setSelection:()=>yn,setText:()=>fn,setUiOption:()=>Wn,showPanel:()=>Ln,showProgress:()=>$n,toggleComment:()=>oo,toggleFold:()=>zn,undo:()=>Zn,unfold:()=>Vn,unfoldAll:()=>Xn,uploadFile:()=>kn,vimEx:()=>ao});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});function l(e,...t){return globalThis.syscall(e,...t)}function cn(){return l("editor.getCurrentPage")}function ln(){return l("editor.getCurrentPageMeta")}function un(){return l("editor.getCurrentPath")}function pn(){return l("editor.getRecentlyOpenedPages")}function dn(){return l("editor.getCurrentEditor")}function mn(){return l("editor.getText")}function fn(e,t=!1){return l("editor.setText",e,t)}function gn(){return l("editor.getCursor")}function hn(){return l("editor.getSelection")}function yn(e,t){return l("editor.setSelection",e,t)}function bn(e,t){return l("editor.invokeCommand",e,t)}function xn(){return l("editor.save")}function wn(e,t=!1,r=!1){return l("editor.navigate",e,t,r)}function An(e="page"){return l("editor.openPageNavigator",e)}function Pn(){return l("editor.openCommandPalette")}function Sn(){return l("editor.reloadPage")}function En(){return l("editor.reloadUI")}function vn(){return l("editor.rebuildEditorState")}function Cn(){return l("editor.reloadConfigAndCommands")}function Tn(e,t=!1){return l("editor.openUrl",e,t)}function Mn(){return l("editor.newWindow")}function In(e){return l("editor.goHistory",e)}function On(e,t){return l("editor.downloadFile",e,t)}function kn(e,t){return l("editor.uploadFile",e,t)}function Nn(e,t="info"){return l("editor.flashNotification",e,t)}function Rn(e,t,r="",o=""){return l("editor.filterBox",e,t,r,o)}function Ln(e,t,r,o=""){return l("editor.showPanel",e,t,r,o)}function Fn(e){return l("editor.hidePanel",e)}function $n(e,t){return l("editor.showProgress",e,t)}function _n(e,t){return l("editor.insertAtPos",e,t)}function Dn(e,t,r){return l("editor.replaceRange",e,t,r)}function Un(e,t=!1){return l("editor.moveCursor",e,t)}function jn(e,t=1,r=!1){return l("editor.moveCursorToLine",e,t,r)}function Hn(e,t=!1,r=!1){return l("editor.insertAtCursor",e,t,r)}function qn(e){return l("editor.dispatch",e)}function Kn(e,t=""){return l("editor.prompt",e,t)}function Bn(e){return l("editor.confirm",e)}function Gn(e){return l("editor.alert",e)}function Yn(e){return l("editor.getUiOption",e)}function Wn(e,t){return l("editor.setUiOption",e,t)}function Qn(){return l("editor.fold")}function Vn(){return l("editor.unfold")}function zn(){return l("editor.toggleFold")}function Jn(){return l("editor.foldAll")}function Xn(){return l("editor.unfoldAll")}function Zn(){return l("editor.undo")}function eo(){return l("editor.redo")}function to(){return l("editor.openSearchPanel")}function ro(e){return l("editor.copyToClipboard",e)}function no(){return l("editor.deleteLine")}function oo(){return l("editor.toggleComment")}function io(){return l("editor.moveLineUp")}function so(){return l("editor.moveLineDown")}function ao(e){return l("editor.vimEx",e)}function co(){return l("editor.configureVimMode")}function lo(e,t){return l("editor.sendMessage",e,t)}function uo(){return l("editor.isMobile")}var T={};G(T,{expandMarkdown:()=>fo,markdownToHtml:()=>go,parseMarkdown:()=>po,renderParseTree:()=>mo});function po(e){return l("markdown.parseMarkdown",e)}function mo(e){return l("markdown.renderParseTree",e)}function fo(e){return l("markdown.expandMarkdown",e)}function go(e){return l("markdown.markdownToHtml",e)}var F={};G(F,{deleteDocument:()=>To,deleteFile:()=>No,deletePage:()=>Ao,fileExists:()=>Ro,getDocumentMeta:()=>Eo,getFileMeta:()=>Oo,getPageMeta:()=>yo,listDocuments:()=>So,listFiles:()=>Mo,listPages:()=>ho,listPlugs:()=>Po,pageExists:()=>bo,readDocument:()=>vo,readFile:()=>Io,readPage:()=>xo,writeDocument:()=>Co,writeFile:()=>ko,writePage:()=>wo});function ho(){return l("space.listPages")}function yo(e){return l("space.getPageMeta",e)}function bo(e){return l("space.pageExists",e)}function xo(e){return l("space.readPage",e)}function wo(e,t){return l("space.writePage",e,t)}function Ao(e){return l("space.deletePage",e)}function Po(){return l("space.listPlugs")}function So(){return l("space.listDocuments")}function Eo(e){return l("space.getDocumentMeta",e)}function vo(e){return l("space.readDocument",e)}function Co(e,t){return l("space.writeDocument",e,t)}function To(e){return l("space.deleteDocument",e)}function Mo(){return l("space.listFiles")}function Io(e){return l("space.readFile",e)}function Oo(e){return l("space.getFileMeta",e)}function ko(e,t){return l("space.writeFile",e,t)}function No(e){return l("space.deleteFile",e)}function Ro(e){return l("space.fileExists",e)}var I={};G(I,{cleanDatabases:()=>Ko,getConfig:()=>Ho,getMode:()=>Uo,getVersion:()=>jo,invokeCommand:()=>Fo,invokeFunction:()=>Lo,listCommands:()=>$o,listSyscalls:()=>_o,reloadPlugs:()=>Do,wipeClient:()=>qo});function Lo(e,...t){return l("system.invokeFunction",e,...t)}function Fo(e,t){return l("system.invokeCommand",e,t)}function $o(){return l("system.listCommands")}function _o(){return l("system.listSyscalls")}function Do(){return l("system.reloadPlugs")}function Uo(){return l("system.getMode")}function jo(){return l("system.getVersion")}function Ho(e,t=void 0){return l("system.getConfig",e,t)}function qo(e=!1){return l("system.wipeClient",e)}function Ko(){return l("system.cleanDatabases")}var J={};G(J,{del:()=>Yo,get:()=>Go,set:()=>Bo});function Bo(e,t){return l("clientStore.set",e,t)}function Go(e){return l("clientStore.get",e)}function Yo(e){return l("clientStore.delete",e)}var ra=new Uint8Array(16);var Te={};G(Te,{dispatchEvent:()=>Jo,listEvents:()=>Xo});function Jo(e,t,r){return new Promise((o,n)=>{let i=-1;r&&(i=setTimeout(()=>{console.log("Timeout!"),n("timeout")},r)),l("event.dispatch",e,t).then(s=>{i!==-1&&clearTimeout(i),o(s)}).catch(n)})}function Xo(){return l("event.listEvents")}var Y={};G(Y,{parse:()=>ei,stringify:()=>ti});function ei(e){return l("yaml.parse",e)}function ti(e){return l("yaml.stringify",e)}var oe={};G(oe,{ack:()=>ii,awaitEmptyQueue:()=>ci,batchAck:()=>si,batchSend:()=>ni,flushQueue:()=>oi,getQueueStats:()=>ai,send:()=>ri});function ri(e,t){return l("mq.send",e,t)}function ni(e,t){return l("mq.batchSend",e,t)}function oi(e){return l("mq.flushQueue",e)}function ii(e,t){return l("mq.ack",e,t)}function si(e,t){return l("mq.batchAck",e,t)}function ai(e){return l("mq.getQueueStats",e)}function ci(e){return l("mq.awaitEmptyQueue",e)}var Z={};G(Z,{evalExpression:()=>mi,parse:()=>pi,parseExpression:()=>di});function pi(e){return l("lua.parse",e)}function di(e){return l("lua.parseExpression",e)}function mi(e){return l("lua.evalExpression",e)}var H={};G(H,{ensureFullIndex:()=>bi,getObjectByRef:()=>yi,indexObjects:()=>gi,queryLuaObjects:()=>hi});function gi(e,t){return l("index.indexObjects",e,t)}function hi(e,t,r){return l("index.queryLuaObjects",e,t,r)}function yi(e,t,r){return l("index.getObjectByRef",e,t,r)}function bi(){return l("index.ensureFullIndex")}var xi=/(?<leadingTrivia>!?\[\[)(?<stringRef>.*?)(?:\|(?<alias>.*?))?(?<trailingTrivia>\]\])/g;var ba=new RegExp("^"+xi.source);function er(e){return e[0]!=="#"?(console.error("extractHashtag called on already clean string",e),e):e[1]==="<"?e.slice(-1)!==">"?e.slice(2):e.slice(2,-1):e.slice(1)}async function ie(e,t={}){let r={tags:[]},o=[];ot(e),await st(e,async n=>{if(n.type==="Paragraph"&&n.parent?.type==="Document"){let i=!0,s=new Set;for(let a of n.children)if(a.text){if(a.text.startsWith(`
`)&&a.text!==`
`)break;if(a.text.trim()){i=!1;break}}else if(a.type==="Hashtag"){let c=er(a.children[0].text);s.add(c),(t.removeTags===!0||t.removeTags?.includes(c))&&(a.children[0].text="")}else if(a.type){i=!1;break}i&&o.push(...s)}if(n.type==="FrontMatter"){let i=n.children[1].children[0],s=j(i);try{let a=ne(await Y.parse(s)),c={...a};if(r={...r,...a},r.tags||(r.tags=[]),typeof r.tags=="string"&&o.push(...r.tags.split(/,\s*|\s+/)),Array.isArray(r.tags)&&o.push(...r.tags),t.removeKeys&&t.removeKeys.length>0){let u=!1;for(let m of t.removeKeys)m in c&&(delete c[m],u=!0);u&&(i.text=await Y.stringify(c))}if(Object.keys(c).length===0||t.removeFrontMatterSection)return null}catch{}}});try{r.tags=[...new Set([...o.map(n=>String(n).replace(/^#/,""))])]}catch(n){console.error("Error while processing tags",n)}return r=ne(r),r}async function tr(){let e=await p.getSelection(),t="";return e.from===e.to?t="":t=(await p.getText()).slice(e.from,e.to),{from:e.from,to:e.to,text:t}}async function se(){return(await p.getText()).length}function ct(e,t){let r=e.split(`
`),o=0;for(let n=0;n<r.length;n++){if(o<=t&&t<o+r[n].length+1)return n;o+=r[n].length+1}return-1}function lt(e,t){let r=e.split(`
`);return t<0||t>=r.length?"":r[t]}function rr(e,t){let r=ct(e,t);return lt(e,r)}function nr(e,t){let r=ct(e,t);return lt(e,r-1)}function or(e,t){let r=ct(e,t);return lt(e,r+1)}async function ut(e){let t=await p.getText(),r=await T.parseMarkdown(t),o=Jt(r,"FrontMatter"),n;if(o.length>0){let i=o[0].children[1].children[0];i.text=await Y.stringify(e),n=j(r)}else n=`---
${await Y.stringify(e)}---
${t}`;await p.setText(n)}function ir(e,t){let r=e.split(`
`),o=0,n=0,i=e.length;for(let s=0;s<r.length;s++){let a=r[s].length+1;if(o<=t&&t<o+a){console.log("Looking backwards for the start of the paragraph");for(let c=s;c>=0;c--)if(c===0||r[c-1].trim()===""){n=c===0?0:r.slice(0,c).join(`
`).length+1;break}console.log("Looking forwards for the end of the paragraph");for(let c=s;c<r.length;c++)if(c===r.length-1||r[c+1].trim()===""){i=r.slice(0,c+1).join(`
`).length;break}break}o+=a}return console.log("Found paragraph",e.slice(n,i)),{from:n,to:i,text:e.slice(n,i)}}var wi=globalThis.nativeFetch,pe=class{apiKey;baseUrl;name;modelName;requireAuth;useProxy;constructor(t,r,o,n,i=!0,s=!0){this.apiKey=t,this.baseUrl=r,this.name=o,this.modelName=n,this.requireAuth=i,this.useProxy=s}fetch(t,r){return this.useProxy?fetch(t,r):wi(t,r)}};var Me=class extends pe{constructor(t,r,o,n=!0){super(t,o,"DALL-E",r,!0,n)}async generateImage(t){try{E||await ae();let r=await this.fetch(`${this.baseUrl}/images/generations`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.modelName,prompt:t.prompt,n:t.numImages,size:t.size,quality:t.quality,response_format:"b64_json"})});if(!r.ok)throw new Error(`HTTP error, status: ${r.status}`);let o=await r.json();if(!o||o.length===0)throw new Error("Invalid response from DALL-E.");return o}catch(r){throw console.error("Error calling DALL\xB7E image generation endpoint:",r),r}}};var ce=function(e,t){if(!(this instanceof ce))return new ce(e,t);this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.url=e,t=t||{},this.headers=t.headers||{},this.payload=t.payload!==void 0?t.payload:"",this.method=t.method||this.payload&&"POST"||"GET",this.withCredentials=!!t.withCredentials,this.debug=!!t.debug,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=this.INITIALIZING,this.progress=0,this.chunk="",this.addEventListener=function(r,o){this.listeners[r]===void 0&&(this.listeners[r]=[]),this.listeners[r].indexOf(o)===-1&&this.listeners[r].push(o)},this.removeEventListener=function(r,o){if(this.listeners[r]!==void 0){var n=[];this.listeners[r].forEach(function(i){i!==o&&n.push(i)}),n.length===0?delete this.listeners[r]:this.listeners[r]=n}},this.dispatchEvent=function(r){if(!r)return!0;this.debug&&console.debug(r),r.source=this;var o="on"+r.type;return this.hasOwnProperty(o)&&(this[o].call(this,r),r.defaultPrevented)?!1:this.listeners[r.type]?this.listeners[r.type].every(function(n){return n(r),!r.defaultPrevented}):!0},this._setReadyState=function(r){var o=new CustomEvent("readystatechange");o.readyState=r,this.readyState=r,this.dispatchEvent(o)},this._onStreamFailure=function(r){var o=new CustomEvent("error");o.data=r.currentTarget.response,this.dispatchEvent(o),this.close()},this._onStreamAbort=function(r){this.dispatchEvent(new CustomEvent("abort")),this.close()},this._onStreamProgress=function(r){if(this.xhr){if(this.xhr.status!==200){this._onStreamFailure(r);return}this.readyState==this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));var o=this.xhr.responseText.substring(this.progress);this.progress+=o.length;var n=(this.chunk+o).split(/(\r\n\r\n|\r\r|\n\n)/g),i=n.pop();n.forEach(function(s){s.trim().length>0&&this.dispatchEvent(this._parseEventChunk(s))}.bind(this)),this.chunk=i}},this._onStreamLoaded=function(r){this._onStreamProgress(r),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""},this._parseEventChunk=function(r){if(!r||r.length===0)return null;this.debug&&console.debug(r);var o={id:null,retry:null,data:null,event:null};r.split(/\n|\r\n|\r/).forEach(function(i){var s=i.indexOf(this.FIELD_SEPARATOR),a,c;if(s>0){var u=i[s+1]===" "?2:1;a=i.substring(0,s),c=i.substring(s+u)}else if(s<0)a=i,c="";else return;a in o&&(a==="data"&&o[a]!==null?o.data+=`
`+c:o[a]=c)}.bind(this));var n=new CustomEvent(o.event||"message");return n.data=o.data||"",n.id=o.id,n},this._checkStreamClosed=function(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)},this.stream=function(){if(!this.xhr){this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(var r in this.headers)this.xhr.setRequestHeader(r,this.headers[r]);this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))},(t.start===void 0||t.start)&&this.stream()};typeof exports<"u"&&(exports.SSE=ce);var sr={};function Ie(e,t){sr[e]=t}function Oe(e){return sr[e]}async function ke(...e){let t=e.join(""),r=new TextEncoder().encode(t),o=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(o)).map(s=>s.toString(16).padStart(2,"0")).join("")}var Ai=globalThis.nativeFetch,W=class{apiKey;baseUrl;name;modelName;requireAuth;useProxy;constructor(t,r,o,n,i=!0,s=!0){this.apiKey=t,this.baseUrl=r,this.name=o,this.modelName=n,this.requireAuth=i,this.useProxy=s}fetch(t,r){return this.useProxy?fetch(t,r):Ai(t,r)}async generateEmbeddings(t){let r=await ke(this.modelName,t.text),o=Oe(r);if(o)return o;let n=await this._generateEmbeddings(t);return Ie(r,n),n}};async function cr(e){let t={};return await Zt(e,async r=>{if(e!==r&&r.type==="ListItem")return!0;if(r.type==="Attribute"){let o=at(r,"AttributeName"),n=at(r,"AttributeValue");if(o&&n){let i=o.children[0].text,s=n.children[0].text;try{t[i]=ne(await Y.parse(s))}catch(a){console.error("Error parsing attribute value as YAML",s,a)}}return!0}return!1}),t}var Pi="\u{1F916} ",lr=new Map;function xe(e){return!(["SETTINGS","SECRETS",...g.indexEmbeddingsExcludePages].includes(e)||e.startsWith("_")||e.startsWith("Library/")||/\.conflicted\.\d+$/.test(e))}async function ur(){return await v(),g.indexEmbeddings&&O!==void 0&&Ae!==void 0&&g.embeddingModels.length>0}async function pr(){return await v(),g.indexEmbeddings&&g.indexSummary&&O!==void 0&&Ae!==void 0&&g.embeddingModels.length>0}async function Si(e){if(!await ur()||!xe(e))return;let t=await F.readPage(e),r=await T.parseMarkdown(t);if(!r.children)return;let o=r.children.filter(c=>c.type==="Paragraph"),n=[],i=Date.now();for(let c of o){let u=j(c).trim();if(!u||u.length<10||g.indexEmbeddingsExcludeStrings.some(h=>u.includes(h)))continue;let m=await O.generateEmbeddings({text:u}),d=c.from??0,f={ref:`${e}@${d}`,page:e,pos:d,embedding:m,text:u,tag:"embedding"};n.push(f)}await H.indexObjects(e,n);let a=(Date.now()-i)/1e3;k(`AI: Indexed ${n.length} embedding objects for page ${e} in ${a} seconds`)}async function Ei(e){if(!await pr()||!xe(e))return;let t=await F.readPage(e),r=await T.parseMarkdown(t);if(!r.children)return;let o=Date.now(),n=j(r),i=g.textModels.find(y=>y.name===g.indexSummaryModelName);if(!i)throw new Error(`Could not find summary model ${g.indexSummaryModelName}`);let s=await le(i),a;g.promptInstructions.indexSummaryPrompt!==""?a=g.promptInstructions.indexSummaryPrompt:a=`Provide a concise and informative summary of the above page. The summary should capture the key points and be useful for search purposes. Avoid any formatting or extraneous text.  No more than one paragraph.  Summary:
`;let c=await ke(i.name,n,a),u=Oe(c);u||(u=await s.singleMessageChat("Contents of "+e+`:
`+n+`

`+a),Ie(c,u));let m=await O.generateEmbeddings({text:u}),d={ref:`${e}@0`,page:e,embedding:m,text:u,tag:"aiSummary"};await H.indexObjects(e,[d]);let h=(Date.now()-o)/1e3;k(`AI: Indexed summary for page ${e} in ${h} seconds`)}async function dr({name:e,tree:t}){await v(),xe(e)&&t.children&&(await ur()&&await oe.send("aiEmbeddingsQueue",e),await pr()&&await oe.send("aiSummaryQueue",e))}async function mr(e){await v();for(let r of e){let o=r.body;console.log(`AI: Generating and indexing embeddings for file ${o}`),await Si(o)}let t=await oe.getQueueStats("aiEmbeddingsQueue");console.log(`AI: Embeddings queue stats: ${JSON.stringify(t)}`)}async function fr(e){await v();for(let r of e){let o=r.body;console.log(`AI: Generating and indexing summary for ${o}`),await Ei(o)}let t=await oe.getQueueStats("aiSummaryQueue");console.log(`AI: Summary queue stats: ${JSON.stringify(t)}`)}async function dt(){return await H.queryLuaObjects("embedding",{})}async function gr(){return await H.queryLuaObjects("aiSummary",{})}async function we(e){if(await v(),!O||!Ae)throw new Error("No embedding provider found");return await O.generateEmbeddings({text:e})}function pt(e,t){let r=e.reduce((i,s,a)=>i+s*t[a],0),o=Math.sqrt(e.reduce((i,s)=>i+s*s,0)),n=Math.sqrt(t.reduce((i,s)=>i+s*s,0));return r/(o*n)}async function mt(e,t=10,r=!1){await v();let o=Date.now(),n=typeof e=="string"?await we(e):e,i=Date.now();console.log(`searchEmbeddings: Query embedding generation took ${i-o} ms`);let s=Date.now(),a=await dt(),c=Date.now();console.log(`Retrieved ${a.length} embeddings in ${c-s} ms`);let u="",m=0;r&&(u=`Retrieved ${a.length} embeddings in ${c-s} ms

`,m=(await p.getText()).length,await p.replaceRange(m,m,u));let d=[],f=Date.now();for(let h=0;h<a.length;h++){let y=a[h];if(xe(y.page)){if(d.push({page:y.page,ref:y.ref,text:y.text,similarity:pt(n,y.embedding)}),r&&(h%100===0||Date.now()-f>=100)){let S=m+u.length;u=`

Processed ${h+1} of ${a.length} embeddings...

`,await p.replaceRange(m,S,u),f=Date.now()}if(r&&h>=a.length-1){let S=m+u.length;await p.replaceRange(m,S,"")}}}if(console.log(`Finished searching embeddings in ${Date.now()-s} ms`),g.indexSummary){let h=Date.now(),y=await gr(),S=Date.now();console.log(`Retrieved ${y.length} summaries in ${S-h} ms`);let w="",D=0;r&&(w=`Retrieved ${y.length} summaries in ${S-h} ms

`,D=(await p.getText()).length,await p.replaceRange(D,D,w));let R=[],L=Date.now();for(let U=0;U<y.length;U++){let K=y[U];if(xe(K.page)){if(R.push({page:K.page,ref:K.ref,text:`Page Summary: ${K.text}`,similarity:pt(n,K.embedding)}),r&&(U%100===0||Date.now()-L>=100)){let P=D+w.length;w=`

Processed ${U+1} of ${y.length} summaries...

`,await p.replaceRange(D,P,w),L=Date.now()}if(r&&U>=y.length-1){let P=D+w.length;await p.replaceRange(D,P,"")}}}console.log(`Finished searching summaries in ${Date.now()-h} ms`),d.push(...R)}return d.sort((h,y)=>y.similarity-h.similarity).slice(0,t)}async function hr(e,t=10){await v();let r=await we(e);return(await gr()).map(i=>({page:i.page,ref:i.ref,text:i.text,similarity:pt(r,i.embedding)})).sort((i,s)=>s.similarity-i.similarity).slice(0,t)}async function Ne(e,t=10,r=.15,o=!1){let n=await mt(e,-1,o),i={};for(let a of n)a.similarity<r||(i[a.page]?(i[a.page].score+=a.similarity,i[a.page].children.push(a)):i[a.page]={page:a.page,score:a.similarity,children:[a]});for(let a in i)i[a].children=i[a].children.sort((c,u)=>u.similarity-c.similarity).slice(0,t);return Object.values(i).sort((a,c)=>c.score-a.score).slice(0,t)}async function Re(e,t=10){try{let r=await Ne(e,t),o="";if(r.length>0)for(let n of r){o+=`>>${n.page}<<
`;for(let i of n.children)o+=`> ${i.text}

`}else return"No relevant pages found.";return o}catch(r){return console.error("Error in searchEmbeddingsForChat:",r),"An error occurred during the search."}}async function vi(e){await v(),await p.showPanel("modal",20,`<style>
      .ai-modal-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 10px;
        box-sizing: border-box;
      }
      .ai-modal {
        padding: 24px 32px;
        text-align: center;
        background: var(--editor-background-color, var(--root-background-color, Canvas));
        color: var(--editor-text-color, var(--root-text-color, CanvasText));
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 400px;
        width: 100%;
      }
      .ai-modal h3 { margin-top: 0; }
      .ai-modal p { margin-bottom: 0; }
    </style>
    <div class="ai-modal-wrapper">
      <div class="ai-modal">
        <h3>\u{1F916} Searching...</h3>
        <p>Searching for "${e}"</p>
      </div>
    </div>`);let r=`# Search results for "${e}"`+`

`;try{if(!g.indexEmbeddings)return r+=`> **warning** Embeddings generation is disabled.
`,r+=`> You can enable it in the AI settings.

`,r;let o=[];try{o=await we(e)}catch(i){return console.error("Error generating query vector embeddings",i),r+=`> **error** \u26A0\uFE0F Failed to generate query vector embeddings.
`,r+=`> ${i}

`,r}let n=[];try{n=await Ne(o,void 0,void 0,!0)}catch(i){return console.error("Error searching embeddings",i),r+=`> **error** \u26A0\uFE0F Failed to search through embeddings.
`,r+=`> ${i}

`,r}if(n.length===0)r+=`No results found.

`;else for(let i of n){r+=`## [[${i.page}]]
`;for(let s of i.children){let c=s.ref.split("@")[1].padStart(4," ");r+=`> [[${s.ref}|${c}]] | ${s.text}
`}}return r}finally{await p.hidePanel("modal")}}function yr(e){let t=lr.get(e);return t||`# Search results for "${e}"

> \u2139\uFE0F No search results available.

Use the **AI: Search** command to search.
`}async function br(){let e=await p.prompt("Search for: ");if(e){let t=await vi(e);lr.set(e,t),await p.navigate(`${Pi}${e}`)}}function xr(e){return e.split("/").slice(0,-1).join("/")}function k(...e){console.log(...e)}async function Le(e){e||(e=await p.getText());let t=await T.parseMarkdown(e);await ie(t,{removeFrontMatterSection:!0}),e=j(t);let r=e.split(`
`),o=[],n="user",i="";return r.forEach(s=>{if(s.trim()==="")return;let a=s.match(/^\*\*(\w+)\*\*:/);if(a){let c=a[1].toLowerCase();n&&n!==c&&i.trim()!==""&&(o.push({role:n,content:i.trim()}),i=""),n=c,i+=s.replace(/^\*\*(\w+)\*\*:/,"").trim()+`
`}else n&&(i+=s.trim()+`
`)}),i&&n&&o.push({role:n,content:i.trim()}),o}async function de(e,t){let r=[],o,n;try{o=await p.getCurrentPage(),n=await F.getPageMeta(o)}catch(i){return console.error("Error fetching page metadata",i),await p.flashNotification("Error fetching page metadata","error"),[]}for(let i of e){if(i.role==="assistant"||i.role==="system"){r.push(i);continue}let s=await T.parseMarkdown(i.content),a=await cr(s);if(i.content=i.content.replace(/\[enrich:\s*(false|true)\s*\]\s*/g,""),a.enrich!==void 0&&a.enrich===!1){console.log("Skipping message enrichment due to enrich=false attribute",a),r.push(i);continue}let c=i.content;if(i.role==="user")if(n){console.log("Rendering template",i.content,n);try{let f=await T.parseMarkdown(i.content),h=await T.expandMarkdown(f);c=j(h).trim(),console.log("Message template expanded successfully via markdown system")}catch(f){console.error("Message template expansion failed:",f),console.error("Failed content:",i.content),console.error("Page metadata:",n),c=i.content}}else console.log("No page metadata found, skipping template rendering");if(g.chat.searchEmbeddings&&g.indexEmbeddings){let f=await Re(c);f!=="No relevant pages found."&&(c+=`

The following pages were found to be relevant to the question. You can use them as context to answer the question. Only partial content is shown. Ask for the whole page if needed. Page name is between >> and <<.
`,c+=f)}if(g.chat.parseWikiLinks&&(c=await Ci(c)),g.chat.bakeMessages){let f=await T.parseMarkdown(c),h=await T.expandMarkdown(f);c=j(h).trim()}let m=(await Te.dispatchEvent("ai:enrichMessage",{enrichedContent:c,message:i})).flat().concat(g.chat.customEnrichFunctions),d=[...new Set(m)];console.log("Received custom enrich message functions",d);for(let f of d)c=await I.invokeFunction(f,c);r.push({...i,content:c})}return r}async function Ci(e){let t=[],r=e,o=/\[\[([^\]]+)\]\]/g,n,i=!1;for(;(n=o.exec(e))!==null;){let s=n[1];if(!t.includes(s)){i||(r+=`

Base your answer on the content of the following referenced pages (referenced above using the >>page name<< format). In these listings ~~~ is used to mark the page's content start and end. If context is missing, always ask me to link directly to a page mentioned in the context.`,i=!0);try{let a=await F.readPage(s);t.push(s),r+=`

Content of the [[${s}]] page:
~~~
${a}
~~~
`}catch(a){console.error(`Error fetching page '${s}':`,a)}}}return r=r.replace(o,">>$1<<"),r}function Fe(e){let t={"X-Proxy-Request":"true"};if(!e)return t;for(let[r,o]of Object.entries(e))t[`X-Proxy-Header-${r}`]=o;return t}function $e(e){return`/.proxy/${e.replace(/^https?:\/\//,"")}`}var Ti=globalThis.nativeFetch,Q=class{name;apiKey;baseUrl;modelName;useProxy;constructor(t,r,o,n,i=!0){this.name=t,this.apiKey=r,this.baseUrl=o,this.modelName=n,this.useProxy=i}fetch(t,r){return this.useProxy?fetch(t,r):Ti(t,r)}async streamChatIntoEditor(t,r){let{onDataReceived:o,onResponseComplete:n,postProcessors:i}=t,s="\u{1F914} Thinking \u2026 ",a=r??await se();await p.insertAtPos(s,a);let c=!0,u=a,m=f=>{try{if(!f){console.log("No data received from LLM");return}c?(["`","-","*"].includes(f.charAt(0))&&(f=`
`+f),p.replaceRange(a,a+s.length,f),c=!1):p.insertAtPos(f,a),a+=f.length,o&&o(f)}catch(h){console.error("Error handling chat stream data:",h),p.flashNotification("An error occurred while processing chat data.","error")}},d=async f=>{console.log("Response complete:",f);let h=u+f.length;console.log("Start of response:",u),console.log("End of response:",h),console.log("Full response:",f),console.log("Post-processors:",i);let y=f;if(i){let S=await p.getText(),w={response:f,lineBefore:nr(S,u),lineCurrent:rr(S,u),lineAfter:or(S,h)};for(let D of i)console.log("Applying post-processor:",D),y=await I.invokeFunction(D,w);console.log("Data changed by post-processors, updating editor"),p.replaceRange(u,h,y)}n&&n(f)};await this.chatWithAI({...t,onDataReceived:m,onResponseComplete:d})}async singleMessageChat(t,r,o=!1){let n=[{role:"user",content:t}];return r&&n.unshift({role:"system",content:r}),o&&(n=await de(n)),await this.chatWithAI({messages:n,stream:!1})}};var _e=class extends Q{name="Gemini";constructor(t,r,o=!0){super("Gemini",t,"https://generativelanguage.googleapis.com",r,o)}async listModels(){let t=`${this.baseUrl}/v1beta/models?key=${this.apiKey}`;try{let r=await this.fetch(t,{method:"GET"});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).models||[]}catch(r){throw console.error("Failed to fetch models:",r),r}}async chatWithAI({messages:t,stream:r,onDataReceived:o}){return r?await this.streamChat({messages:t,stream:r,onDataReceived:o}):await this.nonStreamingChat(t)}mapRolesForGemini(t){let r=[],o="";return t.forEach(n=>{let i="user";n.role==="system"||n.role==="user"?i="user":n.role==="assistant"&&(i="model"),i==="model"&&(r.length===0||o==="model")||(i==="user"&&o==="user"?r[r.length-1].parts[0].text+=" "+n.content:r.push({role:i,parts:[{text:n.content}]})),o=i}),r}streamChat(t){let{messages:r,onDataReceived:o}=t;try{let n=`${this.baseUrl}/v1beta/models/${this.modelName}:streamGenerateContent?key=${this.apiKey}&alt=sse`,i={"Content-Type":"application/json"},s=this.useProxy?$e(n):n,a=this.useProxy?Fe(i):i,c=this.mapRolesForGemini(r),u={method:"POST",headers:a,payload:JSON.stringify({contents:c}),withCredentials:!1},m=new ce(s,u),d="";m.addEventListener("message",f=>{try{if(f.data=="[DONE]")return m.close(),d;if(!f.data)console.error("Received empty message from Gemini"),console.log("source: ",m);else{let h=JSON.parse(f.data),y=h.candidates[0].content.parts[0].text||h.text||"";d+=y,o&&o(y)}}catch(h){console.error("Error processing message event:",h,f.data)}}),m.addEventListener("end",()=>(m.close(),d)),m.addEventListener("error",f=>{console.error("SSE error:",f),m.close()}),m.stream()}catch(n){throw console.error("Error streaming from Gemini chat endpoint:",n),n}}async nonStreamingChat(t){let r=this.mapRolesForGemini(t),o=await this.fetch(`${this.baseUrl}/v1beta/models/${this.modelName}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:r})});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);return(await o.json()).candidates[0].content.parts[0].text}},De=class extends W{constructor(t,r,o="https://generativelanguage.googleapis.com",n=!0,i=!0){super(t,o,"Gemini",r,n,i)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,content:{parts:[{text:t.text}]}}),o={"Content-Type":"application/json"};this.requireAuth&&(o.Authorization=`Bearer ${this.apiKey}`);let n=await this.fetch(`${this.baseUrl}/v1beta/models/${this.modelName}:embedContent?key=${this.apiKey}`,{method:"POST",headers:o,body:r});if(!n.ok)throw console.error("HTTP response: ",n),console.error("HTTP response body: ",await n.json()),new Error(`HTTP error, status: ${n.status}`);let i=await n.json();if(!i||!i.embedding||!i.embedding.values)throw new Error("Invalid response from Gemini.");return i.embedding.values}};var me=class extends Q{name="OpenAI";requireAuth;constructor(t,r,o,n,i=!0){super("OpenAI",t,o,r,i),this.requireAuth=n}async chatWithAI({messages:t,stream:r,onDataReceived:o,onResponseComplete:n}){return r?await this.streamChat({messages:t,onDataReceived:o,onResponseComplete:n}):await this.nonStreamingChat(t)}async streamChat(t){let{messages:r,onDataReceived:o,onResponseComplete:n}=t;try{let i={"Content-Type":"application/json"};this.requireAuth&&(i.Authorization=`Bearer ${this.apiKey}`);let s=this.useProxy?$e(`${this.baseUrl}/chat/completions`):`${this.baseUrl}/chat/completions`,c={method:"POST",headers:this.useProxy?Fe(i):i,payload:JSON.stringify({model:this.modelName,stream:!0,messages:r}),withCredentials:!1},u=new ce(s,c),m="";u.addEventListener("message",function(d){try{if(d.data=="[DONE]")return u.close(),n&&n(m),m;{let h=JSON.parse(d.data).choices[0]?.delta?.content||"";m+=h,o&&o(h)}}catch(f){console.error("Error processing message event:",f,d.data)}}),u.addEventListener("end",function(){return u.close(),n&&n(m),m}),u.addEventListener("error",d=>{console.error("SSE error sseEvent.data:",d.data," ssEventObj:",d),u.close()}),u.stream()}catch(i){throw console.error("Error streaming from OpenAI chat endpoint:",i),await p.flashNotification("Error streaming from OpenAI chat endpoint.","error"),i}return""}async listModels(){try{let t={"Content-Type":"application/json"};this.requireAuth&&(t.Authorization=`Bearer ${this.apiKey}`);let r=await this.fetch(`${this.baseUrl}/models`,{method:"GET",headers:t});if(!r.ok)throw console.error("HTTP response: ",r),console.error("HTTP response body: ",await r.json()),new Error(`HTTP error, status: ${r.status}`);let o=await r.json();if(!o||!o.data)throw new Error("Invalid response from OpenAI models endpoint.");return o.data.map(n=>n.id)}catch(t){throw console.error("Error fetching OpenAI models:",t),t}}async nonStreamingChat(t){try{let r=JSON.stringify({model:this.modelName,messages:t}),o={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},n=await this.fetch(`${this.baseUrl}/chat/completions`,{method:"POST",headers:o,body:r});if(!n.ok)throw console.error("http response: ",n),console.error("http response body: ",await n.json()),new Error(`HTTP error, status: ${n.status}`);let i=await n.json();if(!i||!i.choices||i.choices.length===0)throw new Error("Invalid response from OpenAI.");return i.choices[0].message.content}catch(r){throw console.error("Error calling OpenAI chat endpoint:",r),await p.flashNotification("Error calling OpenAI chat endpoint.","error"),r}}},Ue=class extends W{constructor(t,r,o,n=!0,i=!0){super(t,o,"OpenAI",r,n,i)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,input:t.text,encoding_format:"float"}),o={"Content-Type":"application/json"};this.requireAuth&&(o.Authorization=`Bearer ${this.apiKey}`);let n=await this.fetch(`${this.baseUrl}/embeddings`,{method:"POST",headers:o,body:r});if(!n.ok)throw console.error("HTTP response: ",n),console.error("HTTP response body: ",await n.json()),new Error(`HTTP error, status: ${n.status}`);let i=await n.json();if(!i||!i.data||i.data.length===0)throw new Error("Invalid response from OpenAI.");return i.data[0].embedding}};var je=class extends Q{name="Ollama";requireAuth;openaiProvider;constructor(t,r,o,n,i=!0){super("Ollama",t,o,r,i),this.requireAuth=n,this.openaiProvider=new me(t,r,o,n,i)}async chatWithAI({messages:t,stream:r,onDataReceived:o,onResponseComplete:n}){return await this.openaiProvider.chatWithAI({messages:t,stream:r,onDataReceived:o,onResponseComplete:n})}async listModels(){try{let t={"Content-Type":"application/json"};this.requireAuth&&(t.Authorization=`Bearer ${this.apiKey}`);let r=await this.fetch(`${this.baseUrl.replace(/\/v1\/?/,"")}/api/tags`,{method:"GET",headers:t});if(!r.ok)throw console.error("HTTP response: ",r),console.error("HTTP response body: ",await r.json()),new Error(`HTTP error, status: ${r.status}`);let o=await r.json();if(!o||!o.models)throw new Error("Invalid response from Ollama models endpoint.");return o.models.map(n=>n.name)}catch(t){throw console.error("Error fetching Ollama models:",t),t}}},He=class extends W{constructor(t,r,o,n=!1,i=!0){super(t,o,"Ollama",r,n,i)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,prompt:t.text}),o={"Content-Type":"application/json"};this.requireAuth&&(o.Authorization=`Bearer ${this.apiKey}`);let n=await this.fetch(`${this.baseUrl}/api/embeddings`,{method:"POST",headers:o,body:r});if(!n.ok)throw console.error("HTTP response: ",n),console.error("HTTP response body: ",await n.json()),new Error(`HTTP error, status: ${n.status}`);let i=await n.json();if(!i||!i.embedding||i.embedding.length===0)throw new Error("Invalid response from Ollama.");return i.embedding}};var qe=class extends Q{constructor(t,r,o="http://localhost"){super(t,o,"mock",r)}async chatWithAI(t){let r="This is a mock response from the AI.";if(t.onDataReceived)for(let o of r)await new Promise(n=>setTimeout(n,50)),t.onDataReceived(o);return r}listModels(){return Promise.resolve(["mock-gpt-3.5","mock-gpt-4","mock-claude-2",this.modelName])}},Ke=class extends pe{constructor(t,r,o="http://localhost"){super(t,o,"mock",r)}generateImage(t){return new Promise(r=>{setTimeout(()=>{r("https://example.com/mock-image.jpg")},5)})}},Be=class extends W{constructor(t,r,o="http://localhost"){super(t,o,"mock",r)}_generateEmbeddings(t){return new Promise(r=>{setTimeout(()=>{let o=Array(1536).fill(0).map(()=>Math.random());r(o)},5)})}};async function wr(){await l("config.define","ai.keys",{type:"object",additionalProperties:{type:"string"},description:"API keys for AI services (e.g., OPENAI_API_KEY, GEMINI_API_KEY)"}),await l("config.define","ai.textModels",{type:"array",items:{type:"object",properties:{name:{type:"string",description:"Display name for the model"},description:{type:"string",description:"Description of the model"},modelName:{type:"string",description:"Technical model name/identifier"},provider:{type:"string",enum:["openai","gemini","ollama","mock"],description:"AI provider for this model"},secretName:{type:"string",description:"Name of the API key in ai.keys"},requireAuth:{type:"boolean",description:"Whether this model requires authentication"},baseUrl:{type:"string",description:"Optional custom base URL for the API"},useProxy:{type:"boolean",description:"Whether to use SilverBullet's proxy for requests"}},required:["name","modelName","provider"],additionalProperties:!1},description:"Available text/chat models"}),await l("config.define","ai.imageModels",{type:"array",items:{type:"object",properties:{name:{type:"string",description:"Display name for the image model"},description:{type:"string",description:"Description of the image model"},modelName:{type:"string",description:"Technical model name/identifier"},provider:{type:"string",enum:["dalle","mock"],description:"Image provider for this model"},secretName:{type:"string",description:"Name of the API key in ai.keys"},requireAuth:{type:"boolean",description:"Whether this model requires authentication"},baseUrl:{type:"string",description:"Optional custom base URL for the API"},useProxy:{type:"boolean",description:"Whether to use SilverBullet's proxy for requests"}},required:["name","modelName","provider"],additionalProperties:!1},description:"Available image generation models"}),await l("config.define","ai.embeddingModels",{type:"array",items:{type:"object",properties:{name:{type:"string",description:"Display name for the embedding model"},description:{type:"string",description:"Description of the embedding model"},modelName:{type:"string",description:"Technical model name/identifier"},provider:{type:"string",enum:["openai","gemini","ollama","mock"],description:"Embedding provider for this model"},secretName:{type:"string",description:"Name of the API key in ai.keys"},requireAuth:{type:"boolean",description:"Whether this model requires authentication"},baseUrl:{type:"string",description:"Optional custom base URL for the API"},useProxy:{type:"boolean",description:"Whether to use SilverBullet's proxy for requests"}},required:["name","modelName","provider"],additionalProperties:!1},description:"Available embedding models for semantic search"}),await l("config.define","ai.chat",{type:"object",properties:{userInformation:{type:"string",description:"Information about the user to include in prompts"},userInstructions:{type:"string",description:"Custom instructions for the AI assistant"},parseWikiLinks:{type:"boolean",description:"Whether to parse and resolve wiki-style links"},bakeMessages:{type:"boolean",description:"Whether to bake messages into the conversation"},searchEmbeddings:{type:"boolean",description:"Whether to search embeddings for context"},customEnrichFunctions:{type:"array",items:{type:"string"},description:"Custom functions to enrich chat context"}},additionalProperties:!1,description:"Chat behavior settings"}),await l("config.define","ai.promptInstructions",{type:"object",properties:{pageRenameSystem:{type:"string",description:"System prompt for page renaming"},pageRenameRules:{type:"string",description:"Rules for page renaming"},tagRules:{type:"string",description:"Rules for tag generation"},indexSummaryPrompt:{type:"string",description:"Prompt for generating index summaries"},enhanceFrontMatterPrompt:{type:"string",description:"Prompt for enhancing front matter"}},additionalProperties:!1,description:"Custom prompts for various AI operations"}),await l("config.define","ai.indexEmbeddings",{type:"boolean",description:"Whether to generate and index embeddings for semantic search"}),await l("config.define","ai.indexEmbeddingsExcludePages",{type:"array",items:{type:"string"},description:"Page patterns to exclude from embedding indexing"}),await l("config.define","ai.indexEmbeddingsExcludeStrings",{type:"array",items:{type:"string"},description:"Text patterns to exclude from embedding indexing"}),await l("config.define","ai.indexSummary",{type:"boolean",description:"Whether to generate AI summaries of pages"}),await l("config.define","ai.indexSummaryModelName",{type:"string",description:"Model name to use for generating summaries"})}var E,g,Pe,$,Ge,O,ft,Mi,Ae;async function v(){let e=await Ye();(!E||!$||!g||!ft||JSON.stringify(e)!==JSON.stringify(ft))&&await ae(!0)}async function Ye(){try{return await J.get("ai.selectedTextModel")}catch{return}}async function gt(){try{return await J.get("ai.selectedImageModel")}catch{return}}async function ht(){try{return await J.get("ai.selectedEmbeddingModel")}catch{return}}async function yt(e){await J.set("ai.selectedImageModel",e)}async function bt(e){await J.set("ai.selectedTextModel",e)}async function xt(e){await J.set("ai.selectedEmbeddingModel",e)}async function Ii(){let e=await Ye()||g.textModels[0];if(!e)throw new Error("No text model selected or available as default.");await le(e)}async function Oi(){let e=await gt()||g.imageModels[0];if(!e)throw new Error("No image model selected or available as default.");await wt(e)}async function ki(){let e=await ht()||g.embeddingModels[0];if(!e)throw new Error("No embedding model selected or available as default.");await Se(e)}function Ni(e){let t=e.provider.toLowerCase(),r=e.useProxy??!0;switch(k("Provider name",t),t){case"dalle":Ge=new Me(E,e.modelName,e.baseUrl||"https://api.openai.com/v1",r);break;case"mock":Ge=new Ke(E,e.modelName);break;default:throw new Error(`Unsupported image provider: ${e.provider}. Please configure a supported provider.`)}}function Ri(e){let t=e.provider.toLowerCase(),r=e.useProxy??!0;switch(t){case"openai":$=new me(E,e.modelName,e.baseUrl||"https://api.openai.com/v1",e.requireAuth,r);break;case"gemini":$=new _e(E,e.modelName,r);break;case"ollama":$=new je(E,e.modelName,e.baseUrl||"http://localhost:11434/v1",e.requireAuth,r);break;case"mock":$=new qe(E,e.modelName,e.baseUrl);break;default:throw new Error(`Unsupported AI provider: ${e.provider}. Please configure a supported provider.`)}return $}function Li(e){let t=e.provider.toLowerCase(),r=e.useProxy??!0;switch(t){case"openai":O=new Ue(E,e.modelName,e.baseUrl||"https://api.openai.com/v1",e.requireAuth??!0,r);break;case"gemini":O=new De(E,e.modelName,void 0,e.requireAuth??!0,r);break;case"ollama":O=new He(E,e.modelName,e.baseUrl||"http://localhost:11434",e.requireAuth??!1,r);break;case"mock":O=new Be(E,e.modelName,e.baseUrl);break;default:throw new Error(`Unsupported embedding provider: ${e.provider}. Please configure a supported provider.`)}}async function le(e){if(k("configureSelectedModel called with:",e),k("AI Keys:",await I.getConfig("ai")),!e)throw new Error("No model provided to configure");if(e.requireAuth)try{let t=await I.getConfig(`ai.keys.${e.secretName||"OPENAI_API_KEY"}`);t!==E&&(E=t,k("API key updated"))}catch(t){throw console.error("Error reading secret:",t),new Error("Failed to read the AI API key. Please check your Space Lua config.")}if(e.requireAuth&&!E)throw new Error("AI API key is missing. Please set it in your Space Lua config.");return ft=e,Ri(e)}async function wt(e){if(k("configureSelectedImageModel called with:",e),!e)throw new Error("No image model provided to configure");if(e.requireAuth){let t=await I.getConfig(`ai.keys.${e.secretName||"OPENAI_API_KEY"}`);t!==E&&(E=t,k("API key updated for image model"))}if(e.requireAuth&&!E)throw new Error("AI API key is missing for image model. Please set it in your Space Lua config.");Mi=e,Ni(e)}async function Se(e){if(k("configureSelectedEmbeddingModel called with:",e),!e)throw new Error("No embedding model provided to configure");if(e.requireAuth){let t=await I.getConfig(`ai.keys.${e.secretName||"OPENAI_API_KEY"}`);t!==E&&(E=t,k("API key updated for embedding model"))}if(e.requireAuth&&!E)throw new Error("AI API key is missing for embedding model. Please set it in your Space Lua config.");Ae=e,Li(e)}async function Fi(){let e={chat:{},promptInstructions:{},imageModels:[],embeddingModels:[],textModels:[],indexEmbeddings:!1,indexSummary:!1,indexSummaryModelName:"",indexEmbeddingsExcludePages:[],indexEmbeddingsExcludeStrings:["**user**:"]},t={userInformation:"",userInstructions:"",parseWikiLinks:!0,bakeMessages:!0,customEnrichFunctions:[],searchEmbeddings:!1},r={pageRenameSystem:"",pageRenameRules:"",tagRules:"",indexSummaryPrompt:"",enhanceFrontMatterPrompt:""},o=await I.getConfig("ai",{}),n={...e,...o};return n.chat={...t,...o.chat||{}},n.promptInstructions={...r,...o.promptInstructions||{}},n}async function ae(e=!0){try{await wr()}catch(r){console.warn("Failed to define config schemas:",r)}let t=await Fi();!g||JSON.stringify(g)!==JSON.stringify(t)?(k("aiSettings updating from",g),g=t,k("aiSettings updated to",g)):k("aiSettings unchanged",g),g.textModels.length===1&&await bt(g.textModels[0]),g.imageModels.length===1&&await yt(g.imageModels[0]),g.embeddingModels.length===1&&await xt(g.embeddingModels[0]),e&&(g.textModels.length>0&&await Ii(),g.imageModels.length>0&&await Oi(),g.embeddingModels.length>0&&await ki()),Pe={role:"system",content:"This is an interactive chat session with a user in a markdown-based note-taking tool called SilverBullet."},g.chat.userInformation&&(Pe.content+=`
The user has provided the following information about themselves: ${g.chat.userInformation}`),g.chat.userInstructions&&(Pe.content+=`
The user has provided the following instructions for the chat, follow them as closely as possible: ${g.chat.userInstructions}`)}async function Ar(e){return{options:(await H.queryLuaObjects("page",{objectVariable:"_",where:await Z.parseExpression("_.itags and table.includes(_.itags, 'meta/template/aiPrompt') and _.aiprompt and _.aiprompt.slashCommand")})).map(r=>{let o=r.aiprompt;return{label:o.slashCommand,detail:o.description||r.description,order:o.order||0,templatePage:r.ref,pageName:e.pageName,invoke:"silverbullet-ai.insertAiPromptFromTemplate"}})}}async function Pr(e){let t,r,o;if(e&&"template"in e&&e.template){let A=e;r=A.template,o=A.extraContext,t={ref:"space-lua-prompt",systemPrompt:A.systemPrompt||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:A.insertAt||"cursor",chat:A.chat||!1,enrichMessages:A.enrichMessages||!1,postProcessors:A.postProcessors||[]}}else if(!e||!("templatePage"in e)||!e.templatePage){let A=await H.queryLuaObjects("page",{objectVariable:"_",where:await Z.parseExpression("_.itags and table.includes(_.itags, 'meta/template/aiPrompt') and _.aiprompt")});t=await p.filterBox("Prompt Template",A.map(M=>{let ye=M.ref.split("/").pop();return{...M,description:M.aiprompt.description||M.ref,name:M.aiprompt.displayName||ye,systemPrompt:M.aiprompt.systemPrompt||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:M.aiprompt.insertAt||"cursor",chat:M.aiprompt.chat||!1,enrichMessages:M.aiprompt.enrichMessages||!1,postProcessors:M.aiprompt.postProcessors||[]}}),"Select the template to use as the prompt.  The prompt will be rendered and sent to the LLM model.")}else{let A=e;console.log("selectedTemplate from slash completion: ",A);let M=await F.readPage(A.templatePage),ye=await T.parseMarkdown(M),{aiprompt:z}=await ie(ye);console.log("templatePage from slash completion: ",M),t={ref:A.templatePage,systemPrompt:z.systemPrompt||z.system||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:z.insertAt||"cursor",chat:z.chat||!1,enrichMessages:z.enrichMessages||!1,postProcessors:z.postProcessors||[]}}if(!t){await p.flashNotification("No template selected");return}console.log("User selected prompt template: ",t);let i=["cursor","page-start","page-end","start-of-line","end-of-line","start-of-item","end-of-item","new-line-above","new-line-below","replace-line","replace-paragraph","replace-selection","replace-smart"];if(!i.includes(t.insertAt)){console.error(`Invalid insertAt value: ${t.insertAt}. It must be one of ${i.join(", ")}`),await p.flashNotification(`Invalid insertAt value: ${t.insertAt}. Please select a valid option.`,"error");return}await v();let s,a,c;try{r?s=r:s=await F.readPage(t.ref),a=await p.getCurrentPage(),c=await F.getPageMeta(a)}catch(A){console.error("Error fetching template details or page metadata",A),await p.flashNotification("Error fetching template details or page metadata","error");return}let u="",m=0,d=0,f=0,h=0,y,S,w,D,R,L,U,K;try{u=await p.getText(),d=await p.getCursor();let A=u.split(`
`);m=u.substring(0,d).split(`
`).length,f=d-(u.substring(0,d).split(`
`).pop()?.length||0),h=f+A[m-1].length}catch(A){console.error("Error fetching current page text or cursor position",A),await p.flashNotification("Error fetching current page text or cursor position","error");return}try{(t.insertAt==="start-of-item"||t.insertAt==="end-of-item"||t.insertAt==="replace-smart")&&(y=await I.invokeFunction("editor.determineItemBounds",u,d,void 0,!0),y&&(S=u.slice(y.from,y.to)),w=await I.invokeFunction("editor.determineItemBounds",u,d,0,!0),w&&(D=u.slice(w.from,w.to)))}catch(A){console.error("Error fetching current item",A)}try{(t.insertAt==="replace-paragraph"||t.insertAt==="replace-smart")&&(R=ir(u,d))}catch(A){console.error("Error fetching current paragraph",A),await p.flashNotification("Error fetching current paragraph","error");return}try{(t.insertAt=="replace-selection"||t.insertAt=="replace-smart")&&(L=await tr())}catch(A){console.error("Error fetching selected text",A)}let P;switch(t.insertAt){case"page-start":P=0;break;case"page-end":P=await se();break;case"frontmatter":await p.flashNotification("rendering in frontmatter not supported yet","error");break;case"modal":break;case"replace":break;case"replace-line":P=f,await p.replaceRange(f,h,"");break;case"replace-selection":L?.text?(P=L.from,await p.replaceRange(L.from,L.to,"")):P=await p.getCursor();break;case"replace-paragraph":R?.text?(P=R.from,await p.replaceRange(R.from,R.to,"")):await p.flashNotification("Error: current paragraph is undefined","error");break;case"replace-smart":if(L?.text)U="selected-text",K=L.text,P=L.from,await p.replaceRange(L.from,L.to,"");else if(S&&y)U="current-item",K=S,P=y.from,await p.replaceRange(y.from,y.to,`
`);else if(R?.text)U="current-paragraph",K=R.text,P=R.from,await p.replaceRange(R.from,R.to,"");else{await p.flashNotification("Error: replace-smart: no text selected, current paragraph, or current item","error");return}console.log("smartReplaceType: ",U),console.log("smartReplaceText: ",K);break;case"start-of-line":P=f;break;case"end-of-line":P=h;break;case"new-line-above":P=f,await p.insertAtPos(`
`,P),P+=1;break;case"new-line-below":P=h,await p.insertAtPos(`
`,P),P+=1;break;case"start-of-item":P=y?.from??d;break;case"end-of-item":P=y?.to??d;break;case"cursor":default:P=await p.getCursor()}P===void 0&&(P=await se()),console.log("templatetext: ",s);let X=[],Ze={page:c,currentItemText:S,currentLineNumber:m,lineStartPos:f,lineEndPos:h,currentPageText:u,parentItemText:D,selectedText:L?.text,currentParagraph:R?.text,smartReplaceType:U,smartReplaceText:K,...o||{}};if(t.chat)X=await Le(s),t.systemPrompt&&X.unshift({role:"system",content:t.systemPrompt}),t.chat&&t.enrichMessages&&(X=await de(X,Ze));else{let A;try{let M=s,ye=Ze,z=`spacelua.interpolate(${JSON.stringify(M)}, ${JSON.stringify(ye)})`;console.log("Evaluating template Lua expression:",z),A=await Z.evalExpression(z),console.log("Template rendered successfully:",A)}catch(M){console.error("Template rendering failed:",M),console.error("Failed template content:",s),console.error("Template metadata:",Ze),A=s}t.systemPrompt&&X.push({role:"system",content:t.systemPrompt}),X.push({role:"user",content:A})}console.log("Messages: ",X),await $.streamChatIntoEditor({messages:X,stream:!0,postProcessors:t.postProcessors},P)}var zc=new TextEncoder;function Sr(e){let t=atob(e),r=t.length,o=new Uint8Array(r);for(let n=0;n<r;n++)o[n]=t.charCodeAt(n);return o}var ee=class extends Error{constructor(r="(unknown reason)",o=""){super(`${r} ${o}`);this.mark=o;this.name=this.constructor.name}toString(r){return`${this.name}: ${this.message} ${this.mark}`}};function Er(e){return typeof e=="boolean"||e instanceof Boolean}function vr(e){return e!==null&&typeof e=="object"}function B(e,t){let r="";for(let o=0;o<t;o++)r+=e;return r}function Ee(e){return e===0&&Number.NEGATIVE_INFINITY===1/e}var We=class{constructor(t,r,o,n,i){this.name=t;this.buffer=r;this.position=o;this.line=n;this.column=i}getSnippet(t=4,r=75){if(!this.buffer)return null;let o="",n=this.position;for(;n>0&&`\0\r
\x85\u2028\u2029`.indexOf(this.buffer.charAt(n-1))===-1;)if(n-=1,this.position-n>r/2-1){o=" ... ",n+=5;break}let i="",s=this.position;for(;s<this.buffer.length&&`\0\r
\x85\u2028\u2029`.indexOf(this.buffer.charAt(s))===-1;)if(s+=1,s-this.position>r/2-1){i=" ... ",s-=5;break}let a=this.buffer.slice(n,s);return`${B(" ",t)}${o}${a}${i}
${B(" ",t+this.position-n+o.length)}^`}toString(t){let r,o="";return this.name&&(o+=`in "${this.name}" `),o+=`at line ${this.line+1}, column ${this.column+1}`,t||(r=this.getSnippet(),r&&(o+=`:
${r}`)),o}};function At(e,t,r){let o=[];for(let n of e.include)r=At(n,t,r);for(let n of e[t]){for(let[i,s]of r.entries())s.tag===n.tag&&s.kind===n.kind&&o.push(i);r.push(n)}return r.filter((n,i)=>!o.includes(i))}function $i(...e){let t={fallback:{},mapping:{},scalar:{},sequence:{}};for(let r of e)for(let o of r)o.kind!==null&&(t[o.kind][o.tag]=t.fallback[o.tag]=o);return t}var q=class e{static SCHEMA_DEFAULT;implicit;explicit;include;compiledImplicit;compiledExplicit;compiledTypeMap;constructor(t){this.explicit=t.explicit||[],this.implicit=t.implicit||[],this.include=t.include||[];for(let r of this.implicit)if(r.loadKind&&r.loadKind!=="scalar")throw new ee("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");this.compiledImplicit=At(this,"implicit",[]),this.compiledExplicit=At(this,"explicit",[]),this.compiledTypeMap=$i(this.compiledImplicit,this.compiledExplicit)}extend(t){return new e({implicit:[...new Set([...this.implicit,...t?.implicit??[]])],explicit:[...new Set([...this.explicit,...t?.explicit??[]])],include:[...new Set([...this.include,...t?.include??[]])]})}static create(){}};var x=class{tag;kind=null;instanceOf;predicate;represent;defaultStyle;styleAliases;loadKind;constructor(t,r){this.tag=t,r&&(this.kind=r.kind,this.resolve=r.resolve||(()=>!0),this.construct=r.construct||(o=>o),this.instanceOf=r.instanceOf,this.predicate=r.predicate,this.represent=r.represent,this.defaultStyle=r.defaultStyle,this.styleAliases=r.styleAliases)}resolve=()=>!0;construct=t=>t};var Pt=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;function _i(e){if(e===null)return!1;let t,r=0,o=e.length,n=Pt;for(let i=0;i<o;i++)if(t=n.indexOf(e.charAt(i)),!(t>64)){if(t<0)return!1;r+=6}return r%8===0}function Di(e){let t=e.replace(/[\r\n=]/g,""),r=t.length,o=Pt,n=[],i=0;for(let a=0;a<r;a++)a%4===0&&a&&(n.push(i>>16&255),n.push(i>>8&255),n.push(i&255)),i=i<<6|o.indexOf(t.charAt(a));let s=r%4*6;return s===0?(n.push(i>>16&255),n.push(i>>8&255),n.push(i&255)):s===18?(n.push(i>>10&255),n.push(i>>2&255)):s===12&&n.push(i>>4&255),new Uint8Array(n)}function Ui(e){let t=e.length,r=Pt,o="",n=0;for(let s=0;s<t;s++)s%3===0&&s&&(o+=r[n>>18&63],o+=r[n>>12&63],o+=r[n>>6&63],o+=r[n&63]),n=(n<<8)+e[s];let i=t%3;return i===0?(o+=r[n>>18&63],o+=r[n>>12&63],o+=r[n>>6&63],o+=r[n&63]):i===2?(o+=r[n>>10&63],o+=r[n>>4&63],o+=r[n<<2&63],o+=r[64]):i===1&&(o+=r[n>>2&63],o+=r[n<<4&63],o+=r[64],o+=r[64]),o}function ji(e){return e instanceof Uint8Array}var St=new x("tag:yaml.org,2002:binary",{construct:Di,kind:"scalar",predicate:ji,represent:Ui,resolve:_i});function Hi(e){let t=e.length;return t===4&&(e==="true"||e==="True"||e==="TRUE")||t===5&&(e==="false"||e==="False"||e==="FALSE")}function qi(e){return e==="true"||e==="True"||e==="TRUE"}var Et=new x("tag:yaml.org,2002:bool",{construct:qi,defaultStyle:"lowercase",kind:"scalar",predicate:Er,represent:{lowercase(e){return e?"true":"false"},uppercase(e){return e?"TRUE":"FALSE"},camelcase(e){return e?"True":"False"}},resolve:Hi});var Ki=new RegExp("^(?:[-+]?(?:0|[1-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\\.[0-9_]*|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");function Bi(e){return!(!Ki.test(e)||e[e.length-1]==="_")}function Gi(e){let t=e.replace(/_/g,"").toLowerCase(),r=t[0]==="-"?-1:1,o=[];if(t[0]&&"+-".indexOf(t[0])>=0&&(t=t.slice(1)),t===".inf")return r===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY;if(t===".nan")return NaN;if(t.indexOf(":")>=0){t.split(":").forEach(s=>{o.unshift(parseFloat(s))});let n=0,i=1;return o.forEach(s=>{n+=s*i,i*=60}),r*n}return r*parseFloat(t)}var Yi=/^[-+]?[0-9]+e/;function Wi(e,t){if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(Ee(e))return"-0.0";let r=e.toString(10);return Yi.test(r)?r.replace("e",".e"):r}function Qi(e){return Object.prototype.toString.call(e)==="[object Number]"&&(e%1!==0||Ee(e))}var vt=new x("tag:yaml.org,2002:float",{construct:Gi,defaultStyle:"lowercase",kind:"scalar",predicate:Qi,represent:Wi,resolve:Bi});function Tr(e){let t=new Function(`return ${e}`)();if(!(t instanceof Function))throw new TypeError(`Expected function but got ${typeof t}: ${e}`);return t}var Vi=new x("tag:yaml.org,2002:js/function",{kind:"scalar",resolve(e){if(e===null)return!1;try{return Tr(`${e}`),!0}catch{return!1}},construct(e){return Tr(e)},predicate(e){return e instanceof Function},represent(e){return e.toString()}});function zi(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function Ji(e){return 48<=e&&e<=55}function Xi(e){return 48<=e&&e<=57}function Zi(e){let t=e.length,r=0,o=!1;if(!t)return!1;let n=e[r];if((n==="-"||n==="+")&&(n=e[++r]),n==="0"){if(r+1===t)return!0;if(n=e[++r],n==="b"){for(r++;r<t;r++)if(n=e[r],n!=="_"){if(n!=="0"&&n!=="1")return!1;o=!0}return o&&n!=="_"}if(n==="x"){for(r++;r<t;r++)if(n=e[r],n!=="_"){if(!zi(e.charCodeAt(r)))return!1;o=!0}return o&&n!=="_"}for(;r<t;r++)if(n=e[r],n!=="_"){if(!Ji(e.charCodeAt(r)))return!1;o=!0}return o&&n!=="_"}if(n==="_")return!1;for(;r<t;r++)if(n=e[r],n!=="_"){if(n===":")break;if(!Xi(e.charCodeAt(r)))return!1;o=!0}return!o||n==="_"?!1:n!==":"?!0:/^(:[0-5]?[0-9])+$/.test(e.slice(r))}function es(e){let t=e,r=[];t.indexOf("_")!==-1&&(t=t.replace(/_/g,""));let o=1,n=t[0];if((n==="-"||n==="+")&&(n==="-"&&(o=-1),t=t.slice(1),n=t[0]),t==="0")return 0;if(n==="0")return t[1]==="b"?o*parseInt(t.slice(2),2):t[1]==="x"?o*parseInt(t,16):o*parseInt(t,8);if(t.indexOf(":")!==-1){t.split(":").forEach(a=>{r.unshift(parseInt(a,10))});let i=0,s=1;return r.forEach(a=>{i+=a*s,s*=60}),o*i}return o*parseInt(t,10)}function ts(e){return Object.prototype.toString.call(e)==="[object Number]"&&e%1===0&&!Ee(e)}var Ct=new x("tag:yaml.org,2002:int",{construct:es,defaultStyle:"decimal",kind:"scalar",predicate:ts,represent:{binary(e){return e>=0?`0b${e.toString(2)}`:`-0b${e.toString(2).slice(1)}`},octal(e){return e>=0?`0${e.toString(8)}`:`-0${e.toString(8).slice(1)}`},decimal(e){return e.toString(10)},hexadecimal(e){return e>=0?`0x${e.toString(16).toUpperCase()}`:`-0x${e.toString(16).toUpperCase().slice(1)}`}},resolve:Zi,styleAliases:{binary:[2,"bin"],decimal:[10,"dec"],hexadecimal:[16,"hex"],octal:[8,"oct"]}});var Tt=new x("tag:yaml.org,2002:map",{construct(e){return e!==null?e:{}},kind:"mapping"});function rs(e){return e==="<<"||e===null}var Mt=new x("tag:yaml.org,2002:merge",{kind:"scalar",resolve:rs});function ns(e){let t=e.length;return t===1&&e==="~"||t===4&&(e==="null"||e==="Null"||e==="NULL")}function os(){return null}function is(e){return e===null}var It=new x("tag:yaml.org,2002:null",{construct:os,defaultStyle:"lowercase",kind:"scalar",predicate:is,represent:{canonical(){return"~"},lowercase(){return"null"},uppercase(){return"NULL"},camelcase(){return"Null"}},resolve:ns});var{hasOwn:ss}=Object,as=Object.prototype.toString;function cs(e){let t=[],r="",o=!1;for(let n of e){if(o=!1,as.call(n)!=="[object Object]")return!1;for(r in n)if(ss(n,r))if(!o)o=!0;else return!1;if(!o)return!1;if(t.indexOf(r)===-1)t.push(r);else return!1}return!0}function ls(e){return e!==null?e:[]}var Ot=new x("tag:yaml.org,2002:omap",{construct:ls,kind:"sequence",resolve:cs});var us=Object.prototype.toString;function ps(e){let t=Array.from({length:e.length});for(let[r,o]of e.entries()){if(us.call(o)!=="[object Object]")return!1;let n=Object.keys(o);if(n.length!==1)return!1;t[r]=[n[0],o[n[0]]]}return!0}function ds(e){if(e===null)return[];let t=Array.from({length:e.length});for(let r=0;r<e.length;r+=1){let o=e[r],n=Object.keys(o);t[r]=[n[0],o[n[0]]]}return t}var kt=new x("tag:yaml.org,2002:pairs",{construct:ds,kind:"sequence",resolve:ps});var Nt=/^\/(?<regexp>[\s\S]+)\/(?<modifiers>[gismuy]*)$/,Rt=new x("tag:yaml.org,2002:js/regexp",{kind:"scalar",resolve(e){if(e===null||!e.length)return!1;let t=`${e}`;if(t.charAt(0)==="/"){if(!Nt.test(e))return!1;let r=[...t.match(Nt)?.groups?.modifiers??""];if(new Set(r).size<r.length)return!1}return!0},construct(e){let{regexp:t=`${e}`,modifiers:r=""}=`${e}`.match(Nt)?.groups??{};return new RegExp(t,r)},predicate(e){return e instanceof RegExp},represent(e){return e.toString()}});var Lt=new x("tag:yaml.org,2002:seq",{construct(e){return e!==null?e:[]},kind:"sequence"});var{hasOwn:ms}=Object;function fs(e){if(e===null)return!0;for(let t in e)if(ms(e,t)&&e[t]!==null)return!1;return!0}function gs(e){return e!==null?e:{}}var Ft=new x("tag:yaml.org,2002:set",{construct:gs,kind:"mapping",resolve:fs});var $t=new x("tag:yaml.org,2002:str",{construct(e){return e!==null?e:""},kind:"scalar"});var Mr=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),Ir=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");function hs(e){return e===null?!1:Mr.exec(e)!==null||Ir.exec(e)!==null}function ys(e){let t=Mr.exec(e);if(t===null&&(t=Ir.exec(e)),t===null)throw new Error("Date resolve error");let r=+t[1],o=+t[2]-1,n=+t[3];if(!t[4])return new Date(Date.UTC(r,o,n));let i=+t[4],s=+t[5],a=+t[6],c=0;if(t[7]){let d=t[7].slice(0,3);for(;d.length<3;)d+="0";c=+d}let u=null;if(t[9]&&t[10]){let d=+t[10],f=+(t[11]||0);u=(d*60+f)*6e4,t[9]==="-"&&(u=-u)}let m=new Date(Date.UTC(r,o,n,i,s,a,c));return u&&m.setTime(m.getTime()-u),m}function bs(e){return e.toISOString()}var _t=new x("tag:yaml.org,2002:timestamp",{construct:ys,instanceOf:Date,kind:"scalar",represent:bs,resolve:hs});var Dt=new x("tag:yaml.org,2002:js/undefined",{kind:"scalar",resolve(){return!0},construct(){},predicate(e){return typeof e>"u"},represent(){return""}});var Ut=new q({explicit:[$t,Lt,Tt]});var jt=new q({implicit:[It,Et,Ct,vt],include:[Ut]});var Ht=new q({include:[jt]});var ve=new q({explicit:[St,Ot,kt,Ft],implicit:[_t,Mt],include:[Ht]});var xs=new q({explicit:[Rt,Dt],include:[ve]});var Ce=class{constructor(t=ve){this.schema=t}};var Qe=class extends Ce{constructor(r,{filename:o,schema:n,onWarning:i,legacy:s=!1,json:a=!1,listener:c=null}){super(n);this.input=r;this.filename=o,this.onWarning=i,this.legacy=s,this.json=a,this.listener=c,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=r.length}documents=[];length;lineIndent=0;lineStart=0;position=0;line=0;filename;onWarning;legacy;json;listener;implicitTypes;typeMap;version;checkLineBreaks;tagMap;anchorMap;tag;anchor;kind;result=""};var{hasOwn:re}=Object,Ve=1,$r=2,_r=3,ze=4,qt=1,ws=2,Or=3,As=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,Ps=/[\x85\u2028\u2029]/,Ss=/[,\[\]\{\}]/,Dr=/^(?:!|!!|![a-z\-]+!)$/i,Ur=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function kr(e){return Object.prototype.toString.call(e)}function V(e){return e===10||e===13}function ue(e){return e===9||e===32}function _(e){return e===9||e===32||e===10||e===13}function fe(e){return e===44||e===91||e===93||e===123||e===125}function Es(e){if(48<=e&&e<=57)return e-48;let t=e|32;return 97<=t&&t<=102?t-97+10:-1}function vs(e){return e===120?2:e===117?4:e===85?8:0}function Cs(e){return 48<=e&&e<=57?e-48:-1}function Nr(e){return e===48?"\0":e===97?"\x07":e===98?"\b":e===116||e===9?"	":e===110?`
`:e===118?"\v":e===102?"\f":e===114?"\r":e===101?"\x1B":e===32?" ":e===34?'"':e===47?"/":e===92?"\\":e===78?"\x85":e===95?"\xA0":e===76?"\u2028":e===80?"\u2029":""}function Ts(e){return e<=65535?String.fromCharCode(e):String.fromCharCode((e-65536>>10)+55296,(e-65536&1023)+56320)}var jr=Array.from({length:256}),Hr=Array.from({length:256});for(let e=0;e<256;e++)jr[e]=Nr(e)?1:0,Hr[e]=Nr(e);function qr(e,t){return new ee(t,new We(e.filename,e.input,e.position,e.line,e.position-e.lineStart))}function b(e,t){throw qr(e,t)}function Je(e,t){e.onWarning&&e.onWarning.call(null,qr(e,t))}var Rr={YAML(e,t,...r){if(e.version!==null)return b(e,"duplication of %YAML directive");if(r.length!==1)return b(e,"YAML directive accepts exactly one argument");let o=/^([0-9]+)\.([0-9]+)$/.exec(r[0]);if(o===null)return b(e,"ill-formed argument of the YAML directive");let n=parseInt(o[1],10),i=parseInt(o[2],10);if(n!==1)return b(e,"unacceptable YAML version of the document");if(e.version=r[0],e.checkLineBreaks=i<2,i!==1&&i!==2)return Je(e,"unsupported YAML version of the document")},TAG(e,t,...r){if(r.length!==2)return b(e,"TAG directive accepts exactly two arguments");let o=r[0],n=r[1];if(!Dr.test(o))return b(e,"ill-formed tag handle (first argument) of the TAG directive");if(e.tagMap&&re(e.tagMap,o))return b(e,`there is a previously declared suffix for "${o}" tag handle`);if(!Ur.test(n))return b(e,"ill-formed tag prefix (second argument) of the TAG directive");typeof e.tagMap>"u"&&(e.tagMap=Object.create(null)),e.tagMap[o]=n}};function te(e,t,r,o){let n;if(t<r){if(n=e.input.slice(t,r),o)for(let i=0;i<n.length;i++){let s=n.charCodeAt(i);if(!(s===9||32<=s&&s<=1114111))return b(e,"expected valid JSON character")}else if(As.test(n))return b(e,"the stream contains non-printable characters");e.result+=n}}function Lr(e,t,r,o){if(!vr(r))return b(e,"cannot merge mappings; the provided source object is unacceptable");for(let n in Object.keys(r))re(t,n)||(Object.defineProperty(t,n,{value:r[n],writable:!0,enumerable:!0,configurable:!0}),o[n]=!0)}function ge(e,t,r,o,n,i,s,a){if(Array.isArray(n)){n=Array.prototype.slice.call(n);for(let c=0;c<n.length;c++){if(Array.isArray(n[c]))return b(e,"nested arrays are not supported inside keys");typeof n=="object"&&kr(n[c])==="[object Object]"&&(n[c]="[object Object]")}}if(typeof n=="object"&&kr(n)==="[object Object]"&&(n="[object Object]"),n=String(n),t===null&&(t={}),o==="tag:yaml.org,2002:merge")if(Array.isArray(i))for(let c=0;c<i.length;c++)Lr(e,t,i[c],r);else Lr(e,t,i,r);else{if(!e.json&&!re(r,n)&&re(t,n))return e.line=s||e.line,e.position=a||e.position,b(e,"duplicated mapping key");Object.defineProperty(t,n,{value:i,writable:!0,enumerable:!0,configurable:!0}),delete r[n]}return t}function Kt(e){let t=e.input.charCodeAt(e.position);if(t===10)e.position++;else if(t===13)e.position++,e.input.charCodeAt(e.position)===10&&e.position++;else return b(e,"a line break is expected");e.line+=1,e.lineStart=e.position}function C(e,t,r){let o=0,n=e.input.charCodeAt(e.position);for(;n!==0;){for(;ue(n);)n=e.input.charCodeAt(++e.position);if(t&&n===35)do n=e.input.charCodeAt(++e.position);while(n!==10&&n!==13&&n!==0);if(V(n))for(Kt(e),n=e.input.charCodeAt(e.position),o++,e.lineIndent=0;n===32;)e.lineIndent++,n=e.input.charCodeAt(++e.position);else break}return r!==-1&&o!==0&&e.lineIndent<r&&Je(e,"deficient indentation"),o}function Xe(e){let t=e.position,r=e.input.charCodeAt(t);return!!((r===45||r===46)&&r===e.input.charCodeAt(t+1)&&r===e.input.charCodeAt(t+2)&&(t+=3,r=e.input.charCodeAt(t),r===0||_(r)))}function Bt(e,t){t===1?e.result+=" ":t>1&&(e.result+=B(`
`,t-1))}function Ms(e,t,r){let o=e.kind,n=e.result,i=e.input.charCodeAt(e.position);if(_(i)||fe(i)||i===35||i===38||i===42||i===33||i===124||i===62||i===39||i===34||i===37||i===64||i===96)return!1;let s;if((i===63||i===45)&&(s=e.input.charCodeAt(e.position+1),_(s)||r&&fe(s)))return!1;e.kind="scalar",e.result="";let a=e.position,c=e.position,u=!1,m=0;for(;i!==0;){if(i===58){if(s=e.input.charCodeAt(e.position+1),_(s)||r&&fe(s))break}else if(i===35){let d=e.input.charCodeAt(e.position-1);if(_(d))break}else{if(e.position===e.lineStart&&Xe(e)||r&&fe(i))break;if(V(i)){m=e.line;let d=e.lineStart,f=e.lineIndent;if(C(e,!1,-1),e.lineIndent>=t){u=!0,i=e.input.charCodeAt(e.position);continue}else{e.position=a,e.line=m,e.lineStart=d,e.lineIndent=f;break}}}u&&(te(e,c,a,!1),Bt(e,e.line-m),c=a=e.position,u=!1),ue(i)||(a=e.position+1),i=e.input.charCodeAt(++e.position)}return te(e,c,a,!1),e.result?!0:(e.kind=o,e.result=n,!1)}function Is(e,t){let r,o,n;if(r=e.input.charCodeAt(e.position),r!==39)return!1;for(e.kind="scalar",e.result="",e.position++,o=n=e.position;(r=e.input.charCodeAt(e.position))!==0;)if(r===39)if(te(e,o,e.position,!0),r=e.input.charCodeAt(++e.position),r===39)o=e.position,e.position++,n=e.position;else return!0;else if(V(r))te(e,o,n,!0),Bt(e,C(e,!1,t)),o=n=e.position;else{if(e.position===e.lineStart&&Xe(e))return b(e,"unexpected end of the document within a single quoted scalar");e.position++,n=e.position}return b(e,"unexpected end of the stream within a single quoted scalar")}function Os(e,t){let r=e.input.charCodeAt(e.position);if(r!==34)return!1;e.kind="scalar",e.result="",e.position++;let o=e.position,n=e.position,i;for(;(r=e.input.charCodeAt(e.position))!==0;){if(r===34)return te(e,n,e.position,!0),e.position++,!0;if(r===92){if(te(e,n,e.position,!0),r=e.input.charCodeAt(++e.position),V(r))C(e,!1,t);else if(r<256&&jr[r])e.result+=Hr[r],e.position++;else if((i=vs(r))>0){let s=i,a=0;for(;s>0;s--)if(r=e.input.charCodeAt(++e.position),(i=Es(r))>=0)a=(a<<4)+i;else return b(e,"expected hexadecimal character");e.result+=Ts(a),e.position++}else return b(e,"unknown escape sequence");n=o=e.position}else if(V(r))te(e,n,o,!0),Bt(e,C(e,!1,t)),n=o=e.position;else{if(e.position===e.lineStart&&Xe(e))return b(e,"unexpected end of the document within a double quoted scalar");e.position++,o=e.position}}return b(e,"unexpected end of the stream within a double quoted scalar")}function ks(e,t){let r=e.input.charCodeAt(e.position),o,n=!0,i={};if(r===91)o=93,n=!1,i=[];else if(r===123)o=125;else return!1;e.anchor!==null&&typeof e.anchor<"u"&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=i),r=e.input.charCodeAt(++e.position);let s=e.tag,a=e.anchor,c=!0,u=null,m=null,d=null,f=!1,h=!1,y=0,S=0,w=Object.create(null);for(;r!==0;){if(C(e,!0,t),r=e.input.charCodeAt(e.position),r===o)return e.position++,e.tag=s,e.anchor=a,e.kind=n?"mapping":"sequence",e.result=i,!0;if(!c)return b(e,"missed comma between flow collection entries");d=m=u=null,h=f=!1,r===63&&(y=e.input.charCodeAt(e.position+1),_(y)&&(h=f=!0,e.position++,C(e,!0,t))),S=e.line,he(e,t,Ve,!1,!0),d=e.tag||null,m=e.result,C(e,!0,t),r=e.input.charCodeAt(e.position),(f||e.line===S)&&r===58&&(h=!0,r=e.input.charCodeAt(++e.position),C(e,!0,t),he(e,t,Ve,!1,!0),u=e.result),n?ge(e,i,w,d,m,u):h?i.push(ge(e,null,w,d,m,u)):i.push(m),C(e,!0,t),r=e.input.charCodeAt(e.position),r===44?(c=!0,r=e.input.charCodeAt(++e.position)):c=!1}return b(e,"unexpected end of the stream within a flow collection")}function Ns(e,t){let r=qt,o=!1,n=!1,i=t,s=0,a=!1,c=e.input.charCodeAt(e.position),u=!1;if(c===124)u=!1;else if(c===62)u=!0;else return!1;e.kind="scalar",e.result="";let m=0;for(;c!==0;)if(c=e.input.charCodeAt(++e.position),c===43||c===45)if(qt===r)r=c===43?Or:ws;else return b(e,"repeat of a chomping mode identifier");else if((m=Cs(c))>=0){if(m===0)return b(e,"bad explicit indentation width of a block scalar; it cannot be less than one");if(!n)i=t+m-1,n=!0;else return b(e,"repeat of an indentation width identifier")}else break;if(ue(c)){do c=e.input.charCodeAt(++e.position);while(ue(c));if(c===35)do c=e.input.charCodeAt(++e.position);while(!V(c)&&c!==0)}for(;c!==0;){for(Kt(e),e.lineIndent=0,c=e.input.charCodeAt(e.position);(!n||e.lineIndent<i)&&c===32;)e.lineIndent++,c=e.input.charCodeAt(++e.position);if(!n&&e.lineIndent>i&&(i=e.lineIndent),V(c)){s++;continue}if(e.lineIndent<i){r===Or?e.result+=B(`
`,o?1+s:s):r===qt&&o&&(e.result+=`
`);break}u?ue(c)?(a=!0,e.result+=B(`
`,o?1+s:s)):a?(a=!1,e.result+=B(`
`,s+1)):s===0?o&&(e.result+=" "):e.result+=B(`
`,s):e.result+=B(`
`,o?1+s:s),o=!0,n=!0,s=0;let d=e.position;for(;!V(c)&&c!==0;)c=e.input.charCodeAt(++e.position);te(e,d,e.position,!1)}return!0}function Fr(e,t){let r,o,n=!1,i,s=e.tag,a=e.anchor,c=[];for(e.anchor!==null&&typeof e.anchor<"u"&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=c),i=e.input.charCodeAt(e.position);i!==0&&!(i!==45||(o=e.input.charCodeAt(e.position+1),!_(o)));){if(n=!0,e.position++,C(e,!0,-1)&&e.lineIndent<=t){c.push(null),i=e.input.charCodeAt(e.position);continue}if(r=e.line,he(e,t,_r,!1,!0),c.push(e.result),C(e,!0,-1),i=e.input.charCodeAt(e.position),(e.line===r||e.lineIndent>t)&&i!==0)return b(e,"bad indentation of a sequence entry");if(e.lineIndent<t)break}return n?(e.tag=s,e.anchor=a,e.kind="sequence",e.result=c,!0):!1}function Rs(e,t,r){let o=e.tag,n=e.anchor,i={},s=Object.create(null),a,c=!1,u,m,d=null,f=null,h=null,y=!1,S=!1,w;for(e.anchor!==null&&typeof e.anchor<"u"&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=i),w=e.input.charCodeAt(e.position);w!==0;){if(a=e.input.charCodeAt(e.position+1),u=e.line,m=e.position,(w===63||w===58)&&_(a)){if(w===63)y&&(ge(e,i,s,d,f,null),d=f=h=null),S=!0,y=!0,c=!0;else if(y)y=!1,c=!0;else return b(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line");e.position+=1,w=a}else if(he(e,r,$r,!1,!0))if(e.line===u){for(w=e.input.charCodeAt(e.position);ue(w);)w=e.input.charCodeAt(++e.position);if(w===58){if(w=e.input.charCodeAt(++e.position),!_(w))return b(e,"a whitespace character is expected after the key-value separator within a block mapping");y&&(ge(e,i,s,d,f,null),d=f=h=null),S=!0,y=!1,c=!1,d=e.tag,f=e.result}else return S?b(e,"can not read an implicit mapping pair; a colon is missed"):(e.tag=o,e.anchor=n,!0)}else return S?b(e,"can not read a block mapping entry; a multiline key may not be an implicit key"):(e.tag=o,e.anchor=n,!0);else break;if((e.line===u||e.lineIndent>t)&&(he(e,t,ze,!0,c)&&(y?f=e.result:h=e.result),y||(ge(e,i,s,d,f,h,u,m),d=f=h=null),C(e,!0,-1),w=e.input.charCodeAt(e.position)),e.lineIndent>t&&w!==0)return b(e,"bad indentation of a mapping entry");if(e.lineIndent<t)break}return y&&ge(e,i,s,d,f,null),S&&(e.tag=o,e.anchor=n,e.kind="mapping",e.result=i),S}function Ls(e){let t,r=!1,o=!1,n="",i,s;if(s=e.input.charCodeAt(e.position),s!==33)return!1;if(e.tag!==null)return b(e,"duplication of a tag property");if(s=e.input.charCodeAt(++e.position),s===60?(r=!0,s=e.input.charCodeAt(++e.position)):s===33?(o=!0,n="!!",s=e.input.charCodeAt(++e.position)):n="!",t=e.position,r){do s=e.input.charCodeAt(++e.position);while(s!==0&&s!==62);if(e.position<e.length)i=e.input.slice(t,e.position),s=e.input.charCodeAt(++e.position);else return b(e,"unexpected end of the stream within a verbatim tag")}else{for(;s!==0&&!_(s);){if(s===33){if(o)return b(e,"tag suffix cannot contain exclamation marks");if(n=e.input.slice(t-1,e.position+1),!Dr.test(n))return b(e,"named tag handle cannot contain such characters");o=!0,t=e.position+1}s=e.input.charCodeAt(++e.position)}if(i=e.input.slice(t,e.position),Ss.test(i))return b(e,"tag suffix cannot contain flow indicator characters")}if(i&&!Ur.test(i))return b(e,`tag name cannot contain such characters: ${i}`);if(r)e.tag=i;else if(typeof e.tagMap<"u"&&re(e.tagMap,n))e.tag=e.tagMap[n]+i;else if(n==="!")e.tag=`!${i}`;else if(n==="!!")e.tag=`tag:yaml.org,2002:${i}`;else return b(e,`undeclared tag handle "${n}"`);return!0}function Fs(e){let t=e.input.charCodeAt(e.position);if(t!==38)return!1;if(e.anchor!==null)return b(e,"duplication of an anchor property");t=e.input.charCodeAt(++e.position);let r=e.position;for(;t!==0&&!_(t)&&!fe(t);)t=e.input.charCodeAt(++e.position);return e.position===r?b(e,"name of an anchor node must contain at least one character"):(e.anchor=e.input.slice(r,e.position),!0)}function $s(e){let t=e.input.charCodeAt(e.position);if(t!==42)return!1;t=e.input.charCodeAt(++e.position);let r=e.position;for(;t!==0&&!_(t)&&!fe(t);)t=e.input.charCodeAt(++e.position);if(e.position===r)return b(e,"name of an alias node must contain at least one character");let o=e.input.slice(r,e.position);return typeof e.anchorMap<"u"&&!re(e.anchorMap,o)?b(e,`unidentified alias "${o}"`):(typeof e.anchorMap<"u"&&(e.result=e.anchorMap[o]),C(e,!0,-1),!0)}function he(e,t,r,o,n){let i,s,a=1,c=!1,u=!1,m,d,f;e.listener&&e.listener!==null&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null;let h=i=s=ze===r||_r===r;if(o&&C(e,!0,-1)&&(c=!0,e.lineIndent>t?a=1:e.lineIndent===t?a=0:e.lineIndent<t&&(a=-1)),a===1)for(;Ls(e)||Fs(e);)C(e,!0,-1)?(c=!0,s=h,e.lineIndent>t?a=1:e.lineIndent===t?a=0:e.lineIndent<t&&(a=-1)):s=!1;if(s&&(s=c||n),a===1||ze===r)if(d=Ve===r||$r===r?t:t+1,f=e.position-e.lineStart,a===1)if(s&&(Fr(e,f)||Rs(e,f,d))||ks(e,d))u=!0;else{if(i&&Ns(e,d)||Is(e,d)||Os(e,d))u=!0;else if($s(e)){if(u=!0,e.tag!==null||e.anchor!==null)return b(e,"alias node should not have Any properties")}else Ms(e,d,Ve===r)&&(u=!0,e.tag===null&&(e.tag="?"));e.anchor!==null&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=e.result)}else a===0&&(u=s&&Fr(e,f));if(e.tag!==null&&e.tag!=="!")if(e.tag==="?"){for(let y=0;y<e.implicitTypes.length;y++)if(m=e.implicitTypes[y],m.resolve(e.result)){e.result=m.construct(e.result),e.tag=m.tag,e.anchor!==null&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=e.result);break}}else if(re(e.typeMap[e.kind||"fallback"],e.tag)){if(m=e.typeMap[e.kind||"fallback"][e.tag],e.result!==null&&m.kind!==e.kind)return b(e,`unacceptable node kind for !<${e.tag}> tag; it should be "${m.kind}", not "${e.kind}"`);if(m.resolve(e.result))e.result=m.construct(e.result),e.anchor!==null&&typeof e.anchorMap<"u"&&(e.anchorMap[e.anchor]=e.result);else return b(e,`cannot resolve a node with !<${e.tag}> explicit tag`)}else return b(e,`unknown tag !<${e.tag}>`);return e.listener&&e.listener!==null&&e.listener("close",e),e.tag!==null||e.anchor!==null||u}function _s(e){let t=e.position,r,o,n,i=!1,s;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);(s=e.input.charCodeAt(e.position))!==0&&(C(e,!0,-1),s=e.input.charCodeAt(e.position),!(e.lineIndent>0||s!==37));){for(i=!0,s=e.input.charCodeAt(++e.position),r=e.position;s!==0&&!_(s);)s=e.input.charCodeAt(++e.position);if(o=e.input.slice(r,e.position),n=[],o.length<1)return b(e,"directive name must not be less than one character in length");for(;s!==0;){for(;ue(s);)s=e.input.charCodeAt(++e.position);if(s===35){do s=e.input.charCodeAt(++e.position);while(s!==0&&!V(s));break}if(V(s))break;for(r=e.position;s!==0&&!_(s);)s=e.input.charCodeAt(++e.position);n.push(e.input.slice(r,e.position))}s!==0&&Kt(e),re(Rr,o)?Rr[o](e,o,...n):Je(e,`unknown document directive "${o}"`)}if(C(e,!0,-1),e.lineIndent===0&&e.input.charCodeAt(e.position)===45&&e.input.charCodeAt(e.position+1)===45&&e.input.charCodeAt(e.position+2)===45)e.position+=3,C(e,!0,-1);else if(i)return b(e,"directives end mark is expected");if(he(e,e.lineIndent-1,ze,!1,!0),C(e,!0,-1),e.checkLineBreaks&&Ps.test(e.input.slice(t,e.position))&&Je(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&Xe(e)){e.input.charCodeAt(e.position)===46&&(e.position+=3,C(e,!0,-1));return}if(e.position<e.length-1)return b(e,"end of the stream or a document separator is expected")}function Ds(e,t){e=String(e),t=t||{},e.length!==0&&(e.charCodeAt(e.length-1)!==10&&e.charCodeAt(e.length-1)!==13&&(e+=`
`),e.charCodeAt(0)===65279&&(e=e.slice(1)));let r=new Qe(e,t);for(r.input+="\0";r.input.charCodeAt(r.position)===32;)r.lineIndent+=1,r.position+=1;for(;r.position<r.length-1;)_s(r);return r.documents}function Kr(e,t){let r=Ds(e,t);if(r.length===0)return null;if(r.length===1)return r[0];throw new ee("expected a single document in the stream, but found more")}function Br(e,t){return Kr(e,t)}var{hasOwn:Hu}=Object;var{hasOwn:Yu}=Object;var N={};N[0]="\\0";N[7]="\\a";N[8]="\\b";N[9]="\\t";N[10]="\\n";N[11]="\\v";N[12]="\\f";N[13]="\\r";N[27]="\\e";N[34]='\\"';N[92]="\\\\";N[133]="\\N";N[160]="\\_";N[8232]="\\L";N[8233]="\\P";async function Gr(){(!g||!g.textModels)&&await ae(!1);let e=g.textModels.map(o=>({...o,name:o.name,description:o.description||`${o.modelName} on ${o.provider}`})),t=await p.filterBox("Select a model",e);if(!t){await p.flashNotification("No model selected.","error");return}let r=t.name;await bt(t),await le(t),await p.flashNotification(`Selected model: ${r}`),console.log("Selected model:",t)}async function Yr(){(!g||!g.imageModels)&&await ae(!1);let e=g.imageModels.map(o=>({...o,name:o.name,description:o.description||`${o.modelName} on ${o.provider}`})),t=await p.filterBox("Select an image model",e);if(!t){await p.flashNotification("No image model selected.","error");return}let r=t.name;await yt(t),await wt(t),await p.flashNotification(`Selected image model: ${r}`),console.log("Selected image model:",t)}async function Wr(){(!g||!g.embeddingModels)&&await ae(!1);let e=g.embeddingModels.map(o=>({...o,name:o.name,description:o.description||`${o.modelName} on ${o.provider}`})),t=await p.filterBox("Select an embedding model",e);if(!t){await p.flashNotification("No embedding model selected.","error");return}let r=t.name;await xt(t),await Se(t),await p.flashNotification(`Selected embedding model: ${r}`),console.log("Selected embedding model:",t)}async function Gt(){await v();let e=await p.getText(),t=await p.getCurrentPage(),o=(await H.queryLuaObjects("tag",{objectVariable:"_",where:await Z.parseExpression('_.parent == "page"')})).map(d=>d.name);console.log("All tags:",o);let n=`You are an AI tagging assistant. Please provide a short list of tags, separated by spaces. Follow these guidelines:
    - Only return tags and no other content.
    - Tags must be one word only and in lowercase.
    - Use existing tags as a starting point.
    - Suggest tags sparingly, treating them as thematic descriptors rather than keywords.

    The following tags are currently being used by other notes:
    ${o.join(", ")}
    
    Always follow the below rules, if any, given by the user:
    ${g.promptInstructions.tagRules}`,i=`Page Title: ${t}

Page Content:
${e}`,a=(await $.singleMessageChat(i,n)).trim().replace(/,/g,"").split(/\s+/),c=await T.parseMarkdown(e),u=await ie(c),m=[...new Set([...u.tags||[],...a])];u.tags=m,await ut(u),await p.flashNotification("Note tagged successfully.")}async function Yt(){await v();let e=await p.getText(),t=await p.getCurrentPage(),r=[{name:"Generating suggestions...",description:""}];p.filterBox("Loading...",r,"Retrieving suggestions from LLM provider.").then(u=>{console.log("Selected option (initial):",u)});let n="";g.promptInstructions.pageRenameSystem?n=g.promptInstructions.pageRenameSystem:n=`You are an AI note-naming assistant. Your task is to suggest three to five possible names for the provided note content. Please adhere to the following guidelines:
    - Provide each name on a new line.
    - Use only spaces, forward slashes (as folder separators), and hyphens as special characters.
    - Ensure the names are concise, descriptive, and relevant to the content.
    - Avoid suggesting the same name as the current note.
    - Include as much detail as possible within 3 to 10 words.
    - Start names with ASCII characters only.
    - Do not use markdown or any other formatting in your response.`;let s=(await $.singleMessageChat(`Current Page Title: ${t}

Page Content:
${e}`,`${n}

Always follow the below rules, if any, given by the user:
${g.promptInstructions.pageRenameRules}`,!0)).trim().split(`
`).filter(u=>u.trim()!=="").map(u=>u.replace(/^[*-]\s*/,"").trim());s.push(t),s=[...new Set(s)],s.length===0&&await p.flashNotification("No suggestions available.");let a=await p.filterBox("New page name",s.map(u=>({name:u})),"Select a new page name from one of the suggestions below.");if(!a){await p.flashNotification("No page name selected.","error");return}console.log("selectedSuggestion",a);let c=await I.invokeFunction("index.renamePageCommand",{oldPage:t,page:a.name});console.log("renamedPage",c),c||await p.flashNotification("Error renaming page.","error")}async function Wt(){await v();let e=await p.getText(),t=await p.getCurrentPage(),r=["title","tags"],n=await $.singleMessageChat(`Current Page Title: ${t}

Page Content:
${e}`,`You are an AI note enhancing assistant. Your task is to understand the content of a note, detect and extract important information, and convert it to frontmatter attributes. Please adhere to the following guidelines:
      - Only return valid YAML frontmatter.
      - Do not use any markdown or any other formatting in your response.
      - Do not include --- in your response.
      - Do not include any content from the note in your response.
      - Extract useful facts from the note and add them to the frontmatter, such as a person's name, age, a location, etc.
      - Do not return any tags.
      - Do not return a new note title.
      - Do not use special characters in key names.  Only ASCII.
      - Only return important information that would be useful when searching or filtering notes.
      

Always follow the below rules, if any, given by the user:
${g.promptInstructions.enhanceFrontMatterPrompt}`,!0);console.log("frontmatter returned by enhanceNoteFrontMatter",n);try{let i=Br(n);if(typeof i!="object"||Array.isArray(i)||!i)throw new Error("Invalid YAML: Not an object");r.forEach(u=>{delete i[u]});let s=await T.parseMarkdown(e),c={...await ie(s),...i};await ut(c)}catch(i){console.error("Invalid YAML returned by enhanceNoteFrontMatter",i),await p.flashNotification("Error: Invalid Frontmatter YAML returned.","error");return}await p.flashNotification("Frontmatter enhanced successfully.","info")}async function Qr(){await Gt(),await Wt(),await Yt()}async function Vr(){await v();let e=await Le();if(e.length===0){await p.flashNotification("Error: The page does not match the required format for a chat.");return}e.unshift(Pe);let t=await de(e);console.log("enrichedMessages",t);let r=await se();await p.insertAtPos(`

**assistant**: `,r),r+=17,await p.insertAtPos(`

**user**: `,r),await p.moveCursor(r+12);try{await $.streamChatIntoEditor({messages:t,stream:!0},r)}catch(o){console.error("Error streaming chat on page:",o),await p.flashNotification("Error streaming chat on page.","error")}}async function zr(){if(await v(),!g.imageModels||g.imageModels.length===0){await p.flashNotification("No image models available.","error");return}try{let e=await p.prompt("Enter a prompt for DALL\xB7E:");if(!e||!e.trim()){await p.flashNotification("No prompt entered. Operation cancelled.","error");return}let t={prompt:e,numImages:1,size:"1024x1024",quality:"hd"},r=await Ge.generateImage(t);if(r&&r.data&&r.data.length>0){let o=r.data[0].b64_json,n=r.data[0].revised_prompt,i=new Uint8Array(Sr(o)),s=`dall-e-${Date.now()}.png`,a=xr(await p.getCurrentPage())+"/";a==="/"&&(a=""),await F.writeDocument(a+s,i);let c=`![${s}](${s})
*${n}*`;await p.insertAtCursor(c),await p.flashNotification("Image generated and inserted with caption successfully.")}else await p.flashNotification("Failed to generate image.","error")}catch(e){console.error("Error generating image with DALL\xB7E:",e),await p.flashNotification("Error generating image.","error")}}async function Jr(e,t){try{return await v(),await $.singleMessageChat(e,t||"You are an AI note assistant helping to render content for a note. Please follow user instructions and keep your response short and concise.")}catch(r){throw console.error("Error querying OpenAI:",r),r}}async function Xr(){await v();let e=await p.prompt("Enter some text to embed:");if(!e){await p.flashNotification("No text entered.","error");return}let t=await O.generateEmbeddings({text:e});await p.insertAtCursor(`

Embedding: ${t}`)}var Us="\u{1F6F0}\uFE0F AI Connectivity Test",Qt=null;async function js(){await v(),await p.showPanel("modal",20,`<style>
      .ai-modal-wrapper {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: 10px;
        box-sizing: border-box;
      }
      .ai-modal {
        padding: 24px 32px;
        text-align: center;
        background: var(--editor-background-color, var(--root-background-color, Canvas));
        color: var(--editor-text-color, var(--root-text-color, CanvasText));
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 400px;
        width: 100%;
      }
      .ai-modal h3 { margin-top: 0; }
      .ai-modal p { margin-bottom: 0; }
    </style>
    <div class="ai-modal-wrapper">
      <div class="ai-modal">
        <h3>\u{1F6F0}\uFE0F Running Connectivity Tests...</h3>
        <p>Testing AI provider connections. This may take a moment.</p>
      </div>
    </div>`);let e=`# \u{1F6F0}\uFE0F AI Connectivity Test

## Status Overview

`;try{let t=await Ye(),r=await gt(),o=await ht();if(!t&&!r&&!o)e+=`> \u26A0\uFE0F **No models currently selected**

## Available Models

`,g.textModels.length>0?(e+=`### \u{1F4AC} Text Models

`,g.textModels.forEach(n=>e+=`* ${n.name}
`),e+=`
`):e+=`### \u{1F4AC} Text Models

_No text models configured._

`,g.imageModels.length>0?(e+=`### \u{1F3A8} Image Models

`,g.imageModels.forEach(n=>e+=`* ${n.name}
`),e+=`
`):e+=`### \u{1F3A8} Image Models

_No image models configured._

`,g.embeddingModels.length>0?(e+=`### \u{1F524} Embedding Models

`,g.embeddingModels.forEach(n=>e+=`* ${n.name}
`),e+=`
`):e+=`### \u{1F524} Embedding Models

_No embedding models configured._

`,e+=`## Quick Setup

Use these commands to select your models:

* \`AI: Select Text Model from Config\`
* \`AI: Select Image Model from Config\`
* \`AI: Select Embedding Model from Config\`
`;else{let n=(i,s,a)=>{e+=`## ${a} ${s} Configuration

### Model Details

| Setting | Value |
|---------|-------|
| Name | ${i.name} |
| Description | ${i.description||"_No description provided_"} |
| Provider | ${i.provider} |
| Model Name | \`${i.modelName}\` |
| Authentication | ${i.requireAuth?"Required":"Not Required"} |
| Secret Name | ${i.secretName?`\`${i.secretName}\``:"_Not provided_"} |${i.baseUrl?`
| API Endpoint | \`${i.baseUrl}\` |`:""}

`};if(t){n(t,"Text Model","\u{1F4AC}"),e+=`### \u{1F50C} Provider Setup

`;try{let i=await le(t);e+=`> \u2705 Provider successfully configured

`,e+=`### \u{1F4CB} Model Availability

`;try{let s=await i.listModels();s.includes(t.modelName)?e+=`> \u2705 Selected model is available

`:(e+=`> \u26A0\uFE0F Selected model not found in available models

`,e+=`#### Available Models

`,s.forEach(a=>e+=`* \`${a}\`
`),e+=`
`)}catch(s){e+=`> \u274C Failed to fetch available models: ${s}

`}e+=`### \u{1F50C} API Connectivity

`;try{e+=`#### \u{1F4E1} Non-Streaming Test

`;let s=await i.singleMessageChat("This is a connectivity test. Respond with exactly 'CONNECTED' (no quotes, no other text).");s&&s.trim()==="CONNECTED"?e+=`> \u2705 Successfully connected to API and received expected response

`:(e+=`> \u26A0\uFE0F Connected to API but received unexpected response

`,e+="```diff\n",e+=`- Expected: CONNECTED
`,e+=`+ Received: ${s}
`,e+="```\n\n",e+=`_Note: The API is accessible but may not be following instructions precisely._

`),e+=`#### \u{1F4E1} Streaming Test

`;try{let a=[],c=await new Promise((u,m)=>{i.chatWithAI({messages:[{role:"user",content:"This is a streaming connectivity test. Respond with exactly 'CONNECTED' (no quotes, no other text)."}],stream:!0,onDataReceived:d=>{console.log("Streaming chunk received:",d),a.push(d)},onResponseComplete:d=>{u(d)}}).catch(m)});c.trim()==="CONNECTED"?e+=`> \u2705 Successfully connected to streaming API and received expected response

`:(e+=`> \u26A0\uFE0F Connected to streaming API but received unexpected response

`,e+="```diff\n",e+=`- Expected: CONNECTED
`,e+=`+ Received: ${c}
`,e+="```\n\n",e+=`_Note: The streaming API is accessible but may not be following instructions precisely._

`),e+="Received chunks: \n```\n",a.forEach((u,m)=>{e+=`Chunk ${m+1}: "${u}"
`}),e+="```\n\n\n"}catch(a){e+=`> \u274C Failed to connect to streaming API: ${a}

`,e+=`**Troubleshooting Tips:**

`,e+=`* Verify your provider supports streaming
`,e+=`* Ensure there isn't a proxy affecting streaming

`}}catch(s){e+=`> \u274C Failed to connect to API: ${s}

`,e+=`**Troubleshooting Tips:**

`,e+=`* Check your API key if needed
`,e+=`* Ensure the API endpoint is accessible
`,e+=`* Check if you have exceeded API rate limits
`,e+=`* Verify you are not using https on silverbullet and connecting to regular http for the api endpoint

`}}catch(i){e+=`> **error** \u26A0\uFE0F Failed to configure provider: ${i}

`}}if(r&&(n(r,"Image Model","\u{1F3A8}"),e+=`> \u2139\uFE0F Image generation testing is disabled to avoid unnecessary API usage

`),o){n(o,"Embedding Model","\u{1F524}"),e+=`### \u{1F50C} Embedding Provider Setup

`;try{await Se(o),e+=`> \u2705 Embedding provider successfully configured

`,e+=`### \u{1F9EE} Embedding Generation

`;try{let s=await O.generateEmbeddings({text:"This is a connectivity test."});s&&s.length>0?(e+=`> \u2705 Successfully generated embeddings

`,e+=`\`\`\`
Generated ${s.length}-dimensional embedding vector
\`\`\`

`):e+=`> \u26A0\uFE0F Connected to API but received empty embeddings

`}catch(i){e+=`> \u274C Failed to generate embeddings: ${i}

`}}catch(i){e+=`> \u274C Failed to configure embedding provider: ${i}

`}}}}finally{await p.hidePanel("modal")}return Qt=e,e}function Zr(){return Qt||`# \u{1F6F0}\uFE0F AI Connectivity Test

> \u2139\uFE0F No test results available yet.

Run the **AI: Connectivity Test** command to test your AI provider connections.
`}async function en(){await js(),await p.navigate(Us)}var tn={aiPromptSlashCommplete:Ar,queryAI:Jr,tagNoteWithAI:Gt,promptAndGenerateImage:zr,streamChatOnPage:Vr,insertAiPromptFromTemplate:Pr,suggestPageName:Yt,enhanceNoteFrontMatter:Wt,enhanceNoteWithAI:Qr,selectTextModel:Gr,selectImageModel:Yr,selectEmbeddingModel:Wr,testEmbeddingGeneration:Xr,getAllEmbeddings:dt,searchEmbeddings:mt,queueEmbeddingGeneration:dr,processEmbeddingsQueue:mr,processSummaryQueue:fr,generateEmbeddings:we,searchEmbeddingsForChat:Re,searchCombinedEmbeddings:Ne,searchSummaryEmbeddings:hr,getSearchResults:yr,searchCommand:br,getConnectivityTestResults:Zr,connectivityTestCommand:en},rn={name:"silverbullet-ai",requiredPermissions:["fetch"],functions:{aiPromptSlashCommplete:{path:"src/prompts.ts:aiPromptSlashComplete",events:["slash:complete"]},queryAI:{path:"sbai.ts:queryAI"},tagNoteWithAI:{path:"sbai.ts:tagNoteWithAI",command:{name:"AI: Generate tags for note"}},promptAndGenerateImage:{path:"sbai.ts:promptAndGenerateImage",command:{name:"AI: Generate and insert image using DallE"}},streamChatOnPage:{path:"sbai.ts:streamChatOnPage",command:{name:"AI: Chat on current page",key:"Ctrl-Shift-Enter",mac:"Cmd-Shift-Enter"}},insertAiPromptFromTemplate:{path:"src/prompts.ts:insertAiPromptFromTemplate",command:{name:"AI: Execute AI Prompt from Custom Template"}},suggestPageName:{path:"sbai.ts:suggestPageName",command:{name:"AI: Suggest Page Name"}},enhanceNoteFrontMatter:{path:"sbai.ts:enhanceNoteFrontMatter",command:{name:"AI: Generate Note FrontMatter"}},enhanceNoteWithAI:{path:"sbai.ts:enhanceNoteWithAI",command:{name:"AI: Enhance Note"}},selectTextModel:{path:"sbai.ts:selectModelFromConfig",command:{name:"AI: Select Text Model from Config"}},selectImageModel:{path:"sbai.ts:selectImageModelFromConfig",command:{name:"AI: Select Image Model from Config"}},selectEmbeddingModel:{path:"sbai.ts:selectEmbeddingModelFromConfig",command:{name:"AI: Select Embedding Model from Config"}},testEmbeddingGeneration:{path:"sbai.ts:testEmbeddingGeneration",command:{name:"AI: Test Embedding Generation"}},getAllEmbeddings:{path:"src/embeddings.ts:getAllEmbeddings"},searchEmbeddings:{path:"src/embeddings.ts:searchEmbeddings"},queueEmbeddingGeneration:{path:"src/embeddings.ts:queueEmbeddingGeneration",events:["page:index"]},processEmbeddingsQueue:{path:"src/embeddings.ts:processEmbeddingsQueue",mqSubscriptions:[{queue:"aiEmbeddingsQueue",batchSize:1,autoAck:!0,pollInterval:6e5}]},processSummaryQueue:{path:"src/embeddings.ts:processSummaryQueue",mqSubscriptions:[{queue:"aiSummaryQueue",batchSize:1,autoAck:!0,pollInterval:6e5}]},generateEmbeddings:{path:"src/embeddings.ts:generateEmbeddings"},searchEmbeddingsForChat:{path:"src/embeddings.ts:searchEmbeddingsForChat"},searchCombinedEmbeddings:{path:"src/embeddings.ts:searchCombinedEmbeddings"},searchSummaryEmbeddings:{path:"src/embeddings.ts:searchSummaryEmbeddings"},getSearchResults:{path:"src/embeddings.ts:getSearchResults"},searchCommand:{path:"src/embeddings.ts:searchCommand",command:{name:"AI: Search"}},getConnectivityTestResults:{path:"src/connectivity.ts:getConnectivityTestResults"},connectivityTestCommand:{path:"src/connectivity.ts:connectivityTestCommand",command:{name:"AI: Connectivity Test"}}},assets:{}},jp={manifest:rn,functionMapping:tn};zt(tn,rn,self.postMessage);export{jp as plug};
