var fn=Object.defineProperty;var K=(e,t)=>{for(var r in t)fn(e,r,{get:t[r],enumerable:!0})};var He=typeof window>"u"&&typeof globalThis.WebSocketPair>"u";typeof Deno>"u"&&(self.Deno={args:[],build:{arch:"x86_64"},env:{get(){}}});var Ye=new Map,Be=0;function be(e){self.postMessage(e)}He&&(globalThis.syscall=async(e,...t)=>await new Promise((r,n)=>{Be++,Ye.set(Be,{resolve:r,reject:n}),be({type:"sys",id:Be,name:e,args:t})}));function Nt(e,t){He&&(self.addEventListener("message",r=>{(async()=>{let n=r.data;switch(n.type){case"inv":{let i=e[n.name];if(!i)throw new Error(`Function not loaded: ${n.name}`);try{let o=await Promise.resolve(i(...n.args||[]));be({type:"invr",id:n.id,result:o})}catch(o){console.error("An exception was thrown as a result of invoking function",n.name,"error:",o.message),be({type:"invr",id:n.id,error:o.message})}}break;case"sysr":{let i=n.id,o=Ye.get(i);if(!o)throw Error("Invalid request id");Ye.delete(i),n.error?o.reject(new Error(n.error)):o.resolve(n.result)}break}})().catch(console.error)}),be({type:"manifest",manifest:t}))}function gn(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let i=0;i<r;i++)n[i]=t.charCodeAt(i);return n}function Ot(e){typeof e=="string"&&(e=new TextEncoder().encode(e));let t="",r=e.byteLength;for(let n=0;n<r;n++)t+=String.fromCharCode(e[n]);return btoa(t)}async function hn(e,t){if(typeof e!="string"){let r=new Uint8Array(await e.arrayBuffer()),n=r.length>0?Ot(r):void 0;t={method:e.method,headers:Object.fromEntries(e.headers.entries()),base64Body:n},e=e.url}return syscall("sandboxFetch.fetch",e,t)}globalThis.nativeFetch=globalThis.fetch;function yn(){globalThis.fetch=async function(e,t){let r=t&&t.body?Ot(new Uint8Array(await new Response(t.body).arrayBuffer())):void 0,n=await hn(e,t&&{method:t.method,headers:t.headers,base64Body:r});return new Response(n.base64Body?gn(n.base64Body):null,{status:n.status,headers:n.headers})}}He&&yn();function Ve(e){if(e.children)for(let t of e.children){if(t.parent)return;t.parent=e,Ve(t)}}function bn(e,t){return xe(e,r=>r.type===t)}function xe(e,t){if(t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...xe(n,t)];return r}async function kt(e,t){if(await t(e))return[e];let r=[];if(e.children)for(let n of e.children)r=[...r,...await kt(n,t)];return r}function ze(e,t){if(e.children){let r=e.children.slice();for(let n of r){let i=t(n);if(i!==void 0){let o=e.children.indexOf(n);i?e.children.splice(o,1,i):e.children.splice(o,1)}else ze(n,t)}}}async function Qe(e,t){if(e.children){let r=e.children.slice();for(let n of r){let i=await t(n);if(i!==void 0){let o=e.children.indexOf(n);i?e.children.splice(o,1,i):e.children.splice(o,1)}else await Qe(n,t)}}}function W(e,t){return xe(e,r=>r.type===t)[0]}function Je(e,t){xe(e,t)}async function Ft(e,t){await kt(e,t)}function U(e){if(!e)return"";let t=[];if(e.text!==void 0)return e.text;for(let r of e.children)t.push(U(r));return t.join("")}function Ze(e,t=!0){if(bn(e,"\u26A0").length>0)throw new Error(`Parse error in: ${U(e)}`);if(e.text!==void 0)return e.text;let n=[e.type];for(let i of e.children)i.type&&!i.type.endsWith("Mark")&&n.push(Ze(i,t)),i.text&&(t&&i.text.trim()||!t)&&n.push(i.text);return n}function xn(e){return e.getUTCHours()===0&&e.getUTCMinutes()===0&&e.getUTCSeconds()===0?e.getFullYear()+"-"+String(e.getMonth()+1).padStart(2,"0")+"-"+String(e.getDate()).padStart(2,"0"):e.toISOString()}function we(e){if(!e||typeof e!="object")return e;if(Array.isArray(e))return e.map(we);if(e instanceof Date)return xn(e);let t={};for(let r of Object.keys(e)){let n=r.split("."),i=t;for(let o=0;o<n.length-1;o++){let a=n[o];i[a]||(i[a]={}),i=i[a]}i[n[n.length-1]]=we(e[r])}return t}var m={};K(m,{confirm:()=>Vn,copyToClipboard:()=>ai,deleteLine:()=>si,dispatch:()=>Yn,downloadFile:()=>$n,filterBox:()=>Dn,flashNotification:()=>Rn,fold:()=>Zn,foldAll:()=>ti,getCurrentPage:()=>wn,getCursor:()=>Sn,getSelection:()=>En,getText:()=>Pn,getUiOption:()=>zn,goHistory:()=>Ln,hidePanel:()=>Kn,insertAtCursor:()=>Bn,insertAtPos:()=>_n,moveCursor:()=>Wn,navigate:()=>In,openCommandPalette:()=>Nn,openPageNavigator:()=>Mn,openSearchPanel:()=>oi,openUrl:()=>jn,prompt:()=>Hn,redo:()=>ii,reloadPage:()=>On,reloadSettingsAndCommands:()=>Fn,reloadUI:()=>kn,replaceRange:()=>Gn,save:()=>Tn,setPage:()=>An,setSelection:()=>Cn,setText:()=>vn,setUiOption:()=>Qn,showPanel:()=>qn,toggleFold:()=>ei,undo:()=>ni,unfold:()=>Xn,unfoldAll:()=>ri,uploadFile:()=>Un,vimEx:()=>Jn});typeof self>"u"&&(self={syscall:()=>{throw new Error("Not implemented here")}});var p=globalThis.syscall;function wn(){return p("editor.getCurrentPage")}function An(e){return p("editor.setPage",e)}function Pn(){return p("editor.getText")}function vn(e){return p("editor.setText",e)}function Sn(){return p("editor.getCursor")}function En(){return p("editor.getSelection")}function Cn(e,t){return p("editor.setSelection",e,t)}function Tn(){return p("editor.save")}function In(e,t=!1,r=!1){return p("editor.navigate",e,t,r)}function Mn(e="page"){return p("editor.openPageNavigator",e)}function Nn(){return p("editor.openCommandPalette")}function On(){return p("editor.reloadPage")}function kn(){return p("editor.reloadUI")}function Fn(){return p("editor.reloadSettingsAndCommands")}function jn(e,t=!1){return p("editor.openUrl",e,t)}function Ln(e){return p("editor.goHistory",e)}function $n(e,t){return p("editor.downloadFile",e,t)}function Un(e,t){return p("editor.uploadFile",e,t)}function Rn(e,t="info"){return p("editor.flashNotification",e,t)}function Dn(e,t,r="",n=""){return p("editor.filterBox",e,t,r,n)}function qn(e,t,r,n=""){return p("editor.showPanel",e,t,r,n)}function Kn(e){return p("editor.hidePanel",e)}function _n(e,t){return p("editor.insertAtPos",e,t)}function Gn(e,t,r){return p("editor.replaceRange",e,t,r)}function Wn(e,t=!1){return p("editor.moveCursor",e,t)}function Bn(e){return p("editor.insertAtCursor",e)}function Yn(e){return p("editor.dispatch",e)}function Hn(e,t=""){return p("editor.prompt",e,t)}function Vn(e){return p("editor.confirm",e)}function zn(e){return p("editor.getUiOption",e)}function Qn(e,t){return p("editor.setUiOption",e,t)}function Jn(e){return p("editor.vimEx",e)}function Zn(){return p("editor.fold")}function Xn(){return p("editor.unfold")}function ei(){return p("editor.toggleFold")}function ti(){return p("editor.foldAll")}function ri(){return p("editor.unfoldAll")}function ni(){return p("editor.undo")}function ii(){return p("editor.redo")}function oi(){return p("editor.openSearchPanel")}function ai(e){return p("editor.copyToClipboard",e)}function si(){return p("editor.deleteLine")}var F={};K(F,{parseMarkdown:()=>ci});function ci(e){return p("markdown.parseMarkdown",e)}var j={};K(j,{deleteAttachment:()=>xi,deleteFile:()=>Si,deletePage:()=>mi,getAttachmentMeta:()=>hi,getFileMeta:()=>Pi,getPageMeta:()=>di,listAttachments:()=>gi,listFiles:()=>wi,listPages:()=>li,listPlugs:()=>fi,readAttachment:()=>yi,readFile:()=>Ai,readPage:()=>ui,writeAttachment:()=>bi,writeFile:()=>vi,writePage:()=>pi});function li(e=!1){return p("space.listPages",e)}function di(e){return p("space.getPageMeta",e)}function ui(e){return p("space.readPage",e)}function pi(e,t){return p("space.writePage",e,t)}function mi(e){return p("space.deletePage",e)}function fi(){return p("space.listPlugs")}function gi(){return p("space.listAttachments")}function hi(e){return p("space.getAttachmentMeta",e)}function yi(e){return p("space.readAttachment",e)}function bi(e,t){return p("space.writeAttachment",e,t)}function xi(e){return p("space.deleteAttachment",e)}function wi(){return p("space.listFiles")}function Ai(e){return p("space.readFile",e)}function Pi(e){return p("space.getFileMeta",e)}function vi(e,t){return p("space.writeFile",e,t)}function Si(e){return p("space.deleteFile",e)}var A={};K(A,{applyAttributeExtractors:()=>Ni,getEnv:()=>ki,getMode:()=>Fi,getVersion:()=>ji,invokeCommand:()=>Ci,invokeFunction:()=>Ei,invokeSpaceFunction:()=>Mi,listCommands:()=>Ti,listSyscalls:()=>Ii,reloadPlugs:()=>Oi});function Ei(e,...t){return p("system.invokeFunction",e,...t)}function Ci(e,t){return p("system.invokeCommand",e,t)}function Ti(){return p("system.listCommands")}function Ii(){return p("system.listSyscalls")}function Mi(e,...t){return p("system.invokeSpaceFunction",e,...t)}function Ni(e,t,r){return p("system.applyAttributeExtractors",e,t,r)}function Oi(){return p("system.reloadPlugs")}function ki(){return p("system.getEnv")}function Fi(){return p("system.getMode")}function ji(){return p("system.getVersion")}var _={};K(_,{del:()=>Ui,get:()=>$i,set:()=>Li});function Li(e,t){return p("clientStore.set",e,t)}function $i(e){return p("clientStore.get",e)}function Ui(e){return p("clientStore.delete",e)}var Ae={};K(Ae,{listLanguages:()=>Ki,parseLanguage:()=>qi});function qi(e,t){return p("language.parseLanguage",e,t)}function Ki(){return p("language.listLanguages")}var ee={};K(ee,{parseTemplate:()=>Gi,renderTemplate:()=>_i});function _i(e,t,r={}){return p("template.renderTemplate",e,t,r)}function Gi(e){return p("template.parseTemplate",e)}var z={};K(z,{dispatchEvent:()=>Yi,listEvents:()=>Hi});function Yi(e,t,r){return new Promise((n,i)=>{let o=-1;r&&(o=setTimeout(()=>{console.log("Timeout!"),i("timeout")},r)),p("event.dispatch",e,t).then(a=>{o!==-1&&clearTimeout(o),n(a)}).catch(i)})}function Hi(){return p("event.list")}var R={};K(R,{parse:()=>zi,stringify:()=>Qi});function zi(e){return p("yaml.parse",e)}function Qi(e){return p("yaml.stringify",e)}async function Q(e,t={}){let r={tags:[]},n=[];Ve(e),await Qe(e,async i=>{if(i.type==="Paragraph"&&i.parent?.type==="Document"){let o=!0,a=new Set;for(let s of i.children)if(s.text){if(s.text.startsWith(`
`)&&s.text!==`
`)break;if(s.text.trim()){o=!1;break}}else if(s.type==="Hashtag"){let c=s.children[0].text.substring(1);a.add(c),(t.removeTags===!0||t.removeTags?.includes(c))&&(s.children[0].text="")}else if(s.type){o=!1;break}o&&n.push(...a)}if(i.type==="FrontMatter"){let o=i.children[1].children[0],a=U(o);try{let s=await R.parse(a),c={...s};if(r={...r,...s},r.tags||(r.tags=[]),typeof r.tags=="string"&&n.push(...r.tags.split(/,\s*|\s+/)),Array.isArray(r.tags)&&n.push(...r.tags),t.removeKeys&&t.removeKeys.length>0){let l=!1;for(let u of t.removeKeys)u in c&&(delete c[u],l=!0);l&&(o.text=await R.stringify(c))}if(Object.keys(c).length===0||t.removeFrontmatterSection)return null}catch(s){console.warn("Could not parse frontmatter",s.message)}}});try{r.tags=[...new Set([...n.map(i=>String(i).replace(/^#/,""))])]}catch(i){console.error("Error while processing tags",i)}return r=we(r),r}async function Xe(e,t){let r=null;if(await Ft(e,async n=>{if(n.type==="FrontMatter"){let i=n.children[1].children[0],o=U(i);try{let a="";if(typeof t=="string")a=o+t+`
`;else{let c={...await R.parse(o),...t};a=await R.stringify(c)}r={changes:{from:i.from,to:i.to,insert:a}}}catch(a){console.error("Error parsing YAML",a)}return!0}return!1}),!r){let n="";typeof t=="string"?n=t+`
`:n=await R.stringify(t),r={changes:{from:0,to:0,insert:`---
`+n+`---
`}}}return r}var Pe=class{constructor(t,r={}){this.maxSize=t;this.map=new Map(Object.entries(r))}map;set(t,r,n){let i={value:r,la:Date.now()};if(n){let o=this.map.get(t);o?.expTimer&&clearTimeout(o.expTimer),i.expTimer=setTimeout(()=>{this.map.delete(t)},n)}if(this.map.size>=this.maxSize){let o=this.getOldestKey();this.map.delete(o)}this.map.set(t,i)}get(t){let r=this.map.get(t);if(r)return r.la=Date.now(),r.value}remove(t){this.map.delete(t)}toJSON(){return Object.fromEntries(this.map.entries())}getOldestKey(){let t,r;for(let[n,i]of this.map.entries())(!r||i.la<r)&&(t=n,r=i.la);return t}};var jt=new Pe(50);async function Lt(e,t,r){if(!r)return t(e);let n=JSON.stringify(e),i=jt.get(n);if(i)return i;let o=await t(e);return jt.set(n,o,r*1e3),o}function et(e,t){return A.invokeFunction("index.indexObjects",e,t)}function te(e,t,r){return Lt(t,()=>A.invokeFunction("index.queryObjects",e,t),r)}async function $t(e,t={},r={}){try{let n=await F.parseMarkdown(e),i=await Q(n,{removeFrontmatterSection:!0,removeTags:["template"]});e=U(n).trimStart();let o;return i.frontmatter&&(typeof i.frontmatter=="string"?o=i.frontmatter:o=await R.stringify(i.frontmatter),o=await ee.renderTemplate(o,t,r)),{frontmatter:i,renderedFrontmatter:o,text:await ee.renderTemplate(e,t,r)}}catch(n){throw console.error("Error rendering template",n),n}}async function Xi(){let e=await m.getSelection(),t="";return e.from===e.to?t="":t=(await m.getText()).slice(e.from,e.to),{from:e.from,to:e.to,text:t}}async function ve(){let e=await Xi(),t=await m.getText();if(e.text==="")return{from:0,to:t.length,text:t,isWholeNote:!0};let r=e.from===0&&e.to===t.length;return{...e,isWholeNote:r}}async function re(){return(await m.getText()).length}async function eo(e,t){let r=await j.readPage(e),n=await F.parseMarkdown(r),i;return Je(n,o=>{if(o.type!=="FencedCode")return!1;let a=W(o,"CodeInfo");if(t&&!a||t&&!t.includes(a.children[0].text))return!1;let s=W(o,"CodeText");return s?(i=s.children[0].text,!0):!1}),i}async function Se(e,t=["yaml"]){let r=await eo(e,t);if(r!==void 0)try{return R.parse(r)}catch(n){throw console.error("YAML Page parser error",n),new Error(`YAML Error: ${n.message}`)}}async function Ee(e){try{let r=(await Se("SECRETS",["yaml","secrets"]))[e];if(r===void 0)throw new Error(`No such secret: ${e}`);return r}catch(t){throw t.message==="Not found"?new Error(`No such secret: ${e}`):t}}var to="SETTINGS";async function Ut(e,t){try{let n=(await Se(to,["yaml"])||{})[e];return n===void 0?t:n}catch(r){if(r.message==="Not found")return t;throw r}}var Ce=class{apiKey;baseUrl;name;modelName;requireAuth;constructor(t,r,n,i,o=!0){this.apiKey=t,this.baseUrl=r,this.name=n,this.modelName=i,this.requireAuth=o}};var Te=class extends Ce{constructor(t,r,n){super(t,n,"DALL-E",r)}async generateImage(t){try{C||await B();let r=await nativeFetch(`${this.baseUrl}/images/generations`,{method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:this.modelName,prompt:t.prompt,n:t.numImages,size:t.size,quality:t.quality,response_format:"b64_json"})});if(!r.ok)throw new Error(`HTTP error, status: ${r.status}`);let n=await r.json();if(!n||n.length===0)throw new Error("Invalid response from DALL-E.");return n}catch(r){throw console.error("Error calling DALL\xB7E image generation endpoint:",r),r}}};var J=function(e,t){if(!(this instanceof J))return new J(e,t);this.INITIALIZING=-1,this.CONNECTING=0,this.OPEN=1,this.CLOSED=2,this.url=e,t=t||{},this.headers=t.headers||{},this.payload=t.payload!==void 0?t.payload:"",this.method=t.method||this.payload&&"POST"||"GET",this.withCredentials=!!t.withCredentials,this.debug=!!t.debug,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=this.INITIALIZING,this.progress=0,this.chunk="",this.addEventListener=function(r,n){this.listeners[r]===void 0&&(this.listeners[r]=[]),this.listeners[r].indexOf(n)===-1&&this.listeners[r].push(n)},this.removeEventListener=function(r,n){if(this.listeners[r]!==void 0){var i=[];this.listeners[r].forEach(function(o){o!==n&&i.push(o)}),i.length===0?delete this.listeners[r]:this.listeners[r]=i}},this.dispatchEvent=function(r){if(!r)return!0;this.debug&&console.debug(r),r.source=this;var n="on"+r.type;return this.hasOwnProperty(n)&&(this[n].call(this,r),r.defaultPrevented)?!1:this.listeners[r.type]?this.listeners[r.type].every(function(i){return i(r),!r.defaultPrevented}):!0},this._setReadyState=function(r){var n=new CustomEvent("readystatechange");n.readyState=r,this.readyState=r,this.dispatchEvent(n)},this._onStreamFailure=function(r){var n=new CustomEvent("error");n.data=r.currentTarget.response,this.dispatchEvent(n),this.close()},this._onStreamAbort=function(r){this.dispatchEvent(new CustomEvent("abort")),this.close()},this._onStreamProgress=function(r){if(this.xhr){if(this.xhr.status!==200){this._onStreamFailure(r);return}this.readyState==this.CONNECTING&&(this.dispatchEvent(new CustomEvent("open")),this._setReadyState(this.OPEN));var n=this.xhr.responseText.substring(this.progress);this.progress+=n.length;var i=(this.chunk+n).split(/(\r\n\r\n|\r\r|\n\n)/g),o=i.pop();i.forEach(function(a){a.trim().length>0&&this.dispatchEvent(this._parseEventChunk(a))}.bind(this)),this.chunk=o}},this._onStreamLoaded=function(r){this._onStreamProgress(r),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk=""},this._parseEventChunk=function(r){if(!r||r.length===0)return null;this.debug&&console.debug(r);var n={id:null,retry:null,data:null,event:null};r.split(/\n|\r\n|\r/).forEach(function(o){var a=o.indexOf(this.FIELD_SEPARATOR),s,c;if(a>0){var l=o[a+1]===" "?2:1;s=o.substring(0,a),c=o.substring(a+l)}else if(a<0)s=o,c="";else return;s in n&&(s==="data"&&n[s]!==null?n.data+=`
`+c:n[s]=c)}.bind(this));var i=new CustomEvent(n.event||"message");return i.data=n.data||"",i.id=n.id,i},this._checkStreamClosed=function(){this.xhr&&this.xhr.readyState===XMLHttpRequest.DONE&&this._setReadyState(this.CLOSED)},this.stream=function(){if(!this.xhr){this._setReadyState(this.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._checkStreamClosed.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(var r in this.headers)this.xhr.setRequestHeader(r,this.headers[r]);this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==this.CLOSED&&(this.xhr.abort(),this.xhr=null,this._setReadyState(this.CLOSED))},(t.start===void 0||t.start)&&this.stream()};typeof exports<"u"&&(exports.SSE=J);var Rt={};function Ie(e,t){Rt[e]=t}function Me(e){return Rt[e]}async function Ne(...e){let t=e.join(""),r=new TextEncoder().encode(t),n=await crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(n)).map(a=>a.toString(16).padStart(2,"0")).join("")}var Y=class{apiKey;baseUrl;name;modelName;requireAuth;constructor(t,r,n,i,o=!0){this.apiKey=t,this.baseUrl=r,this.name=n,this.modelName=i,this.requireAuth=o}async generateEmbeddings(t){let r=await Ne(this.modelName,t.text),n=Me(r);if(n)return n;let i=await this._generateEmbeddings(t);return Ie(r,i),i}};var qt=/@(\d+)$/,Kt=/\$([a-zA-Z\.\-\/]+[\w\.\-\/]*)$/,_t=/#([^#]*)$/;function Gt(e){e.startsWith("[[")&&e.endsWith("]]")&&(e=e.slice(2,-2));let t={page:e},r=t.page.match(qt);r&&(t.pos=parseInt(r[1]),t.page=t.page.replace(qt,""));let n=t.page.match(Kt);n&&(t.anchor=n[1],t.page=t.page.replace(Kt,""));let i=t.page.match(_t);return i&&(t.header=i[1],t.page=t.page.replace(_t,"")),t}function Wt(e){return ze(e,t=>{switch(t.type){case"FrontMatter":return null;case"WikiLink":{let r=W(t,"WikiLinkPage").children[0].text,n=r.split("/").pop(),i=W(t,"WikiLinkAlias");i&&(n=i.children[0].text);let o=Gt(r);return{text:`[${n}](${typeof location<"u"?location.origin:""}/${encodeURI(o.page)})`}}case"NamedAnchor":return null;case"CommandLink":{let n=t.children[1].children[0].text,i=W(t,"CommandLinkAlias");return i&&(n=i.children[0].text),{text:"`"+n+"`"}}case"Attribute":return null}}),e}var tt="\u{1F916} ";function Oe(e){return!(["SETTINGS","SECRETS",...f.indexEmbeddingsExcludePages].includes(e)||e.startsWith("_")||e.startsWith("Library/")||/\.conflicted\.\d+$/.test(e))}async function Yt({name:e,tree:t}){if(await A.getEnv()!=="server"||(await I(),!Oe(e))||!t.children)return;let r=t.children.filter(s=>s.type==="Paragraph"),n=[],i=Date.now();for(let s of r){let c=U(s).trim();if(!c||c.length<10||f.indexEmbeddingsExcludeStrings.some(y=>c.includes(y)))continue;let l=await D.generateEmbeddings({text:c}),u=s.from??0,d={ref:`${e}@${u}`,page:e,pos:u,embedding:l,text:c,tag:"embedding"};n.push(d)}await et(e,n);let a=(Date.now()-i)/1e3;O("any",`AI: Indexed ${n.length} embedding objects for page ${e} in ${a} seconds`)}async function Ht({name:e,tree:t}){if(await A.getEnv()!=="server"||(await I(),!Oe(e))||!t.children)return;let r=U(t),n=f.textModels.find(u=>u.name===f.indexSummaryModelName);if(!n)throw new Error(`Could not find summary model ${f.indexSummaryModelName}`);let i=await de(n),o;f.promptInstructions.indexSummaryPrompt!==""?o=f.promptInstructions.indexSummaryPrompt:o=`Provide a concise and informative summary of the above page. The summary should capture the key points and be useful for search purposes. Avoid any formatting or extraneous text.  No more than one paragraph.  Summary:
`;let a=await Ne(n.name,r,o),s=Me(a);s||(s=await i.singleMessageChat("Contents of "+e+`:
`+r+`

`+o),Ie(a,s));let c=await D.generateEmbeddings({text:s}),l={ref:`${e}@0`,page:e,embedding:c,text:s,tag:"aiSummary"};await et(e,[l]),O("any",`AI: Indexed summary for page ${e}`)}async function rt(){return await ot()?await syscall("system.invokeFunctionOnServer","index.queryObjects","embedding",{}):await te("embedding",{})}async function ro(){return await ot()?await syscall("system.invokeFunctionOnServer","index.queryObjects","aiSummary",{}):await te("aiSummary",{})}function Bt(e,t){let r=e.reduce((o,a,s)=>o+a*t[s],0),n=Math.sqrt(e.reduce((o,a)=>o+a*a,0)),i=Math.sqrt(t.reduce((o,a)=>o+a*a,0));return r/(n*i)}async function nt(e,t=10,r=!1){await I();let n=Date.now(),i=typeof e=="string"?await D.generateEmbeddings({text:e}):e,o=Date.now();console.log(`searchEmbeddings: Query embedding generation took ${o-n} ms`);let a=Date.now(),s=await rt(),c=Date.now();console.log(`Retrieved ${s.length} embeddings in ${c-a} ms`);let l="",u=0;r&&await A.getEnv()!=="server"&&(l=`Retrieved ${s.length} embeddings in ${c-a} ms

`,u=(await m.getText()).length,await m.replaceRange(u,u,l));let d=[],y=Date.now();for(let g=0;g<s.length;g++){let b=s[g];if(Oe(b.page)&&(d.push({page:b.page,ref:b.ref,text:b.text,similarity:Bt(i,b.embedding)}),r&&(g%100===0||Date.now()-y>=100)&&await A.getEnv()!=="server")){let w=u+l.length;l=`

Processed ${g+1} of ${s.length} embeddings...

`,await m.replaceRange(u,w,l),y=Date.now()}}if(console.log(`Finished searching embeddings in ${Date.now()-a} ms`),f.indexSummary){let g=Date.now(),b=await ro(),w=Date.now();console.log(`Retrieved ${b.length} summaries in ${w-g} ms`);let P="",T=0;r&&await A.getEnv()!=="server"&&(P=`Retrieved ${b.length} summaries in ${w-g} ms

`,T=(await m.getText()).length,await m.replaceRange(T,T,P));let x=[],Mt=Date.now();for(let ce=0;ce<b.length;ce++){let le=b[ce];if(Oe(le.page)&&(x.push({page:le.page,ref:le.ref,text:`Page Summary: ${le.text}`,similarity:Bt(i,le.embedding)}),r&&(ce%100===0||Date.now()-Mt>=100)&&await A.getEnv()!=="server")){let mn=T+P.length;P=`

Processed ${ce+1} of ${b.length} summaries...

`,await m.replaceRange(T,mn,P),Mt=Date.now()}}console.log(`Finished searching summaries in ${Date.now()-g} ms`),d.push(...x)}return d.sort((g,b)=>b.similarity-g.similarity).slice(0,t)}async function ke(e,t=10,r=.15,n=!1){let i;i=await nt(e,-1,n);let o={};for(let s of i)s.similarity<r||(o[s.page]?(o[s.page].score+=s.similarity,o[s.page].children.push(s)):o[s.page]={page:s.page,score:s.similarity,children:[s]});for(let s in o)o[s].children=o[s].children.sort((c,l)=>l.similarity-c.similarity).slice(0,t);return Object.values(o).sort((s,c)=>c.score-s.score).slice(0,t)}async function Vt(){let e=await m.prompt("Enter some text to search for:");if(!e){await m.flashNotification("No text entered.","error");return}let t=await ke(e);await m.flashNotification(`Found ${t.length} results`),O("any","AI: Search results",t)}function zt(e){return{data:new TextEncoder().encode(""),meta:{name:e,contentType:"text/markdown",size:0,created:0,lastModified:0,perm:"ro"}}}function it(e){return{name:e,contentType:"text/markdown",size:-1,created:0,lastModified:0,perm:"ro"}}function Qt(e){return it(e)}async function Jt(){let e=await m.getCurrentPage();if(e.startsWith(tt)){await I();let t=e.substring(tt.length),r=`# Search results for "${t}"`,n=r+`

`;if(!f.indexEmbeddings){n+=`> **warning** Embeddings generation is disabled.
`,n+=`> You can enable it in the AI settings.


`,await m.setText(n);return}let i=`${r}

Searching for "${t}"...`;i+=`
Generating query vector embeddings..`,await m.setText(i);let o=await D.generateEmbeddings({text:t});i+=`
Searching for similar embeddings...`,await m.setText(i);let a=await ke(o,void 0,void 0,!0),s=i.length;n=r+`

`,a.length===0&&(n+=`No results found.

`);for(let c of a){n+=`## [[${c.page}]]
`;for(let l of c.children){let d=l.ref.split("@")[1].padStart(4," ");n+=`> [[${l.ref}|${d}]] | ${l.text}
`}}await m.replaceRange(0,s,n)}}async function Zt(){let e=await m.prompt("Search for: ");e&&await m.navigate({page:`${tt}${e}`})}function Xt(e){return e.split("/").slice(0,-1).join("/")}async function O(e,...t){(await A.getEnv()===e||e==="any")&&console.log(...t)}async function er(){let t=(await m.getText()).split(`
`),r=[],n="user",i="";return t.forEach(o=>{if(o.trim()==="")return;let a=o.match(/^\*\*(\w+)\*\*:/);if(a){let s=a[1].toLowerCase();n&&n!==s&&i.trim()!==""&&(r.push({role:n,content:i.trim()}),i=""),n=s,i+=o.replace(/^\*\*(\w+)\*\*:/,"").trim()+`
`}else n&&(i+=o.trim()+`
`)}),i&&n&&r.push({role:n,content:i.trim()}),r}async function tr(){try{let e=await syscall("system.getVersion"),[t,r,n]=e.split(".").map(Number),[i,o,a]="0.7.2".split(".").map(Number);return t>i||t===i&&r>o||t===i&&r===o&&n>=a}catch{return!1}}async function ot(){try{return(await A.listSyscalls()).some(t=>t.name==="system.invokeFunctionOnServer")}catch{return!1}}async function Fe(e){let t=[];for(let r of e){let n=r.content;if(r.role==="assistant"){t.push(r);continue}if(f.chat.searchEmbeddings&&f.indexEmbeddings){let s=await ke(n);if(s.length>0){n+=`

The following pages were found to be relevant to the question. You can use them as context to answer the question.
`;for(let c of s)n+=`* [[${c.page}]] (similarity score ${c.score})
`}}if(f.chat.parseWikiLinks&&(n=await no(n)),f.chat.bakeMessages){let s=await F.parseMarkdown(n),c=await A.invokeFunction("markdown.expandCodeWidgets",s,"");n=U(Wt(c)).trim()}let o=(await z.dispatchEvent("ai:enrichMessage",{enrichedContent:n,message:r})).flat().concat(f.chat.customEnrichFunctions),a=[...new Set(o)];console.log("Received custom enrich message functions",a);for(let s of a)n=await A.invokeSpaceFunction(s,n);t.push({...r,content:n})}return t}async function no(e){let t=[],r=e,n=/\[\[([^\]]+)\]\]/g,i,o=!1;for(;(i=n.exec(e))!==null;){let a=i[1];if(!t.includes(a)){o||(r+=`

Base your answer on the content of the following referenced pages (referenced above using the >>page name<< format). In these listings ~~~ is used to mark the page's content start and end. If context is missing, always ask me to link directly to a page mentioned in the context.`,o=!0);try{let s=await j.readPage(a);t.push(a),r+=`

Content of the [[${a}]] page:
~~~
${s}
~~~
`}catch(s){console.error(`Error fetching page '${a}':`,s)}}}return r=r.replace(n,">>$1<<"),r}var ne=class{name;apiKey;baseUrl;modelName;constructor(t,r,n,i){this.name=t,this.apiKey=r,this.baseUrl=n,this.modelName=i}async streamChatIntoEditor(t,r){let{onDataReceived:n}=t,i="\u{1F914} Thinking \u2026 ",o=r??await re();await m.insertAtPos(i,o);let a=!0,s=c=>{try{if(!c){console.log("No data received from LLM");return}a?(["`","-","*"].includes(c.charAt(0))&&(console.log("First character of response is:",c.charAt(0)),c=`
`+c),m.replaceRange(o,o+i.length,c),a=!1):m.insertAtPos(c,o),o+=c.length,n&&n(c)}catch(l){console.error("Error handling chat stream data:",l),m.flashNotification("An error occurred while processing chat data.","error")}};await this.chatWithAI({...t,onDataReceived:s})}async singleMessageChat(t,r,n=!1){let i=[{role:"user",content:t}];return r&&i.unshift({role:"system",content:r}),n&&(i=await Fe(i)),await this.chatWithAI({messages:i,stream:!1})}};var je=class extends ne{name="Gemini";constructor(t,r){super("Gemini",t,"https://generativelanguage.googleapis.com",r)}async listModels(){let t=`${this.baseUrl}/v1beta/models?key=${this.apiKey}`;try{let r=await fetch(t);if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return(await r.json()).models||[]}catch(r){throw console.error("Failed to fetch models:",r),r}}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return r?await this.streamChat({messages:t,stream:r,onDataReceived:n}):await this.nonStreamingChat(t)}mapRolesForGemini(t){let r=[],n="";return t.forEach(i=>{let o="user";i.role==="system"||i.role==="user"?o="user":i.role==="assistant"&&(o="model"),o==="model"&&(r.length===0||n==="model")||(o==="user"&&n==="user"?r[r.length-1].parts[0].text+=" "+i.content:r.push({role:o,parts:[{text:i.content}]})),n=o}),r}streamChat(t){let{messages:r,onDataReceived:n}=t;try{let i=`${this.baseUrl}/v1beta/models/${this.modelName}:streamGenerateContent?key=${this.apiKey}&alt=sse`,o={"Content-Type":"application/json"},a=this.mapRolesForGemini(r),s={method:"POST",headers:o,payload:JSON.stringify({contents:a}),withCredentials:!1},c=new J(i,s),l="";c.addEventListener("message",u=>{try{if(u.data=="[DONE]")return c.close(),l;if(!u.data)console.error("Received empty message from Gemini"),console.log("source: ",c);else{let d=JSON.parse(u.data),y=d.candidates[0].content.parts[0].text||d.text||"";l+=y,n&&n(y)}}catch(d){console.error("Error processing message event:",d,u.data)}}),c.addEventListener("end",()=>(c.close(),l)),c.addEventListener("error",u=>{console.error("SSE error:",u),c.close()}),c.stream()}catch(i){throw console.error("Error streaming from Gemini chat endpoint:",i),i}}async nonStreamingChat(t){let r=this.mapRolesForGemini(t),n=await nativeFetch(`${this.baseUrl}/v1beta/models/${this.modelName}:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:r})});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return(await n.json()).candidates[0].content.parts[0].text}},Le=class extends Y{constructor(t,r,n="https://generativelanguage.googleapis.com",i=!0){super(t,n,"Gemini",r,i)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,content:{parts:[{text:t.text}]}}),n={"Content-Type":"application/json"};this.requireAuth&&(n.Authorization=`Bearer ${this.apiKey}`);let i=await nativeFetch(`${this.baseUrl}/v1beta/models/${this.modelName}:embedContent?key=${this.apiKey}`,{method:"POST",headers:n,body:r});if(!i.ok)throw console.error("HTTP response: ",i),console.error("HTTP response body: ",await i.json()),new Error(`HTTP error, status: ${i.status}`);let o=await i.json();if(!o||!o.embedding||!o.embedding.values)throw new Error("Invalid response from Gemini.");return o.embedding.values}};var $e=class extends ne{name="OpenAI";requireAuth;constructor(t,r,n,i){super("OpenAI",t,n,r),this.requireAuth=i}async chatWithAI({messages:t,stream:r,onDataReceived:n}){return r?await this.streamChat({messages:t,onDataReceived:n}):await this.nonStreamingChat(t)}async streamChat(t){let{messages:r,onDataReceived:n}=t;try{let i=`${this.baseUrl}/chat/completions`,o={"Content-Type":"application/json"};this.requireAuth&&(o.Authorization=`Bearer ${this.apiKey}`);let a={method:"POST",headers:o,payload:JSON.stringify({model:this.modelName,stream:!0,messages:r}),withCredentials:!1},s=new J(i,a),c="";s.addEventListener("message",function(l){try{if(l.data=="[DONE]")return s.close(),c;{let d=JSON.parse(l.data).choices[0]?.delta?.content||"";c+=d,n&&n(d)}}catch(u){console.error("Error processing message event:",u,l.data)}}),s.addEventListener("end",function(){return s.close(),c}),s.addEventListener("error",l=>{console.error("SSE error:",l),s.close()}),s.stream()}catch(i){throw console.error("Error streaming from OpenAI chat endpoint:",i),await m.flashNotification("Error streaming from OpenAI chat endpoint.","error"),i}return""}async nonStreamingChat(t){try{let r=JSON.stringify({model:this.modelName,messages:t}),n={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},i=await nativeFetch(this.baseUrl+"/chat/completions",{method:"POST",headers:n,body:r});if(!i.ok)throw console.error("http response: ",i),console.error("http response body: ",await i.json()),new Error(`HTTP error, status: ${i.status}`);let o=await i.json();if(!o||!o.choices||o.choices.length===0)throw new Error("Invalid response from OpenAI.");return o.choices[0].message.content}catch(r){throw console.error("Error calling OpenAI chat endpoint:",r),await m.flashNotification("Error calling OpenAI chat endpoint.","error"),r}}},Ue=class extends Y{constructor(t,r,n,i=!0){super(t,n,"OpenAI",r,i)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,input:t.text,encoding_format:"float"}),n={"Content-Type":"application/json"};this.requireAuth&&(n.Authorization=`Bearer ${this.apiKey}`);let i=await nativeFetch(`${this.baseUrl}/embeddings`,{method:"POST",headers:n,body:r});if(!i.ok)throw console.error("HTTP response: ",i),console.error("HTTP response body: ",await i.json()),new Error(`HTTP error, status: ${i.status}`);let o=await i.json();if(!o||!o.data||o.data.length===0)throw new Error("Invalid response from OpenAI.");return o.data[0].embedding}};var Re=class extends Y{constructor(t,r,n,i=!1){super(t,n,"Ollama",r,i)}async _generateEmbeddings(t){let r=JSON.stringify({model:this.modelName,prompt:t.text}),n={"Content-Type":"application/json"};this.requireAuth&&(n.Authorization=`Bearer ${this.apiKey}`);let i=await nativeFetch(`${this.baseUrl}/api/embeddings`,{method:"POST",headers:n,body:r});if(!i.ok)throw console.error("HTTP response: ",i),console.error("HTTP response body: ",await i.json()),new Error(`HTTP error, status: ${i.status}`);let o=await i.json();if(!o||!o.embedding||o.embedding.length===0)throw new Error("Invalid response from Ollama.");return o.embedding}};var C,f,ue,k,st,D,at,io,oo;async function I(){let e=await rr();(!C||!k||!f||!at||JSON.stringify(e)!==JSON.stringify(at))&&await B(!0)}async function rr(){if(await A.getEnv()!="server")try{return await _.get("ai.selectedTextModel")}catch{return}}async function ao(){if(await A.getEnv()!="server")try{return await _.get("ai.selectedImageModel")}catch{return}}async function so(){if(await A.getEnv()!="server")try{return await _.get("ai.selectedEmbeddingModel")}catch{return}}async function ct(e){await A.getEnv()!="server"&&await _.set("ai.selectedImageModel",e)}async function lt(e){await A.getEnv()!="server"&&await _.set("ai.selectedTextModel",e)}async function dt(e){await A.getEnv()!="server"&&await _.set("ai.selectedEmbeddingModel",e)}async function co(){let e=await rr()||f.textModels[0];if(!e)throw new Error("No text model selected or available as default.");await de(e)}async function lo(){let e=await ao()||f.imageModels[0];if(!e)throw new Error("No image model selected or available as default.");await ut(e)}async function uo(){let e=await so()||f.embeddingModels[0];if(!e)throw new Error("No embedding model selected or available as default.");await pt(e)}function po(e){let t=e.provider.toLowerCase();switch(O("client","Provider name",t),t){case"dalle":st=new Te(C,e.modelName,e.baseUrl||f.dallEBaseUrl);break;default:throw new Error(`Unsupported image provider: ${e.provider}. Please configure a supported provider.`)}}function mo(e){switch(e.provider.toLowerCase()){case"openai":k=new $e(C,e.modelName,e.baseUrl||f.openAIBaseUrl,e.requireAuth||f.requireAuth);break;case"gemini":k=new je(C,e.modelName);break;default:throw new Error(`Unsupported AI provider: ${e.provider}. Please configure a supported provider.`)}return k}function fo(e){switch(e.provider.toLowerCase()){case"openai":D=new Ue(C,e.modelName,e.baseUrl||f.openAIBaseUrl);break;case"gemini":D=new Le(C,e.modelName);break;case"ollama":D=new Re(C,e.modelName,e.baseUrl||"http://localhost:11434",e.requireAuth);break;default:throw new Error(`Unsupported embedding provider: ${e.provider}. Please configure a supported provider.`)}}async function de(e){if(O("client","configureSelectedModel called with:",e),!e)throw new Error("No model provided to configure");if(e.requireAuth=e.requireAuth??f.requireAuth,e.requireAuth){let t=await Ee(e.secretName||"OPENAI_API_KEY");t!==C&&(C=t,O("client","API key updated"))}if(e.requireAuth&&!C)throw new Error("AI API key is missing. Please set it in the secrets page.");return at=e,mo(e)}async function ut(e){if(O("client","configureSelectedImageModel called with:",e),!e)throw new Error("No image model provided to configure");if(e.requireAuth){let t=await Ee(e.secretName||"OPENAI_API_KEY");t!==C&&(C=t,O("client","API key updated for image model"))}if(e.requireAuth&&!C)throw new Error("AI API key is missing for image model. Please set it in the secrets page.");io=e,po(e)}async function pt(e){if(O("client","configureSelectedEmbeddingModel called with:",e),!e)throw new Error("No embedding model provided to configure");if(e.requireAuth){let t=await Ee(e.secretName||"OPENAI_API_KEY");t!==C&&(C=t,O("client","API key updated for embedding model"))}if(e.requireAuth&&!C)throw new Error("AI API key is missing for embedding model. Please set it in the secrets page.");oo=e,fo(e)}async function go(){let e={openAIBaseUrl:"https://api.openai.com/v1",dallEBaseUrl:"https://api.openai.com/v1",requireAuth:!0,secretName:"OPENAI_API_KEY",provider:"OpenAI",chat:{},promptInstructions:{},imageModels:[],embeddingModels:[],textModels:[],indexEmbeddings:!1,indexSummary:!1,indexSummaryModelName:"",indexEmbeddingsExcludePages:[],indexEmbeddingsExcludeStrings:["**user**:"]},t={userInformation:"",userInstructions:"",parseWikiLinks:!0,bakeMessages:!0,customEnrichFunctions:[],searchEmbeddings:!0},r={pageRenameSystem:"",pageRenameRules:"",tagRules:"",indexSummaryPrompt:"",enhanceFrontMatterPrompt:""},n=await Ut("ai",{}),i={...e,...n};return i.chat={...t,...n.chat||{}},i.promptInstructions={...r,...n.promptInstructions||{}},i}async function B(e=!0){let t=await go();!f||JSON.stringify(f)!==JSON.stringify(t)?(O("client","aiSettings updating from",f),f=t,O("client","aiSettings updated to",f)):O("client","aiSettings unchanged",f),f.textModels.length===1&&await lt(f.textModels[0]),f.imageModels.length===1&&await ct(f.imageModels[0]),f.embeddingModels.length===1&&await dt(f.embeddingModels[0]),e&&(f.textModels.length>0&&await co(),f.imageModels.length>0&&await lo(),f.embeddingModels.length>0&&await uo()),ue={role:"system",content:"This is an interactive chat session with a user in a markdown-based note-taking tool called SilverBullet."},f.chat.userInformation&&(ue.content+=`
The user has provided the following information about themselves: ${f.chat.userInformation}`),f.chat.userInstructions&&(ue.content+=`
The user has provided the following instructions for the chat, follow them as closely as possible: ${f.chat.userInstructions}`)}async function nr(e){return tr()?{options:(await te("template",{filter:["attr",["attr","aiprompt"],"slashCommand"]},5)).map(r=>{let n=r.aiprompt;return console.log("ai prompt template: ",n),{label:n.slashCommand,detail:n.description||r.description,order:n.order||0,templatePage:r.ref,pageName:e.pageName,invoke:"silverbullet-ai.insertAiPromptFromTemplate"}})}:void 0}async function ir(e){let t;if(!e||!e.templatePage){let l=await te("template",{filter:["attr",["attr","aiprompt"],"description"]});t=await m.filterBox("Prompt Template",l.map(u=>{let d=u.ref.split("/").pop();return{...u,description:u.aiprompt.description||u.ref,name:u.aiprompt.displayName||d,systemPrompt:u.aiprompt.systemPrompt||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:u.aiprompt.insertAt||"cursor"}}),"Select the template to use as the prompt.  The prompt will be rendered and sent to the LLM model.")}else{console.log("selectedTemplate from slash completion: ",e);let l=await j.readPage(e.templatePage),u=await F.parseMarkdown(l),{aiprompt:d}=await Q(u);console.log("templatePage from slash completion: ",l),t={ref:e.templatePage,systemPrompt:d.systemPrompt||d.system||"You are an AI note assistant. Please follow the prompt instructions.",insertAt:d.insertAt||"cursor"}}if(!t){await m.flashNotification("No template selected");return}console.log("User selected prompt template: ",t);let r=["cursor","page-start","page-end"];if(!r.includes(t.insertAt)){console.error(`Invalid insertAt value: ${t.insertAt}. It must be one of ${r.join(", ")}`),await m.flashNotification(`Invalid insertAt value: ${t.insertAt}. Please select a valid option.`,"error");return}await I();let n,i,o;try{n=await j.readPage(t.ref),i=await m.getCurrentPage(),o=await j.getPageMeta(i)}catch(l){console.error("Error fetching template details or page metadata",l),await m.flashNotification("Error fetching template details or page metadata","error");return}let a;switch(t.insertAt){case"page-start":a=0;break;case"page-end":a=await re();break;case"frontmatter":await m.flashNotification("rendering in frontmatter not supported yet","error");break;case"modal":break;case"replace":break;case"cursor":default:a=await m.getCursor()}console.log("templatetext: ",n);let s=await $t(n,o,{page:o});console.log("Rendered template:",s);let c=[{role:"user",content:s.text}];t.systemPrompt&&c.unshift({role:"system",content:t.systemPrompt}),await k.streamChatIntoEditor({messages:c,stream:!0},a)}function or(e){let t={querySource:""},[r,n,...i]=e;if(r!=="Query")throw new Error(`Expected query type, got ${r}`);t.querySource=n[1];for(let o of i){let[a]=o;switch(a){case"WhereClause":{t.filter?t.filter=["and",t.filter,v(o[2])]:t.filter=v(o[2]);break}case"OrderClause":{t.orderBy||(t.orderBy=[]);for(let s of o.slice(2))if(s[0]==="OrderBy"){let c=s[1][1];s[2]?t.orderBy.push({expr:v(c),desc:s[2][1][1]==="desc"}):t.orderBy.push({expr:v(c),desc:!1})}break}case"LimitClause":{t.limit=v(o[2][1]);break}case"SelectClause":{for(let s of o.slice(2))s[0]==="Select"&&(t.select||(t.select=[]),s.length===2?t.select.push({name:pe(s[1][1])}):t.select.push({name:pe(s[3][1]),expr:v(s[1])}));break}case"RenderClause":{let s=o.find(c=>c[0]==="PageRef");t.render=s[1].slice(2,-2),t.renderAll=!!o.find(c=>c[0]==="all");break}default:throw new Error(`Unknown clause type: ${a}`)}}return t}function pe(e){return e.startsWith("`")&&e.endsWith("`")?e.slice(1,-1):e}function v(e){if(["LVal","Expression","Value"].includes(e[0]))return v(e[1]);switch(e[0]){case"Attribute":return["attr",v(e[1]),pe(e[3][1])];case"Identifier":return["attr",pe(e[1])];case"String":return["string",e[1].slice(1,-1)];case"Number":return["number",+e[1]];case"Bool":return["boolean",e[1][1]==="true"];case"null":return["null"];case"Regex":return["regexp",e[1].slice(1,-1),"i"];case"List":{let t=[];for(let r of e.slice(2))r[0]==="Expression"&&t.push(r);return["array",t.map(v)]}case"Object":{let t=[];for(let r of e.slice(2)){if(typeof r=="string")continue;let[n,i,o,a]=r;t.push([i[1].slice(1,-1),v(a)])}return["object",t]}case"BinExpression":{let t=v(e[1]),r=e[2][0]==="InKW"?"in":e[2].trim(),n=v(e[3]);return[r,t,n]}case"LogicalExpression":{let t=v(e[1]),r=e[2],n=v(e[3]);return[r[1],t,n]}case"ParenthesizedExpression":return v(e[2]);case"Call":{let t=pe(e[1][1]),r=[];for(let n of e.slice(2))n[0]==="Expression"&&r.push(n);return["call",t,r.map(v)]}case"UnaryExpression":{if(e[1][0]==="NotKW"||e[1][0]==="!")return["not",v(e[2])];if(e[1][0]==="-")return["-",v(e[2])];throw new Error(`Unknown unary expression: ${e[1][0]}`)}case"TopLevelVal":return["attr"];case"GlobalIdentifier":return["global",e[1].substring(1)];case"TernaryExpression":{let[t,r,n,i,o,a]=e;return["?",v(r),v(i),v(a)]}case"QueryExpression":return["query",or(e[2])];case"PageRef":return["pageref",e[1].slice(2,-2)];default:throw new Error(`Not supported: ${e[0]}`)}}async function ar(e){let t=Ze(await Ae.parseLanguage("query",e));return or(t[1])}async function sr(e,t){let r=await ar(e);return ho(r,t)}async function ho(e,t){e.limit||(e.limit=["number",1e3]);let r=`query:${e.querySource}`,n={query:e};t&&(n.variables=t);let i=await z.dispatchEvent(r,n,30*1e3);if(i.length===0)throw new Error(`Unsupported query source '${e.querySource}'`);return i.flat()}var dd=new TextEncoder;function cr(e){let t=atob(e),r=t.length,n=new Uint8Array(r);for(let i=0;i<r;i++)n[i]=t.charCodeAt(i);return n}function Sr(e){return typeof e>"u"||e===null}function yo(e){return typeof e=="object"&&e!==null}function bo(e){return Array.isArray(e)?e:Sr(e)?[]:[e]}function xo(e,t){var r,n,i,o;if(t)for(o=Object.keys(t),r=0,n=o.length;r<n;r+=1)i=o[r],e[i]=t[i];return e}function wo(e,t){var r="",n;for(n=0;n<t;n+=1)r+=e;return r}function Ao(e){return e===0&&Number.NEGATIVE_INFINITY===1/e}var Po=Sr,vo=yo,So=bo,Eo=wo,Co=Ao,To=xo,E={isNothing:Po,isObject:vo,toArray:So,repeat:Eo,isNegativeZero:Co,extend:To};function Er(e,t){var r="",n=e.reason||"(unknown reason)";return e.mark?(e.mark.name&&(r+='in "'+e.mark.name+'" '),r+="("+(e.mark.line+1)+":"+(e.mark.column+1)+")",!t&&e.mark.snippet&&(r+=`

`+e.mark.snippet),n+" "+r):n}function fe(e,t){Error.call(this),this.name="YAMLException",this.reason=e,this.mark=t,this.message=Er(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack||""}fe.prototype=Object.create(Error.prototype);fe.prototype.constructor=fe;fe.prototype.toString=function(e){return this.name+": "+Er(this,e)};var L=fe;function mt(e,t,r,n,i){var o="",a="",s=Math.floor(i/2)-1;return n-t>s&&(o=" ... ",t=n-s+o.length),r-n>s&&(a=" ...",r=n+s-a.length),{str:o+e.slice(t,r).replace(/\t/g,"\u2192")+a,pos:n-t+o.length}}function ft(e,t){return E.repeat(" ",t-e.length)+e}function Io(e,t){if(t=Object.create(t||null),!e.buffer)return null;t.maxLength||(t.maxLength=79),typeof t.indent!="number"&&(t.indent=1),typeof t.linesBefore!="number"&&(t.linesBefore=3),typeof t.linesAfter!="number"&&(t.linesAfter=2);for(var r=/\r?\n|\r|\0/g,n=[0],i=[],o,a=-1;o=r.exec(e.buffer);)i.push(o.index),n.push(o.index+o[0].length),e.position<=o.index&&a<0&&(a=n.length-2);a<0&&(a=n.length-1);var s="",c,l,u=Math.min(e.line+t.linesAfter,i.length).toString().length,d=t.maxLength-(t.indent+u+3);for(c=1;c<=t.linesBefore&&!(a-c<0);c++)l=mt(e.buffer,n[a-c],i[a-c],e.position-(n[a]-n[a-c]),d),s=E.repeat(" ",t.indent)+ft((e.line-c+1).toString(),u)+" | "+l.str+`
`+s;for(l=mt(e.buffer,n[a],i[a],e.position,d),s+=E.repeat(" ",t.indent)+ft((e.line+1).toString(),u)+" | "+l.str+`
`,s+=E.repeat("-",t.indent+u+3+l.pos)+`^
`,c=1;c<=t.linesAfter&&!(a+c>=i.length);c++)l=mt(e.buffer,n[a+c],i[a+c],e.position-(n[a]-n[a+c]),d),s+=E.repeat(" ",t.indent)+ft((e.line+c+1).toString(),u)+" | "+l.str+`
`;return s.replace(/\n$/,"")}var Mo=Io,No=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],Oo=["scalar","sequence","mapping"];function ko(e){var t={};return e!==null&&Object.keys(e).forEach(function(r){e[r].forEach(function(n){t[String(n)]=r})}),t}function Fo(e,t){if(t=t||{},Object.keys(t).forEach(function(r){if(No.indexOf(r)===-1)throw new L('Unknown option "'+r+'" is met in definition of "'+e+'" YAML type.')}),this.options=t,this.tag=e,this.kind=t.kind||null,this.resolve=t.resolve||function(){return!0},this.construct=t.construct||function(r){return r},this.instanceOf=t.instanceOf||null,this.predicate=t.predicate||null,this.represent=t.represent||null,this.representName=t.representName||null,this.defaultStyle=t.defaultStyle||null,this.multi=t.multi||!1,this.styleAliases=ko(t.styleAliases||null),Oo.indexOf(this.kind)===-1)throw new L('Unknown kind "'+this.kind+'" is specified for "'+e+'" YAML type.')}var M=Fo;function lr(e,t){var r=[];return e[t].forEach(function(n){var i=r.length;r.forEach(function(o,a){o.tag===n.tag&&o.kind===n.kind&&o.multi===n.multi&&(i=a)}),r[i]=n}),r}function jo(){var e={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}},t,r;function n(i){i.multi?(e.multi[i.kind].push(i),e.multi.fallback.push(i)):e[i.kind][i.tag]=e.fallback[i.tag]=i}for(t=0,r=arguments.length;t<r;t+=1)arguments[t].forEach(n);return e}function ht(e){return this.extend(e)}ht.prototype.extend=function(e){var t=[],r=[];if(e instanceof M)r.push(e);else if(Array.isArray(e))r=r.concat(e);else if(e&&(Array.isArray(e.implicit)||Array.isArray(e.explicit)))e.implicit&&(t=t.concat(e.implicit)),e.explicit&&(r=r.concat(e.explicit));else throw new L("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");t.forEach(function(i){if(!(i instanceof M))throw new L("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(i.loadKind&&i.loadKind!=="scalar")throw new L("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(i.multi)throw new L("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")}),r.forEach(function(i){if(!(i instanceof M))throw new L("Specified list of YAML types (or a single Type object) contains a non-Type object.")});var n=Object.create(ht.prototype);return n.implicit=(this.implicit||[]).concat(t),n.explicit=(this.explicit||[]).concat(r),n.compiledImplicit=lr(n,"implicit"),n.compiledExplicit=lr(n,"explicit"),n.compiledTypeMap=jo(n.compiledImplicit,n.compiledExplicit),n};var Lo=ht,$o=new M("tag:yaml.org,2002:str",{kind:"scalar",construct:function(e){return e!==null?e:""}}),Uo=new M("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(e){return e!==null?e:[]}}),Ro=new M("tag:yaml.org,2002:map",{kind:"mapping",construct:function(e){return e!==null?e:{}}}),Do=new Lo({explicit:[$o,Uo,Ro]});function qo(e){if(e===null)return!0;var t=e.length;return t===1&&e==="~"||t===4&&(e==="null"||e==="Null"||e==="NULL")}function Ko(){return null}function _o(e){return e===null}var Go=new M("tag:yaml.org,2002:null",{kind:"scalar",resolve:qo,construct:Ko,predicate:_o,represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});function Wo(e){if(e===null)return!1;var t=e.length;return t===4&&(e==="true"||e==="True"||e==="TRUE")||t===5&&(e==="false"||e==="False"||e==="FALSE")}function Bo(e){return e==="true"||e==="True"||e==="TRUE"}function Yo(e){return Object.prototype.toString.call(e)==="[object Boolean]"}var Ho=new M("tag:yaml.org,2002:bool",{kind:"scalar",resolve:Wo,construct:Bo,predicate:Yo,represent:{lowercase:function(e){return e?"true":"false"},uppercase:function(e){return e?"TRUE":"FALSE"},camelcase:function(e){return e?"True":"False"}},defaultStyle:"lowercase"});function Vo(e){return 48<=e&&e<=57||65<=e&&e<=70||97<=e&&e<=102}function zo(e){return 48<=e&&e<=55}function Qo(e){return 48<=e&&e<=57}function Jo(e){if(e===null)return!1;var t=e.length,r=0,n=!1,i;if(!t)return!1;if(i=e[r],(i==="-"||i==="+")&&(i=e[++r]),i==="0"){if(r+1===t)return!0;if(i=e[++r],i==="b"){for(r++;r<t;r++)if(i=e[r],i!=="_"){if(i!=="0"&&i!=="1")return!1;n=!0}return n&&i!=="_"}if(i==="x"){for(r++;r<t;r++)if(i=e[r],i!=="_"){if(!Vo(e.charCodeAt(r)))return!1;n=!0}return n&&i!=="_"}if(i==="o"){for(r++;r<t;r++)if(i=e[r],i!=="_"){if(!zo(e.charCodeAt(r)))return!1;n=!0}return n&&i!=="_"}}if(i==="_")return!1;for(;r<t;r++)if(i=e[r],i!=="_"){if(!Qo(e.charCodeAt(r)))return!1;n=!0}return!(!n||i==="_")}function Zo(e){var t=e,r=1,n;if(t.indexOf("_")!==-1&&(t=t.replace(/_/g,"")),n=t[0],(n==="-"||n==="+")&&(n==="-"&&(r=-1),t=t.slice(1),n=t[0]),t==="0")return 0;if(n==="0"){if(t[1]==="b")return r*parseInt(t.slice(2),2);if(t[1]==="x")return r*parseInt(t.slice(2),16);if(t[1]==="o")return r*parseInt(t.slice(2),8)}return r*parseInt(t,10)}function Xo(e){return Object.prototype.toString.call(e)==="[object Number]"&&e%1===0&&!E.isNegativeZero(e)}var ea=new M("tag:yaml.org,2002:int",{kind:"scalar",resolve:Jo,construct:Zo,predicate:Xo,represent:{binary:function(e){return e>=0?"0b"+e.toString(2):"-0b"+e.toString(2).slice(1)},octal:function(e){return e>=0?"0o"+e.toString(8):"-0o"+e.toString(8).slice(1)},decimal:function(e){return e.toString(10)},hexadecimal:function(e){return e>=0?"0x"+e.toString(16).toUpperCase():"-0x"+e.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),ta=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");function ra(e){return!(e===null||!ta.test(e)||e[e.length-1]==="_")}function na(e){var t,r;return t=e.replace(/_/g,"").toLowerCase(),r=t[0]==="-"?-1:1,"+-".indexOf(t[0])>=0&&(t=t.slice(1)),t===".inf"?r===1?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:t===".nan"?NaN:r*parseFloat(t,10)}var ia=/^[-+]?[0-9]+e/;function oa(e,t){var r;if(isNaN(e))switch(t){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===e)switch(t){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===e)switch(t){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(E.isNegativeZero(e))return"-0.0";return r=e.toString(10),ia.test(r)?r.replace("e",".e"):r}function aa(e){return Object.prototype.toString.call(e)==="[object Number]"&&(e%1!==0||E.isNegativeZero(e))}var sa=new M("tag:yaml.org,2002:float",{kind:"scalar",resolve:ra,construct:na,predicate:aa,represent:oa,defaultStyle:"lowercase"}),ca=Do.extend({implicit:[Go,Ho,ea,sa]}),la=ca,Cr=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),Tr=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");function da(e){return e===null?!1:Cr.exec(e)!==null||Tr.exec(e)!==null}function ua(e){var t,r,n,i,o,a,s,c=0,l=null,u,d,y;if(t=Cr.exec(e),t===null&&(t=Tr.exec(e)),t===null)throw new Error("Date resolve error");if(r=+t[1],n=+t[2]-1,i=+t[3],!t[4])return new Date(Date.UTC(r,n,i));if(o=+t[4],a=+t[5],s=+t[6],t[7]){for(c=t[7].slice(0,3);c.length<3;)c+="0";c=+c}return t[9]&&(u=+t[10],d=+(t[11]||0),l=(u*60+d)*6e4,t[9]==="-"&&(l=-l)),y=new Date(Date.UTC(r,n,i,o,a,s,c)),l&&y.setTime(y.getTime()-l),y}function pa(e){return e.toISOString()}var ma=new M("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:da,construct:ua,instanceOf:Date,represent:pa});function fa(e){return e==="<<"||e===null}var ga=new M("tag:yaml.org,2002:merge",{kind:"scalar",resolve:fa}),At=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=
\r`;function ha(e){if(e===null)return!1;var t,r,n=0,i=e.length,o=At;for(r=0;r<i;r++)if(t=o.indexOf(e.charAt(r)),!(t>64)){if(t<0)return!1;n+=6}return n%8===0}function ya(e){var t,r,n=e.replace(/[\r\n=]/g,""),i=n.length,o=At,a=0,s=[];for(t=0;t<i;t++)t%4===0&&t&&(s.push(a>>16&255),s.push(a>>8&255),s.push(a&255)),a=a<<6|o.indexOf(n.charAt(t));return r=i%4*6,r===0?(s.push(a>>16&255),s.push(a>>8&255),s.push(a&255)):r===18?(s.push(a>>10&255),s.push(a>>2&255)):r===12&&s.push(a>>4&255),new Uint8Array(s)}function ba(e){var t="",r=0,n,i,o=e.length,a=At;for(n=0;n<o;n++)n%3===0&&n&&(t+=a[r>>18&63],t+=a[r>>12&63],t+=a[r>>6&63],t+=a[r&63]),r=(r<<8)+e[n];return i=o%3,i===0?(t+=a[r>>18&63],t+=a[r>>12&63],t+=a[r>>6&63],t+=a[r&63]):i===2?(t+=a[r>>10&63],t+=a[r>>4&63],t+=a[r<<2&63],t+=a[64]):i===1&&(t+=a[r>>2&63],t+=a[r<<4&63],t+=a[64],t+=a[64]),t}function xa(e){return Object.prototype.toString.call(e)==="[object Uint8Array]"}var wa=new M("tag:yaml.org,2002:binary",{kind:"scalar",resolve:ha,construct:ya,predicate:xa,represent:ba}),Aa=Object.prototype.hasOwnProperty,Pa=Object.prototype.toString;function va(e){if(e===null)return!0;var t=[],r,n,i,o,a,s=e;for(r=0,n=s.length;r<n;r+=1){if(i=s[r],a=!1,Pa.call(i)!=="[object Object]")return!1;for(o in i)if(Aa.call(i,o))if(!a)a=!0;else return!1;if(!a)return!1;if(t.indexOf(o)===-1)t.push(o);else return!1}return!0}function Sa(e){return e!==null?e:[]}var Ea=new M("tag:yaml.org,2002:omap",{kind:"sequence",resolve:va,construct:Sa}),Ca=Object.prototype.toString;function Ta(e){if(e===null)return!0;var t,r,n,i,o,a=e;for(o=new Array(a.length),t=0,r=a.length;t<r;t+=1){if(n=a[t],Ca.call(n)!=="[object Object]"||(i=Object.keys(n),i.length!==1))return!1;o[t]=[i[0],n[i[0]]]}return!0}function Ia(e){if(e===null)return[];var t,r,n,i,o,a=e;for(o=new Array(a.length),t=0,r=a.length;t<r;t+=1)n=a[t],i=Object.keys(n),o[t]=[i[0],n[i[0]]];return o}var Ma=new M("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:Ta,construct:Ia}),Na=Object.prototype.hasOwnProperty;function Oa(e){if(e===null)return!0;var t,r=e;for(t in r)if(Na.call(r,t)&&r[t]!==null)return!1;return!0}function ka(e){return e!==null?e:{}}var Fa=new M("tag:yaml.org,2002:set",{kind:"mapping",resolve:Oa,construct:ka}),Ir=la.extend({implicit:[ma,ga],explicit:[wa,Ea,Ma,Fa]}),V=Object.prototype.hasOwnProperty,De=1,Mr=2,Nr=3,qe=4,gt=1,ja=2,dr=3,La=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,$a=/[\x85\u2028\u2029]/,Ua=/[,\[\]\{\}]/,Or=/^(?:!|!!|![a-z\-]+!)$/i,kr=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function ur(e){return Object.prototype.toString.call(e)}function q(e){return e===10||e===13}function X(e){return e===9||e===32}function $(e){return e===9||e===32||e===10||e===13}function oe(e){return e===44||e===91||e===93||e===123||e===125}function Ra(e){var t;return 48<=e&&e<=57?e-48:(t=e|32,97<=t&&t<=102?t-97+10:-1)}function Da(e){return e===120?2:e===117?4:e===85?8:0}function qa(e){return 48<=e&&e<=57?e-48:-1}function pr(e){return e===48?"\0":e===97?"\x07":e===98?"\b":e===116||e===9?"	":e===110?`
`:e===118?"\v":e===102?"\f":e===114?"\r":e===101?"\x1B":e===32?" ":e===34?'"':e===47?"/":e===92?"\\":e===78?"\x85":e===95?"\xA0":e===76?"\u2028":e===80?"\u2029":""}function Ka(e){return e<=65535?String.fromCharCode(e):String.fromCharCode((e-65536>>10)+55296,(e-65536&1023)+56320)}var Fr=new Array(256),jr=new Array(256);for(Z=0;Z<256;Z++)Fr[Z]=pr(Z)?1:0,jr[Z]=pr(Z);var Z;function _a(e,t){this.input=e,this.filename=t.filename||null,this.schema=t.schema||Ir,this.onWarning=t.onWarning||null,this.legacy=t.legacy||!1,this.json=t.json||!1,this.listener=t.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=e.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function Lr(e,t){var r={name:e.filename,buffer:e.input.slice(0,-1),position:e.position,line:e.line,column:e.position-e.lineStart};return r.snippet=Mo(r),new L(t,r)}function h(e,t){throw Lr(e,t)}function Ke(e,t){e.onWarning&&e.onWarning.call(null,Lr(e,t))}var mr={YAML:function(e,t,r){var n,i,o;e.version!==null&&h(e,"duplication of %YAML directive"),r.length!==1&&h(e,"YAML directive accepts exactly one argument"),n=/^([0-9]+)\.([0-9]+)$/.exec(r[0]),n===null&&h(e,"ill-formed argument of the YAML directive"),i=parseInt(n[1],10),o=parseInt(n[2],10),i!==1&&h(e,"unacceptable YAML version of the document"),e.version=r[0],e.checkLineBreaks=o<2,o!==1&&o!==2&&Ke(e,"unsupported YAML version of the document")},TAG:function(e,t,r){var n,i;r.length!==2&&h(e,"TAG directive accepts exactly two arguments"),n=r[0],i=r[1],Or.test(n)||h(e,"ill-formed tag handle (first argument) of the TAG directive"),V.call(e.tagMap,n)&&h(e,'there is a previously declared suffix for "'+n+'" tag handle'),kr.test(i)||h(e,"ill-formed tag prefix (second argument) of the TAG directive");try{i=decodeURIComponent(i)}catch{h(e,"tag prefix is malformed: "+i)}e.tagMap[n]=i}};function H(e,t,r,n){var i,o,a,s;if(t<r){if(s=e.input.slice(t,r),n)for(i=0,o=s.length;i<o;i+=1)a=s.charCodeAt(i),a===9||32<=a&&a<=1114111||h(e,"expected valid JSON character");else La.test(s)&&h(e,"the stream contains non-printable characters");e.result+=s}}function fr(e,t,r,n){var i,o,a,s;for(E.isObject(r)||h(e,"cannot merge mappings; the provided source object is unacceptable"),i=Object.keys(r),a=0,s=i.length;a<s;a+=1)o=i[a],V.call(t,o)||(t[o]=r[o],n[o]=!0)}function ae(e,t,r,n,i,o,a,s,c){var l,u;if(Array.isArray(i))for(i=Array.prototype.slice.call(i),l=0,u=i.length;l<u;l+=1)Array.isArray(i[l])&&h(e,"nested arrays are not supported inside keys"),typeof i=="object"&&ur(i[l])==="[object Object]"&&(i[l]="[object Object]");if(typeof i=="object"&&ur(i)==="[object Object]"&&(i="[object Object]"),i=String(i),t===null&&(t={}),n==="tag:yaml.org,2002:merge")if(Array.isArray(o))for(l=0,u=o.length;l<u;l+=1)fr(e,t,o[l],r);else fr(e,t,o,r);else!e.json&&!V.call(r,i)&&V.call(t,i)&&(e.line=a||e.line,e.lineStart=s||e.lineStart,e.position=c||e.position,h(e,"duplicated mapping key")),i==="__proto__"?Object.defineProperty(t,i,{configurable:!0,enumerable:!0,writable:!0,value:o}):t[i]=o,delete r[i];return t}function Pt(e){var t;t=e.input.charCodeAt(e.position),t===10?e.position++:t===13?(e.position++,e.input.charCodeAt(e.position)===10&&e.position++):h(e,"a line break is expected"),e.line+=1,e.lineStart=e.position,e.firstTabInLine=-1}function S(e,t,r){for(var n=0,i=e.input.charCodeAt(e.position);i!==0;){for(;X(i);)i===9&&e.firstTabInLine===-1&&(e.firstTabInLine=e.position),i=e.input.charCodeAt(++e.position);if(t&&i===35)do i=e.input.charCodeAt(++e.position);while(i!==10&&i!==13&&i!==0);if(q(i))for(Pt(e),i=e.input.charCodeAt(e.position),n++,e.lineIndent=0;i===32;)e.lineIndent++,i=e.input.charCodeAt(++e.position);else break}return r!==-1&&n!==0&&e.lineIndent<r&&Ke(e,"deficient indentation"),n}function We(e){var t=e.position,r;return r=e.input.charCodeAt(t),!!((r===45||r===46)&&r===e.input.charCodeAt(t+1)&&r===e.input.charCodeAt(t+2)&&(t+=3,r=e.input.charCodeAt(t),r===0||$(r)))}function vt(e,t){t===1?e.result+=" ":t>1&&(e.result+=E.repeat(`
`,t-1))}function Ga(e,t,r){var n,i,o,a,s,c,l,u,d=e.kind,y=e.result,g;if(g=e.input.charCodeAt(e.position),$(g)||oe(g)||g===35||g===38||g===42||g===33||g===124||g===62||g===39||g===34||g===37||g===64||g===96||(g===63||g===45)&&(i=e.input.charCodeAt(e.position+1),$(i)||r&&oe(i)))return!1;for(e.kind="scalar",e.result="",o=a=e.position,s=!1;g!==0;){if(g===58){if(i=e.input.charCodeAt(e.position+1),$(i)||r&&oe(i))break}else if(g===35){if(n=e.input.charCodeAt(e.position-1),$(n))break}else{if(e.position===e.lineStart&&We(e)||r&&oe(g))break;if(q(g))if(c=e.line,l=e.lineStart,u=e.lineIndent,S(e,!1,-1),e.lineIndent>=t){s=!0,g=e.input.charCodeAt(e.position);continue}else{e.position=a,e.line=c,e.lineStart=l,e.lineIndent=u;break}}s&&(H(e,o,a,!1),vt(e,e.line-c),o=a=e.position,s=!1),X(g)||(a=e.position+1),g=e.input.charCodeAt(++e.position)}return H(e,o,a,!1),e.result?!0:(e.kind=d,e.result=y,!1)}function Wa(e,t){var r,n,i;if(r=e.input.charCodeAt(e.position),r!==39)return!1;for(e.kind="scalar",e.result="",e.position++,n=i=e.position;(r=e.input.charCodeAt(e.position))!==0;)if(r===39)if(H(e,n,e.position,!0),r=e.input.charCodeAt(++e.position),r===39)n=e.position,e.position++,i=e.position;else return!0;else q(r)?(H(e,n,i,!0),vt(e,S(e,!1,t)),n=i=e.position):e.position===e.lineStart&&We(e)?h(e,"unexpected end of the document within a single quoted scalar"):(e.position++,i=e.position);h(e,"unexpected end of the stream within a single quoted scalar")}function Ba(e,t){var r,n,i,o,a,s;if(s=e.input.charCodeAt(e.position),s!==34)return!1;for(e.kind="scalar",e.result="",e.position++,r=n=e.position;(s=e.input.charCodeAt(e.position))!==0;){if(s===34)return H(e,r,e.position,!0),e.position++,!0;if(s===92){if(H(e,r,e.position,!0),s=e.input.charCodeAt(++e.position),q(s))S(e,!1,t);else if(s<256&&Fr[s])e.result+=jr[s],e.position++;else if((a=Da(s))>0){for(i=a,o=0;i>0;i--)s=e.input.charCodeAt(++e.position),(a=Ra(s))>=0?o=(o<<4)+a:h(e,"expected hexadecimal character");e.result+=Ka(o),e.position++}else h(e,"unknown escape sequence");r=n=e.position}else q(s)?(H(e,r,n,!0),vt(e,S(e,!1,t)),r=n=e.position):e.position===e.lineStart&&We(e)?h(e,"unexpected end of the document within a double quoted scalar"):(e.position++,n=e.position)}h(e,"unexpected end of the stream within a double quoted scalar")}function Ya(e,t){var r=!0,n,i,o,a=e.tag,s,c=e.anchor,l,u,d,y,g,b=Object.create(null),w,P,T,x;if(x=e.input.charCodeAt(e.position),x===91)u=93,g=!1,s=[];else if(x===123)u=125,g=!0,s={};else return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=s),x=e.input.charCodeAt(++e.position);x!==0;){if(S(e,!0,t),x=e.input.charCodeAt(e.position),x===u)return e.position++,e.tag=a,e.anchor=c,e.kind=g?"mapping":"sequence",e.result=s,!0;r?x===44&&h(e,"expected the node content, but found ','"):h(e,"missed comma between flow collection entries"),P=w=T=null,d=y=!1,x===63&&(l=e.input.charCodeAt(e.position+1),$(l)&&(d=y=!0,e.position++,S(e,!0,t))),n=e.line,i=e.lineStart,o=e.position,se(e,t,De,!1,!0),P=e.tag,w=e.result,S(e,!0,t),x=e.input.charCodeAt(e.position),(y||e.line===n)&&x===58&&(d=!0,x=e.input.charCodeAt(++e.position),S(e,!0,t),se(e,t,De,!1,!0),T=e.result),g?ae(e,s,b,P,w,T,n,i,o):d?s.push(ae(e,null,b,P,w,T,n,i,o)):s.push(w),S(e,!0,t),x=e.input.charCodeAt(e.position),x===44?(r=!0,x=e.input.charCodeAt(++e.position)):r=!1}h(e,"unexpected end of the stream within a flow collection")}function Ha(e,t){var r,n,i=gt,o=!1,a=!1,s=t,c=0,l=!1,u,d;if(d=e.input.charCodeAt(e.position),d===124)n=!1;else if(d===62)n=!0;else return!1;for(e.kind="scalar",e.result="";d!==0;)if(d=e.input.charCodeAt(++e.position),d===43||d===45)gt===i?i=d===43?dr:ja:h(e,"repeat of a chomping mode identifier");else if((u=qa(d))>=0)u===0?h(e,"bad explicit indentation width of a block scalar; it cannot be less than one"):a?h(e,"repeat of an indentation width identifier"):(s=t+u-1,a=!0);else break;if(X(d)){do d=e.input.charCodeAt(++e.position);while(X(d));if(d===35)do d=e.input.charCodeAt(++e.position);while(!q(d)&&d!==0)}for(;d!==0;){for(Pt(e),e.lineIndent=0,d=e.input.charCodeAt(e.position);(!a||e.lineIndent<s)&&d===32;)e.lineIndent++,d=e.input.charCodeAt(++e.position);if(!a&&e.lineIndent>s&&(s=e.lineIndent),q(d)){c++;continue}if(e.lineIndent<s){i===dr?e.result+=E.repeat(`
`,o?1+c:c):i===gt&&o&&(e.result+=`
`);break}for(n?X(d)?(l=!0,e.result+=E.repeat(`
`,o?1+c:c)):l?(l=!1,e.result+=E.repeat(`
`,c+1)):c===0?o&&(e.result+=" "):e.result+=E.repeat(`
`,c):e.result+=E.repeat(`
`,o?1+c:c),o=!0,a=!0,c=0,r=e.position;!q(d)&&d!==0;)d=e.input.charCodeAt(++e.position);H(e,r,e.position,!1)}return!0}function gr(e,t){var r,n=e.tag,i=e.anchor,o=[],a,s=!1,c;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=o),c=e.input.charCodeAt(e.position);c!==0&&(e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,h(e,"tab characters must not be used in indentation")),!(c!==45||(a=e.input.charCodeAt(e.position+1),!$(a))));){if(s=!0,e.position++,S(e,!0,-1)&&e.lineIndent<=t){o.push(null),c=e.input.charCodeAt(e.position);continue}if(r=e.line,se(e,t,Nr,!1,!0),o.push(e.result),S(e,!0,-1),c=e.input.charCodeAt(e.position),(e.line===r||e.lineIndent>t)&&c!==0)h(e,"bad indentation of a sequence entry");else if(e.lineIndent<t)break}return s?(e.tag=n,e.anchor=i,e.kind="sequence",e.result=o,!0):!1}function Va(e,t,r){var n,i,o,a,s,c,l=e.tag,u=e.anchor,d={},y=Object.create(null),g=null,b=null,w=null,P=!1,T=!1,x;if(e.firstTabInLine!==-1)return!1;for(e.anchor!==null&&(e.anchorMap[e.anchor]=d),x=e.input.charCodeAt(e.position);x!==0;){if(!P&&e.firstTabInLine!==-1&&(e.position=e.firstTabInLine,h(e,"tab characters must not be used in indentation")),n=e.input.charCodeAt(e.position+1),o=e.line,(x===63||x===58)&&$(n))x===63?(P&&(ae(e,d,y,g,b,null,a,s,c),g=b=w=null),T=!0,P=!0,i=!0):P?(P=!1,i=!0):h(e,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),e.position+=1,x=n;else{if(a=e.line,s=e.lineStart,c=e.position,!se(e,r,Mr,!1,!0))break;if(e.line===o){for(x=e.input.charCodeAt(e.position);X(x);)x=e.input.charCodeAt(++e.position);if(x===58)x=e.input.charCodeAt(++e.position),$(x)||h(e,"a whitespace character is expected after the key-value separator within a block mapping"),P&&(ae(e,d,y,g,b,null,a,s,c),g=b=w=null),T=!0,P=!1,i=!1,g=e.tag,b=e.result;else if(T)h(e,"can not read an implicit mapping pair; a colon is missed");else return e.tag=l,e.anchor=u,!0}else if(T)h(e,"can not read a block mapping entry; a multiline key may not be an implicit key");else return e.tag=l,e.anchor=u,!0}if((e.line===o||e.lineIndent>t)&&(P&&(a=e.line,s=e.lineStart,c=e.position),se(e,t,qe,!0,i)&&(P?b=e.result:w=e.result),P||(ae(e,d,y,g,b,w,a,s,c),g=b=w=null),S(e,!0,-1),x=e.input.charCodeAt(e.position)),(e.line===o||e.lineIndent>t)&&x!==0)h(e,"bad indentation of a mapping entry");else if(e.lineIndent<t)break}return P&&ae(e,d,y,g,b,null,a,s,c),T&&(e.tag=l,e.anchor=u,e.kind="mapping",e.result=d),T}function za(e){var t,r=!1,n=!1,i,o,a;if(a=e.input.charCodeAt(e.position),a!==33)return!1;if(e.tag!==null&&h(e,"duplication of a tag property"),a=e.input.charCodeAt(++e.position),a===60?(r=!0,a=e.input.charCodeAt(++e.position)):a===33?(n=!0,i="!!",a=e.input.charCodeAt(++e.position)):i="!",t=e.position,r){do a=e.input.charCodeAt(++e.position);while(a!==0&&a!==62);e.position<e.length?(o=e.input.slice(t,e.position),a=e.input.charCodeAt(++e.position)):h(e,"unexpected end of the stream within a verbatim tag")}else{for(;a!==0&&!$(a);)a===33&&(n?h(e,"tag suffix cannot contain exclamation marks"):(i=e.input.slice(t-1,e.position+1),Or.test(i)||h(e,"named tag handle cannot contain such characters"),n=!0,t=e.position+1)),a=e.input.charCodeAt(++e.position);o=e.input.slice(t,e.position),Ua.test(o)&&h(e,"tag suffix cannot contain flow indicator characters")}o&&!kr.test(o)&&h(e,"tag name cannot contain such characters: "+o);try{o=decodeURIComponent(o)}catch{h(e,"tag name is malformed: "+o)}return r?e.tag=o:V.call(e.tagMap,i)?e.tag=e.tagMap[i]+o:i==="!"?e.tag="!"+o:i==="!!"?e.tag="tag:yaml.org,2002:"+o:h(e,'undeclared tag handle "'+i+'"'),!0}function Qa(e){var t,r;if(r=e.input.charCodeAt(e.position),r!==38)return!1;for(e.anchor!==null&&h(e,"duplication of an anchor property"),r=e.input.charCodeAt(++e.position),t=e.position;r!==0&&!$(r)&&!oe(r);)r=e.input.charCodeAt(++e.position);return e.position===t&&h(e,"name of an anchor node must contain at least one character"),e.anchor=e.input.slice(t,e.position),!0}function Ja(e){var t,r,n;if(n=e.input.charCodeAt(e.position),n!==42)return!1;for(n=e.input.charCodeAt(++e.position),t=e.position;n!==0&&!$(n)&&!oe(n);)n=e.input.charCodeAt(++e.position);return e.position===t&&h(e,"name of an alias node must contain at least one character"),r=e.input.slice(t,e.position),V.call(e.anchorMap,r)||h(e,'unidentified alias "'+r+'"'),e.result=e.anchorMap[r],S(e,!0,-1),!0}function se(e,t,r,n,i){var o,a,s,c=1,l=!1,u=!1,d,y,g,b,w,P;if(e.listener!==null&&e.listener("open",e),e.tag=null,e.anchor=null,e.kind=null,e.result=null,o=a=s=qe===r||Nr===r,n&&S(e,!0,-1)&&(l=!0,e.lineIndent>t?c=1:e.lineIndent===t?c=0:e.lineIndent<t&&(c=-1)),c===1)for(;za(e)||Qa(e);)S(e,!0,-1)?(l=!0,s=o,e.lineIndent>t?c=1:e.lineIndent===t?c=0:e.lineIndent<t&&(c=-1)):s=!1;if(s&&(s=l||i),(c===1||qe===r)&&(De===r||Mr===r?w=t:w=t+1,P=e.position-e.lineStart,c===1?s&&(gr(e,P)||Va(e,P,w))||Ya(e,w)?u=!0:(a&&Ha(e,w)||Wa(e,w)||Ba(e,w)?u=!0:Ja(e)?(u=!0,(e.tag!==null||e.anchor!==null)&&h(e,"alias node should not have any properties")):Ga(e,w,De===r)&&(u=!0,e.tag===null&&(e.tag="?")),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):c===0&&(u=s&&gr(e,P))),e.tag===null)e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);else if(e.tag==="?"){for(e.result!==null&&e.kind!=="scalar"&&h(e,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+e.kind+'"'),d=0,y=e.implicitTypes.length;d<y;d+=1)if(b=e.implicitTypes[d],b.resolve(e.result)){e.result=b.construct(e.result),e.tag=b.tag,e.anchor!==null&&(e.anchorMap[e.anchor]=e.result);break}}else if(e.tag!=="!"){if(V.call(e.typeMap[e.kind||"fallback"],e.tag))b=e.typeMap[e.kind||"fallback"][e.tag];else for(b=null,g=e.typeMap.multi[e.kind||"fallback"],d=0,y=g.length;d<y;d+=1)if(e.tag.slice(0,g[d].tag.length)===g[d].tag){b=g[d];break}b||h(e,"unknown tag !<"+e.tag+">"),e.result!==null&&b.kind!==e.kind&&h(e,"unacceptable node kind for !<"+e.tag+'> tag; it should be "'+b.kind+'", not "'+e.kind+'"'),b.resolve(e.result,e.tag)?(e.result=b.construct(e.result,e.tag),e.anchor!==null&&(e.anchorMap[e.anchor]=e.result)):h(e,"cannot resolve a node with !<"+e.tag+"> explicit tag")}return e.listener!==null&&e.listener("close",e),e.tag!==null||e.anchor!==null||u}function Za(e){var t=e.position,r,n,i,o=!1,a;for(e.version=null,e.checkLineBreaks=e.legacy,e.tagMap=Object.create(null),e.anchorMap=Object.create(null);(a=e.input.charCodeAt(e.position))!==0&&(S(e,!0,-1),a=e.input.charCodeAt(e.position),!(e.lineIndent>0||a!==37));){for(o=!0,a=e.input.charCodeAt(++e.position),r=e.position;a!==0&&!$(a);)a=e.input.charCodeAt(++e.position);for(n=e.input.slice(r,e.position),i=[],n.length<1&&h(e,"directive name must not be less than one character in length");a!==0;){for(;X(a);)a=e.input.charCodeAt(++e.position);if(a===35){do a=e.input.charCodeAt(++e.position);while(a!==0&&!q(a));break}if(q(a))break;for(r=e.position;a!==0&&!$(a);)a=e.input.charCodeAt(++e.position);i.push(e.input.slice(r,e.position))}a!==0&&Pt(e),V.call(mr,n)?mr[n](e,n,i):Ke(e,'unknown document directive "'+n+'"')}if(S(e,!0,-1),e.lineIndent===0&&e.input.charCodeAt(e.position)===45&&e.input.charCodeAt(e.position+1)===45&&e.input.charCodeAt(e.position+2)===45?(e.position+=3,S(e,!0,-1)):o&&h(e,"directives end mark is expected"),se(e,e.lineIndent-1,qe,!1,!0),S(e,!0,-1),e.checkLineBreaks&&$a.test(e.input.slice(t,e.position))&&Ke(e,"non-ASCII line breaks are interpreted as content"),e.documents.push(e.result),e.position===e.lineStart&&We(e)){e.input.charCodeAt(e.position)===46&&(e.position+=3,S(e,!0,-1));return}if(e.position<e.length-1)h(e,"end of the stream or a document separator is expected");else return}function $r(e,t){e=String(e),t=t||{},e.length!==0&&(e.charCodeAt(e.length-1)!==10&&e.charCodeAt(e.length-1)!==13&&(e+=`
`),e.charCodeAt(0)===65279&&(e=e.slice(1)));var r=new _a(e,t),n=e.indexOf("\0");for(n!==-1&&(r.position=n,h(r,"null byte is not allowed in input")),r.input+="\0";r.input.charCodeAt(r.position)===32;)r.lineIndent+=1,r.position+=1;for(;r.position<r.length-1;)Za(r);return r.documents}function Xa(e,t,r){t!==null&&typeof t=="object"&&typeof r>"u"&&(r=t,t=null);var n=$r(e,r);if(typeof t!="function")return n;for(var i=0,o=n.length;i<o;i+=1)t(n[i])}function es(e,t){var r=$r(e,t);if(r.length!==0){if(r.length===1)return r[0];throw new L("expected a single document in the stream, but found more")}}var ts=Xa,rs=es,Ur={loadAll:ts,load:rs},Rr=Object.prototype.toString,Dr=Object.prototype.hasOwnProperty,St=65279,ns=9,ge=10,is=13,os=32,as=33,ss=34,yt=35,cs=37,ls=38,ds=39,us=42,qr=44,ps=45,_e=58,ms=61,fs=62,gs=63,hs=64,Kr=91,_r=93,ys=96,Gr=123,bs=124,Wr=125,N={};N[0]="\\0";N[7]="\\a";N[8]="\\b";N[9]="\\t";N[10]="\\n";N[11]="\\v";N[12]="\\f";N[13]="\\r";N[27]="\\e";N[34]='\\"';N[92]="\\\\";N[133]="\\N";N[160]="\\_";N[8232]="\\L";N[8233]="\\P";var xs=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],ws=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function As(e,t){var r,n,i,o,a,s,c;if(t===null)return{};for(r={},n=Object.keys(t),i=0,o=n.length;i<o;i+=1)a=n[i],s=String(t[a]),a.slice(0,2)==="!!"&&(a="tag:yaml.org,2002:"+a.slice(2)),c=e.compiledTypeMap.fallback[a],c&&Dr.call(c.styleAliases,s)&&(s=c.styleAliases[s]),r[a]=s;return r}function Ps(e){var t,r,n;if(t=e.toString(16).toUpperCase(),e<=255)r="x",n=2;else if(e<=65535)r="u",n=4;else if(e<=4294967295)r="U",n=8;else throw new L("code point within a string may not be greater than 0xFFFFFFFF");return"\\"+r+E.repeat("0",n-t.length)+t}var vs=1,he=2;function Ss(e){this.schema=e.schema||Ir,this.indent=Math.max(1,e.indent||2),this.noArrayIndent=e.noArrayIndent||!1,this.skipInvalid=e.skipInvalid||!1,this.flowLevel=E.isNothing(e.flowLevel)?-1:e.flowLevel,this.styleMap=As(this.schema,e.styles||null),this.sortKeys=e.sortKeys||!1,this.lineWidth=e.lineWidth||80,this.noRefs=e.noRefs||!1,this.noCompatMode=e.noCompatMode||!1,this.condenseFlow=e.condenseFlow||!1,this.quotingType=e.quotingType==='"'?he:vs,this.forceQuotes=e.forceQuotes||!1,this.replacer=typeof e.replacer=="function"?e.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function hr(e,t){for(var r=E.repeat(" ",t),n=0,i=-1,o="",a,s=e.length;n<s;)i=e.indexOf(`
`,n),i===-1?(a=e.slice(n),n=s):(a=e.slice(n,i+1),n=i+1),a.length&&a!==`
`&&(o+=r),o+=a;return o}function bt(e,t){return`
`+E.repeat(" ",e.indent*t)}function Es(e,t){var r,n,i;for(r=0,n=e.implicitTypes.length;r<n;r+=1)if(i=e.implicitTypes[r],i.resolve(t))return!0;return!1}function Ge(e){return e===os||e===ns}function ye(e){return 32<=e&&e<=126||161<=e&&e<=55295&&e!==8232&&e!==8233||57344<=e&&e<=65533&&e!==St||65536<=e&&e<=1114111}function yr(e){return ye(e)&&e!==St&&e!==is&&e!==ge}function br(e,t,r){var n=yr(e),i=n&&!Ge(e);return(r?n:n&&e!==qr&&e!==Kr&&e!==_r&&e!==Gr&&e!==Wr)&&e!==yt&&!(t===_e&&!i)||yr(t)&&!Ge(t)&&e===yt||t===_e&&i}function Cs(e){return ye(e)&&e!==St&&!Ge(e)&&e!==ps&&e!==gs&&e!==_e&&e!==qr&&e!==Kr&&e!==_r&&e!==Gr&&e!==Wr&&e!==yt&&e!==ls&&e!==us&&e!==as&&e!==bs&&e!==ms&&e!==fs&&e!==ds&&e!==ss&&e!==cs&&e!==hs&&e!==ys}function Ts(e){return!Ge(e)&&e!==_e}function me(e,t){var r=e.charCodeAt(t),n;return r>=55296&&r<=56319&&t+1<e.length&&(n=e.charCodeAt(t+1),n>=56320&&n<=57343)?(r-55296)*1024+n-56320+65536:r}function Br(e){var t=/^\n* /;return t.test(e)}var Yr=1,xt=2,Hr=3,Vr=4,ie=5;function Is(e,t,r,n,i,o,a,s){var c,l=0,u=null,d=!1,y=!1,g=n!==-1,b=-1,w=Cs(me(e,0))&&Ts(me(e,e.length-1));if(t||a)for(c=0;c<e.length;l>=65536?c+=2:c++){if(l=me(e,c),!ye(l))return ie;w=w&&br(l,u,s),u=l}else{for(c=0;c<e.length;l>=65536?c+=2:c++){if(l=me(e,c),l===ge)d=!0,g&&(y=y||c-b-1>n&&e[b+1]!==" ",b=c);else if(!ye(l))return ie;w=w&&br(l,u,s),u=l}y=y||g&&c-b-1>n&&e[b+1]!==" "}return!d&&!y?w&&!a&&!i(e)?Yr:o===he?ie:xt:r>9&&Br(e)?ie:a?o===he?ie:xt:y?Vr:Hr}function Ms(e,t,r,n,i){e.dump=function(){if(t.length===0)return e.quotingType===he?'""':"''";if(!e.noCompatMode&&(xs.indexOf(t)!==-1||ws.test(t)))return e.quotingType===he?'"'+t+'"':"'"+t+"'";var o=e.indent*Math.max(1,r),a=e.lineWidth===-1?-1:Math.max(Math.min(e.lineWidth,40),e.lineWidth-o),s=n||e.flowLevel>-1&&r>=e.flowLevel;function c(l){return Es(e,l)}switch(Is(t,s,e.indent,a,c,e.quotingType,e.forceQuotes&&!n,i)){case Yr:return t;case xt:return"'"+t.replace(/'/g,"''")+"'";case Hr:return"|"+xr(t,e.indent)+wr(hr(t,o));case Vr:return">"+xr(t,e.indent)+wr(hr(Ns(t,a),o));case ie:return'"'+Os(t)+'"';default:throw new L("impossible error: invalid scalar style")}}()}function xr(e,t){var r=Br(e)?String(t):"",n=e[e.length-1]===`
`,i=n&&(e[e.length-2]===`
`||e===`
`),o=i?"+":n?"":"-";return r+o+`
`}function wr(e){return e[e.length-1]===`
`?e.slice(0,-1):e}function Ns(e,t){for(var r=/(\n+)([^\n]*)/g,n=function(){var l=e.indexOf(`
`);return l=l!==-1?l:e.length,r.lastIndex=l,Ar(e.slice(0,l),t)}(),i=e[0]===`
`||e[0]===" ",o,a;a=r.exec(e);){var s=a[1],c=a[2];o=c[0]===" ",n+=s+(!i&&!o&&c!==""?`
`:"")+Ar(c,t),i=o}return n}function Ar(e,t){if(e===""||e[0]===" ")return e;for(var r=/ [^ ]/g,n,i=0,o,a=0,s=0,c="";n=r.exec(e);)s=n.index,s-i>t&&(o=a>i?a:s,c+=`
`+e.slice(i,o),i=o+1),a=s;return c+=`
`,e.length-i>t&&a>i?c+=e.slice(i,a)+`
`+e.slice(a+1):c+=e.slice(i),c.slice(1)}function Os(e){for(var t="",r=0,n,i=0;i<e.length;r>=65536?i+=2:i++)r=me(e,i),n=N[r],!n&&ye(r)?(t+=e[i],r>=65536&&(t+=e[i+1])):t+=n||Ps(r);return t}function ks(e,t,r){var n="",i=e.tag,o,a,s;for(o=0,a=r.length;o<a;o+=1)s=r[o],e.replacer&&(s=e.replacer.call(r,String(o),s)),(G(e,t,s,!1,!1)||typeof s>"u"&&G(e,t,null,!1,!1))&&(n!==""&&(n+=","+(e.condenseFlow?"":" ")),n+=e.dump);e.tag=i,e.dump="["+n+"]"}function Pr(e,t,r,n){var i="",o=e.tag,a,s,c;for(a=0,s=r.length;a<s;a+=1)c=r[a],e.replacer&&(c=e.replacer.call(r,String(a),c)),(G(e,t+1,c,!0,!0,!1,!0)||typeof c>"u"&&G(e,t+1,null,!0,!0,!1,!0))&&((!n||i!=="")&&(i+=bt(e,t)),e.dump&&ge===e.dump.charCodeAt(0)?i+="-":i+="- ",i+=e.dump);e.tag=o,e.dump=i||"[]"}function Fs(e,t,r){var n="",i=e.tag,o=Object.keys(r),a,s,c,l,u;for(a=0,s=o.length;a<s;a+=1)u="",n!==""&&(u+=", "),e.condenseFlow&&(u+='"'),c=o[a],l=r[c],e.replacer&&(l=e.replacer.call(r,c,l)),G(e,t,c,!1,!1)&&(e.dump.length>1024&&(u+="? "),u+=e.dump+(e.condenseFlow?'"':"")+":"+(e.condenseFlow?"":" "),G(e,t,l,!1,!1)&&(u+=e.dump,n+=u));e.tag=i,e.dump="{"+n+"}"}function js(e,t,r,n){var i="",o=e.tag,a=Object.keys(r),s,c,l,u,d,y;if(e.sortKeys===!0)a.sort();else if(typeof e.sortKeys=="function")a.sort(e.sortKeys);else if(e.sortKeys)throw new L("sortKeys must be a boolean or a function");for(s=0,c=a.length;s<c;s+=1)y="",(!n||i!=="")&&(y+=bt(e,t)),l=a[s],u=r[l],e.replacer&&(u=e.replacer.call(r,l,u)),G(e,t+1,l,!0,!0,!0)&&(d=e.tag!==null&&e.tag!=="?"||e.dump&&e.dump.length>1024,d&&(e.dump&&ge===e.dump.charCodeAt(0)?y+="?":y+="? "),y+=e.dump,d&&(y+=bt(e,t)),G(e,t+1,u,!0,d)&&(e.dump&&ge===e.dump.charCodeAt(0)?y+=":":y+=": ",y+=e.dump,i+=y));e.tag=o,e.dump=i||"{}"}function vr(e,t,r){var n,i,o,a,s,c;for(i=r?e.explicitTypes:e.implicitTypes,o=0,a=i.length;o<a;o+=1)if(s=i[o],(s.instanceOf||s.predicate)&&(!s.instanceOf||typeof t=="object"&&t instanceof s.instanceOf)&&(!s.predicate||s.predicate(t))){if(r?s.multi&&s.representName?e.tag=s.representName(t):e.tag=s.tag:e.tag="?",s.represent){if(c=e.styleMap[s.tag]||s.defaultStyle,Rr.call(s.represent)==="[object Function]")n=s.represent(t,c);else if(Dr.call(s.represent,c))n=s.represent[c](t,c);else throw new L("!<"+s.tag+'> tag resolver accepts not "'+c+'" style');e.dump=n}return!0}return!1}function G(e,t,r,n,i,o,a){e.tag=null,e.dump=r,vr(e,r,!1)||vr(e,r,!0);var s=Rr.call(e.dump),c=n,l;n&&(n=e.flowLevel<0||e.flowLevel>t);var u=s==="[object Object]"||s==="[object Array]",d,y;if(u&&(d=e.duplicates.indexOf(r),y=d!==-1),(e.tag!==null&&e.tag!=="?"||y||e.indent!==2&&t>0)&&(i=!1),y&&e.usedDuplicates[d])e.dump="*ref_"+d;else{if(u&&y&&!e.usedDuplicates[d]&&(e.usedDuplicates[d]=!0),s==="[object Object]")n&&Object.keys(e.dump).length!==0?(js(e,t,e.dump,i),y&&(e.dump="&ref_"+d+e.dump)):(Fs(e,t,e.dump),y&&(e.dump="&ref_"+d+" "+e.dump));else if(s==="[object Array]")n&&e.dump.length!==0?(e.noArrayIndent&&!a&&t>0?Pr(e,t-1,e.dump,i):Pr(e,t,e.dump,i),y&&(e.dump="&ref_"+d+e.dump)):(ks(e,t,e.dump),y&&(e.dump="&ref_"+d+" "+e.dump));else if(s==="[object String]")e.tag!=="?"&&Ms(e,e.dump,t,o,c);else{if(s==="[object Undefined]"||e.skipInvalid)return!1;throw new L("unacceptable kind of an object to dump "+s)}e.tag!==null&&e.tag!=="?"&&(l=encodeURI(e.tag[0]==="!"?e.tag.slice(1):e.tag).replace(/!/g,"%21"),e.tag[0]==="!"?l="!"+l:l.slice(0,18)==="tag:yaml.org,2002:"?l="!!"+l.slice(18):l="!<"+l+">",e.dump=l+" "+e.dump)}return!0}function Ls(e,t){var r=[],n=[],i,o;for(wt(e,r,n),i=0,o=n.length;i<o;i+=1)t.duplicates.push(r[n[i]]);t.usedDuplicates=new Array(o)}function wt(e,t,r){var n,i,o;if(e!==null&&typeof e=="object")if(i=t.indexOf(e),i!==-1)r.indexOf(i)===-1&&r.push(i);else if(t.push(e),Array.isArray(e))for(i=0,o=e.length;i<o;i+=1)wt(e[i],t,r);else for(n=Object.keys(e),i=0,o=n.length;i<o;i+=1)wt(e[n[i]],t,r)}function $s(e,t){t=t||{};var r=new Ss(t);r.noRefs||Ls(e,r);var n=e;return r.replacer&&(n=r.replacer.call({"":n},"",n)),G(r,0,n,!0,!0)?r.dump+`
`:""}var Us=$s,Rs={dump:Us};function Et(e,t){return function(){throw new Error("Function yaml."+e+" is removed in js-yaml 4. Use yaml."+t+" instead, which is now safe by default.")}}var zr=Ur.load,gd=Ur.loadAll,hd=Rs.dump;var yd=Et("safeLoad","load"),bd=Et("safeLoadAll","loadAll"),xd=Et("safeDump","dump");async function Qr(e){(e==="SETTINGS"||e==="SECRETS")&&await B(!0)}async function Jr(){(!f||!f.textModels)&&await B(!1);let e=f.textModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await m.filterBox("Select a model",e);if(!t){await m.flashNotification("No model selected.","error");return}let r=t.name;await lt(t),await de(t),await m.flashNotification(`Selected model: ${r}`),console.log("Selected model:",t)}async function Zr(){(!f||!f.imageModels)&&await B(!1);let e=f.imageModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await m.filterBox("Select an image model",e);if(!t){await m.flashNotification("No image model selected.","error");return}let r=t.name;await ct(t),await ut(t),await m.flashNotification(`Selected image model: ${r}`),console.log("Selected image model:",t)}async function Xr(){(!f||!f.embeddingModels)&&await B(!1);let e=f.embeddingModels.map(n=>({...n,name:n.name,description:n.description||`${n.modelName} on ${n.provider}`})),t=await m.filterBox("Select an embedding model",e);if(!t){await m.flashNotification("No embedding model selected.","error");return}let r=t.name;await dt(t),await pt(t),await m.flashNotification(`Selected embedding model: ${r}`),console.log("Selected embedding model:",t)}async function en(){await I();let e=await ve(),t=await m.prompt("Please enter a prompt to send to the LLM. Selected text or the entire note will also be sent as context."),r=await m.getCurrentPage(),n=new Date,i=n.toISOString().split("T")[0],o=n.toLocaleDateString("en-US",{weekday:"long"});await k.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant. Follow all user instructions and use the note context and note content to help follow those instructions. Use Markdown for any formatting."},{role:"user",content:`Note Context: Today is ${o}, ${i}. The current note name is "${r}".
User Prompt: ${t}
Note Content:
${e.text}`}],stream:!0},e.to)}async function tn(){await I();let e=await ve();if(console.log("selectedTextInfo",e),e.text.length>0){let t=await m.getCurrentPage(),r=await k.chatWithAI({messages:[{role:"user",content:`Please summarize this note using markdown for any formatting. Your summary will be appended to the end of this note, do not include any of the note contents yourself. Keep the summary brief. The note name is ${t}.

${e.text}`}],stream:!1});return console.log("OpenAI response:",r),{summary:r,selectedTextInfo:e}}return{summary:"",selectedTextInfo:null}}async function rn(){let{summary:e,selectedTextInfo:t}=await tn();e&&t&&await m.insertAtPos(`

`+e,t.to)}async function nn(){let{summary:e}=await tn();e?await m.showPanel("rhs",2,e):await m.flashNotification("No summary available.")}async function Ct(){await I();let e=await m.getText(),t=await m.getCurrentPage(),r=(await sr("tag select name where parent = 'page' order by name")).map(d=>d.name);console.log("All tags:",r);let n=`You are an AI tagging assistant. Please provide a short list of tags, separated by spaces. Follow these guidelines:
    - Only return tags and no other content.
    - Tags must be one word only and in lowercase.
    - Use existing tags as a starting point.
    - Suggest tags sparingly, treating them as thematic descriptors rather than keywords.

    The following tags are currently being used by other notes:
    ${r.join(", ")}
    
    Always follow the below rules, if any, given by the user:
    ${f.promptInstructions.tagRules}`,i=`Page Title: ${t}

Page Content:
${e}`,a=(await k.singleMessageChat(i,n)).trim().replace(/,/g,"").split(/\s+/),s=await F.parseMarkdown(e),c=await Q(s),l=[...new Set([...c.tags||[],...a])];c.tags=l,console.log("Current frontmatter:",c);let u=await Xe(s,c);console.log("updatedNoteContent",u),await m.dispatch(u),await m.flashNotification("Note tagged successfully.")}async function Tt(){await I();let e=await m.getText(),t=await m.getCurrentPage(),r=[{name:"Generating suggestions...",description:""}];m.filterBox("Loading...",r,"Retrieving suggestions from LLM provider.").then(l=>{console.log("Selected option (initial):",l)});let i="";f.promptInstructions.pageRenameSystem?i=f.promptInstructions.pageRenameSystem:i=`You are an AI note-naming assistant. Your task is to suggest three to five possible names for the provided note content. Please adhere to the following guidelines:
    - Provide each name on a new line.
    - Use only spaces, forward slashes (as folder separators), and hyphens as special characters.
    - Ensure the names are concise, descriptive, and relevant to the content.
    - Avoid suggesting the same name as the current note.
    - Include as much detail as possible within 3 to 10 words.
    - Start names with ASCII characters only.
    - Do not use markdown or any other formatting in your response.`;let a=(await k.singleMessageChat(`Current Page Title: ${t}

Page Content:
${e}`,`${i}

Always follow the below rules, if any, given by the user:
${f.promptInstructions.pageRenameRules}`,!0)).trim().split(`
`).filter(l=>l.trim()!=="").map(l=>l.replace(/^[*-]\s*/,"").trim());a.push(t),a=[...new Set(a)],a.length===0&&await m.flashNotification("No suggestions available.");let s=await m.filterBox("New page name",a.map(l=>({name:l})),"Select a new page name from one of the suggestions below.");if(!s){await m.flashNotification("No page name selected.","error");return}console.log("selectedSuggestion",s);let c=await A.invokeFunction("index.renamePageCommand",{oldPage:t,page:s.name});console.log("renamedPage",c),c||await m.flashNotification("Error renaming page.","error")}async function It(){await I();let e=await m.getText(),t=await m.getCurrentPage(),r=["title","tags"],i=await k.singleMessageChat(`Current Page Title: ${t}

Page Content:
${e}`,`You are an AI note enhancing assistant. Your task is to understand the content of a note, detect and extract important information, and convert it to frontmatter attributes. Please adhere to the following guidelines:
      - Only return valid YAML frontmatter.
      - Do not use any markdown or any other formatting in your response.
      - Do not include --- in your response.
      - Do not include any content from the note in your response.
      - Extract useful facts from the note and add them to the frontmatter, such as a person's name, age, a location, etc.
      - Do not return any tags.
      - Do not return a new note title.
      - Do not use special characters in key names.  Only ASCII.
      - Only return important information that would be useful when searching or filtering notes.
      

Always follow the below rules, if any, given by the user:
${f.promptInstructions.enhanceFrontMatterPrompt}`,!0);console.log("frontmatter returned by enhanceNoteFrontMatter",i);try{let o=zr(i);if(typeof o!="object"||Array.isArray(o)||!o)throw new Error("Invalid YAML: Not an object");r.forEach(u=>{delete o[u]});let a=await F.parseMarkdown(e),c={...await Q(a),...o},l=await Xe(a,c);console.log("updatedNoteContent",l),await m.dispatch(l)}catch(o){console.error("Invalid YAML returned by enhanceNoteFrontMatter",o),await m.flashNotification("Error: Invalid Frontmatter YAML returned.","error");return}await m.flashNotification("Frontmatter enhanced successfully.","info")}async function on(){await Ct(),await It(),await Tt()}async function an(){let e=await ve(),t=e.to;await k.streamChatIntoEditor({messages:[{role:"system",content:"You are an AI note assistant in a markdown-based note tool."},{role:"user",content:e.text}],stream:!0},t)}async function sn(){await I();let e=await er();if(e.length===0){await m.flashNotification("Error: The page does not match the required format for a chat.");return}e.unshift(ue);let t=await Fe(e);console.log("enrichedMessages",t);let r=await re();await m.insertAtPos(`

**assistant**: `,r),r+=17,await m.insertAtPos(`

**user**: `,r),await m.moveCursor(r+12);try{await k.streamChatIntoEditor({messages:t,stream:!0},r)}catch(n){console.error("Error streaming chat on page:",n),await m.flashNotification("Error streaming chat on page.","error")}}async function cn(){if(await I(),!f.imageModels||f.imageModels.length===0){await m.flashNotification("No image models available.","error");return}try{let e=await m.prompt("Enter a prompt for DALL\xB7E:");if(!e||!e.trim()){await m.flashNotification("No prompt entered. Operation cancelled.","error");return}let t={prompt:e,numImages:1,size:"1024x1024",quality:"hd"},r=await st.generateImage(t);if(r&&r.data&&r.data.length>0){let n=r.data[0].b64_json,i=r.data[0].revised_prompt,o=new Uint8Array(cr(n)),a=`dall-e-${Date.now()}.png`,s=Xt(await m.getCurrentPage())+"/";s==="/"&&(s=""),await j.writeAttachment(s+a,o);let c=`![${a}](${a})
*${i}*`;await m.insertAtCursor(c),await m.flashNotification("Image generated and inserted with caption successfully.")}else await m.flashNotification("Failed to generate image.","error")}catch(e){console.error("Error generating image with DALL\xB7E:",e),await m.flashNotification("Error generating image.","error")}}async function ln(e,t){try{return await I(),await k.singleMessageChat(e,t||"You are an AI note assistant helping to render content for a note. Please follow user instructions and keep your response short and concise.")}catch(r){throw console.error("Error querying OpenAI:",r),r}}async function dn(){await I();let e=await m.prompt("Enter some text to embed:");if(!e){await m.flashNotification("No text entered.","error");return}let t=await D.generateEmbeddings({text:e});await m.insertAtCursor(`

Embedding: ${t}`)}var un={aiPromptSlashCommplete:nr,queryAI:ln,reloadConfig:Qr,summarizeNote:nn,insertSummary:rn,callOpenAI:en,tagNoteWithAI:Ct,promptAndGenerateImage:cn,streamOpenAIWithSelectionAsPrompt:an,streamChatOnPage:sn,insertAiPromptFromTemplate:ir,suggestPageName:Tt,enhanceNoteFrontMatter:It,enhanceNoteWithAI:on,selectTextModel:Jr,selectImageModel:Zr,selectEmbeddingModel:Xr,testEmbeddingGeneration:dn,getAllEmbeddings:rt,searchEmbeddings:nt,indexEmbeddings:Yt,indexSummaryEmbeddings:Ht,debugSearchEmbeddings:Vt,readPageSearchEmbeddings:zt,writePageSearchEmbeddings:Qt,getPageMetaSearchEmbeddings:it,searchCommand:Zt,updateSearchPage:Jt},pn={name:"silverbullet-ai",requiredPermissions:["fetch"],functions:{aiPromptSlashCommplete:{path:"src/prompts.ts:aiPromptSlashComplete",events:["slash:complete"]},queryAI:{path:"sbai.ts:queryAI"},reloadConfig:{path:"sbai.ts:reloadConfig",events:["page:saved"]},summarizeNote:{path:"sbai.ts:openSummaryPanel",command:{name:"AI: Summarize Note and open summary"}},insertSummary:{path:"sbai.ts:insertSummary",command:{name:"AI: Insert Summary"}},callOpenAI:{path:"sbai.ts:callOpenAIwithNote",command:{name:"AI: Call OpenAI with Note as context"}},tagNoteWithAI:{path:"sbai.ts:tagNoteWithAI",command:{name:"AI: Generate tags for note"}},promptAndGenerateImage:{path:"sbai.ts:promptAndGenerateImage",command:{name:"AI: Generate and insert image using DallE"}},streamOpenAIWithSelectionAsPrompt:{path:"sbai.ts:streamOpenAIWithSelectionAsPrompt",command:{name:"AI: Stream response with selection or note as prompt"}},streamChatOnPage:{path:"sbai.ts:streamChatOnPage",command:{name:"AI: Chat on current page",key:"Ctrl-Shift-Enter",mac:"Cmd-Shift-Enter"}},insertAiPromptFromTemplate:{path:"src/prompts.ts:insertAiPromptFromTemplate",command:{name:"AI: Execute AI Prompt from Custom Template"}},suggestPageName:{path:"sbai.ts:suggestPageName",command:{name:"AI: Suggest Page Name"}},enhanceNoteFrontMatter:{path:"sbai.ts:enhanceNoteFrontMatter",command:{name:"AI: Generate Note FrontMatter"}},enhanceNoteWithAI:{path:"sbai.ts:enhanceNoteWithAI",command:{name:"AI: Enhance Note"}},selectTextModel:{path:"sbai.ts:selectModelFromConfig",command:{name:"AI: Select Text Model from Config"}},selectImageModel:{path:"sbai.ts:selectImageModelFromConfig",command:{name:"AI: Select Image Model from Config"}},selectEmbeddingModel:{path:"sbai.ts:selectEmbeddingModelFromConfig",command:{name:"AI: Select Embedding Model from Config"}},testEmbeddingGeneration:{path:"sbai.ts:testEmbeddingGeneration",command:{name:"AI: Test Embedding Generation"}},getAllEmbeddings:{path:"src/embeddings.ts:getAllEmbeddings",env:"server"},searchEmbeddings:{path:"src/embeddings.ts:searchEmbeddings",env:"server"},indexEmbeddings:{path:"src/embeddings.ts:indexEmbeddings",env:"server",events:["page:index"]},indexSummaryEmbeddings:{path:"src/embeddings.ts:indexSummary",env:"server",events:["page:index"]},debugSearchEmbeddings:{path:"src/embeddings.ts:debugSearchEmbeddings",command:{name:"AI: Debug Search Embeddings"}},readPageSearchEmbeddings:{path:"src/embeddings.ts:readFileEmbeddings",pageNamespace:{pattern:"\u{1F916} .+",operation:"readFile"}},writePageSearchEmbeddings:{path:"src/embeddings.ts:writeFileEmbeddings",pageNamespace:{pattern:"\u{1F916} .+",operation:"writeFile"}},getPageMetaSearchEmbeddings:{path:"src/embeddings.ts:getFileMetaEmbeddings",pageNamespace:{pattern:"\u{1F916} .+",operation:"getFileMeta"}},searchCommand:{path:"src/embeddings.ts:searchCommand",command:{name:"AI: Search"}},updateSearchPage:{path:"src/embeddings.ts:updateSearchPage",events:["editor:pageLoaded","editor:pageReloaded"]}},assets:{}},su={manifest:pn,functionMapping:un};Nt(un,pn);export{su as plug};
/*! Bundled license information:

js-yaml/dist/js-yaml.mjs:
  (*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT *)
*/
